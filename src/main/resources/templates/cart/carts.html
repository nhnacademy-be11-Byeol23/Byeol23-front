<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>장바구니 - 별이삼shop</title>

    <th:block th:replace="~{fragments/file_link :: linkInfo}"></th:block>

    <style>
        .cart-grid {
            display: grid;
            grid-template-columns: 4fr 1fr 1fr 1fr 1fr;
            align-items: center;
            gap: 10px;
        }
        .cart-info-box {
            display: flex;
            align-items: flex-start;
        }
        .cart-item { gap: 10px; }
        .cart-col-info { min-width: 360px; }
        .cart-img {
            width: 90px;
            height: 120px;
            object-fit: cover;
            border-radius: 6px;
            flex-shrink: 0;
            margin-right: 15px;
        }
        .cart-price-info {
            margin-bottom: 2px;
        }
        .price-sale {
            color: #d32f2f;
            font-weight: bold;
            font-size: 15px;
        }
        .price-regular {
            text-decoration: line-through;
            color: #777;
            font-size: 14px;
        }
        .cart-col-qty { width: 150px; justify-content: center; }
        .cart-col-total { width: 130px; text-align: center; }
        .cart-col-remove { width: 80px; text-align: center; }
        .cart-col-order { width: 100px; text-align: center; }
        .cart-col-qty, .cart-col-total,
        .cart-col-remove, .cart-col-order {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .qty-btn {
            width: 32px;
            height: 32px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .qty-input {
            width: 55px;
            text-align: center;
        }
        .qty-input::-webkit-inner-spin-button,
        .qty-input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .qty-input {
            -moz-appearance: textfield;
        }
    </style>
</head>

<body>

<div th:replace="~{fragments/common_header :: commonHeader}"></div>

<main class="main">

    <div class="page-title light-background">
        <div class="container d-lg-flex justify-content-between align-items-center">
            <h1 class="mb-2 mb-lg-0">장바구니</h1>
            <nav class="breadcrumbs">
                <ol>
                    <li><a th:href="@{/}">홈</a></li>
                    <li class="current">장바구니</li>
                </ol>
            </nav>
        </div>
    </div>

    <section class="cart section">
        <div class="container">

            <div th:if="${cartBooks == null || cartBooks.isEmpty()}" class="text-center py-5">
                <i class="bi bi-cart-x" style="font-size: 80px; color: #ddd;"></i>
                <h3 class="mt-3">장바구니에 담긴 상품이 없습니다.</h3>
                <a th:href="@{/}" class="btn btn-accent">홈으로 돌아가기</a>
            </div>

            <div th:if="${cartBooks != null && !cartBooks.isEmpty()}">
                <div class="cart-grid fw-bold border-bottom py-2 mb-2">
                    <div class="cart-col-info">상품 정보</div>
                    <div class="cart-col-qty">수량</div>
                    <div class="cart-col-total">상품금액</div>
                    <div class="cart-col-remove">삭제</div>
                    <div class="cart-col-order">주문</div>
                </div>

                <div th:each="item : ${cartBooks}"
                     class="cart-item cart-grid py-3 border-bottom"
                     th:attr="data-book-id=${item.bookId}, data-sale-price=${item.salePrice}">

                    <div class="cart-info-box">
                        <img th:src="${item.imageUrl != null ? item.imageUrl : 'https://image.yes24.com/momo/Noimg_L.jpg'}" alt="상품 이미지" class="cart-img">

                        <div class="cart-text ms-3">
                            <div class="cart-title fw-bold mb-1"
                                 th:text="${item.bookName}"
                                 style="font-size: 16px;"></div>

                            <div class="cart-price-info">
                                <span class="price-sale"
                                      th:text="${#numbers.formatInteger(item.salePrice,3,'COMMA')} + '원'"></span>
                                <span class="price-regular ms-2"
                                      th:text="${#numbers.formatInteger(item.regularPrice,3,'COMMA')} + '원'"></span>
                            </div>

                        </div>
                    </div>

                    <div class="cart-col-qty">
                        <button class="qty-btn decrease btn btn-outline-secondary btn-sm">-</button>
                        <input type="number" class="qty-input form-control form-control-sm mx-2"
                               th:value="${item.quantity}" min="1" max="999">
                        <button class="qty-btn increase btn btn-outline-secondary btn-sm">+</button>
                    </div>

                    <div class="cart-col-total fw-bold">
                        <span class="item-total"
                            th:text="${#numbers.formatInteger(item.salePrice * item.quantity,3,'COMMA')} + '원'">
                        </span>
                    </div>

                    <div class="cart-col-remove">
                        <button class="remove-btn btn btn-outline-danger btn-sm"
                                th:attr="data-book-id=${item.bookId}">
                            삭제
                        </button>
                    </div>

                    <div class="cart-col-order">
                        <a class="btn btn-outline-secondary btn-sm"
                           th:href="@{#}">
                            주문
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<div th:replace="~{fragments/common_footer :: commonFooter}"></div>

<script>
    function updateRowTotal(row, qty) {
        const price = Number(row.dataset.salePrice);  // data-sale-price 가져오기
        const total = price * qty;
        row.querySelector(".item-total").textContent =
            total.toLocaleString() + "원";
    }

    const debounceTimers = {};

    function updateQuantity(bookId, quantity) {
        fetch(`/carts/books/${bookId}/update`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ quantity })
        })
            .then(res => {
                if (!res.ok) {
                    return res.json().then(body => {
                        throw new Error(body.message || "수량 변경 실패");
                    });
                }
            })
            .catch(err => alert(err.message));
    }

    document.querySelectorAll(".increase").forEach(btn => {
        btn.addEventListener("click", function () {
            const row = this.closest(".cart-item");
            const input = row.querySelector(".qty-input");
            const bookId = row.dataset.bookId;

            let qty = Number(input.value);
            if (qty < 999) qty++;

            input.value = qty;

            updateRowTotal(row, qty);

            if (debounceTimers[bookId]) clearTimeout(debounceTimers[bookId]);
            debounceTimers[bookId] = setTimeout(() => {
                updateQuantity(bookId, qty);
            }, 300);
        });
    });

    document.querySelectorAll(".decrease").forEach(btn => {
        btn.addEventListener("click", function () {
            const row = this.closest(".cart-item");
            const input = row.querySelector(".qty-input");
            const bookId = row.dataset.bookId;

            let qty = Number(input.value);
            if (qty > 1) qty--;

            input.value = qty;

            updateRowTotal(row, qty);

            if (debounceTimers[bookId]) clearTimeout(debounceTimers[bookId]);
            debounceTimers[bookId] = setTimeout(() => {
                updateQuantity(bookId, qty);
            }, 300);
        });
    });
    function deleteCartItem(bookId, row) {
        fetch(`/carts/books/${bookId}/delete`, {
            method: "POST",
            headers: { "Content-Type": "application/json" }
        })
            .then(res => {
                if (!res.ok) {
                    return res.json().then(body => {
                        throw new Error(body.message || "삭제 실패");
                    });
                }

                row.remove();

                if (document.querySelectorAll(".cart-item").length === 0) {
                    showEmptyCartView();
                }
            })
            .catch(err => alert(err.message));
    }

    function showEmptyCartView() {
        const container = document.querySelector(".cart .container");
        container.innerHTML = `
        <div class="text-center py-5">
            <i class="bi bi-cart-x" style="font-size: 80px; color: #ddd;"></i>
            <h3 class="mt-3">장바구니에 담긴 상품이 없습니다.</h3>
            <a href="/" class="btn btn-accent">홈으로 돌아가기</a>
        </div>
    `;
    }

    document.querySelectorAll(".remove-btn").forEach(btn => {
        btn.addEventListener("click", function () {
            const bookId = this.dataset.bookId;
            const row = this.closest(".cart-item");

            if (confirm("해당 상품을 장바구니에서 삭제하시겠습니까?")) {
                deleteCartItem(bookId, row);
            }
        });
    });
</script>
</body>
</html>
