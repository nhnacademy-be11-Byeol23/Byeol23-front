<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Ï£ºÎ¨∏ÎÇ¥Ïó≠ - Î≥ÑÏù¥ÏÇºshop</title>
    <meta name="description" content="">
    <meta name="keywords" content="">

    <th:block th:replace="~{fragments/file_link :: linkInfo}"></th:block>

    <!-- Custom Styles -->
    <style>
        /* Ï†ÄÏû• Î≤ÑÌäº Î∞è Ï∂îÍ∞Ä Î≤ÑÌäº Ïä§ÌÉÄÏùº */
        .modal-footer .btn-primary,
        .settings-form .btn-save,
        .section-header .btn-primary {
            background-color: #252223 !important;
            border-color: #252223 !important;
        }

        .modal-footer .btn-primary:hover,
        .settings-form .btn-save:hover,
        .section-header .btn-primary:hover {
            background-color: #1a1819 !important;
            border-color: #1a1819 !important;
        }

        /* ÌÜ†Í∏Ä Ïä§ÏúÑÏπò Ïä§ÌÉÄÏùº */
        .form-check-input:checked {
            background-color: #252223 !important;
            border-color: #252223 !important;
        }

        .form-check-input:focus {
            border-color: #252223 !important;
            box-shadow: 0 0 0 0.25rem rgba(37, 34, 35, 0.25) !important;
        }
        .order-card {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 1.25rem; /* 20px */
        }

        /* .order-contentÎ•º flex Ïª®ÌÖåÏù¥ÎÑàÎ°ú Î≥ÄÍ≤Ω
          (Ïù¥ÎØ∏ÏßÄ | ÌÖçÏä§Ìä∏ Ï†ïÎ≥¥) 2Îã® Î†àÏù¥ÏïÑÏõÉ
        */
        .order-content {
            display: flex;
            align-items: flex-start; /* ÏÉÅÎã® Ï†ïÎ†¨ */
            gap: 1.25rem; /* 20px Í∞ÑÍ≤© */
            padding: 1.25rem 0;
            border-bottom: 1px solid #f0f0f0;
            border-top: 1px solid #f0f0f0;
            margin-top: 1.25rem;
            margin-bottom: 1.25rem;
        }

        /* ... (Ïù¥Ï†Ñ CSSÎäî Í∑∏ÎåÄÎ°ú Îë†) ... */

        /* 1. Ïù¥ÎØ∏ÏßÄ Ïª®ÌÖåÏù¥ÎÑà (ÌÅ¨Í∏∞ ÌÇ§Ïö∞Í∏∞) */
        .product-image-container {
            width: 90px;
            height: 120px;
            flex-shrink: 0;
            background-color: #f8f8f8;
        }

        .product-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
        }

        /* 2. Î™®Îì† ÌÖçÏä§Ìä∏ Ï†ïÎ≥¥ Ïª®ÌÖåÏù¥ÎÑà (Flexbox + ÏñëÏ™Ω Ï†ïÎ†¨) */
        .product-details-container {
            flex-grow: 1; /* ÎÇ®ÏùÄ Í≥µÍ∞Ñ Î™®Îëê Ï∞®ÏßÄ */
            display: flex; /* ‚ú® ÏûêÏãù ÏöîÏÜå(ÏÉÅÌíàÏ†ïÎ≥¥, Ï£ºÎ¨∏ÏöîÏïΩ)Î•º Í∞ÄÎ°úÎ°ú Î∞∞Ïπò */
            justify-content: space-between; /* ‚ú® ÏñëÏ™Ω ÎÅùÏúºÎ°ú Ï†ïÎ†¨ */
            align-items: flex-start; /* ÏÉÅÎã® Ï†ïÎ†¨ */
        }

        /* 2-1. ÏôºÏ™Ω ÌÖçÏä§Ìä∏ Í∑∏Î£π (ÏÉÅÌíà Ï†ïÎ≥¥) */
        .product-details-container .product-info-group {
            /* (Î≥ÑÎèÑ Ïä§ÌÉÄÏùº Î∂àÌïÑÏöî) */
        }

        .product-details-container .book-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .product-details-container .item-meta {
            font-size: 0.95rem;
            color: #555;
            margin-bottom: 5px;
        }

        .product-details-container .item-meta .separator { margin: 0 5px; }
        .product-details-container .item-meta .price { font-weight: 500; }

        .product-details-container .more-items {
            font-size: 0.9rem;
            color: #333;
        }

        /* 2-2. Ïò§Î•∏Ï™Ω ÌÖçÏä§Ìä∏ Í∑∏Î£π (Ï£ºÎ¨∏ ÏöîÏïΩ) */
        .product-details-container .order-info {
            /* margin-top: 1.5rem; /* flex-itemÏù¥ÎØÄÎ°ú ÏÉÅÎã® ÎßàÏßÑ Ï†úÍ±∞ */
            flex-shrink: 0; /* ÏöîÏïΩ Ï†ïÎ≥¥Í∞Ä Ï∞åÍ∑∏Îü¨ÏßÄÏßÄ ÏïäÎèÑÎ°ù */
        }

        .order-info .info-row {
            display: flex;
            justify-content: flex-end !important; /* ‚ú® Ïò§Î•∏Ï™Ω ÎÅù Ï†ïÎ†¨ */
            gap: 10px;                   /* ‚ú® ÎùºÎ≤®Í≥º Í∞í ÏÇ¨Ïù¥Ïùò Í∞ÑÍ≤© */
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .order-info .info-row .label {
            color: #6c757d;
            text-align: right; /* ÎùºÎ≤®ÎèÑ Ïò§Î•∏Ï™Ω Ï†ïÎ†¨ */
        }

        .order-info .info-row .value {
            font-weight: 500;
            text-align: right;
            min-width: 60px; /* Í∞íÏùò ÏµúÏÜå ÎÑàÎπÑÎ•º Ï£ºÏñ¥ Ï†ïÎ†¨ÏùÑ ÎßûÏ∂§ */
        }

        .order-info .info-row.total {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #f0f0f0;
        }
        .order-info .info-row.total .label {
            font-weight: 600;
            color: #000;
        }
        .order-info .info-row.total .value {
            font-weight: 700;
            font-size: 1.1rem;
            color: #000;
        }

        /* 3. Ï£ºÎ¨∏ ÏöîÏïΩ Ï†ïÎ≥¥ (Ïò§Î•∏Ï™Ω Ï†ïÎ†¨) */
        .product-details-container .order-info {
            margin-top: 1.5rem; /* ÏÉÅÌíà Ï†ïÎ≥¥ÏôÄ Í∞ÑÍ≤© ÎùÑÏö∞Í∏∞ */
        }

        /* ‚ú® .product-details-containerÎ•º ÏïûÏóê Î∂ôÏó¨ CSS Ïö∞ÏÑ†ÏàúÏúÑ ÌôïÎ≥¥ */
        .product-details-container .order-info .info-row {
            display: flex;
            justify-content: flex-end !important; /* üëà Ïò§Î•∏Ï™Ω ÎÅù Ï†ïÎ†¨ (space-between -> flex-end) */
            gap: 10px;                   /* ‚ú® ÎùºÎ≤®Í≥º Í∞í ÏÇ¨Ïù¥Ïùò Í∞ÑÍ≤©ÏùÑ 10pxÎ°ú Í≥†Ï†ï */
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        /* 4. ÎùºÎ≤®('Status', 'Items', 'Total') Ïä§ÌÉÄÏùº */
        .product-details-container .order-info .info-row .label {
            color: #6c757d;
            /* width: 60px; /* Í≥†Ï†ï ÎÑàÎπÑ Ï†úÍ±∞ (flex-endÏù¥ÎØÄÎ°ú Î∂àÌïÑÏöî) */
            flex-shrink: 0; /* ÎùºÎ≤®Ïù¥ Ï§ÑÏñ¥Îì§ÏßÄ ÏïäÎèÑÎ°ù */
        }

        /* 5. Í∞í('ÎåÄÍ∏∞', '1 items' Îì±) Ïä§ÌÉÄÏùº */
        .product-details-container .order-info .info-row .value {
            font-weight: 500;
        }

        /* 6. Total ÌñâÎßå Í∞ïÏ°∞ */
        .product-details-container .order-info .info-row.total {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #f0f0f0;
        }
        .product-details-container .order-info .info-row.total .label {
            font-weight: 600;
            color: #000;
        }
        .product-details-container .order-info .info-row.total .value {
            font-weight: 700;
            font-size: 1.1rem;
            color: #000;
        }
    </style>

</head>

<body class="account-page">

<div th:replace="~{fragments/common_header :: commonHeader}"></div>

<main class="main">

    <!-- Page Title -->
    <div class="page-title light-background">
        <div class="container d-lg-flex justify-content-between align-items-center">
            <h1 class="mb-2 mb-lg-0">Ï£ºÎ¨∏ÎÇ¥Ïó≠</h1>
            <nav class="breadcrumbs">
                <ol>
                    <li><a th:href="@{/}">Ìôà</a></li>
                    <li><a th:href="@{/mypage}">ÎßàÏù¥ÌéòÏù¥ÏßÄ</a></li>
                    <li class="current">Ï£ºÎ¨∏ÎÇ¥Ïó≠</li>
                </ol>
            </nav>
        </div>
    </div><!-- End Page Title -->

    <!-- Account Section -->
    <section id="account" class="account section">

        <div class="container" data-aos="fade-up" data-aos-delay="100">

            <!-- Mobile Menu Toggle -->
            <div class="mobile-menu d-lg-none mb-4">
                <button class="mobile-menu-toggle" type="button" data-bs-toggle="collapse"
                        data-bs-target="#profileMenu">
                    <i class="bi bi-grid"></i>
                    <span>Menu</span>
                </button>
            </div>

            <div class="row g-4">
                <!-- Profile Menu -->
                <div class="col-lg-3">
                    <div th:replace="~{fragments/mypage_profile :: mypage_profile}"></div>
                </div>

                <!-- Content Area -->
                <div class="col-lg-9">
                    <div class="content-area">
                        <div id="orders">
                            <div class="section-header" data-aos="fade-up">
                                <h2>Ï£ºÎ¨∏ ÎÇ¥Ïó≠</h2>
                            </div>

                            <div class="orders-grid" th:if="${orders != null and !orders.isEmpty()}">
                                <div class="order-card" data-aos="fade-up" data-aos-delay="100"
                                     th:each="viewModel : ${orders}">

                                    <div class="order-header">
                                        <div class="order-id">
                                            <span class="label">Ï£ºÎ¨∏ Î≤àÌò∏:</span>
                                            <span class="value" th:text="${viewModel.order.orderNumber}">...</span>
                                        </div>
                                        <div class="order-date"
                                             th:text="${#temporals.format(viewModel.order.orderDate, 'yyyy-MM-dd')}">...
                                        </div>
                                    </div>

                                    <div class="order-content">
                                        <div class="product-grid">
                                            <img th:src="${viewModel.firstImageUrl}"
                                                 th:alt="${viewModel.order.items[0].bookTitle}"
                                                 alt="Product Image" loading="lazy">
                                        </div>
                                        <div class="product-details-container"
                                             th:if="${!#lists.isEmpty(viewModel.order.items)}"
                                             th:with="firstItem = ${viewModel.order.items[0]},
                                                    totalItems = ${#lists.size(viewModel.order.items)}">

                                            <div class="product-info-group">
                                                <h6 class="book-title" th:text="${firstItem.bookTitle}">Book Title</h6>
                                                <div class="item-meta">
                                                    <span th:text="'ÏàòÎüâ: ' + ${firstItem.quantity}">ÏàòÎüâ: 1</span>
                                                    <span class="separator">|</span>
                                                    <span class="price" th:text="${#numbers.formatCurrency(firstItem.price)}">‚Ç©15,000</span>
                                                </div>
                                                <div class="more-items" th:if="${totalItems > 1}">
                                                    <span th:text="'Ïô∏ ' + (${totalItems} - 1) + 'Í±¥'">Ïô∏ 2Í±¥</span>
                                                </div>
                                            </div>

                                            <div class="order-info">
                                                <div class="info-row">
                                                    <span class="value" th:text="${viewModel.order.orderStatus}">...</span>
                                                </div>
                                                <div class="info-row">
                                                    <span class="value" th:text="${#lists.size(viewModel.order.items)} + ' items'">...</span>
                                                </div>
                                                <div class="info-row total">
                                                    <span class="label">Ï†ÑÏ≤¥ Ï£ºÎ¨∏ Í∏àÏï°</span>
                                                    <span class="value price"
                                                          th:text="${#numbers.formatCurrency(viewModel.order.actualOrderPrice)}">...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="order-footer">
                                        <button type="button" class="btn btn-light w-100"
                                                data-bs-toggle="modal"
                                                data-bs-target="#orderDetailsModal"
                                                th:data-order-id="${viewModel.order.orderNumber}">
                                            View Details
                                        </button>
                                    </div>

                                    <div class="collapse tracking-info"
                                         th:id="'tracking-' + ${viewModel.order.orderNumber}">
                                    </div>

                                </div>
                            </div>

                            <div class="alert alert-info" th:if="${orders == null or orders.isEmpty()}">
                                Ï£ºÎ¨∏ ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.
                            </div>

                            <div class="pagination-wrapper" data-aos="fade-up">
                            </div>


                        </div>
                    </div>
                </div>

            </div>
        </div>
    </section><!-- /Account Section -->

</main>

<div th:replace="~{fragments/common_footer :: commonFooter}"></div>

<!-- Scroll Top -->
<a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i
        class="bi bi-arrow-up-short"></i></a>

<!-- Preloader -->
<div id="preloader"></div>

<!-- Vendor JS Files -->
<script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/assets/vendor/php-email-form/validate.js"></script>
<script src="/assets/vendor/swiper/swiper-bundle.min.js"></script>
<script src="/assets/vendor/aos/aos.js"></script>
<script src="/assets/vendor/glightbox/js/glightbox.min.js"></script>
<script src="/assets/vendor/drift-zoom/Drift.min.js"></script>
<script src="/assets/vendor/purecounter/purecounter_vanilla.js"></script>

<!-- Main JS File -->
<script src="/assets/js/main.js"></script>

<div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orderDetailsModalLabel">
                    Ï£ºÎ¨∏ ÏÉÅÏÑ∏ (<span id="modal-order-number">#ORD-XXXX</span>)
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modal-order-body">
                <div class="text-center p-5">
                    <div class="spinner-border text-dark" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Îã´Í∏∞</button>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">

    // DTOÏùò price(Ïà´Ïûê)Î•º ÌÜµÌôî ÌòïÏãù(Ïòà: ‚Ç©3,024)ÏúºÎ°ú Î≥ÄÌôòÌïòÎäî Ìó¨Ìçº Ìï®Ïàò
    function formatCurrency(price) {
        if (price == null) return '';
        return new Intl.NumberFormat('ko-KR', {
            style: 'currency',
            currency: 'KRW'
        }).format(price);
    }

    // Î°úÎî© Ïä§ÌîºÎÑàÎ•º ÏÉùÏÑ±ÌïòÎäî Ìó¨Ìçº Ìï®Ïàò
    function createLoadingSpinner() {
        const wrapper = document.createElement('div');
        wrapper.className = 'text-center p-5';

        const spinner = document.createElement('div');
        spinner.className = 'spinner-border text-dark';
        spinner.setAttribute('role', 'status');

        const visuallyHidden = document.createElement('span');
        visuallyHidden.className = 'visually-hidden';
        visuallyHidden.textContent = 'Loading...';

        spinner.appendChild(visuallyHidden);
        wrapper.appendChild(spinner);
        return wrapper;
    }

    document.addEventListener('DOMContentLoaded', () => {
        const orderDetailsModal = document.getElementById('orderDetailsModal');

        orderDetailsModal.addEventListener('show.bs.modal', async (event) => {
            const button = event.relatedTarget;
            const orderNumber = button.getAttribute('data-order-id');

            const modalBody = document.getElementById('modal-order-body');
            const modalOrderNum = document.getElementById('modal-order-number');

            // 1. Î™®Îã¨ ÎÇ¥Ïö©ÏùÑ Î°úÎî© Ïä§ÌîºÎÑàÎ°ú Ï¥àÍ∏∞Ìôî (DOM API ÏÇ¨Ïö©)
            while (modalBody.firstChild) {
                modalBody.removeChild(modalBody.firstChild);
            }
            modalBody.appendChild(createLoadingSpinner());
            modalOrderNum.textContent = '...';

            try {
                // 2. ÏÑúÎ≤ÑÏóê Ï£ºÎ¨∏ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÏöîÏ≤≠
                const response = await fetch(`/mypage/orders/${orderNumber}`);
                if (!response.ok) throw new Error('Ï£ºÎ¨∏ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§Îäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');

                const orderData = await response.json();

                // 3. Î™®Îã¨ ÎÇ¥Ïö© HTML ÏÉùÏÑ± (DOM API ÏÇ¨Ïö©)
                modalOrderNum.textContent = orderData.orderNumber;

                // Î°úÎî© Ïä§ÌîºÎÑà Ï†úÍ±∞
                while (modalBody.firstChild) {
                    modalBody.removeChild(modalBody.firstChild);
                }

                const items = orderData.items || [];

                // --- "Ï£ºÎ¨∏ ÏÉÅÌíà" ÏÑπÏÖò ---
                const h5Items = document.createElement('h5');
                h5Items.textContent = `Ï£ºÎ¨∏ ÏÉÅÌíà (${items.length}Í∞ú)`;
                modalBody.appendChild(h5Items);

                const orderItemsDiv = document.createElement('div');
                orderItemsDiv.className = 'order-items';

                items.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'item';

                    const itemInfoDiv = document.createElement('div');
                    itemInfoDiv.className = 'item-info';
                    itemInfoDiv.style.width = '70%';

                    const h6Title = document.createElement('h6');
                    h6Title.textContent = item.bookTitle; // .textContentÎ°ú XSS Î∞©ÏßÄ
                    itemInfoDiv.appendChild(h6Title);

                    const itemMetaDiv = document.createElement('div');
                    itemMetaDiv.className = 'item-meta';

                    const spanQty = document.createElement('span');
                    spanQty.textContent = `ÏàòÎüâ : ${item.quantity}`; // .textContentÎ°ú XSS Î∞©ÏßÄ
                    itemMetaDiv.appendChild(spanQty);
                    itemInfoDiv.appendChild(itemMetaDiv);

                    const itemPriceDiv = document.createElement('div');
                    itemPriceDiv.className = 'item-price';
                    itemPriceDiv.textContent = formatCurrency(item.price); // Ìó¨Ìçº Ìï®Ïàò ÏÇ¨Ïö©

                    itemDiv.appendChild(itemInfoDiv);
                    itemDiv.appendChild(itemPriceDiv);
                    orderItemsDiv.appendChild(itemDiv);
                });
                modalBody.appendChild(orderItemsDiv);

                modalBody.appendChild(document.createElement('hr'));

                // --- "Î∞∞ÏÜ°ÏßÄ Ï†ïÎ≥¥" ÏÑπÏÖò ---
                const h5Shipping = document.createElement('h5');
                h5Shipping.textContent = 'Î∞∞ÏÜ°ÏßÄ Ï†ïÎ≥¥';
                modalBody.appendChild(h5Shipping);

                const addressInfoDiv = document.createElement('div');
                addressInfoDiv.className = 'address-info';

                const pAddress = document.createElement('p');

                const strongReceiver = document.createElement('strong');
                strongReceiver.textContent = orderData.receiver; // .textContent
                pAddress.appendChild(strongReceiver);
                pAddress.appendChild(document.createElement('br'));

                // .createTextNodeÎ•º ÏÇ¨Ïö©Ìï¥ ÏàúÏàò ÌÖçÏä§Ìä∏Î°ú ÏÇΩÏûÖ (XSS Î∞©ÏßÄ)
                pAddress.appendChild(document.createTextNode(`${orderData.receiverAddress} ${orderData.receiverAddressDetail}`));
                pAddress.appendChild(document.createElement('br'));
                pAddress.appendChild(document.createTextNode(`(${orderData.postCode})`));
                pAddress.appendChild(document.createElement('br'));
                pAddress.appendChild(document.createTextNode(orderData.receiverPhone));

                addressInfoDiv.appendChild(pAddress);
                modalBody.appendChild(addressInfoDiv);

            } catch (error) {
                // --- ÏóêÎü¨ Ï≤òÎ¶¨ (DOM API ÏÇ¨Ïö©) ---
                while (modalBody.firstChild) {
                    modalBody.removeChild(modalBody.firstChild);
                }
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger';
                errorDiv.textContent = error.message; // .textContent
                modalBody.appendChild(errorDiv);
            }
        });
    });
</script>
</body>

</html>
