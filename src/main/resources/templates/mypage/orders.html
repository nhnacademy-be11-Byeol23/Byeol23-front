<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>ì£¼ë¬¸ë‚´ì—­ - ë³„ì´ì‚¼shop</title>
    <meta name="description" content="">
    <meta name="keywords" content="">

    <th:block th:replace="~{fragments/file_link :: linkInfo}"></th:block>

    <!-- Custom Styles -->
    <style>
        /* ì €ì¥ ë²„íŠ¼ ë° ì¶”ê°€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .modal-footer .btn-primary,
        .settings-form .btn-save,
        .section-header .btn-primary {
            background-color: #252223 !important;
            border-color: #252223 !important;
        }

        .modal-footer .btn-primary:hover,
        .settings-form .btn-save:hover,
        .section-header .btn-primary:hover {
            background-color: #1a1819 !important;
            border-color: #1a1819 !important;
        }

        /* í† ê¸€ ìŠ¤ìœ„ì¹˜ ìŠ¤íƒ€ì¼ */
        .form-check-input:checked {
            background-color: #252223 !important;
            border-color: #252223 !important;
        }

        .form-check-input:focus {
            border-color: #252223 !important;
            box-shadow: 0 0 0 0.25rem rgba(37, 34, 35, 0.25) !important;
        }

        .order-card {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 1.25rem; /* 20px */
        }

        /* .order-contentë¥¼ flex ì»¨í…Œì´ë„ˆë¡œ ë³€ê²½
          (ì´ë¯¸ì§€ | í…ìŠ¤íŠ¸ ì •ë³´) 2ë‹¨ ë ˆì´ì•„ì›ƒ
        */
        .order-content {
            display: flex;
            align-items: flex-start; /* ìƒë‹¨ ì •ë ¬ */
            gap: 1.25rem; /* 20px ê°„ê²© */
            padding: 1.25rem 0;
            border-bottom: 1px solid #f0f0f0;
            margin-top: 1.25rem;
            margin-bottom: 1.25rem;
        }

        /* ... (ì´ì „ CSSëŠ” ê·¸ëŒ€ë¡œ ë‘ ) ... */

        /* 1. ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ (í¬ê¸° í‚¤ìš°ê¸°) */
        .product-image-container {
            width: 90px;
            height: 120px;
            flex-shrink: 0;
            background-color: #f8f8f8;
        }

        .product-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
        }

        /* 2. ëª¨ë“  í…ìŠ¤íŠ¸ ì •ë³´ ì»¨í…Œì´ë„ˆ (Flexbox + ì–‘ìª½ ì •ë ¬) */
        .product-details-container {
            flex-grow: 1;
            display: flex;
            justify-content: space-between;
            align-items: flex-start; /* âœ¨ Top alignment. ì´ ë¶€ë¶„ì´ ë°˜ë“œì‹œ í•„ìš”í•©ë‹ˆë‹¤. */
        }

        /* 2-1. ì™¼ìª½ í…ìŠ¤íŠ¸ ê·¸ë£¹ (ìƒí’ˆ ì •ë³´) */
        .product-details-container .product-info-group {
            /* (ë³„ë„ ìŠ¤íƒ€ì¼ ë¶ˆí•„ìš”) */
        }

        .product-details-container .book-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .product-details-container .item-meta {
            font-size: 0.95rem;
            color: #555;
            margin-bottom: 5px;
        }

        .product-details-container .item-meta .separator {
            margin: 0 5px;
        }

        .product-details-container .item-meta .price {
            font-weight: 500;
        }

        .product-details-container .more-items {
            font-size: 0.9rem;
            color: #333;
        }

        /* 2-2. ì˜¤ë¥¸ìª½ í…ìŠ¤íŠ¸ ê·¸ë£¹ (ì£¼ë¬¸ ìš”ì•½) */
        .product-details-container .order-info {
            /* margin-top: 1.5rem; /* flex-itemì´ë¯€ë¡œ ìƒë‹¨ ë§ˆì§„ ì œê±° */
            flex-shrink: 0; /* ìš”ì•½ ì •ë³´ê°€ ì°Œê·¸ëŸ¬ì§€ì§€ ì•Šë„ë¡ */
        }

        .order-info .info-row {
            display: flex;
            justify-content: flex-end !important; /* âœ¨ ì˜¤ë¥¸ìª½ ë ì •ë ¬ */
            gap: 10px; /* âœ¨ ë¼ë²¨ê³¼ ê°’ ì‚¬ì´ì˜ ê°„ê²© */
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .order-info .info-row .label {
            color: #6c757d;
            text-align: right; /* ë¼ë²¨ë„ ì˜¤ë¥¸ìª½ ì •ë ¬ */
        }

        .order-info .info-row .value {
            font-weight: 500;
            text-align: right;
            min-width: 60px; /* ê°’ì˜ ìµœì†Œ ë„ˆë¹„ë¥¼ ì£¼ì–´ ì •ë ¬ì„ ë§ì¶¤ */
        }



        .order-info .info-row.total .label {
            font-weight: 600;
            color: #000;
        }

        .order-info .info-row.total .value {
            font-weight: 700;
            font-size: 1.1rem;
            color: #000;
        }

        /* âœ¨ .product-details-containerë¥¼ ì•ì— ë¶™ì—¬ CSS ìš°ì„ ìˆœìœ„ í™•ë³´ */
        .product-details-container .order-info .info-row {
            display: flex;
            justify-content: flex-end !important; /* ğŸ‘ˆ ì˜¤ë¥¸ìª½ ë ì •ë ¬ (space-between -> flex-end) */
            gap: 10px; /* âœ¨ ë¼ë²¨ê³¼ ê°’ ì‚¬ì´ì˜ ê°„ê²©ì„ 10pxë¡œ ê³ ì • */
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        /* 4. ë¼ë²¨('Status', 'Items', 'Total') ìŠ¤íƒ€ì¼ */
        .product-details-container .order-info .info-row .label {
            color: #6c757d;
            /* width: 60px; /* ê³ ì • ë„ˆë¹„ ì œê±° (flex-endì´ë¯€ë¡œ ë¶ˆí•„ìš”) */
            flex-shrink: 0; /* ë¼ë²¨ì´ ì¤„ì–´ë“¤ì§€ ì•Šë„ë¡ */
        }

        /* 5. ê°’('ëŒ€ê¸°', '1 items' ë“±) ìŠ¤íƒ€ì¼ */
        .product-details-container .order-info .info-row .value {
            font-weight: 500;
        }

        .product-details-container .order-info .info-row.total .label {
            font-weight: 600;
            color: #000;
        }

        .product-details-container .order-info .info-row.total .value {
            font-weight: 700;
            font-size: 1.1rem;
            color: #000;
        }

        /* Modal spacing */
        .order-detail-modal .modal-header{
            padding: 20px 30px 20px 30px;
        }
        .order-detail-modal .modal-footer {
            padding: 20px 30px 20px 30px;
        }
        .order-detail-modal .modal-body
       {
            padding: 30px;
        }
    </style>

</head>

<body class="account-page">

<div th:replace="~{fragments/common_header :: commonHeader}"></div>

<main class="main">

    <!-- Page Title -->
    <div class="page-title light-background">
        <div class="container d-lg-flex justify-content-between align-items-center">
            <h1 class="mb-2 mb-lg-0">ì£¼ë¬¸ë‚´ì—­</h1>
            <nav class="breadcrumbs">
                <ol>
                    <li><a th:href="@{/}">í™ˆ</a></li>
                    <li><a th:href="@{/mypage}">ë§ˆì´í˜ì´ì§€</a></li>
                    <li class="current">ì£¼ë¬¸ë‚´ì—­</li>
                </ol>
            </nav>
        </div>
    </div><!-- End Page Title -->

    <!-- Account Section -->
    <section id="account" class="account section">

        <div class="container" data-aos-delay="100">

            <div class="mobile-menu d-lg-none mb-4">
                <button class="mobile-menu-toggle" type="button" data-bs-toggle="collapse"
                        data-bs-target="#profileMenu">
                    <i class="bi bi-grid"></i>
                    <span>Menu</span>
                </button>
            </div>

            <div class="row g-4">
                <div class="col-lg-3">
                    <div th:replace="~{fragments/mypage_profile :: mypage_profile}"></div>
                </div>

                <div class="col-lg-9">
                    <div class="content-area">
                        <div id="orders">
                            <div class="section-header" data-aos="fade-up">
                                <h2>ì£¼ë¬¸ ë‚´ì—­</h2>
                            </div>

                            <div class="orders-grid" th:if="${orders != null and !orders.isEmpty()}">

                                <div class="order-card" data-aos="fade-up" data-aos-delay="100"
                                     th:each="viewModel : ${viewModels}"
                                     th:with="firstItem = ${viewModel.order.items[0]}, totalItems = ${#lists.size(viewModel.order.items)}">

                                    <div class="order-header">
                                        <div class="order-id">
                                            <span class="label">ì£¼ë¬¸ ë²ˆí˜¸:</span>
                                            <span class="value" th:text="${viewModel.order.orderNumber}">...</span>
                                        </div>
                                        <div class="order-date"
                                             th:text="${#temporals.format(viewModel.order.orderDate, 'yyyy-MM-dd')}">...
                                        </div>
                                    </div>

                                    <div class="order-content">

                                        <div class="product-grid">
                                            <img th:src="${viewModel.firstImageUrl}"
                                                 th:alt="${firstItem.bookTitle}"
                                                 alt="Product Image" loading="lazy">
                                        </div>

                                        <div class="product-details-container"
                                             th:if="${!#lists.isEmpty(viewModel.order.items)}">

                                            <div class="product-info-group">
                                                <h6 class="book-title" th:text="${firstItem.bookTitle}">Book Title</h6>
                                                <div class="item-meta">
                                                    <span th:text="'ìˆ˜ëŸ‰: ' + ${firstItem.quantity}">ìˆ˜ëŸ‰: 1</span>
                                                    <span class="separator">|</span>
                                                    <span class="price" th:text="${#numbers.formatInteger(firstItem.price, 0, 'COMMA') + 'ì›'}">15,000ì›</span>
                                                </div>
                                                <div class="more-items" th:if="${totalItems > 1}">
                                                    <span th:text="'ì™¸ ' + (${totalItems} - 1) + 'ê±´'">ì™¸ 2ê±´</span>
                                                </div>
                                            </div>

                                            <div class="order-info">
                                                <div class="info-row">
                                                    <span class="label">ìƒíƒœ / ê°œìˆ˜:</span>
                                                    <span class="value" th:text="${viewModel.order.orderStatus} + ' (' + ${totalItems} + ' items)'">ëŒ€ê¸° (3 items)</span>
                                                </div>
                                                <div class="info-row total">
                                                    <span class="label">ì´ ê²°ì œ ê¸ˆì•¡</span>
                                                    <span class="value price"  th:text="${#numbers.formatInteger(viewModel.order.actualOrderPrice, 0, 'COMMA') + 'ì›'}">30,000ì›</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="order-footer">
                                        <button type="button" class="btn btn-light w-50"
                                                data-bs-toggle="modal"
                                                data-bs-target="#orderDetailsModal"
                                                th:data-order-id="${viewModel.order.orderNumber}">
                                            ì£¼ë¬¸ ìƒì„¸
                                        </button>
                                        <button type="button" class="btn btn-light w-50 review-open-btn"
                                                data-bs-toggle="modal"
                                                data-bs-target="#reviewModal"
                                                th:attr="data-order-number=${viewModel.order.orderNumber}">
                                            ë¦¬ë·° ì‘ì„±
                                        </button>
                                    </div>


                                    <!-- ìˆ¨ê²¨ì§„ select: ì´ ì£¼ë¬¸ì— í¬í•¨ëœ ë„ì„œë“¤ì„ ì„œë²„ì‚¬ì´ë“œì—ì„œ ë Œë”ë§ -->
                                    <select class="order-book-select" style="display:none;"
                                            th:if="${!#lists.isEmpty(viewModel.order.items)}">
                                        <option value="" disabled selected>ì„ íƒ</option>
                                        <option th:each="item : ${viewModel.order.items}"
                                                th:value="${item.bookId}"
                                                th:text="${item.bookTitle}">
                                            Book
                                        </option>
                                    </select>

                                    <div class="collapse tracking-info"
                                         th:id="'tracking-' + ${viewModel.order.orderNumber}">
                                    </div>

                                </div>
                            </div>
                            <div class="pagination-wrapper" data-aos="fade-up"
                                 th:if="${orders != null and orders.totalPages > 1}">

                                <a th:if="${orders.hasPrevious()}"
                                   th:href="@{/mypage/orders(page=${orders.number - 1})}"
                                   class="btn-prev">
                                    <i class="bi bi-chevron-left"></i>
                                </a>
                                <button type="button" class="btn-prev" th:unless="${orders.hasPrevious()}" disabled>
                                    <i class="bi bi-chevron-left"></i>
                                </button>

                                <div class="page-numbers">
                                    <th:block th:each="i : ${#numbers.sequence(0, orders.totalPages - 1)}">
                                        <a th:href="@{/mypage/orders(page=${i})}"
                                           th:text="${i + 1}"
                                           th:classappend="${i == orders.number ? 'active' : ''}">
                                            1
                                        </a>
                                    </th:block>
                                </div>

                                <a th:if="${orders.hasNext()}"
                                   th:href="@{/mypage/orders(page=${orders.number + 1})}"
                                   class="btn-next">
                                    <i class="bi bi-chevron-right"></i>
                                </a>
                                <button type="button" class="btn-next" th:unless="${orders.hasNext()}" disabled>
                                    <i class="bi bi-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<div th:replace="~{fragments/common_footer :: commonFooter}"></div>

<!-- Scroll Top -->
<a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i
        class="bi bi-arrow-up-short"></i></a>

<!-- Preloader -->
<div id="preloader"></div>

<!-- Vendor JS Files -->
<script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/assets/vendor/php-email-form/validate.js"></script>
<script src="/assets/vendor/swiper/swiper-bundle.min.js"></script>
<script src="/assets/vendor/aos/aos.js"></script>
<script src="/assets/vendor/glightbox/js/glightbox.min.js"></script>
<script src="/assets/vendor/drift-zoom/Drift.min.js"></script>
<script src="/assets/vendor/purecounter/purecounter_vanilla.js"></script>

<!-- Main JS File -->
<script src="/assets/js/main.js"></script>

<div class="modal fade order-detail-modal" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orderDetailsModalLabel">
                    ì£¼ë¬¸ ìƒì„¸ (<span id="modal-order-number">#ORD-XXXX</span>)
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modal-order-body">
                <div class="text-center p-5">
                    <div class="spinner-border text-dark" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>
<!-- Review Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <form id="reviewForm" enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title" id="reviewModalLabel">ë¦¬ë·° ì‘ì„±</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- ì£¼ë¬¸ë²ˆí˜¸ë¥¼ ì„œë²„ë¡œ ì „ì†¡í•˜ëŠ” ìˆ¨ê¹€ í•„ë“œ -->
                    <input type="hidden" name="orderNumber" id="reviewOrderNumber" value=""/>

                    <div class="mb-3">
                        <label class="form-label">ë¦¬ë·° ëŒ€ìƒ ë„ì„œ</label>
                        <select class="form-select" id="reviewBookId" name="bookId" required>
                            <option value="">ì„ íƒ</option>
                            <!-- ì˜µì…˜ì€ ëª¨ë‹¬ ì˜¤í”ˆ ì‹œ JSë¡œ ë³µì‚¬ë©ë‹ˆë‹¤ -->
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="reviewContent" class="form-label">ë¦¬ë·° ë‚´ìš©</label>
                        <textarea class="form-control" id="reviewContent" name="reviewContent" rows="4" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">í‰ì </label>
                        <select class="form-select" name="reviewRate" id="reviewRate" required>
                            <option value="">ì„ íƒ</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="reviewImage" class="form-label">ì´ë¯¸ì§€ (ì„ íƒ)</label>
                        <input class="form-control" type="file" id="reviewImage" name="image" accept="image/*">
                    </div>
                    <div id="reviewAlert" style="display:none;" class="alert" role="alert"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                    <button type="submit" class="btn btn-primary">ë“±ë¡í•˜ê¸°</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script th:inline="javascript">

    // DTOì˜ price(ìˆ«ì)ë¥¼ í†µí™” í˜•ì‹(ì˜ˆ: â‚©3,024)ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
    function formatCurrency(price) {
        if (price == null) return '';
        return new Intl.NumberFormat('ko-KR', {
            style: 'currency',
            currency: 'KRW'
        }).format(price);
    }

    // ë¡œë”© ìŠ¤í”¼ë„ˆë¥¼ ìƒì„±í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
    function createLoadingSpinner() {
        const wrapper = document.createElement('div');
        wrapper.className = 'text-center p-5';
        // Note: innerHTML ì‚¬ìš©ì„ í”¼í•´ì•¼ í•˜ì§€ë§Œ, ë¡œë”© ìŠ¤í”¼ë„ˆì˜ static HTML ì‚½ì…ì€ í—ˆìš©í•©ë‹ˆë‹¤.
        wrapper.innerHTML = `<div class="spinner-border text-dark" role="status"><span class="visually-hidden">Loading...</span></div>`;
        return wrapper;
    }

    document.addEventListener('DOMContentLoaded', () => {
        const orderDetailsModal = document.getElementById('orderDetailsModal');

        orderDetailsModal.addEventListener('show.bs.modal', async (event) => {
            const button = event.relatedTarget;
            const orderNumber = button.getAttribute('data-order-id');

            const modalBody = document.getElementById('modal-order-body');
            const modalOrderNum = document.getElementById('modal-order-number');

            // 1. ëª¨ë‹¬ ë‚´ìš©ì„ ë¡œë”© ìŠ¤í”¼ë„ˆë¡œ ì´ˆê¸°í™”
            while (modalBody.firstChild) {
                modalBody.removeChild(modalBody.firstChild);
            }
            modalBody.appendChild(createLoadingSpinner());
            modalOrderNum.textContent = '...';

            try {
                // 2. âœ¨ ì„œë²„ì— ë Œë”ë§ëœ HTML Fragmentë¥¼ ìš”ì²­í•©ë‹ˆë‹¤.
                // (ê°€ì •: ControllerëŠ” /api/orders/modal-content/{orderNumber}ì— ë§¤í•‘ë˜ì–´ ìˆìŒ)
                const url = `/mypage/orders/${orderNumber}`;
                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error('ì£¼ë¬¸ ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

                // 3. ë Œë”ë§ëœ HTML ë¬¸ìì—´ì„ íšë“
                const renderedHtml = await response.text();

                // 4. ì„±ê³µ: ë¡œë”© ìŠ¤í”¼ë„ˆ ì œê±° í›„, HTML Fragmentë¥¼ innerHTMLë¡œ ì£¼ì…
                while (modalBody.firstChild) {
                    modalBody.removeChild(modalBody.firstChild);
                }
                modalBody.innerHTML = renderedHtml;

                // 5. ëª¨ë‹¬ ì œëª© ì—…ë°ì´íŠ¸ (ì£¼ë¬¸ ë²ˆí˜¸ ì¬ì‚¬ìš©)
                modalOrderNum.textContent = orderNumber;

            } catch (error) {
                // --- ì—ëŸ¬ ì²˜ë¦¬ (DOM API ì‚¬ìš©) ---
                while (modalBody.firstChild) {
                    modalBody.removeChild(modalBody.firstChild);
                }
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger';
                errorDiv.textContent = error.message || 'ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                modalBody.appendChild(errorDiv);
            }
        });
    });

    window.refundModalInstance = null;
    window.currentRefundOrderNumber = null;
    window.currentAppliedFee = 0;
    window.currentDeliveryStartDate = null;

    function displayAlert(message) {
        console.warn('Alert: ' + message);
        alert(message);
    }

    function getDateDifferenceInDays(date1, date2) {
        const diffTime = Math.abs(date2 - date1);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays;
    }

    function handleToggleRefundSection(buttonElement) {
        const refundSection = document.getElementById('refundSection');
        const refundReasonSelect = document.getElementById('refundReason');
        const isVisible = refundSection.style.display !== 'none';

        if (isVisible) {
            // ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            refundSection.style.display = 'none';
            return;
        }

        // ì„¹ì…˜ ë³´ì´ê¸°
        refundSection.style.display = 'block';

        // ë°ì´í„° ì´ˆê¸°í™” (ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œ í•˜ë˜ ì‘ì—…)
        const dataset = buttonElement.dataset;
        window.currentRefundOrderNumber = dataset.orderNumber;
        window.currentAppliedFee = parseFloat(dataset.appliedFee);
        window.currentDeliveryStartDate = new Date(dataset.orderDate);

        if (refundReasonSelect) {
            refundReasonSelect.value = "";

            const changeHandler = function(event) {
                handleUpdateRefundPolicy(event.target.value);
            };

            refundReasonSelect.removeEventListener('change', window.refundReasonChangeHandler);
            refundReasonSelect.addEventListener('change', changeHandler);
            window.refundReasonChangeHandler = changeHandler; // ì œê±°ë¥¼ ìœ„í•´ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥

            handleUpdateRefundPolicy(""); // ì •ì±… ì´ˆê¸°í™”
        }
    }

    window.processRefund = function () {
        // ë¡œê·¸ê°€ ì•ˆ ì°íˆëŠ” ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ ì´ í•¨ìˆ˜ë¥¼ handleProcessRefundì˜ ë³„ì¹­ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
        handleProcessRefund();
    }

    function handleUpdateRefundPolicy(reason) {
        const refundPolicyText = document.getElementById('refundPolicyText');
        const refundDeliveryFeeDisplay = document.getElementById('refundDeliveryFee');
        const processRefundBtn = document.getElementById('processRefundBtn');

        const currentDeliveryStartDate = window.currentDeliveryStartDate;
        const currentAppliedFee = window.currentAppliedFee;

        // --- ìœ íš¨ì„± ê²€ì‚¬ ë° ì •ì±… ë¡œì§ (ì´ì „ ë¡œì§ ìœ ì§€) ---
        if (!refundPolicyText || !currentDeliveryStartDate || !processRefundBtn || isNaN(currentAppliedFee)) {
            refundPolicyText.innerHTML = '<p class="text-danger">ì˜¤ë¥˜: ì£¼ë¬¸ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>';
            if (processRefundBtn) processRefundBtn.disabled = true;
            return;
        }

        const today = new Date();
        const daysPassed = getDateDifferenceInDays(currentDeliveryStartDate, today);
        let policyHtml = '';
        let deliveryFeeText = '';
        let isValid = true;
        const fee = currentAppliedFee;

        if (reason === 'simple_change') {
            if (daysPassed <= 10) {
                policyHtml = `<p class="text-success fw-bold">ì •ì±… ì ìš© ê°€ëŠ¥: ë‹¨ìˆœ ë³€ì‹¬ (10ì¼ ì´ë‚´)</p><p>ë°˜í’ˆ/í™˜ë¶ˆ ê¸ˆì•¡ì€ **ë°˜í’ˆ íƒë°°ë¹„ ${fee.toLocaleString()}ì›**ì„ ì œì™¸í•˜ê³  **ì „ì•¡ í¬ì¸íŠ¸**ë¡œ í™˜ë¶ˆë©ë‹ˆë‹¤.</p>`;
                deliveryFeeText = `(ì°¨ê°) ${fee.toLocaleString()}ì›`;
            } else {
                policyHtml = `<p class="text-danger fw-bold">ì •ì±… ì ìš© ë¶ˆê°€</p><p>ë‹¨ìˆœ ë³€ì‹¬ ë°˜í’ˆ/í™˜ë¶ˆì€ ë°°ì†¡ ì‹œì‘ì¼(${currentDeliveryStartDate.toLocaleDateString()})ë¡œë¶€í„° 10ì¼ ì´ë‚´ì—ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤. (ê²½ê³¼ì¼: ${daysPassed}ì¼)</p>`;
                deliveryFeeText = '-';
                isValid = false;
            }
        } else if (reason === 'damage') {
            if (daysPassed <= 30) {
                policyHtml = `<p class="text-success fw-bold">ì •ì±… ì ìš© ê°€ëŠ¥: íŒŒì†/íŒŒë³¸ (30ì¼ ì´ë‚´)</p><p>ìƒí’ˆ ë¬¸ì œë¡œ ì¸í•œ ë°˜í’ˆ/í™˜ë¶ˆì€ **ë°°ì†¡ë¹„ í¬í•¨ ì „ì•¡ í¬ì¸íŠ¸**ë¡œ í™˜ë¶ˆë©ë‹ˆë‹¤.</p>`;
                deliveryFeeText = `0ì› (ë°°ì†¡ë¹„ ë©´ì œ)`;
            } else {
                policyHtml = `<p class="text-danger fw-bold">ì •ì±… ì ìš© ë¶ˆê°€</p><p>íŒŒì†/íŒŒë³¸ ë°˜í’ˆ/í™˜ë¶ˆì€ ë°°ì†¡ ì‹œì‘ì¼(${currentDeliveryStartDate.toLocaleDateString()})ë¡œë¶€í„° 30ì¼ ì´ë‚´ì—ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤. (ê²½ê³¼ì¼: ${daysPassed}ì¼)</p>`;
                deliveryFeeText = '-';
                isValid = false;
            }
        } else {
            policyHtml = '<p class="text-secondary">í™˜ë¶ˆ ì‚¬ìœ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>';
            deliveryFeeText = '-';
            isValid = false;
        }

        refundPolicyText.innerHTML = policyHtml;
        if (refundDeliveryFeeDisplay) refundDeliveryFeeDisplay.textContent = deliveryFeeText;
        if (processRefundBtn) processRefundBtn.disabled = !isValid;

    }

    function handleCancelOrderByUser(orderNumber) {
        console.log("ì·¨ì†Œ ë²„íŠ¼ ëˆŒë¦¼ - Delegate íŒ¨í„´ ìµœì¢… í™•ì¸. ì£¼ë¬¸ ë²ˆí˜¸: " + orderNumber);
        if (!confirm(`ì£¼ë¬¸ ë²ˆí˜¸ [${orderNumber}]ì˜ ê²°ì œë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            return;
        }
        const url = `/orders/${orderNumber}/cancel`;
        const orderCancelRequest = {cancelReason: "ê³ ê° ìš”ì²­ì— ì˜í•œ ì·¨ì†Œ"};

        fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(orderCancelRequest)
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.message || "ê²°ì œ ì·¨ì†Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
                    });
                }
                return response.text();
            })
            .then(() => {
                displayAlert(`ì£¼ë¬¸ [${orderNumber}]ì´(ê°€) ì„±ê³µì ìœ¼ë¡œ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.`);
                window.location.reload();
            })
            .catch(error => {
                console.error("Order cancellation failed:", error);
                displayAlert(`ê²°ì œ ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            });
    }

    function handleOpenRefundModal(buttonElement) {
        const dataset = buttonElement.dataset;
        window.currentRefundOrderNumber = dataset.orderNumber;
        window.currentAppliedFee = parseFloat(dataset.appliedFee);
        window.currentDeliveryStartDate = new Date(dataset.orderDate);

        if (!window.refundModalInstance) {
            const refundModalElement = document.getElementById('refundModal');

            // ìš”ì†ŒëŠ” ì°¾ì•˜ì§€ë§Œ, Bootstrapì´ ë¡œë“œë˜ì—ˆëŠ”ì§€ë„ í™•ì¸í•©ë‹ˆë‹¤.
            if (refundModalElement && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                window.refundModalInstance = new bootstrap.Modal(refundModalElement);
            } else {
                // ì´ ê²½ê³ ê°€ ëœ¬ë‹¤ë©´: 1. Fragmentê°€ ì œëŒ€ë¡œ ë¡œë“œë˜ì§€ ì•ŠìŒ. 2. Bootstrap JS ë¡œë“œ ë¬¸ì œ.
                displayAlert("í™˜ë¶ˆ ëª¨ë‹¬ì„ ì°¾ê±°ë‚˜ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ëª¨ë‹¬ HTMLì´ DOMì— ìˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.");
                return;
            }
        }

        const refundReasonSelect = document.getElementById('refundReason');
        if (refundReasonSelect) refundReasonSelect.value = "";
        handleUpdateRefundPolicy("");

        window.refundModalInstance.show();
    }

    function handleProcessRefund() { // HTMLì˜ onclickì— ì—°ê²°\
        console.log("í™˜ë¶ˆ/ë°˜í’ˆ ë²„íŠ¼ í´ë¦­");

        const refundReasonSelect = document.getElementById('refundReason');
        const processRefundBtn = document.getElementById('processRefundBtn');
        const reason = refundReasonSelect ? refundReasonSelect.value : "";

        if (reason === "" || (processRefundBtn && processRefundBtn.disabled)) {
            displayAlert("í™˜ë¶ˆ/ë°˜í’ˆ ì‚¬ìœ ë¥¼ ì„ íƒí•˜ê±°ë‚˜, ì •ì±… ì ìš© ê°€ëŠ¥ ìƒíƒœì¸ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.");
            return;
        }
        if (!confirm(`ì„ íƒ ì‚¬ìœ  (${reason})ë¡œ í™˜ë¶ˆì„ ìš”ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ê¸ˆì•¡ì€ í¬ì¸íŠ¸ë¡œ í™˜ë¶ˆë©ë‹ˆë‹¤.`)) {
            return;
        }

        let refundOptionKey = '';

        if (reason === 'simple_change') {
            refundOptionKey = 'MIND_CHANGED'; // Enum: MIND_CHANGED("ë‹¨ìˆœ ë³€ì‹¬")
        } else if (reason === 'damage') {
            refundOptionKey = 'BREAK';      // Enum: BREAK("íŒŒì†, íŒŒë³¸")
        } else {
            displayAlert("ìœ íš¨í•˜ì§€ ì•Šì€ í™˜ë¶ˆ ì‚¬ìœ ì…ë‹ˆë‹¤.");
            return;
        }

        const url = `/refunds`;
        const refundRequest = {
            orderNumber: window.currentRefundOrderNumber,
            refundReason: reason,
            refundOption: refundOptionKey,
            appliedFee: window.currentAppliedFee
        };

        fetch(url, {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(refundRequest)})
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.message || "í™˜ë¶ˆ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
                    });
                }
                return response.text();
            })
            .then(() => {
                displayAlert(`ì£¼ë¬¸ [${window.currentRefundOrderNumber}]ì— ëŒ€í•œ í™˜ë¶ˆ ìš”ì²­ì´ ì„±ê³µì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.`);
                if (window.refundModalInstance) window.refundModalInstance.hide();
                window.location.reload();
            })
            .catch(error => {
                console.error("Refund failed:", error);
                if (window.refundModalInstance) window.refundModalInstance.hide();
                displayAlert(`í™˜ë¶ˆ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            });
    }

    document.addEventListener('DOMContentLoaded', () => {

        // Modal ì¸ìŠ¤í„´ìŠ¤ ìƒì„± (ë¶€ëª¨ í˜ì´ì§€ì—ì„œ í•œ ë²ˆë§Œ)
        document.body.addEventListener('change', function (event) {
            const target = event.target;

            // 1. í™˜ë¶ˆ ì‚¬ìœ  ì„ íƒ ë°•ìŠ¤(id='refundReason')ì˜ ë³€ê²½ ê°ì§€
            if (target.id === 'refundReason') {
                const selectedReason = target.value;
                handleUpdateRefundPolicy(selectedReason);
            }
        });

        document.body.addEventListener('click', function (event) {
            const target = event.target;

            // 1. ì£¼ë¬¸ ì·¨ì†Œ ë²„íŠ¼(.js-cancel-order-btn) í™•ì¸
            if (target.classList.contains('js-cancel-order-btn')) {
                event.preventDefault();
                const orderNumber = target.dataset.orderNumber;
                handleCancelOrderByUser(orderNumber);
            }

            // 2. í™˜ë¶ˆ/ë°˜í’ˆ í† ê¸€ ë²„íŠ¼(.js-toggle-refund-section) í™•ì¸
            if (target.classList.contains('js-toggle-refund-section')) {
                event.preventDefault();
                handleToggleRefundSection(target);
            }

            if (target.id === 'processRefundBtn' || target.classList.contains('js-process-refund-btn')) {
                event.preventDefault();
                handleProcessRefund(); // ìƒˆë¡œìš´ í•¸ë“¤ëŸ¬ í˜¸ì¶œ
            }
        });
    });

</script>

</body>

</html>
