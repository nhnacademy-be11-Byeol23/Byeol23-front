<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>주문내역 - 별이삼shop</title>
    <meta name="description" content="">
    <meta name="keywords" content="">

    <th:block th:replace="~{fragments/file_link :: linkInfo}"></th:block>

    <!-- Custom Styles -->
    <style>
        /* 저장 버튼 및 추가 버튼 스타일 */
        .modal-footer .btn-primary,
        .settings-form .btn-save,
        .section-header .btn-primary {
            background-color: #252223 !important;
            border-color: #252223 !important;
        }

        .modal-footer .btn-primary:hover,
        .settings-form .btn-save:hover,
        .section-header .btn-primary:hover {
            background-color: #1a1819 !important;
            border-color: #1a1819 !important;
        }

        /* 토글 스위치 스타일 */
        .form-check-input:checked {
            background-color: #252223 !important;
            border-color: #252223 !important;
        }

        .form-check-input:focus {
            border-color: #252223 !important;
            box-shadow: 0 0 0 0.25rem rgba(37, 34, 35, 0.25) !important;
        }
    </style>

    <!-- Daum Postcode API -->
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>

<body class="account-page">

<div th:replace="~{fragments/common_header :: commonHeader}"></div>

<main class="main">

    <!-- Page Title -->
    <div class="page-title light-background">
        <div class="container d-lg-flex justify-content-between align-items-center">
            <h1 class="mb-2 mb-lg-0">주문내역</h1>
            <nav class="breadcrumbs">
                <ol>
                    <li><a th:href="@{/}">홈</a></li>
                    <li><a th:href="@{/mypage}">마이페이지</a></li>
                    <li class="current">주문내역</li>
                </ol>
            </nav>
        </div>
    </div><!-- End Page Title -->

    <!-- Account Section -->
    <section id="account" class="account section">

        <div class="container" data-aos="fade-up" data-aos-delay="100">

            <!-- Mobile Menu Toggle -->
            <div class="mobile-menu d-lg-none mb-4">
                <button class="mobile-menu-toggle" type="button" data-bs-toggle="collapse"
                        data-bs-target="#profileMenu">
                    <i class="bi bi-grid"></i>
                    <span>Menu</span>
                </button>
            </div>

            <div class="row g-4">
                <!-- Profile Menu -->
                <div class="col-lg-3">
                    <div th:replace="~{fragments/mypage_profile :: mypage_profile}"></div>
                </div>

                <!-- Content Area -->
                <div class="col-lg-9">
                    <div class="content-area">
                        <div id="orders">
                            <div class="section-header" data-aos="fade-up">
                                <h2>My Orders</h2>
                                <div class="header-actions">
                                    <div class="search-box">
                                        <i class="bi bi-search"></i>
                                        <input type="text" placeholder="Search orders...">
                                    </div>
                                    <div class="dropdown">
                                        <button class="filter-btn" data-bs-toggle="dropdown">
                                            <i class="bi bi-funnel"></i>
                                            <span>Filter</span>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#">All Orders</a></li>
                                            <li><a class="dropdown-item" href="#">Processing</a></li>
                                            <li><a class="dropdown-item" href="#">Shipped</a></li>
                                            <li><a class="dropdown-item" href="#">Delivered</a></li>
                                            <li><a class="dropdown-item" href="#">Cancelled</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div class="orders-grid" th:if="${orders != null and !orders.isEmpty()}">
                                <div class="order-card" data-aos="fade-up" data-aos-delay="100"
                                     th:each="order : ${orders}">

                                    <div class="order-header">
                                        <div class="order-id">
                                            <span class="label">Order ID:</span>
                                            <span class="value" th:text="${order.orderNumber}">#ORD-2024-1278</span>
                                        </div>
                                        <div class="order-date"
                                             th:text="${#temporals.format(order.orderDate, 'yyyy-MM-dd')}">Feb 20, 2025
                                        </div>
                                    </div>

                                    <div class="order-content">
                                        <div class="product-grid">
                                            <div th:each="item, iterStat : ${order.items}" th:if="${iterStat.index < 3}"
                                                 class="product-title-preview">
                                                <span th:text="${item.bookTitle}">Book Title</span>
                                            </div>
                                            <span class="more-items" th:if="${#lists.size(order.items) > 3}"
                                                  th:text="'+' + (${#lists.size(order.items)} - 3)"></span>
                                        </div>

                                        <div class="order-info">
                                            <div class="info-row">
                                                <span>Status</span>
                                                <span class="status" th:text="${order.orderStatus}"
                                                      th:classappend="${#strings.toLowerCase(order.orderStatus)}">Processing</span>
                                            </div>
                                            <div class="info-row">
                                                <span>Items</span>
                                                <span th:text="${#lists.size(order.items)} + ' items'">3 items</span>
                                            </div>
                                            <div class="info-row">
                                                <span>Total</span>
                                                <span class="price"
                                                      th:text="${#numbers.formatCurrency(order.actualOrderPrice)}">$789.99</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="order-footer">
                                        <button type="button" class="btn-details"
                                                data-bs-toggle="modal"
                                                data-bs-target="#orderDetailsModal"
                                                th:data-order-id="${order.orderNumber}">
                                            View Details
                                        </button>
                                    </div>

                                    <div class="collapse tracking-info" th:id="'tracking-' + ${order.orderNumber}">
                                    </div>

                                </div>
                            </div>

                            <div class="alert alert-info" th:if="${orders == null or orders.isEmpty()}">
                                주문 내역이 없습니다.
                            </div>

                            <div class="pagination-wrapper" data-aos="fade-up">
                            </div>


                        </div>
                    </div>
                </div>

            </div>
        </div>
    </section><!-- /Account Section -->

</main>

<div th:replace="~{fragments/common_footer :: commonFooter}"></div>

<!-- Scroll Top -->
<a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i
        class="bi bi-arrow-up-short"></i></a>

<!-- Preloader -->
<div id="preloader"></div>

<!-- Vendor JS Files -->
<script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/assets/vendor/php-email-form/validate.js"></script>
<script src="/assets/vendor/swiper/swiper-bundle.min.js"></script>
<script src="/assets/vendor/aos/aos.js"></script>
<script src="/assets/vendor/glightbox/js/glightbox.min.js"></script>
<script src="/assets/vendor/drift-zoom/Drift.min.js"></script>
<script src="/assets/vendor/purecounter/purecounter_vanilla.js"></script>

<!-- Main JS File -->
<script src="/assets/js/main.js"></script>

<div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orderDetailsModalLabel">
                    주문 상세 (<span id="modal-order-number">#ORD-XXXX</span>)
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modal-order-body">
                <div class="text-center p-5">
                    <div class="spinner-border text-dark" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', () => {
        const orderDetailsModal = document.getElementById('orderDetailsModal');

        orderDetailsModal.addEventListener('show.bs.modal', async (event) => {
            const button = event.relatedTarget;

            // ✨ 1. th:data-order-id에서 주문번호(orderNumber)를 가져옵니다.
            const orderNumber = button.getAttribute('data-order-id');

            const modalBody = document.getElementById('modal-order-body');
            const modalOrderNum = document.getElementById('modal-order-number');

            // 2. 모달 내용을 로딩 스피너로 초기화
            modalBody.innerHTML = `<div class="text-center p-5"><div class="spinner-border text-dark" role="status"><span class="visually-hidden">Loading...</span></div></div>`;
            modalOrderNum.textContent = '...';

            try {
                // 3. 서버에 주문 상세 정보 요청 (orderNumber 사용)
                // (참고: 이 API는 /api/orders/{orderNumber} 형식으로 JSON을 반환해야 합니다)
                const response = await fetch(`/api/orders/${orderNumber}`);
                if (!response.ok) throw new Error('주문 정보를 불러오는 데 실패했습니다.');

                const orderData = await response.json();

                // ✨ 4. 모달 내용 HTML 생성 (DTO 필드명에 맞게 수정)
                modalOrderNum.textContent = orderData.orderNumber;

                // (DTO에 items가 없으면 orderData.items?.length로 안전하게 체크)
                const items = orderData.items || [];

                modalBody.innerHTML = `
                    <h5>주문 상품 (${items.length}개)</h5>
                    <div class="order-items">
                        ${items.map(item => `
                            <div class="item">
                                <div class="item-info" style="width: 70%;"> <h6>${item.bookTitle}</h6>
                                    <div class="item-meta">
                                        <span>Qty: ${item.quantity}</span>
                                    </div>
                                </div>
                                <div class="item-price">$${item.price}</div>
                            </div>
                        `).join('')}
                    </div>
                    <hr>
                    <h5>배송지 정보</h5>
                    <div class="address-info">
                        <p>
                            <strong>${orderData.receiver}</strong><br>
                            ${orderData.receiverAddress} ${orderData.receiverAddressDetail}<br>
                            (${orderData.postCode})<br>
                            ${orderData.receiverPhone}
                        </p>
                    </div>
                `;

            } catch (error) {
                modalBody.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
            }
        });
    });
</script>

</body>

</html>
