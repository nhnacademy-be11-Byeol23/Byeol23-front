<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>관리자 - 쿠폰 등록</title>
    <meta name="description" content="관리자 쿠폰 등록 페이지">
    <meta name="keywords" content="">
    <th:block th:replace="~{fragments/file_link :: linkInfo}"></th:block>
</head>

<body class="admin-coupon-registration-page">
<div th:replace="~{fragments/common_header :: commonHeader}"></div>

<main class="main">

    <div class="page-title light-background">
        <div class="container d-lg-flex justify-content-between align-items-center">
            <h1 class="mb-2 mb-lg-0">관리자 - 쿠폰 등록</h1>
            <nav class="breadcrumbs">
                <ol>
                    <li><a th:href="@{/}">Home</a></li>
                    <li><a th:href="@{/admin}">관리자 홈</a></li>
                    <li class="current">쿠폰 관리</li>
                    <li class="current">쿠폰 등록</li>
                </ol>
            </nav>
        </div>
    </div>

    <section id="admin-coupon-registration" class="admin-coupon-registration section">
        <div class="container" data-aos="fade-up" data-aos-delay="100">

            <div class="row g-4">

                <div class="col-lg-3">
                    <div th:replace="~{fragments/admin_side_bar :: admin_side_bar}"></div>
                </div>

                <div class="col-lg-9">
                    <div class="registration-page">

                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h5 class="fw-semibold mb-3">신규 쿠폰 등록</h5>
                                <form id="couponRegistrationForm" action="/admin/coupons" method="post" class="row g-3">

                                    <div class="col-md-6">
                                        <label for="couponName" class="form-label">쿠폰명</label>
                                        <input type="text" class="form-control" id="couponName" name="couponName"
                                               placeholder="예: 5월 가정의 달 특별 할인" required>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="couponPolicyId" class="form-label">쿠폰 정책 선택</label>
                                        <select class="form-select" id="couponPolicyId" name="couponPolicyId" required>
                                            <option value="" selected disabled>적용할 쿠폰 정책을 선택하세요</option>
                                            <option th:each="policy : ${policies}"

                                                    th:text="${policy.policyName}">
                                                신규 회원가입 10% 할인
                                            </option>
                                        </select>
                                    </div>

                                    <div class="col-12">
                                        <label class="form-label">쿠폰 적용 대상</label>
                                        <div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="couponScope"
                                                       id="scopeGeneral" value="GENERAL" checked>
                                                <label class="form-check-label" for="scopeGeneral">
                                                    일반 쿠폰 (Welcome/생일)
                                                </label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="couponScope"
                                                       id="scopeCategory" value="CATEGORY">
                                                <label class="form-check-label" for="scopeCategory">
                                                    카테고리 대상
                                                </label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="couponScope"
                                                       id="scopeBook" value="BOOK">
                                                <label class="form-check-label" for="scopeBook">
                                                    특정 도서 대상
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="categoryOptions" class="col-12" style="display: none;">
                                        <label class="form-label">적용 카테고리 선택 (다중 선택 가능)</label>
                                        <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                                            <div class="form-check" th:each="category : ${categories}">
                                                <input class="form-check-input" type="checkbox" name="categoryIds"
                                                       th:id="|category-${category.id}|" th:value="${category.id}">
                                                <label class="form-check-label" th:for="|category-${category.id}|"
                                                       th:text="${category.name}">
                                                    [임시] 소설
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="categoryIds" id="category-1" value="1">
                                                <label class="form-check-label" for="category-1">소설</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="categoryIds" id="category-2" value="2">
                                                <label class="form-check-label" for="category-2">경제/경영</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="categoryIds" id="category-3" value="3">
                                                <label class="form-check-label" for="category-3">인문</label>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="bookOptions" class="col-12" style="display: none;">
                                        <label class="form-label">적용 도서 선택</label>
                                        <div class="input-group mb-3">
                                            <input type="text" id="bookSearchKeyword" class="form-control" placeholder="도서명, 저자, ISBN 검색">
                                            <button class="btn btn-outline-secondary" type="button" id="btnBookSearch">검색 조회</button>
                                            <button class="btn btn-outline-info" type="button" id="btnBookSearchAll">전체 도서 조회</button>
                                        </div>

                                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                            <table class="table table-sm table-hover align-middle">
                                                <thead class="table-light">
                                                <tr>
                                                    <th scope="col" style="width: 10%;">선택</th>
                                                    <th scope="col">도서명</th>
                                                    <th scope="col" style="width: 20%;">저자</th>
                                                    <th scope="col" style="width: 20%;">출판사</th>
                                                </tr>
                                                </thead>
                                                <tbody id="bookSearchResultBody">
                                                <tr>
                                                    <td colspan="4" class="text-center text-muted py-3">
                                                        검색 버튼을 눌러 도서를 조회하세요.
                                                    </td>
                                                </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <div class="col-12 text-end">
                                        <button type="submit" class="btn btn-dark">쿠폰 등록</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </section>

</main>

<div th:replace="~{fragments/common_footer :: commonFooter}"></div>

<a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>
<div id="preloader"></div>

<script th:src="@{/assets/vendor/bootstrap/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/assets/vendor/php-email-form/validate.js}"></script>
<script th:src="@{/assets/vendor/swiper/swiper-bundle.min.js}"></script>
<script th:src="@{/assets/vendor/aos/aos.js}"></script>
<script th:src="@{/assets/vendor/glightbox/js/glightbox.min.js}"></script>
<script th:src="@{/assets/vendor/drift-zoom/Drift.min.js}"></script>
<script th:src="@{/assets/vendor/purecounter/purecounter_vanilla.js}"></script>
<script th:src="@{/assets/js/main.js}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {

        // --- 1. 동적 폼 섹션 표시/숨기기 ---
        const scopeRadios = document.querySelectorAll('input[name="couponScope"]');
        const categoryOptions = document.getElementById('categoryOptions');
        const bookOptions = document.getElementById('bookOptions');

        function toggleOptions() {
            const selectedScope = document.querySelector('input[name="couponScope"]:checked').value;

            // 모든 옵션 숨기기
            categoryOptions.style.display = 'none';
            bookOptions.style.display = 'none';

            // 선택된 옵션만 표시
            if (selectedScope === 'CATEGORY') {
                categoryOptions.style.display = 'block';
            } else if (selectedScope === 'BOOK') {
                bookOptions.style.display = 'block';
            }
        }

        // 라디오 버튼 클릭 시마다 함수 실행
        scopeRadios.forEach(radio => radio.addEventListener('change', toggleOptions));

        // --- 2. 도서 검색 (AJAX) ---
        // 이 부분은 실제 서버 API 엔드포인트가 필요합니다.
        // 여기서는 기능 시연을 위한 가짜 데이터를 사용합니다.

        const btnBookSearch = document.getElementById('btnBookSearch');
        const btnBookSearchAll = document.getElementById('btnBookSearchAll');
        const searchKeyword = document.getElementById('bookSearchKeyword');
        const resultsBody = document.getElementById('bookSearchResultBody');

        // (가짜 데이터)
        const fakeBookData = [
            { id: 1, title: '트렌드 코리아 2026', author: '김난도', publisher: '미래의창' },
            { id: 2, title: '세이노의 가르침', author: '세이노', publisher: '데이원' },
            { id: 3, title: '도시와 그 불확실한 벽', author: '무라카미 하루키', publisher: '문학동네' },
            { id: 4, title: '자바의 정석', author: '남궁성', publisher: '도우출판' }
        ];

        function renderBookResults(books) {
            resultsBody.innerHTML = ''; // 기존 결과 초기화

            if (books.length === 0) {
                resultsBody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-3">검색 결과가 없습니다.</td></tr>`;
                return;
            }

            books.forEach(book => {
                const row = `
                    <tr>
                        <td class="text-center">
                            <input class="form-check-input" type="checkbox" name="bookIds" value="${book.id}">
                        </td>
                        <td>${book.title}</td>
                        <td>${book.author}</td>
                        <td>${book.publisher}</td>
                    </tr>
                `;
                resultsBody.innerHTML += row;
            });
        }

        // "검색 조회" 버튼 클릭
        btnBookSearch.addEventListener('click', function() {
            const keyword = searchKeyword.value.toLowerCase();
            if (!keyword) {
                alert('검색어를 입력하세요.');
                return;
            }
            // --- TODO: 실제 AJAX (fetch) 로직으로 교체 ---
            // 예: fetch('/admin/api/books/search?keyword=' + keyword)
            //     .then(response => response.json())
            //     .then(data => renderBookResults(data));

            // (가짜 로직)
            console.log('Searching for:', keyword);
            const filteredData = fakeBookData.filter(book =>
                book.title.toLowerCase().includes(keyword) ||
                book.author.toLowerCase().includes(keyword)
            );
            renderBookResults(filteredData);
        });

        // "전체 도서 조회" 버튼 클릭
        btnBookSearchAll.addEventListener('click', function() {
            // --- TODO: 실제 AJAX (fetch) 로직으로 교체 ---
            // 예: fetch('/admin/api/books/all')
            //     .then(response => response.json())
            //     .then(data => renderBookResults(data));

            // (가짜 로직)
            console.log('Fetching all books');
            renderBookResults(fakeBookData);
        });

        // --- 3. 폼 제출 유효성 검사 ---
        const form = document.getElementById('couponRegistrationForm');
        form.addEventListener('submit', function(event) {
            const selectedScope = document.querySelector('input[name="couponScope"]:checked').value;
            let isValid = true;
            let alertMessage = '';

            if (selectedScope === 'CATEGORY') {
                const checkedCategories = document.querySelectorAll('input[name="categoryIds"]:checked').length;
                if (checkedCategories === 0) {
                    isValid = false;
                    alertMessage = '적용할 카테고리를 1개 이상 선택해주세요.';
                }
            } else if (selectedScope === 'BOOK') {
                const checkedBooks = document.querySelectorAll('input[name="bookIds"]:checked').length;
                if (checkedBooks === 0) {
                    isValid = false;
                    alertMessage = '적용할 도서를 1개 이상 선택해주세요.';
                }
            }

            if (!isValid) {
                event.preventDefault(); // 폼 제출 중단
                alert(alertMessage);
            }
            // 'GENERAL' 타입은 추가 검사 필요 없음
        });
    });
</script>

</body>
</html>