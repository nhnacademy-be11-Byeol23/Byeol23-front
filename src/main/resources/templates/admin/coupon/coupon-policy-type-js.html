<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<body>
<th:block th:fragment="couponPolicyTypeJs">
    <script>
        document.addEventListener('DOMContentLoaded', function () {

            // ============================================================
            // 1. 할인 유형 선택 로직 (정률 vs 정액)
            // ============================================================
            const rateRadio = document.getElementById('rateDiscount');
            const fixedRadio = document.getElementById('fixedDiscount');
            const rateOptions = document.getElementById('rateOptions');
            const fixedOptions = document.getElementById('fixedOptions');
            const discountRateInput = document.getElementById('discountRate');
            const discountLimitInput = document.getElementById('discountLimit');
            const discountAmountInput = document.getElementById('discountAmount');

            function toggleDiscountOptions() {
                if (!rateRadio || !fixedRadio || !rateOptions || !fixedOptions) return;

                if (rateRadio.checked) {
                    rateOptions.style.display = 'flex';
                    fixedOptions.style.display = 'none';

                    if (discountRateInput) discountRateInput.disabled = false;
                    if (discountLimitInput) discountLimitInput.disabled = false;

                    if (discountAmountInput) {
                        discountAmountInput.disabled = true;
                        discountAmountInput.value = '';
                    }
                } else if (fixedRadio.checked) {
                    rateOptions.style.display = 'none';
                    fixedOptions.style.display = 'flex';

                    if (discountRateInput) {
                        discountRateInput.disabled = true;
                        discountRateInput.value = '';
                    }
                    if (discountLimitInput) {
                        discountLimitInput.disabled = true;
                        discountLimitInput.value = '';
                    }

                    if (discountAmountInput) discountAmountInput.disabled = false;
                }
            }

            if (rateRadio) rateRadio.addEventListener('change', toggleDiscountOptions);
            if (fixedRadio) fixedRadio.addEventListener('change', toggleDiscountOptions);

            // 초기 실행
            toggleDiscountOptions();


            // ============================================================
            // 2. 적용 대상 선택 로직 (카테고리 vs 도서)
            // ============================================================
            const targetRadios = document.querySelectorAll('input[name="targetTypeSelect"]');

            const categorySection = document.getElementById('categoryListContainer');
            const bookSection = document.getElementById('bookListContainer');

            const scopeInput = document.getElementById('couponPolicyType');
            const categoryIdsInput = document.getElementById('selectedCategoryIds');
            const bookIdInput = document.getElementById('selectedBookId');
            const policyNameInput = document.getElementById('policyName');
            const originalPolicyNamePlaceholder = policyNameInput ? policyNameInput.placeholder : '';

            // 대상 변경 처리 함수
            function handleTargetTypeChange(type) {
                // scope 값 업데이트
                if (scopeInput) scopeInput.value = type;

                if (type === 'CATEGORY') {
                    // 1) UI 표시 전환
                    if (categorySection) categorySection.style.display = 'block';
                    if (bookSection) bookSection.style.display = 'none';

                    // 2) 도서 데이터 초기화
                    if (bookIdInput) bookIdInput.value = '';
                    document.querySelectorAll('.book-radio').forEach(el => el.checked = false);

                    // 3) 플레이스홀더 변경
                    if (policyNameInput) policyNameInput.placeholder = '예: IT/컴퓨터 10% 할인';

                    // 4) 카테고리 트리 로드 (최초 1회)
                    const rootUl = document.getElementById('category-tree');
                    if (rootUl && categorySection.dataset.allLoaded !== 'true') {
                        console.log('최초 1회, 모든 카테고리 로드를 시작합니다...');
                        const topLevelToggles = rootUl.querySelectorAll(':scope > li > div > button.category-toggle');

                        topLevelToggles.forEach(toggle => {
                            const categoryId = toggle.dataset.id;
                            const childrenUl = document.getElementById(`children-${categoryId}`);
                            if (childrenUl) {
                                globalThis.loadCategoryChildren(categoryId, childrenUl, true);
                            }
                        });
                        categorySection.dataset.allLoaded = 'true';
                    }

                } else if (type === 'BOOK') {
                    // 1) UI 표시 전환
                    if (categorySection) categorySection.style.display = 'none';
                    if (bookSection) bookSection.style.display = 'block';

                    // 2) 카테고리 데이터 초기화
                    if (categoryIdsInput) categoryIdsInput.value = '';
                    document.querySelectorAll('.category-tree-radio').forEach(el => el.checked = false);
                    if (globalThis.updateSelectedCategories) {
                        globalThis.updateSelectedCategories(); // 뱃지 UI 제거
                    }

                    // 3) 플레이스홀더 변경
                    if (policyNameInput) policyNameInput.placeholder = '예: "이펙티브 자바" 1,000원 할인';
                }
            }

            // 이벤트 리스너 등록
            targetRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    handleTargetTypeChange(this.value);
                });
            });

            // ============================================================
            // 3. 페이지 로드 시 상태 유지 로직 (URL 파라미터 확인)
            // ============================================================
            const urlParams = new URLSearchParams(window.location.search);
            const targetTypeParam = urlParams.get('targetTypeSelect');

            if (targetTypeParam === 'BOOK') {
                const targetBookRadio = document.getElementById('targetBook');
                if (targetBookRadio) {
                    targetBookRadio.checked = true;
                    // true를 넘겨 초기 로드임을 알리고 데이터 초기화를 건너뜁니다.
                    handleTargetTypeChange('BOOK', true);
                }
            } else {
                const targetCategoryRadio = document.getElementById('targetCategory');
                if (targetCategoryRadio) {
                    targetCategoryRadio.checked = true;
                    handleTargetTypeChange('CATEGORY', true);
                }
            }


            // ============================================================
            // 4. 폼 제출 및 리셋 핸들러
            // ============================================================
            const form = document.querySelector('form[action="/admin/coupon-policy"]');
            if (form) {
                form.addEventListener('submit', function (event) {
                    event.preventDefault();

                    const discountType = document.querySelector('input[name="discountType"]:checked').value;
                    let isValid = false;
                    let alertMessage = '';

                    // 할인 값 검증
                    if (discountType === 'RATE') {
                        const discountRate = document.getElementById('discountRate').value;
                        const discountLimit = document.getElementById('discountLimit').value;

                        if (discountRate && discountRate > 0) {
                            // discountLimit는 0일 수도 있으므로(제한없음) rate만 필수 체크
                            isValid = true;
                        } else {
                            alertMessage = '할인률(%)을 올바르게 입력해주세요.';
                            isValid = false;
                        }
                    } else if (discountType === 'FIXED') {
                        const discountAmount = document.getElementById('discountAmount').value;
                        if (discountAmount && discountAmount > 0) {
                            isValid = true;
                        } else {
                            alertMessage = '할인액(원)을 올바르게 입력주세요.';
                            isValid = false;
                        }
                    }

                    // 적용 대상 선택 검증
                    if (isValid) {
                        const scope = scopeInput.value;
                        const categoryIds = categoryIdsInput.value;
                        const bookId = bookIdInput.value;

                        if (scope === 'CATEGORY' && (!categoryIds || categoryIds.trim() === '')) {
                            isValid = false;
                            alertMessage = '카테고리 쿠폰을 선택했으나, 적용할 카테고리를 선택하지 않았습니다.';
                        } else if (scope === 'BOOK' && (!bookId || bookId.trim() === '')) {
                            isValid = false;
                            alertMessage = '도서 쿠폰을 선택했으나, 적용할 도서를 선택하지 않았습니다.';
                        } else if (scope === '') {
                            isValid = false;
                            alertMessage = '쿠폰 적용 대상(카테고리 또는 도서)을 선택해주세요.';
                        }
                    }

                    if (isValid) {
                        event.target.submit();
                    } else {
                        alert(alertMessage);
                    }
                });

                form.addEventListener('reset', function() {
                    // 1) 할인 유형 리셋
                    document.getElementById('rateDiscount').checked = true;
                    document.getElementById('fixedDiscount').checked = false;
                    toggleDiscountOptions();

                    // 2) 적용 대상 리셋 (카테고리로 초기화)
                    // targetCategory ID를 가진 라디오 버튼이 있다고 가정
                    const categoryRadio = document.getElementById('targetCategory');
                    if (categoryRadio) {
                        categoryRadio.checked = true;
                        handleTargetTypeChange('CATEGORY');
                    }

                    // 3) 입력값 및 선택값 초기화
                    if (scopeInput) scopeInput.value = 'CATEGORY';
                    if (categoryIdsInput) categoryIdsInput.value = '';
                    if (bookIdInput) bookIdInput.value = '';

                    const checkedCategoryRadio = document.querySelector('.category-tree-radio:checked');
                    if (checkedCategoryRadio) checkedCategoryRadio.checked = false;

                    const checkedBookRadio = document.querySelector('.book-radio:checked');
                    if (checkedBookRadio) checkedBookRadio.checked = false;

                    if (globalThis.updateSelectedCategories) {
                        globalThis.updateSelectedCategories();
                    }
                    if (policyNameInput) policyNameInput.placeholder = originalPolicyNamePlaceholder;
                });
            }
        });


        // ============================================================
        // 5. 전역(Global) 함수들 - 카테고리 트리 및 선택 로직
        // ============================================================

        globalThis.toggleCategory = function(element) {
            const categoryId = element.dataset.id;
            const isExpanded = element.dataset.expanded === 'true';
            const childrenUl = document.getElementById(`children-${categoryId}`);
            const icon = element.querySelector('i');

            if (!childrenUl) return;

            if (isExpanded) {
                childrenUl.style.display = 'none';
                icon.classList.remove('bi-chevron-down');
                icon.classList.add('bi-chevron-right');
                element.dataset.expanded = 'false';
            } else {
                if (childrenUl.dataset.loaded !== 'true') {
                    globalThis.loadCategoryChildren(categoryId, childrenUl, false);
                } else {
                    childrenUl.style.display = 'block';
                }
                icon.classList.remove('bi-chevron-right');
                icon.classList.add('bi-chevron-down');
                element.dataset.expanded = 'true';
            }
        };

        globalThis.loadCategoryChildren = function(parentId, parentUl, expandAll = false) {

            if (expandAll) {
                const toggleButton = document.querySelector(`button.category-toggle[data-id="${parentId}"]`);
                if (toggleButton) {
                    const icon = toggleButton.querySelector('i');
                    if (icon) {
                        icon.classList.remove('bi-chevron-right');
                        icon.classList.add('bi-chevron-down');
                    }
                    toggleButton.dataset.expanded = 'true';
                }
            }

            fetch(`/categories/${parentId}/children`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('카테고리 정보를 불러오는데 실패했습니다.');
                    }
                    return response.json();
                })
                .then(children => {
                    parentUl.innerHTML = '';
                    children.forEach(child => {
                        const hasChildren = child.hasChildren;
                        const li = document.createElement('li');

                        li.innerHTML = `
                            <div class="d-flex align-items-center mb-2">
                                ${hasChildren ?
                            `<button type="button" class="category-toggle me-2"
                                             data-id="${child.id}"
                                             data-expanded="false"
                                             onclick="globalThis.toggleCategory(this)"
                                             style="border: none; background: none; padding: 0; cursor: pointer; user-select: none; color: var(--bs-body-color);">
                                        <i class="bi bi-chevron-right"></i>
                                    </button>` :
                            '<span style="width: 20px; display: inline-block;"></span>'
                        }
                                <div class="form-check">
                                    <input class="form-check-input category-tree-radio"
                                           type="radio"
                                           name="selectedCategory"
                                           id="category_tree_${child.id}"
                                           value="${child.id}"
                                           data-category-name="${child.name}"
                                           onclick="globalThis.updateSelectedCategories()">
                                    <label class="form-check-label"
                                           for="category_tree_${child.id}"
                                           style="${hasChildren ? 'font-weight: 600; color: #666;' : ''}">
                                        ${child.name}
                                    </label>
                                </div>
                            </div>
                            ${hasChildren ?
                            `<ul id="children-${child.id}"
                                     class="ms-4"
                                     style="list-style: none; padding-left: 0; display: none;">
                                </ul>` : ''
                        }
                        `;
                        parentUl.appendChild(li);

                        if (child.hasChildren && expandAll) {
                            const newChildrenUl = document.getElementById(`children-${child.id}`);
                            if (newChildrenUl) {
                                globalThis.loadCategoryChildren(child.id, newChildrenUl, true);
                            }
                        }
                    });
                    parentUl.dataset.loaded = 'true';
                    parentUl.style.display = 'block';
                })
                .catch(error => {
                    console.error('카테고리 로드 실패:', error);
                    parentUl.innerHTML = `<li class="text-danger small">${error.message}</li>`;
                    parentUl.style.display = 'block';
                });
        };

        globalThis.updateSelectedCategories = function() {
            const checkedRadio = document.querySelector('.category-tree-radio:checked');
            const categoryIdsInput = document.getElementById('selectedCategoryIds');
            const displayDiv = document.getElementById('inlineSelectedCategoriesDisplay');

            if (checkedRadio) {
                const selectedId = checkedRadio.value;
                const selectedName = checkedRadio.dataset.categoryName;

                if (categoryIdsInput) {
                    categoryIdsInput.value = selectedId;
                }

                if (displayDiv) {
                    displayDiv.innerHTML = `<span class="badge bg-info me-1 mb-1">${selectedName}</span>`;
                }
            } else {
                if (categoryIdsInput) {
                    categoryIdsInput.value = '';
                }
                if (displayDiv) {
                    displayDiv.innerHTML = '';
                }
            }
        };

        globalThis.updateSelectedBook = function(bookId) {
            const bookIdInput = document.getElementById('selectedBookId');
            if (bookIdInput) {
                bookIdInput.value = bookId;
            }
        };
    </script>
</th:block>
</body>
</html>