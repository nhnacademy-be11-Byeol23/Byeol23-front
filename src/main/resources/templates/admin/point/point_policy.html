<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>관리자 - 포인트 정책 관리</title>
    <meta name="description" content="관리자 포인트 정책 관리 페이지">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <th:block th:replace="~{fragments/file_link :: linkInfo}"></th:block>
</head>
<body class="admin-point-policies-page">
<div th:replace="~{fragments/common_header :: commonHeader}"></div>

<main class="main">
    <div class="page-title light-background">
        <div class="container d-lg-flex justify-content-between align-items-center">
            <h1 class="mb-2 mb-lg-0">관리자 - 포인트 정책 관리</h1>
            <nav class="breadcrumbs">
                <ol>
                    <li><a th:href="@{/}">Home</a></li>
                    <li><a th:href="@{/admin}">관리자 홈</a></li>
                    <li class="current">정책 관리</li>
                    <li class="current">포인트 정책 관리</li>
                </ol>
            </nav>
        </div>
    </div>

    <section id="admin-point-policies" class="admin-policies section">
        <div class="container" data-aos="fade-up" data-aos-delay="100">
            <div class="row g-4">
                <div class="col-lg-3">
                    <div th:replace="~{fragments/admin_side_bar :: admin_side_bar}"></div>
                </div>

                <div class="col-lg-9">
                    <div class="policy-page">

                        <!-- 신규 정책 등록 폼 -->
                        <div class="card shadow-sm mb-4">
                            <div class="card-body">
                                <h5 class="fw-semibold mb-3" id="policy-form-title">신규 포인트 정책 등록</h5>
                                <form id="createPolicyForm" class="row g-3">
                                    <div class="col-md-6">
                                        <label for="pointPolicyName" class="form-label">정책명</label>
                                        <input type="text" class="form-control" id="pointPolicyName" name="pointPolicyName"
                                               placeholder="예: 상품 리뷰 작성 보상" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="saveAmount" class="form-label">적립 금액</label>
                                        <input type="number" class="form-control" id="saveAmount" name="saveAmount"
                                               placeholder="100.00" min="0" step="0.01" required>
                                    </div>

                                    <!-- 활성화 checkbox 제거하고 타입 선택 추가 -->
                                    <div class="col-md-6">
                                        <label for="typeSelect" class="form-label">정책 타입</label>
                                        <select id="typeSelect" name="type" class="form-select" required>
                                            <option value="" disabled selected>선택하세요</option>
                                            <!-- thymeleaf로 ReservedPolicy 목록 제공 -->
                                            <option th:each="t : ${reservedPolicies}"
                                                    th:value="${t}"
                                                    th:text="${t}"></option>
                                        </select>
                                    </div>

                                    <div class="col-12 text-end">
                                        <button type="submit" class="btn btn-dark">포인트 정책 저장</button>
                                        <button type="reset" class="btn btn-outline-secondary">초기화</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- 정책 목록 -->
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h5 class="fw-semibold mb-3">포인트 정책 목록</h5>

                                <!-- ReservedPolicy 기준 그룹 렌더링 영역 -->
                                <div id="policyGroupContainer">
                                    <p class="text-center text-muted" id="noDataText">등록된 포인트 정책이 없습니다.</p>
                                </div>

                                <div class="d-flex gap-2 mt-2">
                                    <button class="btn btn-outline-secondary btn-sm" id="reloadBtn">새로고침</button>
                                </div>
                            </div>
                        </div>

                        <!-- 수정 모달 -->
                        <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <form id="editPolicyForm">
                                        <div class="modal-header">
                                            <h5 class="modal-title">포인트 정책 수정</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <!-- 식별을 위해 ID 보관(읽기 전용) -->
                                            <input type="hidden" id="editPointPolicyId">
                                            <!-- 타입도 수정 불가, 필요 시 표시만 -->
                                            <div class="mb-3">
                                                <label class="form-label">정책 타입</label>
                                                <input type="text" class="form-control" id="editType" disabled>
                                            </div>
                                            <div class="mb-3">
                                                <label for="editPointPolicyName" class="form-label">정책명</label>
                                                <input type="text" class="form-control" id="editPointPolicyName" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="editSaveAmount" class="form-label">적립 금액</label>
                                                <input type="number" class="form-control" id="editSaveAmount" min="0" step="0.01" required>
                                            </div>
                                            <!-- isActive, createdAt 등은 읽기 전용 -->
                                            <div class="mb-3">
                                                <label class="form-label">활성 여부</label>
                                                <input type="text" class="form-control" id="editIsActiveView" disabled>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">생성일</label>
                                                <input type="text" class="form-control" id="editCreatedAt" disabled>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">닫기</button>
                                            <button type="submit" class="btn btn-primary">저장</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                    </div> <!-- policy-page -->
                </div>
            </div>
        </div>
    </section>
</main>

<div th:replace="~{fragments/common_footer :: commonFooter}"></div>

<a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center">
    <i class="bi bi-arrow-up-short"></i>
</a>
<div id="preloader"></div>

<script th:src="@{/assets/vendor/bootstrap/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/assets/vendor/aos/aos.js}"></script>
<script th:src="@{/assets/vendor/glightbox/js/glightbox.min.js}"></script>
<script th:src="@{/assets/js/main.js}"></script>

<script>
    const API_BASE = '/api/front/point-policies';

    document.addEventListener('DOMContentLoaded', () => {
        loadPolicies();

        document.getElementById('createPolicyForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const dto = {
                type: document.getElementById('typeSelect').value, // 추가: 선택한 ReservedPolicy 타입
                pointPolicyName: document.getElementById('pointPolicyName').value.trim(),
                saveAmount: document.getElementById('saveAmount').value.trim() // BigDecimal 호환 위해 문자열
            };
            if (!dto.type) {
                alert('정책 타입을 선택하세요.');
                return;
            }
            if (!dto.pointPolicyName || dto.saveAmount === '' || Number(dto.saveAmount) < 0) {
                alert('필수 값을 확인하세요.');
                return;
            }
            fetch(API_BASE + '/create', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(dto)
            })
                .then(r => {
                    if (!r.ok) throw new Error('생성 실패');
                    return r;
                })
                .then(() => {
                    alert('생성 완료');
                    e.target.reset();
                    loadPolicies();
                })
                .catch(err => alert(err.message));
        });

        document.getElementById('reloadBtn').addEventListener('click', loadPolicies);

        // 수정: saveAmount, pointPolicyName 만 보냄
        document.getElementById('editPolicyForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('editPointPolicyId').value;
            const dto = {
                pointPolicyName: document.getElementById('editPointPolicyName').value.trim(),
                saveAmount: document.getElementById('editSaveAmount').value.trim()
            };
            if (!dto.pointPolicyName || dto.saveAmount === '' || Number(dto.saveAmount) < 0) {
                alert('필수 값을 확인하세요.');
                return;
            }
            fetch(API_BASE + '/update/' + encodeURIComponent(id), {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(dto)
            })
                .then(r => {
                    if (!r.ok) throw new Error('수정 실패');
                    return r;
                })
                .then(() => {
                    alert('수정 완료');
                    const modalEl = document.getElementById('editModal');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    modal.hide();
                    loadPolicies();
                })
                .catch(err => alert(err.message));
        });
    });

    function loadPolicies() {
        fetch(API_BASE)
            .then(r => {
                if (!r.ok) throw new Error('목록 조회 실패');
                return r.json();
            })
            .then(map => renderPolicyGroups(map))
            .catch(err => alert(err.message));
    }

    // ReservedPolicy 기준으로 ul/ol 로 구분해서 렌더링
    function renderPolicyGroups(map) {
        const container = document.getElementById('policyGroupContainer');
        const noDataText = document.getElementById('noDataText');
        container.innerHTML = '';

        if (!map || Object.keys(map).length === 0) {
            noDataText.style.display = '';
            container.appendChild(noDataText);
            return;
        }
        noDataText.style.display = 'none';

        Object.keys(map).forEach(key => {
            const policies = map[key] || [];
            if (policies.length === 0) return;

            // 그룹 카드
            const groupDiv = document.createElement('div');
            groupDiv.className = 'mb-4';

            // 제목: ReservedPolicy key 와 description 둘 다 나오도록
            const title = document.createElement('h6');
            title.className = 'fw-semibold';
            title.textContent = key;
            groupDiv.appendChild(title);

            // 목록 (ol 사용)
            const listEl = document.createElement('ol');
            listEl.className = 'list-group list-group-numbered';

            policies.forEach(p => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';

                const left = document.createElement('div');
                left.innerHTML = `
                    <div><strong>${escapeHtml(p.pointPolicyName)}</strong></div>
                    <div class="small text-muted">
                        적립 금액: ${p.saveAmount ?? '-'} /
                        활성 여부: ${p.isActive ? '활성' : '비활성'} /
                        생성일: ${formatDateTime(p.createdAt)}
                    </div>
                `;

                const right = document.createElement('div');
                right.className = 'text-nowrap';
                // 활성화 버튼: isActive 가 true 일 때 비활성화(disabled)
                right.innerHTML = `
                    <button class="btn btn-sm btn-outline-success me-1" ${p.isActive ? 'disabled' : ''} onclick="activatePolicy(${encodeURIComponent(p.pointPolicyId)})">활성화</button>
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="openEdit(${encodeURIComponent(p.pointPolicyId)})">수정</button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deletePolicy(${encodeURIComponent(p.pointPolicyId)})">삭제</button>
                `;

                li.appendChild(left);
                li.appendChild(right);
                listEl.appendChild(li);
            });

            groupDiv.appendChild(listEl);
            container.appendChild(groupDiv);
        });
    }

    // id 기반 단건 조회 후 모달 열기
    function openEdit(id) {
        fetch(API_BASE + '/' + encodeURIComponent(id))
            .then(r => {
                if (!r.ok) throw new Error('정책 조회 실패');
                return r.json();
            })
            .then(p => {
                document.getElementById('editPointPolicyId').value = p.pointPolicyId;
                document.getElementById('editType').value = p.type ?? '';
                document.getElementById('editPointPolicyName').value = p.pointPolicyName ?? '';
                document.getElementById('editSaveAmount').value = p.saveAmount ?? 0;
                document.getElementById('editIsActiveView').value = p.isActive ? '활성' : '비활성';
                document.getElementById('editCreatedAt').value = formatDateTime(p.createdAt);
                const modal = new bootstrap.Modal(document.getElementById('editModal'));
                modal.show();
            })
            .catch(err => alert(err.message));
    }

    function deletePolicy(id) {
        if (!confirm('삭제하시겠습니까?')) return;
        fetch(API_BASE + '/' + encodeURIComponent(id), { method: 'DELETE' })
            .then(r => {
                if (!r.ok) throw new Error('삭제 실패');
                return r;
            })
            .then(() => {
                alert('삭제 완료');
                loadPolicies();
            })
            .catch(err => alert(err.message));
    }

    // 활성화(POST)
    function activatePolicy(id) {
        if (!confirm('정책을 활성화 하시겠습니까?')) return;
        fetch(API_BASE + '/activate/' + encodeURIComponent(id), { method: 'POST' })
            .then(r => {
                if (!r.ok) throw new Error('활성화 실패');
                return r;
            })
            .then(() => {
                alert('활성화 완료');
                loadPolicies();
            })
            .catch(err => alert(err.message));
    }

    function formatDateTime(s) {
        if (!s) return '-';
        return String(s).replace('T', ' ').substring(0, 19);
    }

    function escapeHtml(str) {
        if (str == null) return '';
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }
</script>
</body>
</html>
