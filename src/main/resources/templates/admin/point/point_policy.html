<!-- html -->
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>관리자 - 포인트 정책 관리</title>
    <meta name="description" content="관리자 포인트 정책 관리 페이지">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <th:block th:replace="~{fragments/file_link :: linkInfo}"></th:block>
</head>
<body class="admin-point-policies-page">
<div th:replace="~{fragments/common_header :: commonHeader}"></div>

<main class="main">
    <div class="page-title light-background">
        <div class="container d-lg-flex justify-content-between align-items-center">
            <h1 class="mb-2 mb-lg-0">관리자 - 포인트 정책 관리</h1>
            <nav class="breadcrumbs">
                <ol>
                    <li><a th:href="@{/}">Home</a></li>
                    <li><a th:href="@{/admin}">관리자 홈</a></li>
                    <li class="current">정책 관리</li>
                    <li class="current">포인트 정책 관리</li>
                </ol>
            </nav>
        </div>
    </div>

    <section id="admin-point-policies" class="admin-policies section">
        <div class="container" data-aos="fade-up" data-aos-delay="100">
            <div class="row g-4">
                <div class="col-lg-2">
                    <div th:replace="~{fragments/admin_side_bar :: admin_side_bar}"></div>
                </div>

                <div class="col-lg-10">
                    <div class="policy-page">

                        <!-- 신규 정책 등록 폼 -->
                        <div class="card shadow-sm mb-4">
                            <div class="card-body">
                                <h5 class="fw-semibold mb-3" id="policy-form-title">신규 포인트 정책 등록</h5>
                                <form id="createPolicyForm" class="row g-3">
                                    <div class="col-md-6">
                                        <label for="pointPolicyName" class="form-label">정책명</label>
                                        <input type="text" class="form-control" id="pointPolicyName" name="pointPolicyName"
                                               placeholder="예: 상품 리뷰 작성 보상" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="saveAmount" class="form-label">적립 금액</label>
                                        <input type="number" class="form-control" id="saveAmount" name="saveAmount"
                                               placeholder="100.00" min="0" step="0.01" required>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="isActive" name="isActive" checked>
                                            <label class="form-check-label" for="isActive">활성화</label>
                                        </div>
                                    </div>
                                    <div class="col-12 text-end">
                                        <button type="submit" class="btn btn-dark">포인트 정책 저장</button>
                                        <button type="reset" class="btn btn-outline-secondary">초기화</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- 정책 목록 -->
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h5 class="fw-semibold mb-3">포인트 정책 목록</h5>
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle" id="pointPolicyTable">
                                        <thead class="table-light">
                                        <tr>
                                            <th scope="col">정책명</th>
                                            <th scope="col">적립 금액</th>
                                            <th scope="col">활성 여부</th>
                                            <th scope="col">생성일</th>
                                            <th scope="col">관리</th>
                                        </tr>
                                        </thead>
                                        <tbody id="policyTbody">
                                        <tr id="noDataRow">
                                            <td colspan="5" class="text-center py-4">등록된 포인트 정책이 없습니다.</td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="d-flex gap-2 mt-2">
                                    <button class="btn btn-outline-secondary btn-sm" id="reloadBtn">새로고침</button>
                                </div>
                            </div>
                        </div>

                        <!-- 수정 모달 -->
                        <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <form id="editPolicyForm">
                                        <div class="modal-header">
                                            <h5 class="modal-title">포인트 정책 수정</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <input type="hidden" id="editOriginalName">
                                            <div class="mb-3">
                                                <label for="editPointPolicyName" class="form-label">정책명</label>
                                                <input type="text" class="form-control" id="editPointPolicyName" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="editSaveAmount" class="form-label">적립 금액</label>
                                                <input type="number" class="form-control" id="editSaveAmount" min="0" step="0.01" required>
                                            </div>
                                            <div class="mb-3 form-check">
                                                <input class="form-check-input" type="checkbox" id="editIsActive">
                                                <label class="form-check-label" for="editIsActive">활성화</label>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">생성일</label>
                                                <input type="text" class="form-control" id="editCreatedAt" disabled>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">닫기</button>
                                            <button type="submit" class="btn btn-primary">저장</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                    </div> <!-- policy-page -->
                </div>
            </div>
        </div>
    </section>
</main>

<div th:replace="~{fragments/common_footer :: commonFooter}"></div>

<a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center">
    <i class="bi bi-arrow-up-short"></i>
</a>
<div id="preloader"></div>

<script th:src="@{/assets/vendor/bootstrap/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/assets/vendor/aos/aos.js}"></script>
<script th:src="@{/assets/vendor/glightbox/js/glightbox.min.js}"></script>
<script th:src="@{/assets/js/main.js}"></script>

<script>
    const API_BASE = '/api/front/point-policies';

    document.addEventListener('DOMContentLoaded', () => {
        loadPolicies();

        document.getElementById('createPolicyForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const dto = {
                pointPolicyName: document.getElementById('pointPolicyName').value.trim(),
                saveAmount: document.getElementById('saveAmount').value.trim(), // BigDecimal 호환을 위해 문자열 전송
                isActive: document.getElementById('isActive').checked
            };
            if (!dto.pointPolicyName || dto.saveAmount === '' || Number(dto.saveAmount) < 0) {
                alert('필수 값을 확인하세요.');
                return;
            }
            fetch(API_BASE + '/create', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(dto)
            })
                .then(r => {
                    if (!r.ok) throw new Error('생성 실패');
                    return r;
                })
                .then(() => {
                    alert('생성 완료');
                    e.target.reset();
                    document.getElementById('isActive').checked = true;
                    loadPolicies();
                })
                .catch(err => alert(err.message));
        });

        document.getElementById('reloadBtn').addEventListener('click', loadPolicies);

        document.getElementById('editPolicyForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const dto = {
                pointPolicyName: document.getElementById('editPointPolicyName').value.trim(),
                saveAmount: document.getElementById('editSaveAmount').value.trim(),
                isActive: document.getElementById('editIsActive').checked
            };
            if (!dto.pointPolicyName || dto.saveAmount === '' || Number(dto.saveAmount) < 0) {
                alert('필수 값을 확인하세요.');
                return;
            }
            fetch(API_BASE + '/update', {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(dto)
            })
                .then(r => {
                    if (!r.ok) throw new Error('수정 실패');
                    return r;
                })
                .then(() => {
                    alert('수정 완료');
                    const modalEl = document.getElementById('editModal');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    modal.hide();
                    loadPolicies();
                })
                .catch(err => alert(err.message));
        });
    });

    function loadPolicies() {
        fetch(API_BASE)
            .then(r => {
                if (!r.ok) throw new Error('목록 조회 실패');
                return r.json();
            })
            .then(list => renderPolicyTable(list))
            .catch(err => alert(err.message));
    }

    function renderPolicyTable(list) {
        const tbody = document.getElementById('policyTbody');
        tbody.innerHTML = '';
        if (!list || list.length === 0) {
            const noRow = document.getElementById('noDataRow');
            noRow.style.display = '';
            tbody.appendChild(noRow);
            return;
        }
        list.forEach(p => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${escapeHtml(p.pointPolicyName)}</td>
                <td>${p.saveAmount ?? '-'}</td>
                <td>${p.isActive ? '활성' : '비활성'}</td>
                <td>${formatDateTime(p.createdAt)}</td>
                <td class="text-nowrap">
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="openEdit('${encodeURIComponent(p.pointPolicyName)}')">수정</button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deletePolicy('${encodeURIComponent(p.pointPolicyName)}')">삭제</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function openEdit(encodedName) {
        fetch(API_BASE + '/' + encodedName)
            .then(r => {
                if (!r.ok) throw new Error('정책 조회 실패');
                return r.json();
            })
            .then(p => {
                document.getElementById('editOriginalName').value = p.pointPolicyName;
                document.getElementById('editPointPolicyName').value = p.pointPolicyName;
                document.getElementById('editSaveAmount').value = p.saveAmount ?? 0;
                document.getElementById('editIsActive').checked = !!p.isActive;
                document.getElementById('editCreatedAt').value = formatDateTime(p.createdAt);
                const modal = new bootstrap.Modal(document.getElementById('editModal'));
                modal.show();
            })
            .catch(err => alert(err.message));
    }

    function deletePolicy(encodedName) {
        if (!confirm('삭제하시겠습니까?')) return;
        fetch(API_BASE + '/' + encodedName, { method: 'DELETE' })
            .then(r => {
                if (!r.ok) throw new Error('삭제 실패');
                return r;
            })
            .then(() => {
                alert('삭제 완료');
                loadPolicies();
            })
            .catch(err => alert(err.message));
    }

    function formatDateTime(s) {
        if (!s) return '-';
        // ISO-8601 문자열을 간단 표시로
        return String(s).replace('T', ' ').substring(0, 19);
    }

    function escapeHtml(str) {
        if (str == null) return '';
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }
</script>
</body>
</html>
