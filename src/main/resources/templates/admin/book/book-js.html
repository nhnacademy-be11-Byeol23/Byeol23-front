<th:block xmlns:th="http://www.thymeleaf.org" th:fragment="bookJs">
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const initialContent = document.getElementById('descriptionContent')?.value || '내용을 입력해 주세요.';
            const editor = new toastui.Editor({
                el: document.querySelector('#descriptionEditor'),
                height: '300px',
                initialEditType: 'wysiwyg',
                previewStyle: 'vertical',
                initialValue: initialContent
            });

            const bookForm = document.getElementById('bookForm');
            if (bookForm) {
                bookForm.addEventListener('submit', function (event) {
                    event.preventDefault();

                    document.getElementById('description').value = editor.getHTML();

                    const formData = new FormData(bookForm);
                    const data = Object.fromEntries(formData.entries());

                    const bookId = data.bookId;
                    const isUpdate = bookId && bookId.length > 0;

                    const requestBody = {
                        bookName: data.bookName,
                        toc: data.toc,
                        description: data.description,
                        regularPrice: parseFloat(data.regularPrice),
                        salePrice: parseFloat(data.salePrice),
                        publishDate: data.publishDate,
                        isPack: bookForm.querySelector('#isPack').checked,
                        bookStatus: data.bookStatus,
                        stock: parseInt(data.stock, 10),
                        publisherId: parseInt(data.publisherId, 10)
                    };

                    if (!isUpdate) {
                        requestBody.isbn = data.isbn;
                    }

                    const url = isUpdate ? `/admin/books/${bookId}` : '/admin/books/new';
                    const method = isUpdate ? 'PUT' : 'POST';

                    fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestBody),
                    })
                        .then(response => {
                            if (response.ok) {
                                alert(isUpdate ? '도서가 성공적으로 수정되었습니다.' : '도서가 성공적으로 생성되었습니다.');
                                window.location.href = '/admin/books';
                            } else {
                                response.text().then(text => alert((isUpdate ? '도서 수정' : '도서 생성') + '에 실패했습니다: ' + text));
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('오류가 발생했습니다.');
                        });
                });
            }
        });

        // 도서 삭제 함수
        function softDeleteBook(bookId) {
            console.log('softDeleteBook 호출됨, bookId:', bookId);
            if (confirm('정말로 이 도서의 삭제 상태를 변경하시겠습니까?')) {
                const url = '/admin/books/' + bookId;
                console.log('DELETE 요청 전송:', url);
                fetch(url, {
                    method: 'DELETE'
                })
                    .then(response => {
                        console.log('응답 수신:', response.status, response.statusText);
                        if (response.ok) {
                            alert('도서의 삭제 상태가 변경되었습니다.');
                            window.location.reload();
                        } else {
                            response.text().then(text => {
                                console.error('삭제 실패:', text);
                                alert('상태 변경에 실패했습니다: ' + text);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('오류가 발생했습니다: ' + error.message);
                    });
            }
        }
    </script>
</th:block>
