<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>관리자 - 도서 목록</title>
    <th:block th:replace="~{fragments/file_link :: linkInfo}"></th:block>
    <th:block th:replace="~{admin/book/book-css :: bookCss}"></th:block>
</head>
<body>
<div th:replace="~{fragments/common_header :: commonHeader}"></div>

<main class="main">
    <div class="page-title light-background">
        <div class="container d-lg-flex justify-content-between align-items-center">
            <h1 class="mb-2 mb-lg-0">도서 관리</h1>
            <nav class="breadcrumbs">
                <ol>
                    <li><a th:href="@{/}">Home</a></li>
                    <li><a th:href="@{/admin}">관리자 홈</a></li>
                    <li class="current">도서 목록</li>
                </ol>
            </nav>
        </div>
    </div>

    <section class="section">
        <div class="container">
            <div class="row g-4">
                <div class="col-lg-3">
                    <div th:replace="~{fragments/admin_side_bar :: admin_side_bar}"></div>
                </div>

                <div class="col-lg-9">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="card-title fw-semibold mb-0">도서 목록</h5>
                                <a th:href="@{/admin/books/new}" class="btn btn-primary">+ 새 도서 추가</a>
                            </div>

                            <table class="table table-striped table-sm">
                                <thead class="table-light">
                                <tr>
                                    <th>이미지</th>
                                    <th>ID</th>
                                    <th>도서명</th>
                                    <th>판매가</th>
                                    <th>ISBN</th>
                                    <th>출판일</th>
                                    <th>재고</th>
                                    <th>카테고리</th>
                                    <th>상태</th>
                                    <th>관리</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="book : ${books}">
                                    <td>
                                        <img th:src="${(book.images != null and !book.images.isEmpty()) 
                                                       ? book.images[0].imageUrl() 
                                                       : 'https://image.yes24.com/momo/Noimg_L.jpg'}" 
                                             th:alt="${book.bookName}"
                                             style="width: 60px; height: 80px; object-fit: cover; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                                             onerror="this.src='https://image.yes24.com/momo/Noimg_L.jpg'; this.onerror=null;">
                                    </td>
                                    <td th:text="${book.bookId}"></td>
                                    <td style="max-width: 250px;">
                                        <div style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; line-height: 1.4;"
                                             th:text="${book.bookName}"></div>
                                    </td>
                                    <td th:text="${#numbers.formatInteger(book.salePrice, 0, 'COMMA') + '원'}"></td>
                                    <td th:text="${book.isbn}"></td>
                                    <td th:text="${book.publishDate}"></td>
                                    <td th:text="${book.stock}"></td>
                                    <td>
                                        <div th:if="${book.categories != null and !#lists.isEmpty(book.categories)}" class="d-flex flex-wrap gap-1">
                                            <span th:each="category : ${book.categories}" 
                                                  class="badge bg-secondary"
                                                  th:text="${category.categoryName}"
                                                  title="${category.pathName}">
                                            </span>
                                        </div>
                                        <span th:if="${book.categories == null or #lists.isEmpty(book.categories)}"
                                              class="text-muted">-</span>
                                    </td>
                                    <td>
                                        <span th:if="${book.bookStatus != null}" 
                                              class="badge"
                                              th:classappend="${book.bookStatus == 'SALE'} ? 'text-bg-success' : (${book.bookStatus == 'SOLDOUT'} ? 'text-bg-warning' : 'text-bg-secondary')"
                                              th:text="${book.bookStatus}"></span>
                                        <span th:if="${book.bookStatus == null}" class="text-muted">-</span>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a th:href="@{/admin/books/update/{book-id}/stock(book-id=${book.bookId})}"
                                               class="btn btn-sm btn-outline-primary">재고 수정</a>
                                            <a th:href="@{/admin/books/update/{book-id}(book-id=${book.bookId})}"
                                               class="btn btn-sm btn-outline-primary">수정</a>
                                            <button type="button" 
                                                    class="btn btn-sm btn-outline-danger"
                                                    th:onclick="|softDeleteBook(${book.bookId})|">삭제</button>
                                        </div>
                                    </td>
                                </tr>
                                <tr th:if="${books == null or #lists.isEmpty(books)}">
                                    <td colspan="11" class="text-center py-4">등록된 도서가 없습니다.</td>
                                </tr>
                                </tbody>
                            </table>

                            <nav th:if="${!books.isEmpty()}" class="mt-3">
                                <ul class="pagination justify-content-center">
                                    <!-- 첫 페이지 그룹 버튼 (<<) - 10페이지 초과이고 현재 10페이지 이상일 때만 표시 -->
                                    <li class="page-item" 
                                        th:if="${paging.totalPages() > 10 and paging.number() >= 10}"
                                        th:classappend="${(paging.number() / 10) == 0} ? 'disabled'">
                                        <a class="page-link" 
                                           th:href="@{|?page=${T(java.lang.Math).max(0, (paging.number() / 10) * 10 - 10)}|}">
                                            <span>&laquo;&laquo;</span>
                                        </a>
                                    </li>
                                    
                                    <!-- 이전 페이지 버튼 -->
                                    <li class="page-item" th:classappend="${paging.first()} ? 'disabled'">
                                        <a class="page-link"
                                           th:href="@{|?page=${paging.number() - 1}|}">
                                            <span>이전</span>
                                        </a>
                                    </li>
                                    
                                    <!-- 10페이지씩 끊어서 표시 -->
                                    <li th:each="pageNum: ${#numbers.sequence(
                                        T(java.lang.Math).max(0, (paging.number() / 10) * 10),
                                        T(java.lang.Math).min((paging.number() / 10) * 10 + 9, paging.totalPages() - 1)
                                    )}"
                                        th:classappend="${pageNum == paging.number()} ? 'active'"
                                        class="page-item">
                                        <a th:text="${pageNum + 1}" 
                                           class="page-link" 
                                           th:href="@{|?page=${pageNum}|}"></a>
                                    </li>
                                    
                                    <!-- 다음 페이지 버튼 -->
                                    <li class="page-item" th:classappend="${paging.last()} ? 'disabled'">
                                        <a class="page-link" th:href="@{|?page=${paging.number() + 1}|}">
                                            <span>다음</span>
                                        </a>
                                    </li>
                                    
                                    <!-- 다음 페이지 그룹 버튼 (>>) - 10페이지 초과이고 다음 그룹이 있을 때만 표시 -->
                                    <li class="page-item" 
                                        th:if="${paging.totalPages() > 10 and (paging.number() / 10) * 10 + 9 < paging.totalPages() - 1}">
                                        <a class="page-link" 
                                           th:href="@{|?page=${T(java.lang.Math).min((paging.number() / 10) * 10 + 10, paging.totalPages() - 1)}|}">
                                            <span>&raquo;&raquo;</span>
                                        </a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<div th:replace="~{fragments/common_footer :: commonFooter}"></div>

<a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>
<div id="preloader"></div>

<!-- Vendor & Main JS Files -->
<th:block th:replace="~{fragments/common_scripts :: commonScripts}"></th:block>
<div th:replace="~{admin/book/book-js :: bookJs}"></div>
</body>
</html>
