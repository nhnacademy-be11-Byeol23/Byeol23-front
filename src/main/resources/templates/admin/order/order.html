<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>관리자 - 주문 내역</title>
  <meta name="description" content="관리자 주문 내역 페이지">
  <meta name="keywords" content="">
  <th:block th:replace="~{fragments/file_link :: linkInfo}"></th:block>
</head>

<body class="admin-orders-page">
<div th:replace="~{fragments/common_header :: commonHeader}"></div>

<main class="main">
  <div class="page-title light-background">
    <div class="container d-lg-flex justify-content-between align-items-center">
      <h1 class="mb-2 mb-lg-0">관리자 - 주문 내역</h1>
      <nav class="breadcrumbs">
        <ol>
          <li><a th:href="@{/}">Home</a></li>
          <li><a th:href="@{/admin}">관리자 홈</a></li>
          <li class="current">주문 내역</li>
        </ol>
      </nav>
    </div>
  </div>

  <section id="admin-orders" class="admin-orders section">
    <div class="container" data-aos="fade-up" data-aos-delay="100">

      <div class="row g-4">

        <div class="col-lg-2">
          <div th:replace="~{fragments/admin_side_bar :: admin_side_bar}"></div>
        </div>

        <div class="col-lg-10">
          <div class="order-page">

            <div class="card shadow-sm mb-4">
              <div class="card-body">
                <h5 class="fw-semibold mb-3">주문 내역 검색</h5>
                <form id="orderSearchForm" class="row g-3" th:action="@{/admin/orders}" method="GET">
                  <div class="col-md-3">
                    <label for="orderStatus" class="form-label">주문 상태</label>
                    <select id="orderStatus" name="status" class="form-select">
                      <option value="" th:selected="${param.status == null or param.status == ''}">전체</option>
                      <option value="대기" th:selected="${param.status == '대기'}">대기</option>
                      <option value="결제 완료" th:selected="${param.status == '결제 완료'}">결제 완료</option>
                      <option value="배송중" th:selected="${param.status == '배송중'}">배송중</option>
                      <option value="배송완료" th:selected="${param.status == '배송완료'}">배송완료</option>
                      <option value="주문 취소" th:selected="${param.status == '주문 취소'}">주문 취소</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label for="orderId" class="form-label">주문 번호</label>
                    <input id="orderId" type="text" name="orderNumber" class="form-control" placeholder="주문 번호 입력"
                           th:value="${param.orderNumber}">
                  </div>
                  <div class="col-md-3">
                    <label for="customerName" class="form-label">주문자명</label>
                    <input id="customerName" type="text" name="receiver" class="form-control" placeholder="수신자명 입력"
                           th:value="${param.receiver}">
                  </div>
                  <div class="col-md-2 d-grid align-self-end">
                    <button type="submit" class="btn btn-dark">검색</button>
                  </div>
                </form>
              </div>
            </div>

            <div class="card shadow-sm">
              <div class="card-body">
                <h5 class="fw-semibold mb-0">주문 목록</h5>

                <div class="dropdown">
                  <button class="btn btn-outline-secondary dropdown-toggle btn-sm" type="button" id="bulkActionBtn" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-check-square me-1"></i> 일괄 작업
                  </button>
                  <ul class="dropdown-menu" aria-labelledby="bulkActionBtn">
                    <li>
                      <a class="dropdown-item bulk-action-item" href="#" data-status="배송중">
                        선택 항목 '배송중'으로 변경
                      </a>
                    </li>
                    <li>
                      <a class="dropdown-item bulk-action-item" href="#" data-status="배송완료">
                        선택 항목 '배송완료'로 변경
                      </a>
                    </li>
                  </ul>
                </div>
              </div>
                <table class="table table-hover align-middle">
                  <thead class="table-light">
                  <tr>
                    <th scope="col" class="text-center" style="width: 3rem;">
                      <input class="form-check-input" type="checkbox" id="check-all">
                    </th>
                    <th scope="col">주문번호</th>
                    <th scope="col">주문일시</th>
                    <th scope="col">주문자(수신자)</th>
                    <th scope="col">결제 금액</th>
                    <th scope="col">주문 상태</th>
                    <th scope="col">관리</th>
                  </tr>
                  </thead>
                  <tbody>
                  <tr th:each="order : ${orders.content}">
                    <td class="text-center">
                      <input class="form-check-input order-checkbox" type="checkbox"
                             th:value="${order.orderNumber}">
                    </td>
                    <td th:text="${order.orderNumber}">...</td>
                    <td th:text="${#temporals.format(order.orderDate, 'yyyy-MM-dd HH:mm')}">...</td>
                    <td th:text="${order.receiver}">...</td>
                    <td th:text="${#numbers.formatInteger(order.actualOrderPrice, 0, 'COMMA') + '원'}">...</td>
                    <td>
                        <span class="badge"
                              th:classappend="${order.orderStatus == '결제 완료'} ? 'text-bg-success' :
                                             (${order.orderStatus == '배송중'} ? 'text-bg-primary' :
                                             (${order.orderStatus == '주문 취소'} ? 'text-bg-danger' : 'text-bg-secondary'))"
                              th:text="${order.orderStatus}">...</span>
                    </td>
                    <td>
                      <button type="button" class="btn btn-outline-primary btn-sm"
                              data-bs-toggle="modal"
                              data-bs-target="#orderDetailsModal"
                              th:attr="data-order-number=${order.orderNumber}"
                              onclick="loadOrderDetails(this)">상세</button>

                      <button type="button" class="btn btn-outline-danger btn-sm"
                              th:attr="data-id=${order.orderNumber}"
                              onclick="cancelOrder(this)">취소</button>
                    </td>
                  </tr>
                  <tr th:if="${orders.isEmpty()}">
                    <td colspan="7" class="text-center py-4">조회된 주문 내역이 없습니다.</td>
                  </tr>
                  </tbody>
                </table>

                <nav th:if="${!orders.isEmpty() and orders.totalPages > 1}" aria-label="Page navigation" class="mt-4">
                  <ul class="pagination justify-content-center">

                    <li class="page-item" th:classappend="${orders.first} ? 'disabled'">
                      <a class="page-link"
                         th:href="@{/admin/orders(page=0, status=${param.status}, orderNumber=${param.orderNumber}, receiver=${param.receiver})}"
                         aria-label="First">
                        <span aria-hidden="true">&laquo;</span>
                      </a>
                    </li>
                    <li class="page-item" th:classappend="${orders.first} ? 'disabled'">
                      <a class="page-link"
                         th:href="@{/admin/orders(page=${orders.number - 1}, status=${param.status}, orderNumber=${param.orderNumber}, receiver=${param.receiver})}"
                         aria-label="Previous">
                        <span aria-hidden="true">&lsaquo;</span>
                      </a>
                    </li>

                    <th:block th:with="
                        start = ${T(java.lang.Math).max(0, orders.number - 2)},
                        end = ${T(java.lang.Math).min(orders.totalPages - 1, orders.number + 2)}">
                      <li class="page-item" th:each="pageNum : ${#numbers.sequence(start, end)}"
                          th:classappend="${pageNum == orders.number} ? 'active'">
                        <a class="page-link"
                           th:href="@{/admin/orders(page=${pageNum}, status=${param.status}, orderNumber=${param.orderNumber}, receiver=${param.receiver})}"
                           th:text="${pageNum + 1}">1</a>
                      </li>
                    </th:block>

                    <li class="page-item" th:classappend="${orders.last} ? 'disabled'">
                      <a class="page-link"
                         th:href="@{/admin/orders(page=${orders.number + 1}, status=${param.status}, orderNumber=${param.orderNumber}, receiver=${param.receiver})}"
                         aria-label="Next">
                        <span aria-hidden="true">&rsaquo;</span>
                      </a>
                    </li>
                    <li class="page-item" th:classappend="${orders.last} ? 'disabled'">
                      <a class="page-link"
                         th:href="@{/admin/orders(page=${orders.totalPages - 1}, status=${param.status}, orderNumber=${param.orderNumber}, receiver=${param.receiver})}"
                         aria-label="Last">
                        <span aria-hidden="true">&raquo;</span>
                      </a>
                    </li>
                  </ul>
                </nav>
              </div>
            </div>

          </div> </div> </div> </div> </section>
</main>

<div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="orderDetailsModalLabel">주문 상세 정보</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-center" id="modalLoadingSpinner">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
        <div id="modalOrderDetailsContent">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>


<div th:replace="~{fragments/common_footer :: commonFooter}"></div>

<a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>
<div id="preloader"></div>

<script th:src="@{/assets/vendor/bootstrap/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/assets/vendor/php-email-form/validate.js}"></script>
<script th:src="@{/assets/vendor/swiper/swiper-bundle.min.js}"></script>
<script th:src="@{/assets/vendor/aos/aos.js}"></script>
<script th:src="@{/assets/vendor/glightbox/js/glightbox.min.js}"></script>
<script th:src="@{/assets/vendor/drift-zoom/Drift.min.js}"></script>
<script th:src="@{/assets/vendor/purecounter/purecounter_vanilla.js}"></script>
<script th:src="@{/assets/js/main.js}"></script>

<th:block th:replace="~{'admin/order/order-js' :: orderJs}"></th:block>


<script th:inline="javascript">

  /**
   * 일괄 변경(체크박스, 드롭다운) 관련 이벤트 리스너를 초기화합니다.
   */
  function initBulkActions() {
    const checkAll = document.getElementById('check-all');
    const orderCheckboxes = document.querySelectorAll('.order-checkbox');
    const bulkActionItems = document.querySelectorAll('.bulk-action-item');

    // 1. "전체 선택" 체크박스 클릭 이벤트
    if (checkAll) {
      checkAll.addEventListener('click', () => {
        orderCheckboxes.forEach(checkbox => {
          checkbox.checked = checkAll.checked;
        });
      });
    }

    // 2. 개별 체크박스 클릭 이벤트 (전체 선택 상태 반영)
    orderCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('click', () => {
        if (!checkbox.checked) {
          checkAll.checked = false;
        } else if (document.querySelectorAll('.order-checkbox:checked').length === orderCheckboxes.length) {
          checkAll.checked = true;
        }
      });
    });

    // 3. "일괄 작업" 드롭다운 메뉴 클릭 이벤트
    bulkActionItems.forEach(item => {
      item.addEventListener('click', (event) => {
        event.preventDefault(); // 링크 이동 방지

        const statusToUpdate = event.target.dataset.status;

        // 3-1. 체크된 박스들의 'value' (orderNumber)를 수집
        const checkedBoxes = document.querySelectorAll('.order-checkbox:checked');
        if (checkedBoxes.length === 0) {
          alert('먼저 변경할 주문을 하나 이상 선택하세요.');
          return;
        }

        const orderNumbers = Array.from(checkedBoxes).map(cb => cb.value);

        if (!confirm(`선택한 ${orderNumbers.length}개 주문의 상태를 '${statusToUpdate}'(으)로 변경하시겠습니까?`)) {
          return;
        }

        // 3-2. 서버로 전송할 DTO 생성
        const bulkUpdateRequest = {
          orderNumberLists: orderNumbers,
          status: statusToUpdate
        };

        // 3-3. fetch API로 서버에 POST (또는 PUT/PATCH) 요청
        // (CSRF 토큰이 필요하면 headers에 추가해야 합니다)
        const csrfToken = document.querySelector("meta[name='_csrf']")?.content;
        const csrfHeader = document.querySelector("meta[name='_csrf_header']")?.content;

        const headers = {
          'Content-Type': 'application/json'
        };
        if (csrfToken && csrfHeader) {
          headers[csrfHeader] = csrfToken;
        }

        fetch('/admin/orders/bulk-status', {
          method: 'POST',
          headers: headers,
          body: JSON.stringify(bulkUpdateRequest)
        })
                .then(response => {
                  if (response.ok) {
                    alert('성공적으로 변경되었습니다.');
                    location.reload(); // 페이지 새로고침
                  } else {
                    return response.json().then(err => { throw new Error(err.message || '변경에 실패했습니다.') });
                  }
                })
                .catch(error => {
                  console.error('일괄 변경 실패:', error);
                  alert(`오류 발생: ${error.message}`);
                });
      });
    });
  }

  // 4. 페이지 로드 완료 시 함수 실행
  document.addEventListener('DOMContentLoaded', initBulkActions);

</script>
</body>
</html>