<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>카테고리 관리</title>
    <style>
        :root {
            --accent-color: #3b5bdb;
            --indent: 24px;
        }
        body { background-color: #f8f9fa; }
        ul { list-style: none; padding-left: 0; margin: 0; }
        li { margin: 4px 0; }
        ul ul { padding-left: var(--indent); border-left: 1px dashed #e0e0e0; margin-left: 8px; }
        .category-line { display: grid; grid-template-columns: 1fr auto; align-items: center; padding: 4px 8px; border-radius: 6px; transition: background-color 0.2s; }
        .category-line:hover { background-color: color-mix(in srgb, var(--accent-color), transparent 92%); }
        .category-name { display: inline-block; cursor: pointer; }
        .folder { color: var(--accent-color); font-weight: 600; }
        .leaf { color: #333; }
        .category-actions { display: flex; gap: 4px; }
        .category-actions .btn { font-size: 0.85rem; padding: 2px 10px; height: 28px; }
        .inline-form { display: flex; align-items: center; gap: 6px; margin-top: 4px; }
        .inline-form .form-control { width: 180px; height: 28px; font-size: 0.85rem; padding: 2px 8px; }
        .hidden { display: none; }
    </style>
    <th:insert th:replace="~{fragments/file_link :: linkInfo}"></th:insert>
</head>

<body>
<th:insert th:replace="~{fragments/common_header :: commonHeader}"></th:insert>

<main class="container my-5">

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h5 class="fw-semibold mb-3">최상위 카테고리 등록</h5>
            <form id="rootForm" class="row g-3">
                <div class="col-md-4">
                    <input id="root" type="text" name="name" class="form-control" placeholder="예: 국내도서" required>
                </div>
                <div class="col-md-1 d-grid">
                    <button type="submit" class="btn btn-dark">등록</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <h5 class="fw-semibold mb-3">카테고리 목록</h5>
            <ul id="category-list">
                <li th:each="category : ${categories}">
                    <div class="category-line">
                        <span class="category-name"
                              th:text="${category.name}"
                              th:attr="data-id=${category.id}, data-has-children=${category.hasChildren}"
                              th:classappend="${category.hasChildren} ? ' folder' : ' leaf'"
                              onclick="loadChildren(this)">
                        </span>
                        <div class="category-actions">
                            <button type="button" class="btn btn-outline-secondary btn-sm"
                                    th:attr="data-id=${category.id}" onclick="showAddForm(this)">추가</button>
                            <button type="button" class="btn btn-outline-warning btn-sm"
                                    th:attr="data-id=${category.id}, data-name=${category.name}" onclick="showEditForm(this)">수정</button>
                            <button type="button" class="btn btn-outline-danger btn-sm"
                                    th:attr="data-id=${category.id}" onclick="deleteCategory(this)">삭제</button>
                        </div>
                    </div>
                    <ul th:id="'children-' + ${category.id}" class="hidden"></ul>
                </li>
            </ul>
        </div>
    </div>

</main>

<th:insert th:replace="~{fragments/common_footer :: commonFooter}"></th:insert>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>

    document.getElementById("rootForm").addEventListener("submit", e => {
        e.preventDefault();
        const name = document.getElementById("root").value.trim();
        if (!name) return alert("카테고리명을 입력하세요.");
        fetch("/categories", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ name })
        })
            .then(res => { if (!res.ok) throw new Error("등록 실패"); location.reload(); })
            .catch(err => alert(err));
    });

    function loadChildren(element) {
        const parentId = element.dataset.id;
        const hasChildren = element.dataset.hasChildren === "true";
        const childrenUl = document.getElementById(`children-${parentId}`);
        if (!hasChildren) return;

        if (childrenUl.dataset.loaded === "true") {
            childrenUl.classList.toggle("hidden");
            return;
        }

        fetch(`/categories/${parentId}/children`)
            .then(res => res.json())
            .then(children => {
                childrenUl.innerHTML = "";
                children.forEach(child => {
                    const li = document.createElement("li");
                    li.innerHTML = `
                        <div class="category-line">
                            <span class="category-name ${child.hasChildren ? "folder" : "leaf"}"
                                  data-id="${child.id}"
                                  data-has-children="${child.hasChildren}"
                                  onclick="loadChildren(this)">${child.name}</span>
                            <div class="category-actions">
                                <button class="btn btn-outline-secondary btn-sm" data-id="${child.id}" onclick="showAddForm(this)">추가</button>
                                <button class="btn btn-outline-warning btn-sm" data-id="${child.id}" data-name="${child.name}" onclick="showEditForm(this)">수정</button>
                                <button class="btn btn-outline-danger btn-sm" data-id="${child.id}" onclick="deleteCategory(this)">삭제</button>
                            </div>
                        </div>
                        <ul id="children-${child.id}" class="hidden"></ul>
                    `;
                    childrenUl.appendChild(li);
                });
                childrenUl.dataset.loaded = "true";
                childrenUl.classList.remove("hidden");
            });
    }

    function showAddForm(button) {
        const parentId = button.dataset.id;
        const li = button.closest("li");
        const existingForm = li.querySelector(".inline-form");
        if (existingForm) existingForm.remove();

        const form = document.createElement("form");
        form.classList.add("inline-form");
        form.innerHTML = `
        <input type="text" name="name" class="form-control form-control-sm" placeholder="하위 카테고리명" required>
        <button type="submit" class="btn btn-sm btn-dark">등록</button>
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="cancelForm(this)">취소</button>
    `;

        const childUl = li.querySelector(`#children-${parentId}`);
        if (childUl) {
            li.insertBefore(form, childUl);
        } else {
            li.appendChild(form);
        }

        form.addEventListener("submit", e => {
            e.preventDefault();
            const name = form.querySelector("input[name='name']").value.trim();
            if (!name) return alert("이름을 입력하세요.");
            fetch("/categories", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ name, parentId })
            })
                .then(res => { if (!res.ok) throw new Error("추가 실패"); location.reload(); })
                .catch(err => alert(err));
        });
    }

    function showEditForm(button) {
        const id = button.dataset.id;
        const oldName = button.dataset.name;
        const li = button.closest("li");
        const existingForm = li.querySelector(".inline-form");
        if (existingForm) existingForm.remove();

        const form = document.createElement("form");
        form.classList.add("inline-form");
        form.innerHTML = `
        <input type="text" name="name" class="form-control form-control-sm" value="${oldName}" required>
        <button type="submit" class="btn btn-outline-warning btn-sm">수정</button>
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="cancelForm(this)">취소</button>
    `;

        const childUl = li.querySelector(`#children-${id}`);
        if (childUl) {
            li.insertBefore(form, childUl);
        } else {
            li.appendChild(form);
        }

        form.addEventListener("submit", e => {
            e.preventDefault();
            const newName = form.querySelector("input[name='name']").value.trim();
            if (!newName || newName === oldName) return;
            fetch(`/categories/${id}`, {
                method: "PUT",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ name: newName })
            })
                .then(res => {
                    if (!res.ok) throw new Error("수정 실패");
                    return res.json();
                })
                .then(data => {
                    li.querySelector(".category-name").textContent = data.name;
                    button.dataset.name = data.name;
                    form.remove();
                })
                .catch(err => alert(err));
        });
    }

    function cancelForm(btn) { btn.closest(".inline-form").remove(); }

    function deleteCategory(button) {
        const id = button.dataset.id;
        fetch(`/categories/${id}`, { method: "DELETE" })
            .then(res => { if (!res.ok) throw new Error("삭제 실패"); location.reload(); })
            .catch(err => alert(err));
    }
</script>

</body>
</html>
