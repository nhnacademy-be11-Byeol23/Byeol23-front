<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title th:text="${book.bookName} + ' - 도서 상세'">도서 상세 정보</title>
  <meta name="description" content="">
  <meta name="keywords" content="">

  <th:block th:replace="~{fragments/file_link :: linkInfo}"></th:block>
</head>

<body class="product-details-page">

<div th:replace="~{fragments/common_header :: commonHeader}"></div>

<main class="main">

  <div class="page-title light-background">
    <div class="container d-lg-flex justify-content-between align-items-center">
      <h1 class="mb-2 mb-lg-0">도서 상세 정보</h1>
      <nav class="breadcrumbs">
        <ol>
          <li><a th:href="@{/}">Home</a></li>
          <li class="current" th:text="${book.bookName}">도서 상세</li>
        </ol>
      </nav>
    </div>
  </div><section id="product-details" class="product-details section">

  <div class="container" data-aos="fade-up" data-aos-delay="100">

    <div class="row g-4">
      <div class="col-lg-7" data-aos="zoom-in" data-aos-delay="150">
        <div class="product-gallery">

          <div class="main-showcase">
            <img th:src="${(book.images != null and !#lists.isEmpty(book.images))
                       ? book.images.get(0).imageUrl()
                       : 'https://image.yes24.com/momo/Noimg_L.jpg'}"
                 alt="도서 커버"
                 class="img-fluid main-product-image"
                 id="main-product-image">
          </div>

          <div class="thumbnail-gallery d-flex flex-wrap mt-3"
               th:if="${book.images != null and !#lists.isEmpty(book.images)}">

            <img th:each="image, iterStat : ${book.images}"
                 th:src="${image.imageUrl()}"
                 alt="도서 썸네일"
                 class="img-thumbnail thumbnail-item"
                 th:classappend="${iterStat.first} ? 'active'"
                 th:data-full-src="${image.imageUrl()}"
                 style="width: 80px; height: 80px; object-fit: cover; margin-right: 10px; cursor: pointer; border-width: 2px;">
          </div>

        </div>
      </div>

      <div class="col-lg-5" data-aos="fade-left" data-aos-delay="200">
        <div class="product-details">
          <div class="product-badge-container">
            <div class="category-badges mb-2" th:if="${book.categories != null and !#lists.isEmpty(book.categories)}">
              <span th:each="category : ${book.categories}"
                    class="badge bg-primary me-1"
                    th:text="${category.categoryName}"
                    title="${category.pathName}">
              </span>
            </div>
            <span class="badge-category" th:if="${book.categories == null or #lists.isEmpty(book.categories)}">카테고리 없음</span>
            <div class="tag-badges" th:if="${book.tags != null and !#lists.isEmpty(book.tags)}">
              <i class="bi bi-tags-fill me-1" style="font-size: 0.9rem;"></i>
              <span th:each="tag : ${book.tags}"
                    class="badge bg-secondary me-1"
                    th:text="${tag.tagName}">
                </span>
            </div>
            <div class="rating-group">
              <div class="stars">
                <i class="bi bi-star-fill"></i>
                <i class="bi bi-star-fill"></i>
                <i class="bi bi-star-fill"></i>
                <i class="bi bi-star-fill"></i>
                <i class="bi bi-star-half"></i>
              </div>
              <span class="review-text">(0 리뷰)</span>
            </div>
          </div>

          <h1 class="product-name" th:text="${book.bookName}">도서명</h1>

          <div class="pricing-section">
            <div class="price-display">
              <span class="sale-price" th:text="${#numbers.formatInteger(book.salePrice, 0, 'COMMA') + '원'}">16,000원</span>
              <span class="regular-price" th:text="${#numbers.formatInteger(book.regularPrice, 0, 'COMMA') + '원'}">15,990원</span>
            </div>
            <div class="savings-info">
              <span class="save-amount" th:text="'Save ' + ${#numbers.formatInteger(book.regularPrice - book.salePrice, 0, 'COMMA')} + '원'">10원 할인</span>
              <span class="discount-percent" th:if="${book.regularPrice > 0}"
                    th:text="'(' + ${#numbers.formatDecimal((book.regularPrice - book.salePrice) * 100.0 / book.regularPrice, 0, 0)} + '% off)'">0.0625프로 할인</span>
            </div>
          </div>

          <span th:text="${book.publisher().publisherName()}">출판사명</span>

          <span class="mx-1">|</span>

          <th:block th:each="contributor, iter : ${book.contributors}">
            <span th:text="${contributor.contributorName()}">저자명</span>
            <span th:text="${contributor.contributorRole()} ? ' (' + ${contributor.contributorRole()} + ')' : ''">(저)</span>
            <span th:if="!${iter.last}">, </span>
          </th:block>

          <span th:if="${book.contributors == null or #lists.isEmpty(book.contributors)}">
                기여자 정보 없음
              </span>
          <div class="availability-status mt-3">
            <div class="stock-indicator" th:if="${book.stock > 0}">
              <i class="bi bi-check-circle-fill"></i>
              <span class="stock-text">구매 가능</span>
            </div>
            <div class="stock-indicator text-danger" th:if="${book.stock <= 0}">
              <i class="bi bi-x-circle-fill"></i>
              <span class="stock-text">재고 없음</span>
            </div>
            <div class="quantity-left" th:if="${book.stock > 0}" th:text="'(잔여 재고: ' + ${book.stock} + '권)'">재고: 18권</div>
            <div th:if="${book.isPack}" class="stock-indicator text-success">
              <i class="bi bi-box-seam-fill"></i>
              <span class="stock-text">포장 가능</span>
            </div>
            <div th:unless="${book.isPack}" class="stock-indicator text-muted">
              <i class="bi bi-box"></i>
              <span class="stock-text">포장 불가</span>
            </div>
          </div>

          <div class="purchase-section">
            <div class="quantity-control">
              <label class="control-label">수량:</label>
              <div class="quantity-input-group">
                <div class="quantity-selector">
                  <button class="quantity-btn decrease" type="button">
                    <i class="bi bi-dash"></i>
                  </button>
                  <input type="number" class="quantity-input" value="1" min="1" th:max="${book.stock}">
                  <button class="quantity-btn increase" type="button">
                    <i class="bi bi-plus"></i>
                  </button>
                </div>
              </div>
            </div>

            <div class="action-buttons">
              <button class="btn primary-action">
                <i class="bi bi-bag-plus"></i>
                장바구니 담기
              </button>
              <button class="btn secondary-action" id="buy-now-btn">
                <i class="bi bi-lightning"></i>
                바로 구매
              </button>
              <button class="btn icon-action" title="Add to Wishlist">
                <i class="bi bi-heart"></i>
              </button>
            </div>
          </div>

          <div class="benefits-list">
            <div class="benefit-item">
              <i class="bi bi-truck"></i>
              <span th:if="${delivery != null}"
                    th:text="${#numbers.formatInteger(delivery.freeDeliveryCondition, 0, 'COMMA')} + '원 이상 구매 시 무료 배송'">
      5만원 이상 구매 시 무료 배송
    </span>
              <small th:if="${delivery != null}"
                     th:text="'(기본 배송비: ' + ${#numbers.formatInteger(delivery.deliveryFee, 0, 'COMMA')} + '원)'">
              </small>
            </div>
            <div class="benefit-item">
              <i class="bi bi-arrow-clockwise"></i>
              <span>단순 변심 10일 이내 반품 가능(반품 택배비 제외)</span>
            </div>
            <div class="benefit-item">
            <i class="bi bi-arrow-clockwise"></i>
            <span>파손 파지 30일 이내 반품 가능</span>
          </div>
          </div>
        </div>
      </div>
    </div>
    <div class="row mt-5" data-aos="fade-up" data-aos-delay="300">
      <div class="col-12">
        <div class="info-tabs-container">
          <nav class="tabs-navigation nav">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-overview" type="button">도서 소개</button>
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-details" type="button">상세 정보</button>
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-reviews" type="button">리뷰 (0)</button>
          </nav>

          <div class="tab-content">
            <div class="tab-pane fade show active" id="tab-overview">
              <div class="overview-content">
                <div class="row g-4">
                  <div class="col-lg-12"> <div class="content-section">
                    <h3>도서 설명</h3>
                    <p th:text="${book.description}">
                      도서에 대한 상세한 설명글입니다.
                    </p>
                  </div>
                    <div class="content-section mt-4">
                      <h3>도서 목차</h3>
                      <p th:text="${book.toc}">
                        도서 목차가 여기에 표시됩니다.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="tab-pane fade" id="tab-details">
              <div class="technical-content">
                <div class="row g-4">
                  <div class="col-md-8">
                    <div class="tech-group">
                      <h4>도서 상세 정보</h4>
                      <div class="spec-table">
                        <div class="spec-row">
                          <span class="spec-name">기여자</span>
                          <span class="spec-value">
                            <th:block th:each="contrib, iter : ${book.contributors}">
                              <span th:text="${contrib.contributorName}"></span>
                              <span th:text="' (' + ${contrib.contributorRole} + ')'"></span>
                              <span th:if="!${iter.last}">, </span>
                            </th:block>
                            <span th:if="${book.contributors == null or #lists.isEmpty(book.contributors)}">
                              기여자 정보 없음
                            </span>
                          </span>
                        </div>
                        <div class="spec-row">
                          <span class="spec-name">출판사</span>
                          <span class="spec-value" th:text="${book.publisher().publisherName()}">출판사명</span>
                        </div>
                        <div class="spec-row">
                          <span class="spec-name">발행일</span>
                          <span class="spec-value" th:text="${#temporals.format(book.publishDate, 'yyyy-MM-dd')}">2025-01-01</span>
                        </div>
                        <div class="spec-row">
                          <span class="spec-name">ISBN</span>
                          <span class="spec-value" th:text="${book.isbn}">97911...</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="tab-pane fade" id="tab-reviews">
              <div class="reviews-content">
                <div class="reviews-header">
                  <div class="rating-overview">
                    ...
                  </div>
                  <div class="write-review-cta">
                    <h4>리뷰 남기기</h4>
                    <p>고객님의 소중한 리뷰를 남겨주세요</p>
                    <button class="btn review-btn">리뷰 작성하기</button>
                  </div>
                </div>
                <div class="customer-reviews-list">
                  ...
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</section></main>

<div th:replace="~{fragments/common_footer :: commonFooter}"></div>

<a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

<div id="preloader"></div>
<script th:src="@{/assets/vendor/bootstrap/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/assets/vendor/php-email-form/validate.js}"></script>
<script th:src="@{/assets/vendor/swiper/swiper-bundle.min.js}"></script>
<script th:src="@{/assets/vendor/aos/aos.js}"></script>
<script th:src="@{/assets/vendor/glightbox/js/glightbox.min.js}"></script>
<script th:src="@{/assets/vendor/drift-zoom/Drift.min.js}"></script>
<script th:src="@{/assets/vendor/purecounter/purecounter_vanilla.js}"></script>

<script th:src="@{/assets/js/main.js}"></script>

<script th:inline="javascript">
  document.addEventListener('DOMContentLoaded', () => {
    const buyNowButton = document.getElementById('buy-now-btn');

    const bookId = /*[[${book.bookId}]]*/ 1;
    const bookName = /*[[${book.bookName}]]*/ "책 이름";
    const regularPrice = /*[[${book.regularPrice}]]*/ null;
    const salePrice = /*[[${book.salePrice}]]*/ null;
    const postUrl = /*[[@{/orders/direct}]]*/ '/orders/direct';
    const successUrl = /*[[@{/orders/direct}]]*/ '/orders/direct';

    if (buyNowButton) {
      buyNowButton.addEventListener('click', () => {
        console.log("버튼 클릭");
        const memberId = 1; // 테스트용 회원 아이디

        const quantityInput = document.querySelector('.quantity-input');
        const quantity = quantityInput ? quantityInput.value : 1;

        if(!memberId) {
          // 로그인이 안 돼있을 때 로그인 페이지로 리다이렉트 시킬 수 있도록
        }

        const isPack = /*[[${book.isPack}]]*/ false;
        const publisher = /*[[${book.publisher}]]*/ null;
        const contributors = /*[[${book.contributors}]]*/ [];

        const bookInfoRequest = {
          bookId: bookId,
          bookName: bookName,
          imageUrl: "https://image.aladin.co.kr/product/33566/83/cover100/8937456486_1.jpg",
          isPack: isPack,
          regularPrice: regularPrice,
          salePrice: salePrice,
          publisher: publisher,
          quantity: quantity,
          contributors: contributors
      }

        const bookOrderRequest = {
          memberId: memberId,
          bookList:[bookInfoRequest]
        }

        fetch(postUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(bookOrderRequest)
        })
        .then(response => {
          if(response.ok){
            window.location.href = successUrl;
          } else {
            alert('주문 페이지로 이동하는 데 실패했습니다.');
          }
        })
        .catch(error => {
          console.error('Error: ', error);
          alert('오류가 발생했습니다.');
        });
      });
    }
  });

  // 1. DOMContentLoaded 이벤트 리스너
  document.addEventListener('DOMContentLoaded', () => {

    // 2. 핵심 요소 찾기
    const mainImage = document.getElementById('main-product-image');
    const thumbnails = document.querySelectorAll('.thumbnail-item');

    // 3. 예외 처리 (가드 클로즈)
    if (!mainImage || thumbnails.length === 0) {
      return;
    }

    // 4. 썸네일에 클릭 이벤트 '등록' (forEach 루프)
    thumbnails.forEach(thumb => {

      // 5. 클릭 이벤트 '발생' 시 실행될 함수
      thumb.addEventListener('click', function() { // 'this'를 사용하기 위해 화살표 함수( => ) 대신 function() 사용

        // 6. 클릭된 썸네일에서 큰 이미지 URL 가져오기
        const newSrc = this.dataset.fullSrc;

        // 7. 메인 이미지 변경
        mainImage.src = newSrc;

        // 8. (선택) 'active' 클래스 관리 (시각적 피드백)
        thumbnails.forEach(t => t.classList.remove('active'));
        this.classList.add('active');
      });
    });
  });


</script>

</body>

</html>
