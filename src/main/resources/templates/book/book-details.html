<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title th:text="${book.bookName} + ' - 도서 상세'">도서 상세 정보</title>
  <meta name="description" content="">
  <meta name="keywords" content="">

  <th:block th:replace="~{fragments/file_link :: linkInfo}"></th:block>
</head>

<body class="product-details-page">

<div th:replace="~{fragments/common_header :: commonHeader}"></div>

<main class="main">

  <div class="page-title light-background">
    <div class="container d-lg-flex justify-content-between align-items-center">
      <h1 class="mb-2 mb-lg-0">도서 상세 정보</h1>
      <nav class="breadcrumbs">
        <ol>
          <li><a th:href="@{/}">Home</a></li>
          <li class="current" th:text="${book.bookName}">도서 상세</li>
        </ol>
      </nav>
    </div>
  </div><section id="product-details" class="product-details section">

  <div class="container" data-aos="fade-up" data-aos-delay="100">

    <div class="row g-4">
      <div class="col-lg-7" data-aos="zoom-in" data-aos-delay="150">
        <div class="product-gallery">

          <div class="main-showcase">
            <img th:src="${(book.images != null and !#lists.isEmpty(book.images))
                       ? book.images.get(0).imageUrl()
                       : 'https://image.yes24.com/momo/Noimg_L.jpg'}"
                 alt="도서 커버"
                 class="img-fluid main-product-image"
                 id="main-product-image">
          </div>

          <div class="thumbnail-gallery d-flex flex-wrap mt-3"
               th:if="${book.images != null and !#lists.isEmpty(book.images)}">

            <img th:each="image, iterStat : ${book.images}"
                 th:src="${image.imageUrl()}"
                 alt="도서 썸네일"
                 class="img-thumbnail thumbnail-item"
                 th:classappend="${iterStat.first} ? 'active'"
                 th:data-full-src="${image.imageUrl()}"
                 style="width: 80px; height: 80px; object-fit: cover; margin-right: 10px; cursor: pointer; border-width: 2px;">
          </div>

        </div>
      </div>

      <div class="col-lg-5" data-aos="fade-left" data-aos-delay="200">
        <div class="product-details">
          <div class="product-badge-container">
            <div class="category-badges mb-2" th:if="${book.categories != null and !#lists.isEmpty(book.categories)}">
              <span th:each="category : ${book.categories}"
                    class="badge bg-primary me-1"
                    th:text="${category.categoryName}"
                    title="${category.pathName}">
              </span>
            </div>
            <span class="badge-category" th:if="${book.categories == null or #lists.isEmpty(book.categories)}">카테고리 없음</span>
            <div class="tag-badges" th:if="${book.tags != null and !#lists.isEmpty(book.tags)}">
              <i class="bi bi-tags-fill me-1" style="font-size: 0.9rem;"></i>
              <span th:each="tag : ${book.tags}"
                    class="badge bg-secondary me-1"
                    th:text="${tag.tagName}">
                </span>
            </div>
            <div class="rating-group">
              <div class="stars">
                <i class="bi bi-star-fill"></i>
                <i class="bi bi-star-fill"></i>
                <i class="bi bi-star-fill"></i>
                <i class="bi bi-star-fill"></i>
                <i class="bi bi-star-half"></i>
              </div>
              <span class="review-text">(0 리뷰)</span>
            </div>
          </div>

          <h1 class="product-name" th:text="${book.bookName}">도서명</h1>

          <div class="pricing-section">
            <div class="price-display">
              <span class="sale-price" th:text="${#numbers.formatInteger(book.salePrice, 0, 'COMMA') + '원'}">16,000원</span>
              <span class="regular-price" th:text="${#numbers.formatInteger(book.regularPrice, 0, 'COMMA') + '원'}">15,990원</span>
            </div>
            <div class="savings-info">
              <span class="save-amount" th:text="'Save ' + ${#numbers.formatInteger(book.regularPrice - book.salePrice, 0, 'COMMA')} + '원'">10원 할인</span>
              <span class="discount-percent" th:if="${book.regularPrice > 0}"
                    th:text="'(' + ${#numbers.formatDecimal((book.regularPrice - book.salePrice) * 100.0 / book.regularPrice, 0, 0)} + '% off)'">0.0625프로 할인</span>
            </div>
          </div>

          <span th:text="${book.publisher().publisherName()}">출판사명</span>

          <span class="mx-1">|</span>

          <th:block th:each="contributor, iter : ${book.contributors}">
            <span th:text="${contributor.contributorName()}">저자명</span>
            <span th:text="${contributor.contributorRole()} ? ' (' + ${contributor.contributorRole()} + ')' : ''">(저)</span>
            <span th:if="!${iter.last}">, </span>
          </th:block>

          <span th:if="${book.contributors == null or #lists.isEmpty(book.contributors)}">
                기여자 정보 없음
              </span>
          <div class="availability-status mt-3">
            <div class="stock-indicator" th:if="${book.stock > 0}">
              <i class="bi bi-check-circle-fill"></i>
              <span class="stock-text">구매 가능</span>
            </div>
            <div class="stock-indicator text-danger" th:if="${book.stock <= 0}">
              <i class="bi bi-x-circle-fill"></i>
              <span class="stock-text">재고 없음</span>
            </div>
            <div class="quantity-left" th:if="${book.stock > 0}" th:text="'(잔여 재고: ' + ${book.stock} + '권)'">재고: 18권</div>
            <div th:if="${book.isPack}" class="stock-indicator text-success">
              <i class="bi bi-box-seam-fill"></i>
              <span class="stock-text">포장 가능</span>
            </div>
            <div th:unless="${book.isPack}" class="stock-indicator text-muted">
              <i class="bi bi-box"></i>
              <span class="stock-text">포장 불가</span>
            </div>
          </div>

          <div class="purchase-section" th:attr="data-book-id=${book.bookId}">
            <div class="quantity-control">
              <label class="control-label">수량:</label>
              <div class="quantity-input-group">
                <div class="quantity-selector">
                  <button class="quantity-btn decrease" type="button">
                    <i class="bi bi-dash"></i>
                  </button>
                    <input type="number" class="quantity-input" value="1" min="1" th:max="${book.stock}">
                  <button class="quantity-btn increase" type="button">
                    <i class="bi bi-plus"></i>
                  </button>
                </div>
              </div>
            </div>

            <div class="action-buttons">
              <button class="btn primary-action add-to-cart-btn">
                <i class="bi bi-bag-plus"></i>
                장바구니 담기
              </button>
              <button class="btn secondary-action" id="buy-now-btn">
                <i class="bi bi-lightning"></i>
                바로 구매
              </button>
              <button class="btn icon-action wishlist-btn" 
                      id="wishlist-btn" 
                      th:attr="data-book-id=${book.bookId}">
                <i class="bi bi-heart" id="wishlist-icon"></i>
              </button>
            </div>
          </div>

          <div class="benefits-list">
            <div class="benefit-item">
              <i class="bi bi-truck"></i>
              <span th:if="${delivery != null}"
                    th:text="${#numbers.formatInteger(delivery.freeDeliveryCondition, 0, 'COMMA')} + '원 이상 구매 시 무료 배송'">
      5만원 이상 구매 시 무료 배송
    </span>
              <small th:if="${delivery != null}"
                     th:text="'(기본 배송비: ' + ${#numbers.formatInteger(delivery.deliveryFee, 0, 'COMMA')} + '원)'">
              </small>
            </div>
            <div class="benefit-item">
              <i class="bi bi-arrow-clockwise"></i>
              <span>단순 변심 10일 이내 반품 가능(반품 택배비 제외)</span>
            </div>
            <div class="benefit-item">
            <i class="bi bi-arrow-clockwise"></i>
            <span>파손 파지 30일 이내 반품 가능</span>
          </div>
          </div>
        </div>
      </div>
    </div>
    <div class="row mt-5" data-aos="fade-up" data-aos-delay="300">
      <div class="col-12">
        <div class="info-tabs-container">
          <nav class="tabs-navigation nav">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-overview" type="button">도서 소개</button>
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-details" type="button">상세 정보</button>
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-reviews" type="button" th:text="|리뷰 (${reviews.size()})|">리뷰 (0)</button>
          </nav>

          <div class="tab-content">
            <div class="tab-pane fade show active" id="tab-overview">
              <div class="overview-content">
                <div class="row g-4">
                  <div class="col-lg-12"> <div class="content-section">
                    <h3>도서 설명</h3>
                    <p th:text="${book.description}">
                      도서에 대한 상세한 설명글입니다.
                    </p>
                  </div>
                    <div class="content-section mt-4">
                      <h3>도서 목차</h3>
                      <p th:text="${book.toc}">
                        도서 목차가 여기에 표시됩니다.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="tab-pane fade" id="tab-details">
              <div class="technical-content">
                <div class="row g-4">
                  <div class="col-md-8">
                    <div class="tech-group">
                      <h4>도서 상세 정보</h4>
                      <div class="spec-table">
                        <div class="spec-row">
                          <span class="spec-name">기여자</span>
                          <span class="spec-value">
                            <th:block th:each="contrib, iter : ${book.contributors}">
                              <span th:text="${contrib.contributorName}"></span>
                              <span th:text="' (' + ${contrib.contributorRole} + ')'"></span>
                              <span th:if="!${iter.last}">, </span>
                            </th:block>
                            <span th:if="${book.contributors == null or #lists.isEmpty(book.contributors)}">
                              기여자 정보 없음
                            </span>
                          </span>
                        </div>
                        <div class="spec-row">
                          <span class="spec-name">출판사</span>
                          <span class="spec-value" th:text="${book.publisher().publisherName()}">출판사명</span>
                        </div>
                        <div class="spec-row">
                          <span class="spec-name">발행일</span>
                          <span class="spec-value" th:text="${#temporals.format(book.publishDate, 'yyyy-MM-dd')}">2025-01-01</span>
                        </div>
                        <div class="spec-row">
                          <span class="spec-name">ISBN</span>
                          <span class="spec-value" th:text="${book.isbn}">97911...</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

              <!-- language: html -->
              <div class="tab-pane fade" id="tab-reviews">
                  <div class="reviews-content">
<!--                      <div class="reviews-header">-->
<!--                          <div class="rating-overview">-->
<!--                              &lt;!&ndash; 필요시 전체 평점/통계 추가 가능 &ndash;&gt;-->
<!--                          </div>-->
<!--                          <div class="write-review-cta">-->
<!--                              <h4>리뷰 남기기</h4>-->
<!--                              <p>고객님의 소중한 리뷰를 남겨주세요</p>-->
<!--                              <button class="btn review-btn">리뷰 작성하기</button>-->
<!--                          </div>-->
<!--                      </div>-->

                      <div class="customer-reviews-list">
                          <div th:if="${reviews == null or #lists.isEmpty(reviews)}" class="no-reviews text-center py-4">
                              <p>등록된 리뷰가 없습니다.</p>
                          </div>

                          <div th:each="review : ${reviews}" class="review-item card mb-3">
                              <div class="card-body">
                                  <div class="d-flex justify-content-between align-items-start mb-2">
                                      <div>
                                          <strong th:text="${review.reviewerName}">작성자명</strong>
                                          <div class="small text-muted" th:text="${#temporals.format(review.revisedAt, 'yyyy-MM-dd HH:mm')}">2025-01-01 12:00</div>
                                      </div>
                                      <div class="review-rate">
              <span th:each="i : ${#numbers.sequence(1,5)}"
                    th:classappend="${i <= review.reviewRate} ? 'text-warning' : 'text-muted'">
                <i class="bi" th:classappend="${i <= review.reviewRate} ? ' bi-star-fill' : ' bi-star'"></i>
              </span>
                                      </div>
                                  </div>

                                  <p class="review-content mb-2" th:text="${review.reviewContent}">리뷰 내용이 표시됩니다.</p>

                                  <div class="review-images mt-2" th:if="${review.reviewImageUrls != null and !#lists.isEmpty(review.reviewImageUrls)}">
                                      <div class="d-flex flex-wrap">
                                          <img th:each="imgUrl : ${review.reviewImageUrls}"
                                               th:src="${imgUrl}"
                                               alt="리뷰 이미지"
                                               class="img-thumbnail me-2 mb-2"
                                               style="width: 80px; height: 80px; object-fit: cover; cursor: pointer;"
                                               th:attr="data-full-src=${imgUrl}">
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>

                  </div>
              </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</section></main>

<div th:replace="~{fragments/common_footer :: commonFooter}"></div>

<a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

<div id="preloader"></div>
<!-- Vendor & Main JS Files -->
<th:block th:replace="~{fragments/common_scripts :: commonScripts}"></th:block>

<script th:inline="javascript">
  function displayAlert(message) {
    alert(message);
    console.error(message);
  }

  document.addEventListener('DOMContentLoaded', () => {

    // --- 핵심 요소 정의 ---
    const purchaseSection = document.querySelector(".purchase-section");
    if (!purchaseSection) return; // 필수 요소가 없으면 실행 중단

    // Thymeleaf 변수를 JavaScript로 가져오기 (bookId는 필수)
    const bookId = /*[[${book.bookId}]]*/ null;
    if (!bookId) {
      console.error("Book ID is null. Cannot proceed with purchase logic.");
      return;
    }

    const qtyInput = purchaseSection.querySelector(".quantity-input");
    const maxStock = Number(qtyInput?.max) || 999;
    const minQuantity = Number(qtyInput?.min) || 1;


    // =========================================================
    // A. 수량 조절 및 입력 검사
    // =========================================================

    // 수량 증가/감소 핸들러
    const updateQuantityHandler = (type) => {
      if (!qtyInput) return;
      let value = parseInt(qtyInput.value, 10);

      if (type === 'increase' && value < maxStock) {
        value++;
      } else if (type === 'decrease' && value > minQuantity) {
        value--;
      }
      qtyInput.value = value;
    };

    // 수량 입력 필드 유효성 검사 (keydown, input, blur 로직)
    // ... (이전에 제공된 유효성 검사 로직을 여기에 통합) ...
    qtyInput.addEventListener("keydown", event => {
      if (["e", "E", "-", "+"].includes(event.key)) event.preventDefault();
    });
    qtyInput.addEventListener("input", event => {
      let value = qtyInput.value.replace(/[^0-9]/g, "");
      let num = Number(value);
      if (num < minQuantity) num = minQuantity;
      if (num > maxStock) num = maxStock;
      qtyInput.value = num;
    });
    qtyInput.addEventListener("blur", () => {
      if (!qtyInput.value || isNaN(qtyInput.value)) qtyInput.value = minQuantity;
    });


    // =========================================================
    // B. 바로 구매 (Buy Now) 로직 (인증 체크 후 리다이렉트)
    // =========================================================

    const buyNowButton = document.getElementById('buy-now-btn');

    if (buyNowButton) {
      buyNowButton.addEventListener('click', () => {
        const quantity = parseInt(qtyInput.value, 10);

        // 유효성 검사
        if (quantity < minQuantity || quantity > maxStock) {
          alert(`수량은 ${minQuantity}권 이상, ${maxStock}권 이하로 설정해주세요.`);
          return;
        }

        // 1. 단일 상품 정보 수집 (bookId 변수는 이미 정의되어 있다고 가정)
        const bookId = /*[[${book.bookId}]]*/ 1; // Thymeleaf 변수 사용

        // 2. ⭐ URL Query Parameter String 생성 ⭐
        const params = new URLSearchParams();
        params.append('bookIds', String(bookId));
        params.append('quantities', String(quantity));
        const itemParams = params.toString(); // "bookIds=X&quantities=Y"

        // 3. ⭐ POST 검증 API 호출 없이, 바로 비회원 주문서 GET URL로 리다이렉트 ⭐
        const nonMemberOrderBaseUrl = "/orders/nonmember/direct";
        const finalUrl = `${nonMemberOrderBaseUrl}?${itemParams}`;

        console.log("최종 Checkout URL:", finalUrl);
        window.location.href = finalUrl;

      });
    }

    const mainImage = document.getElementById('main-product-image');
    const thumbnails = document.querySelectorAll('.thumbnail-item');
    if (mainImage && thumbnails.length > 0) {
      thumbnails.forEach(thumb => {
        thumb.addEventListener('click', function() {
          mainImage.src = this.dataset.fullSrc;
          thumbnails.forEach(t => t.classList.remove('active'));
          this.classList.add('active');
        });
      });
    }

    const addToCartBtn = document.querySelector(".add-to-cart-btn");
    if (addToCartBtn) {
      addToCartBtn.addEventListener("click", async () => {
        const quantity = Number(qtyInput.value);
        const payload = { bookId: Number(bookId), quantity: quantity };

        try {
          const res = await fetch("/carts/books", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          if (!res.ok) {
            const body = await res.json().catch(() => ({}));
            alert(body.message || "장바구니 담기 실패");
            return;
          }

          alert("상품이 장바구니에 담겼습니다.");

        } catch (err) {
          console.error(err);
          alert("장바구니 처리 중 오류 발생");
        }
      });
    }

  });

  // 위시리스트 버튼 클릭 이벤트
  document.addEventListener("DOMContentLoaded", () => {
    const wishlistBtn = document.getElementById("wishlist-btn");
    const wishlistIcon = document.getElementById("wishlist-icon");
    
    if (!wishlistBtn || !wishlistIcon) return;
    
    const bookId = wishlistBtn.dataset.bookId;
    let isLiked = false; // 초기 상태 (나중에 서버에서 확인 가능)
    
    wishlistBtn.addEventListener("click", async () => {
      try {
        const res = await fetch(`/likes/${bookId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" }
        });
        
        if (!res.ok) {
          if (res.status === 401) {
            alert("로그인이 필요한 서비스입니다.");
            window.location.href = `/members/login`;
            return;
          }
          const body = await res.json().catch(() => ({}));
          alert(body.message || "위시리스트 처리 중 오류가 발생했습니다.");
          return;
        }
        
        // 토글 상태 변경
        isLiked = !isLiked;
        
        // 아이콘 변경
        if (isLiked) {
          wishlistIcon.classList.remove("bi-heart");
          wishlistIcon.classList.add("bi-heart-fill");
          wishlistBtn.style.color = "#e74c3c"; // 빨간색
          alert("위시리스트에 추가되었습니다.");
        } else {
          wishlistIcon.classList.remove("bi-heart-fill");
          wishlistIcon.classList.add("bi-heart");
          wishlistBtn.style.color = ""; // 기본 색상
          alert("위시리스트에서 제거되었습니다.");
        }
        
      } catch (err) {
        console.error(err);
        alert("위시리스트 처리 중 오류가 발생했습니다.");
      }
    });
  });
</script>
</body>
</html>
