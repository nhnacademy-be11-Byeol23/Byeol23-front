<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title th:text="'주문 상세 - ' + ${order.orderNumber}">주문 상세 정보</title>

    <th:block th:replace="~{fragments/file_link :: linkInfo}"></th:block>

    <style>
        .detail-card-container {
            max-width: 900px;
            margin: 30px auto;
        }
        .detail-section {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }
        .detail-section h4 {
            border-bottom: 2px solid #252223;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        .item-row {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed #f0f0f0;
        }
        .item-row:last-child {
            border-bottom: none;
        }
        .item-info-group {
            flex-grow: 1;
            margin-left: 15px;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px 30px;
        }
    </style>
</head>

<body class="order-detail-page">

<div th:replace="~{fragments/common_header :: commonHeader}"></div>

<main class="main">

    <div class="page-title light-background">
        <div class="container d-lg-flex justify-content-between align-items-center">
            <h1 class="mb-2 mb-lg-0">비회원 주문 상세</h1>
            <nav class="breadcrumbs">
                <ol>
                    <li><a th:href="@{/}">홈</a></li>
                    <li class="current" th:text="'주문번호: ' + ${order.orderNumber()}">주문번호: 12345</li>
                </ol>
            </nav>
        </div>
    </div><section id="order-detail" class="section">
    <div class="container detail-card-container">

        <div class="detail-section text-center p-4 mb-4 bg-light">
            <h3 class="mb-3">주문 상태:
                <span class="text-primary fw-bold" th:text="${order.orderStatus()}">대기</span>
            </h3>
            <p class="text-muted small">주문 일시:
                <span th:text="${#temporals.format(order.orderDate(), 'yyyy년 MM월 dd일 HH:mm')}">2025-11-13</span>
            </p>
        </div>

        <div class="detail-section">
            <h4>주문 상품 (<span th:text="${#lists.size(order.items())}">3</span>개)</h4>

            <div class="order-items-list">
                <div class="item-row" th:each="item, iterStat : ${order.items()}">

                    <div class="item-image me-3">
                        <img src="/assets/img/book_placeholder.png" alt="Book" style="width: 60px; height: 80px; object-fit: cover;">
                    </div>

                    <div class="item-info-group">
                        <h5 class="mb-1" th:text="${item.bookTitle()}">도서 제목</h5>
                        <p class="text-muted small mb-0">수량: <span th:text="${item.quantity()}">1</span>권</p>
                    </div>

                    <div class="item-price ms-auto fw-bold">
                        <span th:text="${#numbers.formatCurrency(item.price())}">₩15,000</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="detail-section">
            <h4>배송 및 결제 정보</h4>
            <div class="row">
                <div class="col-md-6">
                    <h5>배송 정보</h5>
                    <p class="mb-1 fw-bold" th:text="${order.receiver()}">주문자 이름</p>
                    <p class="mb-0 small text-muted" th:text="'(' + ${order.postCode()} + ')'">우편번호</p>
                    <p th:text="${order.receiverAddress()} + ' ' + ${order.receiverAddressDetail()}">주소 상세</p>
                    <p class="text-muted" th:text="'연락처: ' + ${order.receiverPhone()}">010-XXXX-XXXX</p>
                </div>

                <div class="col-md-6">
                    <h5>최종 결제 금액</h5>
                    <div class="summary-grid">

                        <span class="label">상품 합계:</span>
                        <span class="value text-end" th:text="${#numbers.formatCurrency(subTotal)}">₩30,000</span>

                        <span class="label">포장비:</span>
                        <span class="value text-end" th:text="${#numbers.formatCurrency(packagingTotal)}">₩0</span>

                        <span class="label">배송비:</span>
                        <span class="value text-end" th:text="${#numbers.formatCurrency(appliedFee)}">₩0</span>

                        <th:block th:if="${usedPoint != null and usedPoint > 0}">
                            <span class="label text-danger">포인트 할인:</span>
                            <span class="value text-end text-danger" th:text="'-' + ${#numbers.formatCurrency(usedPoint)}">₩0</span>
                        </th:block>

                        <span class="label fw-bold">총 결제 금액:</span>
                        <span class="value text-end fw-bold text-primary" th:text="${#numbers.formatCurrency(order.actualOrderPrice())}">₩30,000</span>
                    </div>
                </div>
            </div>
            <div class="text-end pt-4 mt-3 border-top">
                <button th:if="${order.orderStatus() == '결제 완료' or order.orderStatus() == '배송중'}"
                        type="button"
                        class="btn btn-danger"
                        th:data-order-number="${order.orderNumber()}"
                        th:onclick="|cancelNonMemberOrder(this)|">
                    결제 취소
                </button>
            </div>
        </div>

    </div>
</section></main>

<div th:replace="~{fragments/common_footer :: commonFooter}"></div>

<script th:src="@{/assets/vendor/bootstrap/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/assets/js/main.js}"></script>

<script>
    /**
     * 비회원 주문 취소 요청을 처리합니다.
     * @param {HTMLElement} buttonElement - 클릭된 '결제 취소' 버튼 요소
     */
    function cancelNonMemberOrder(buttonElement) {
        const orderNumber = buttonElement.dataset.orderNumber;

        if (!confirm(`주문 번호 [${orderNumber}]의 결제를 취소하시겠습니까? 취소 후에는 다시 복구할 수 없습니다.`)) {
            return;
        }

        const url = `/orders/${orderNumber}/cancel`;

        const cancelRequest = {
            // 비회원 취소이므로 사유는 고정
            cancelReason: "고객 요청에 의한 취소"
        };

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(cancelRequest)
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.message || "주문 취소 처리 중 오류가 발생했습니다.") });
                }
                return response.text();
            })
            .then(() => {
                alert(`주문 [${orderNumber}]이(가) 성공적으로 취소되었습니다.`);
                // 취소 후 페이지 새로고침하여 상태 업데이트
                window.location.reload();
            })
            .catch(error => {
                console.error("Order cancellation failed:", error);
                alert(`결제 취소에 실패했습니다: ${error.message}`);
            });
    }
</script>

</body>

</html>