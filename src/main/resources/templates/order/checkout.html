<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Checkout - NiceShop Bootstrap Template</title>
    <meta name="description" content="">
    <meta name="keywords" content="">

    <th:block th:replace="~{fragments/file_link :: linkInfo}"></th:block>
    <script src="//js.tosspayments.com/v1"></script>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>

<body class="checkout-page">

<div th:replace="~{fragments/common_header :: commonHeader}"></div>
<main class="main">

    <!-- Page Title -->
    <div class="page-title light-background">
        <div class="container d-lg-flex justify-content-between align-items-center">
            <h1 class="mb-2 mb-lg-0">주문</h1>
            <nav class="breadcrumbs">
                <ol>
                    <li><a th:hred="@{/}">Home</a></li>
                    <li class="current">주문</li>
                </ol>
            </nav>
        </div>
    </div><!-- End Page Title -->

    <!-- Checkout Section -->
    <section id="checkout" class="checkout section">

        <div class="container" data-aos="fade-up" data-aos-delay="100">

            <form id="checkout-form">


                <div class="row">
                    <div class="col-lg-7">
                        <div class="checkout-container" data-aos="fade-up">
                            <div class="checkout-section" id="order-items-list">
                                <div class="section-header">
                                    <div class="section-number">1</div>
                                    <h3>주문 상품</h3>
                                </div>
                                <div class="section-content">
                                    <div class="order-items-container">

                                        <div class="order-item"
                                             th:each="item : ${bookOrderRequest.bookList()}"
                                             th:data-book-id="${item.bookId}"
                                             th:data-quantity="${item.quantity}"
                                             th:data-sale-price="${item.salePrice}"
                                             th:data-regular-price="${item.regularPrice}"
                                             th:data-book-name="${item.bookName}"
                                             th:data-image-url="${item.imageUrl}"
                                             th:data-publisher-id="${item.publisher().publisherId()}"
                                             th:data-publisher-name="${item.publisher().publisherName()}"
                                        >

                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="order-item-image me-3">
                                                    <img th:src="${item.imageUrl}" alt="Product" class="img-fluid"
                                                         style="width: 80px; height: auto;">
                                                </div>

                                                <div class="order-item-details flex-grow-1 me-3">
                                                    <h5 class="mb-1" th:text="${item.bookName}">도서 제목</h5>

                                                    <p class="text-muted small mb-0">
                                                        <span th:text="${item.publisher().publisherName()}">출판사</span>
                                                        <span class="mx-1">|</span>
                                                        <th:block th:each="contributor, iter : ${item.contributors()}">
                                                            <span th:text="${contributor.contributorName()}">저자명</span>
                                                            <span th:text="${contributor.contributorRole()} ? ' (' + ${contributor.contributorRole()} + ')' : ''">(저)</span>
                                                            <span th:if="!${iter.last}">, </span>
                                                        </th:block>
                                                    </p>

                                                </div>

                                                <div class="order-item-price mb-2">
                                                    <div class="mb-1">
                                                        <span class="quantity"
                                                              th:text="${item.quantity} + ' ×'">1 ×</span>
                                                    </div>
                                                    <span class="price-sale fw-bold fs-5"
                                                          th:text="${#numbers.formatInteger(item.salePrice, 0, 'COMMA') + '원'}">
                                                      10,000원
                                                    </span>
                                                    <span class="price-regular text-muted text-decoration-line-through ms-1"
                                                          style="font-size: 0.9em;"
                                                          th:if="${item.regularPrice > item.salePrice}"
                                                          th:text="${#numbers.formatInteger(item.regularPrice, 0, 'COMMA') + '원'}">
                                                      16,000원
                                                    </span>
                                                </div>

                                                <div th:if="${item.isPack}">
                                                    <button type="button" class="btn btn-outline-secondary btn-sm"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#packagingSelectModal"
                                                            th:data-order-item-id="${item.bookId}"><i
                                                            class="bi bi-box-seam me-1"></i> 포장 선택
                                                    </button>
                                                </div>

                                                <div class="contributor-data" style="display: none;">
                                                    <div class="contributor"
                                                         th:each="c : ${item.contributors()}"
                                                         th:data-contributor-id="${c.contributorId()}"
                                                         th:data-contributor-name="${c.contributorName()}"
                                                         th:data-contributor-role="${c.contributorRole()}">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="checkout-section" id="customer-info">
                                <div class="section-header">
                                    <div class="section-number">2</div>
                                    <h3>주문자 정보</h3>
                                </div>
                                <div class="section-content">
                                    <div class="row">
                                        <div class="col-md-12 form-group">
                                            <label for="name">이름</label>
                                            <input type="text" name="name" class="form-control" id="name"
                                                   placeholder="주문자 이름" required="">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="phone">연락처</label>
                                        <input type="tel" class="form-control" name="phone" id="phone"
                                               placeholder="010-1234-5678" required="">
                                    </div>
                                </div>
                            </div>

                            <div class="checkout-section" id="shipping-address">
                                <div class="section-header">
                                    <div class="section-number">3</div>
                                    <h3>배송지 정보</h3>
                                </div>
                                <div class="section-content">
                                    <div class="form-group">
                                        <label for="zip">우편번호</label>
                                        <div class="input-group">
                                            <input type="text" name="zip" class="form-control" id="zip"
                                                   placeholder="우편번호" required="" readonly
                                                   th:value="${defaultAddress?.postCode}">
                                            <button class="btn btn-outline-secondary" type="button" id="find-zip-btn">
                                                우편번호 찾기
                                            </button>

                                            <button class="btn btn-outline-primary" type="button"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#addressSelectModal"
                                                    id="load-addresses-btn">
                                                기존 배송지 불러오기
                                            </button>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="address">주소</label>
                                        <input type="text" class="form-control" name="address" id="address"
                                               placeholder="기본 주소" readonly
                                               th:value="${defaultAddress?.addressInfo}"></div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="address-detail">상세주소</label>
                                                <input type="text" class="form-control" name="address-detail"
                                                       id="address-detail" placeholder="상세주소 (아파트 동, 호수 등)"
                                                       th:value="${defaultAddress?.addressDetail}"></div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="address-extra">참고 항목</label>
                                                <input type="text" class="form-control" name="address-extra"
                                                       id="address-extra" placeholder="참고항목" readonly
                                                       th:value="${defaultAddress?.addressExtra}"></div>
                                        </div>
                                    </div>
                                    <div class="section-content">
                                        <div class="form-group mt-3">
                                            <label class="form-label">배송일 선택 <small class="text-muted">(도착 예상일)</small></label>
                                            <div class="delivery-date-buttons d-flex flex-wrap gap-2">
                                                <th:block th:each="dateInfo, iterStat : ${deliveryDates}">
                                                    <input type="radio" class="btn-check" name="deliveryDate"
                                                           th:id="'date-' + ${dateInfo.valueDate}"
                                                           th:value="${dateInfo.valueDate}"
                                                           th:checked="${iterStat.first}"
                                                           autocomplete="off">
                                                    <label class="btn btn-outline-secondary"
                                                           th:for="'date-' + ${dateInfo.valueDate}"
                                                           th:text="${dateInfo.dayName} + ' (' + ${dateInfo.displayDate} + ')'">
                                                        날짜 버튼
                                                    </label>
                                                </th:block>
                                            </div>
                                            <small class="text-muted d-block mt-1">주말 및 공휴일 제외, 5 영업일 이내 선택
                                                가능합니다.</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div class="checkout-section" id="discount-section">
                            <div class="section-header">
                                <div class="section-number">4</div>
                                <h3>할인 적용</h3>
                            </div>
                            <div class="section-content">
                                <div class="mb-3 row align-items-center">
                                    <label class="col-sm-2 col-form-label"><i class="bi bi-coin me-1"></i>보유</label>
                                    <div class="col-sm-10">
                                        <div class="fw-bold" id="current-points"
                                             th:text="${userPoint != null ? #numbers.formatInteger(userPoint, 0, 'COMMA') + ' P' : '0 P'}">
                                            5,000 P
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3 row align-items-center">
                                    <label for="points-to-use" class="col-sm-2 col-form-label">사용</label>
                                    <div class="col-sm-10">
                                        <div class="input-group">
                                            <input type="number" class="form-control text-end" id="points-to-use"
                                                   name="usedPoints" placeholder="0" min="0"
                                                   th:max="${userPoint ?: 0}" step="1">
                                            <span class="input-group-text">P</span>
                                            <button class="btn btn-outline-secondary" type="button"
                                                    id="apply-all-points-btn">모두 사용
                                            </button>
                                        </div>
                                        <small class="text-muted d-block mt-1"
                                               th:text="'(최대 ' + (${userPoint != null ? #numbers.formatInteger(userPoint, 0, 'COMMA') : 0}) + ' P 사용 가능)'">(최대
                                            5,000 P 사용 가능)</small></div>
                                </div>

                                <div class="row align-items-center">
                                    <label class="col-sm-2 col-form-label"><i
                                            class="bi bi-ticket-perc me-1"></i>쿠폰</label>
                                    <div class="col-sm-10">
                                        <button type="button" class="btn btn-outline-secondary" id="select-coupon-btn"
                                                data-bs-toggle="modal" data-bs-target="#couponSelectModal">
                                            사용 가능한 쿠폰 선택하기
                                        </button>
                                        <div id="selected-coupon-info" class="mt-2 text-success fw-semibold"
                                             style="display: none;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-5">
                        <div class="order-summary" data-aos="fade-left" data-aos-delay="200">
                            <div class="order-summary-header">
                                <h3>주문 요약</h3>
                                <span class="item-count" th:text="${totalQuantity} + '개 상품'">0개 상품</span>
                            </div>

                            <div class="order-summary-content">
                                <div class="order-totals">
                                    <div class="order-subtotal d-flex justify-content-between">
                                        <span>상품 금액</span>
                                        <span id="total-book-price"
                                              th:text="${#numbers.formatInteger(totalBookPrice, 0, 'COMMA') + '원'}">0원</span>
                                    </div>

                                    <div class="order-shipping d-flex justify-content-between">
                                        <span>배송비</span>
                                        <span id="delivery-fee"
                                              th:text="${deliveryFee != null ? #numbers.formatInteger(deliveryFee, 0, 'COMMA') : '0'} + '원'">0원</span>
                                    </div>

                                    <div class="order-points-discount d-flex justify-content-between text-danger"
                                         style="display: none;">
                                        <span>포인트 할인</span>
                                        <span id="points-discount-amount">-0원</span>
                                    </div>

                                    <div class="order-coupon-discount d-flex justify-content-between text-danger"
                                         style="display: none;">
                                        <span>쿠폰 할인</span>
                                        <span id="coupon-discount-amount">-0원</span>
                                    </div>
                                    <hr class="my-2">

                                    <div class="order-total d-flex justify-content-between fw-bold">
                                        <span>최종 결제 금액</span>
                                        <span id="actual-order-price"
                                              th:text="${actualOrderPrice != null ? #numbers.formatInteger(actualOrderPrice, 0, 'COMMA') : '0'} + '원'">
                      0원
                    </span>
                                    </div>
                                </div>

                                <div class="d-grid mt-4">
                                    <button type="button" id="payment-button" class="btn btn-primary btn-lg"
                                            th:text="${#numbers.formatInteger(actualOrderPrice, 0, 'COMMA') + '원 결제하기'}">
                                        0원 결제하기
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checkout-section" id="payment-method">
                        <div class="section-header">
                            <div class="section-number">5</div>
                            <h3>결제 방법</h3>
                        </div>
                        <div class="section-content">

                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="pointPay"
                                       value="POINT_PAYMENT">
                                <label class="form-check-label" for="pointPay">
                                    <strong>포인트 결제</strong>
                                </label>
                            </div>

                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="tossPay"
                                       value="TOSS_EASY_PAY">
                                <label class="form-check-label" for="tossPay">
                                    <strong>토스 간편 결제</strong>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
            <!-- Terms and Privacy Modals -->
            <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="termsModalLabel">Terms and Conditions</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam in dui mauris. Vivamus
                                hendrerit arcu sed erat molestie vehicula. Sed auctor neque eu tellus rhoncus ut
                                eleifend nibh porttitor. Ut in nulla enim. Phasellus molestie magna non est bibendum non
                                venenatis nisl tempor.</p>
                            <p>Suspendisse in orci enim. Vivamus hendrerit arcu sed erat molestie vehicula. Sed auctor
                                neque eu tellus rhoncus ut eleifend nibh porttitor. Ut in nulla enim. Phasellus molestie
                                magna non est bibendum non venenatis nisl tempor.</p>
                            <p>Suspendisse in orci enim. Vivamus hendrerit arcu sed erat molestie vehicula. Sed auctor
                                neque eu tellus rhoncus ut eleifend nibh porttitor. Ut in nulla enim. Phasellus molestie
                                magna non est bibendum non venenatis nisl tempor.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">I Understand</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="privacyModal" tabindex="-1" aria-labelledby="privacyModalLabel"
                 aria-hidden="true">
                <div class="modal-dialog modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="privacyModalLabel">Privacy Policy</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam in dui mauris. Vivamus
                                hendrerit arcu sed erat molestie vehicula. Sed auctor neque eu tellus rhoncus ut
                                eleifend nibh porttitor. Ut in nulla enim.</p>
                            <p>Suspendisse in orci enim. Vivamus hendrerit arcu sed erat molestie vehicula. Sed auctor
                                neque eu tellus rhoncus ut eleifend nibh porttitor. Ut in nulla enim. Phasellus molestie
                                magna non est bibendum non venenatis nisl tempor.</p>
                            <p>Suspendisse in orci enim. Vivamus hendrerit arcu sed erat molestie vehicula. Sed auctor
                                neque eu tellus rhoncus ut eleifend nibh porttitor. Ut in nulla enim. Phasellus molestie
                                magna non est bibendum non venenatis nisl tempor.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">I Understand</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section><!-- /Checkout Section -->
</main>

<div th:replace="~{fragments/common_footer :: commonFooter}"></div>
<!-- Scroll Top -->
<a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i
        class="bi bi-arrow-up-short"></i></a>
<!-- Preloader -->
<div id="preloader"></div>

<!-- Vendor & Main JS Files -->
<th:block th:replace="~{fragments/common_scripts :: commonScripts}"></th:block>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        initPhoneHyphen();
        const TOSS_CLIENT_KEY = /*[[${tossClientIKey}]]*/ 'test_ck_nRQoOaPz8L4QRwM6lGa58y47BMw6';
        initTossPayments(TOSS_CLIENT_KEY);
        initPointInputListener();
        initApplyAllPointsButton();
        initPackagingModal();
        initAddressSelectModal();
        const findZipBtn = document.getElementById('find-zip-btn');
        if (findZipBtn) {
            findZipBtn.addEventListener('click', sample6_execDaumPostcode);
        }
    });

    function initPhoneHyphen() {
        const phoneInput = document.getElementById('phone');
        if (!phoneInput) return;

        const formatPhoneNumber = (value) => {
            if (!value) return value;
            let phoneNumber = value.replace(/[^\d]/g, '');
            if (phoneNumber.length > 11) phoneNumber = phoneNumber.slice(0, 11);
            const len = phoneNumber.length;
            if (len < 4) return phoneNumber;
            if (len < 8) return `${phoneNumber.slice(0, 3)}-${phoneNumber.slice(3)}`;
            return `${phoneNumber.slice(0, 3)}-${phoneNumber.slice(3, 7)}-${phoneNumber.slice(7)}`;
        };

        phoneInput.addEventListener('input', (e) => {
            const target = e.target;
            const originalValue = target.value;
            const formattedValue = formatPhoneNumber(originalValue);
            // 커서 계산은 간단하게 처리 (정교화 가능)
            target.value = formattedValue;
        });
    }

    // 결제 금액 가져오기
    // 금액 파싱 함수 (이 함수 스코프 안에도 정의)
    const parsePrice = (priceValue) => {
        if (priceValue == null) return 0;
        const priceString = String(priceValue);
        return Number(priceString.replace(/[^\d]/g, '')) || 0;
    };

    function initTossPayments(clientKey) {
        const paymentButton = document.getElementById('payment-button');
        const actualOrderPriceEl = document.getElementById('actual-order-price'); // 요소 미리 찾아두기

        if (!paymentButton || !actualOrderPriceEl) {
            console.error("결제 버튼 또는 최종 금액 요소를 찾을 수 없습니다!");
            return;
        }
        var tossPayments = TossPayments(clientKey);

        paymentButton.addEventListener('click', async function () {

            const bookInfoRequestList = []; // 백엔드로 보낼 최종 리스트
            const orderItemElements = document.querySelectorAll('.order-item');

            orderItemElements.forEach(item => {
                const dataset = item.dataset;

                const publisher = {
                    publisherId: parseInt(dataset.publisherId, 10),
                    publisherName: dataset.publisherName
                };

                const contributors = [];
                const contributorElements = item.querySelectorAll('.contributor-data .contributor');

                contributorElements.forEach(c_item => {
                    contributors.push({
                        contributorId: parseInt(c_item.dataset.contributorId, 10),
                        contributorName: c_item.dataset.contributorName,
                        contributorRole: c_item.dataset.contributorRole
                    });
                });

                bookInfoRequestList.push({
                    bookId: parseInt(dataset.bookId, 10),
                    bookName: dataset.bookName,
                    imageUrl: dataset.imageUrl,
                    isPack: (dataset.isPack === 'true'),
                    regularPrice: parseFloat(dataset.regularPrice),
                    salePrice: parseFloat(dataset.salePrice),
                    publisher: publisher,
                    quantity: parseInt(dataset.quantity, 10),
                    contributors: contributors,
                    packagingId: parseInt(dataset.packagingId || '0', 10)
                });
            });

            console.log("bookInfoRequestList:", bookInfoRequestList);

            if (bookInfoRequestList.length === 0) {
                alert("주문할 상품이 없습니다.");
                return;
            }

            const customerName = document.getElementById('name')?.value.trim();
            const rawPhone = document.getElementById('phone')?.value;
            const phoneNumber = rawPhone ? rawPhone.replace(/[^\d]/g, '') : '';
            const zip = document.getElementById('zip')?.value;
            const address = document.getElementById('address')?.value;
            const addressDetail = document.getElementById('address-detail')?.value;
            const addressExtra = document.getElementById('address-extra')?.value;
            const totalBookPrice = parsePrice(document.getElementById('total-book-price')?.textContent);

            const currentFinalPrice = parsePrice(actualOrderPriceEl.textContent); // 미리 찾아둔 요소 사용

            const pointsInput = document.getElementById('points-to-use');
            const usedPointsValue = parseInt(pointsInput.value, 10) || 0;

            const orderItems = document.querySelectorAll('.order-summary-content .order-item');
            let orderName = "주문 상품"; // 기본값
            if (!customerName || customerName.length === 0) {
                alert("주문자 이름을 입력해 주세요.");
                document.getElementById('name').focus();
                return;
            }
            if (!phoneNumber || phoneNumber.length < 10) { // 최소 10자리 (하이픈 제외)
                alert("유효한 연락처를 입력해 주세요.");
                document.getElementById('phone').focus();
                return;
            }
            if (!zip || zip.length === 0) {
                alert("우편번호 찾기를 통해 배송지 주소를 입력해 주세요.");
                document.getElementById('find-zip-btn').focus();
                return;
            }
            if (!address || address.length === 0 || !addressDetail || addressDetail.length === 0) {
                alert("상세 주소를 포함하여 정확한 배송지 정보를 입력해 주세요.");
                document.getElementById('address-detail').focus();
                return;
            }

            if (orderItems.length > 0) {
                const firstItemName = orderItems[0].querySelector('.order-item-details h4')?.textContent.trim();
                if (firstItemName) {
                    if (orderItems.length > 1) {
                        orderName = `${firstItemName} 외 ${orderItems.length - 1}건`;
                    } else {
                        orderName = firstItemName;
                    }
                }
            }

            const selectedDeliveryArrivedDate = document.querySelector('input[name="deliveryDate"]:checked');
            const deliveryDateValue = selectedDeliveryArrivedDate ? selectedDeliveryArrivedDate.value : null;

            const orderPrepareRequest = {
                totalBookPrice: totalBookPrice,
                actualOrderPrice: currentFinalPrice,
                receiver: customerName,
                postCode: `${zip}`,
                receiverAddress: `${address}`,
                receiverAddressDetail: addressDetail,
                receiverAddressExtra: addressExtra,
                receiverPhone: phoneNumber,
                deliveryArrivedDate: deliveryDateValue,
                bookInfoRequestList: bookInfoRequestList,
                usedPoints: usedPointsValue
            };

            const tossPayRadio = document.getElementById('tossPay');
            const pointPayRadio = document.getElementById('pointPay');

            if (currentFinalPrice === 0) {
                // Case 1: 0원인데 토스가 선택된 경우 (Alert 후 중단)
                if (tossPayRadio && tossPayRadio.checked) {
                    alert("최종 결제 금액이 0원이므로 토스 간편 결제(유료)를 사용할 수 없습니다. 토스 결제 선택을 해제 후 주문을 진행해 주세요.");
                    return;
                }
            } else {
                if (pointPayRadio && pointPayRadio.checked) {
                    // Case 2: 유료 결제인데 '전액 포인트 결제'가 선택된 경우 (경고 후 중단)
                    alert("총 결제 금액이 0원 이상이므로 '전액 포인트 결제'를 사용할 수 없습니다. 토스 간편 결제를 선택해 주세요.");
                    return; // 함수 실행 중단
                }

                if (!tossPayRadio || !tossPayRadio.checked) {
                    // Case 3: 유료 결제인데 TOSS도 선택되지 않은 경우
                    alert("결제 방법을 선택해주세요.");
                    return; // 함수 실행 중단
                }
            }

            console.log("전송할 객체:", orderPrepareRequest);
            console.log("실제 JSON:", JSON.stringify(orderPrepareRequest));

            try {
                const response = await fetch('/orders/prepare', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(orderPrepareRequest)
                });

                console.log("주문 준비 응답: {}", response)
                console.log("주문 준비 응답 바디: {}", response.body);
                console.log("주문 준비 응답 코드: {}", response.status);

                if (!response.ok) {
                    const err = await response.json().catch(() => ({message: '주문 준비 API 응답 실패.'}));
                    throw new Error(err.message || '주문 준비에 실패했습니다.');
                }
                const prepareResponse = await response.json();
                const orderIdFromServer = prepareResponse.orderNumber;
                if (!orderIdFromServer) {
                    throw new Error('주문 ID를 서버로부터 받지 못했습니다.');
                }

                if (currentFinalPrice === 0) {
                    // 회원 주문일 경우에만 0원 처리 (비회원은 위에서 이미 차단됨)
                    console.log("0원 주문: 성공 처리.");
                    window.location.href = window.location.origin + `/orders/success?orderNumber=${orderIdFromServer}`;
                } else {
                    // 유료 주문: 토스페이먼츠 호출
                    console.log("유료 주문: 토스페이먼츠 호출");
                    tossPayments.requestPayment('토스페이', {
                        orderId: orderIdFromServer,
                        amount: currentFinalPrice,
                        orderName: orderName,
                        customerName: prepareResponse.receiver,
                        successUrl: window.location.origin + "/payments/confirm",
                        failUrl: window.location.origin + "/payments/fail"
                    });
                }
            } catch (error) {
                console.error('주문 처리 중 오류: ', error);
                alert(error.message || '알 수 없는 오류가 발생하였습니다.');
            }
        });
    }

    /**
     * 포인트 입력 필드에 이벤트 리스너를 추가하는 함수
     */
    function initPointInputListener() {
        const pointsInput = document.getElementById('points-to-use');
        if (pointsInput) {
            console.log("포인트 입력 리스너 추가됨"); // <--- 로그 추가
            pointsInput.addEventListener('input', (event) => { // event 파라미터 추가
                console.log("포인트 입력 감지:", event.target.value); // <--- 로그 추가
                updatePriceSummary();
            });
        } else {
            console.error("ID 'points-to-use' 요소를 찾을 수 없음!"); // <--- 요소 못 찾을 때 로그 추가
        }
    }

    // --- [추가] '모두 사용' 버튼 클릭 이벤트 리스너 ---
    function initApplyAllPointsButton() {
        const applyAllBtn = document.getElementById('apply-all-points-btn');
        const pointsInput = document.getElementById('points-to-use');
        const totalBookPriceEl = document.getElementById('total-book-price');
        const deliveryFeeEl = document.getElementById('delivery-fee'); // ⭐ 새로 추가: 배송비 요소

        const parsePrice = (element) => {
            if (!element || !element.textContent) return 0;
            return parseInt(element.textContent.replace(/[^\d]/g, ''), 10) || 0;
        };

        if (applyAllBtn && pointsInput && totalBookPriceEl && deliveryFeeEl) { // ⭐ deliveryFeeEl 체크 추가
            console.log("'모두 사용' 버튼 리스너 추가됨");
            applyAllBtn.addEventListener('click', () => {
                const maxPointsInput = parseInt(pointsInput.getAttribute('max') || '0', 10);
                const currentPointsStr = document.getElementById('current-points')?.textContent.replace(/[^\d]/g, '');
                const availablePoints = parseInt(currentPointsStr, 10) || 0;
                const maxPointsFromBalance = Math.min(maxPointsInput, availablePoints);

                const subtotal = parsePrice(totalBookPriceEl);
                const deliveryFee = parsePrice(deliveryFeeEl);

                const totalCost = subtotal + deliveryFee;

                const maxPointsToUse = Math.min(maxPointsFromBalance, totalCost);

                pointsInput.value = maxPointsToUse;
                updatePriceSummary();
            });
        } else {
            console.error("ID 'apply-all-points-btn' 또는 필수 요소를 찾을 수 없음!");
        }
    }

    /**
     * 최종 결제 금액 및 할인 내역을 업데이트하는 함수
     */
    function updatePriceSummary() {
        // 1. 필요한 DOM 요소 가져오기
        const pointsInput = document.getElementById('points-to-use');
        const pointsDiscountAmountEl = document.getElementById('points-discount-amount');
        const pointsDiscountRowEl = document.querySelector('.order-points-discount'); // 할인 행 전체 div
        // const couponDiscountAmountEl = document.getElementById('coupon-discount-amount'); // (쿠폰 구현 시)
        // const couponDiscountRowEl = document.querySelector('.order-coupon-discount'); // (쿠폰 구현 시)
        const totalBookPriceEl = document.getElementById('total-book-price');
        const deliveryFeeEl = document.getElementById('delivery-fee');
        const actualOrderPriceEl = document.getElementById('actual-order-price');
        const paymentButton = document.getElementById('payment-button');

        let packagingTotalRow = document.getElementById('order-packaging-total');
        // 포장비 행이 없으면 동적으로 생성
        if (!packagingTotalRow) {
            packagingTotalRow = document.createElement('div');
            packagingTotalRow.id = 'order-packaging-total';
            packagingTotalRow.className = 'order-shipping d-flex justify-content-between'; // 배송비와 같은 스타일 적용
            // 배송비(deliveryFeeEl)의 부모(order-totals)를 찾아 그 다음에 삽입
            deliveryFeeEl.parentNode.insertAdjacentElement('afterend', packagingTotalRow);
        }

        // 금액 파싱 함수 (쉼표, '원' 제거)
        const parsePrice = (element) => {
            if (!element || !element.textContent) return 0;
            return parseInt(element.textContent.replace(/[^\d]/g, ''), 10) || 0;
        };

        // 2. 현재 값 읽기
        let usedPoints = parseInt(pointsInput.value, 10) || 0;
        const maxPoints = parseInt(pointsInput.getAttribute('max') || '0', 10); // input의 max 속성값
        const currentPointsStr = document.getElementById('current-points')?.textContent.replace(/[^\d]/g, '');
        const availablePoints = parseInt(currentPointsStr, 10) || 0; // 실제 보유 포인트


        // ▼▼▼ [수정] 상품 금액(subtotal)과 포장비(packagingTotal) 계산 ▼▼▼
        let subtotal = 0;
        let packagingTotal = 0;
        document.querySelectorAll('.order-item').forEach(item => {
            const salePrice = parseFloat(item.dataset.salePrice) || 0;
            const quantity = parseInt(item.dataset.quantity, 10) || 0;
            subtotal += salePrice * quantity;

            // 각 아이템에 저장된 포장지 가격 * 수량
            const packagingPrice = parseFloat(item.dataset.packagingPrice) || 0;
            packagingTotal += packagingPrice * quantity;
        });

        // 화면에 상품 금액 업데이트
        totalBookPriceEl.textContent = `${subtotal.toLocaleString('ko-KR')}원`;

        // 화면에 포장비 업데이트
        packagingTotalRow.innerHTML = `<span>포장비</span><span>+${packagingTotal.toLocaleString('ko-KR')}원</span>`;
        if (packagingTotal === 0) {
            packagingTotalRow.style.display = 'none'; // 포장비가 0원이면 숨김
        } else {
            packagingTotalRow.style.display = 'flex'; // 0원 아니면 표시
        }

        const goodsCost = subtotal + packagingTotal;
        const deliveryFee = parsePrice(deliveryFeeEl);

        const totalBeforeDiscount = goodsCost + deliveryFee;

        const maxPointsAllowed = Math.min(maxPoints, availablePoints);
        const effectiveMaxPoints = Math.min(maxPointsAllowed, totalBeforeDiscount);
        console.log("계산된 최대 사용 가능 포인트:", effectiveMaxPoints); // <--- 로그 추가!

        // 3. 포인트 유효성 검사 및 조정
        if (usedPoints < 0) {
            usedPoints = 0;
            pointsInput.value = 0; // 음수 입력 시 0으로 변경
        }
        if (usedPoints > effectiveMaxPoints) {
            usedPoints = effectiveMaxPoints;
            pointsInput.value = usedPoints;
        }
        // 4. 할인 금액 계산 (1포인트 = 1원으로 가정)
        const pointDiscount = usedPoints;
        // const couponDiscount = parsePrice(couponDiscountAmountEl); // (쿠폰 구현 시)
        const couponDiscount = 0; // 임시

        // 5. 할인 금액 표시 업데이트
        if (pointDiscount > 0) {
            pointsDiscountAmountEl.textContent = `-${pointDiscount.toLocaleString('ko-KR')}원`;
            pointsDiscountRowEl.style.display = 'flex'; // 할인 행 보이기
        } else {
            pointsDiscountAmountEl.textContent = '-0원';
            pointsDiscountRowEl.style.display = 'none'; // 할인 행 숨기기
        }

        // (쿠폰 할인 표시 업데이트 로직 추가)

        // 6. 최종 결제 금액 계산
        // (상품금액 + 포장비 + 배송비) - 할인
        const finalPrice = Math.max(0, totalBeforeDiscount - pointDiscount - couponDiscount);

        // 7. 최종 결제 금액 및 버튼 텍스트 업데이트
        actualOrderPriceEl.textContent = `${finalPrice.toLocaleString('ko-KR')}원`;
        paymentButton.textContent = `${finalPrice.toLocaleString('ko-KR')}원 결제하기`;
    }

    function sample6_execDaumPostcode() {
        new daum.Postcode({
            oncomplete: function (data) {
                //  팝업에서 검색 결과 항목을 클릭했을 때 실행할 코드를 작성하는 부분
                var addr = '';
                var extraAddr = '';

                // 사용자가 선택한 주소 타입에 따라 해당 주소 값을 가져옴
                if (data.userSelectedType !== 'R') { // 사용자가 도로명을 선택하지 않았을 경우
                    alert('지번 주소가 선택되었습니다. 도로명 주소로 반영됩니다.');
                }

                addr = data.roadAddress;

                // 사용자가 선택한 주소가 도로명 타입일때 참고항목을 조합한다.
                if (data.userSelectedType === 'R') {
                    // 법정동명이 있을 경우 추가한다. (법정리는 제외)
                    // 법정동의 경우 마지막 문자가 "동/로/가"로 끝난다.
                    if (data.bname !== '' && /[동|로|가]$/g.test(data.bname)) {
                        extraAddr += data.bname;
                    }
                    // 건물명이 있고, 공동주택일 경우 추가한다.
                    if (data.buildingName !== '' && data.apartment === 'Y') {
                        extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                    }
                    // 표시할 참고항목이 있을 경우, 괄호까지 추가한 최종 문자열을 만든다.
                    if (extraAddr !== '') {
                        extraAddr = ' (' + extraAddr + ')';
                    }
                    // 조합된 참고항목을 해당 필드에 넣는다.
                    document.getElementById("address-extra").value = extraAddr;

                } else {
                    document.getElementById("address-extra").value = '';
                }

                document.getElementById('zip').value = data.zonecode;
                document.getElementById("address").value = addr;
                document.getElementById("address-detail").focus();
            }
        }).open();
    }

    document.addEventListener('DOMContentLoaded', () => {
        // 1. "포장지 선택" 모달 요소를 가져옵니다.
        const packagingModal = document.getElementById('packagingSelectModal');
        if (packagingModal) {
            // 2. 모달이 열리기 '직전'에 실행되는 이벤트를 감지합니다.
            packagingModal.addEventListener('show.bs.modal', function (event) {
                // 3. 어떤 버튼이 모달을 열었는지 가져옵니다.
                const button = event.relatedTarget;
                // 4. 버튼에 심어둔 'data-order-item-id' 속성 값을 읽어옵니다.
                const orderItemId = button.dataset.orderItemId;
                // 5. 모달 안의 숨겨진(hidden) input을 찾습니다.
                const hiddenInput = document.getElementById('modal_order_item_id');
                // 6. 숨겨진 input의 값(value)에 상품 ID를 설정합니다.
                hiddenInput.value = orderItemId;
                // 7. (선택) 모달이 열릴 때마다 "포장 안 함"을 기본으로 체크
                const defaultRadio = packagingModal.querySelector('input[name="packagingId"][value="0"]');
                if (defaultRadio) {
                    defaultRadio.checked = true;
                }
            });
        }
    });

    function initPackagingModal() {
        const packagingModal = document.getElementById('packagingSelectModal');
        const savePackagingButton = document.getElementById('savePackagingButton');
        if (!packagingModal || !savePackagingButton) return;

        // ... (모달 열릴 때 로직은 그대로) ...

        // '적용' 버튼 클릭 시
        savePackagingButton.addEventListener('click', () => {
            const bookId = document.getElementById('modal_order_item_id').value;
            const selectedRadio = packagingModal.querySelector('input[name="packagingId"]:checked');
            if (!selectedRadio) return;

            const packagingId = selectedRadio.value;
            const label = selectedRadio.closest('label');

            const priceText = label.querySelector('.text-muted').textContent;
            const packagingPrice = parseInt(priceText.replace(/[^\d]/g, ''), 10) || 0;

            const nameElement = label.querySelector('strong, span:not(.text-muted)');
            const packagingName = nameElement ? nameElement.textContent : '포장 선택됨';

            const orderItemDiv = document.querySelector(`.order-item[data-book-id="${bookId}"]`);
            const triggerButton = document.querySelector(`button[data-order-item-id="${bookId}"]`);

            if (orderItemDiv && triggerButton) {
                orderItemDiv.dataset.packagingId = packagingId;
                orderItemDiv.dataset.packagingPrice = packagingPrice;

                // 모든 색상 클래스를 제거하여 초기화합니다.
                triggerButton.classList.remove('btn-success', 'btn-dark', 'btn-outline-secondary', 'text-white');

                if (packagingId === '0') {
                    // '포장 안 함' 선택 시 (기본값)
                    triggerButton.innerHTML = '<i class="bi bi-box-seam me-1"></i> 포장 선택';
                    triggerButton.classList.add('btn-outline-secondary'); // 기본 회색 테두리 버튼
                } else {
                    // 포장 선택 시
                    triggerButton.innerHTML = `<i class="bi bi-check-lg me-1"></i> ${packagingName}`;
                    triggerButton.classList.add('btn', 'btn-dark', 'text-white'); // 검은색 배경, 흰색 텍스트
                }
            }

            updatePriceSummary();

            const modalInstance = bootstrap.Modal.getInstance(packagingModal);
            modalInstance.hide();

            if (triggerButton) {
                triggerButton.focus();
            }
        });
    }

    /**
     * 주소 선택 모달 초기화 및 로드 로직
     */
    function initAddressSelectModal() {
        const addressSelectModal = document.getElementById('addressSelectModal');
        if (addressSelectModal) {
            addressSelectModal.addEventListener('show.bs.modal', async (event) => {
                const modalBody = document.getElementById('address-list-body');

                // 1. 모달 내용을 로딩 스피너로 초기화 (임시 스피너)
                modalBody.innerHTML = `<div class="text-center p-5"><div class="spinner-border text-dark" role="status"></div></div>`;

                try {
                    // 2. ✨ API 호출: 현재 로그인한 회원의 주소 목록을 요청
                    const response = await fetch('/addresses/me');

                    if (!response.ok) {
                        throw new Error('주소 목록을 불러오는 데 실패했습니다.');
                    }

                    // 3. 주소 목록 데이터 (JSON 배열) 획득
                    const addresses = await response.json();

                    // 4. 주소 목록 HTML 렌더링
                    modalBody.innerHTML = renderAddressList(addresses);

                } catch (error) {
                    modalBody.innerHTML = `<div class="alert alert-danger">주소 로딩 실패: ${error.message || '오류 발생'}</div>`;
                }
            });

            // 5. 주소 목록에서 항목 선택 시 폼에 데이터 주입
            addressSelectModal.addEventListener('click', function (event) {
                const target = event.target.closest('.address-select-item');
                if (target) {
                    const dataset = target.dataset;

                    // 폼 요소에 데이터 주입
                    document.getElementById('zip').value = dataset.postCode;         // DTO: postCode -> dataset.postCode
                    document.getElementById('address').value = dataset.addressInfo;    // DTO: addressInfo -> dataset.addressInfo
                    document.getElementById('address-detail').value = dataset.addressDetail || ''; // DTO: addressDetail -> dataset.addressDetail
                    document.getElementById('address-extra').value = dataset.addressExtra || '';   // DTO: addressExtra -> dataset.addressExtra
                    // 모달 닫기
                    const modalInstance = bootstrap.Modal.getInstance(addressSelectModal);
                    modalInstance.hide();

                    document.getElementById('address-detail').focus();
                }
            });
        }
    }


    /**
     * 주소 목록 데이터를 받아 HTML로 렌더링하는 헬퍼 함수
     */
    function renderAddressList(addresses) {
        if (addresses.length === 0) {
            return '<div class="alert alert-info">등록된 배송지가 없습니다. 새로운 주소를 입력해주세요.</div>';
        }

        let html = '';

        addresses.forEach((addr, index) => {

            // ⭐ DTO: isDefault (Boolean) 필드를 사용하여 '기본' 여부를 판단합니다.
            const isDefault = addr.isDefault ? ' (기본)' : '';
            const defaultClass = addr.isDefault ? ' border-primary border-2' : '';

            html += `
        <div class="list-group-item list-group-item-action d-flex flex-column address-select-item ${defaultClass}"
             role="button"

             data-post-code="${addr.postCode || ''}"
             data-address-info="${addr.addressInfo || ''}"
             data-address-detail="${addr.addressDetail || ''}"
             data-address-extra="${addr.addressExtra || ''}"

        >
            <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1 fw-bold">
                    [${addr.addressAlias || '주소'}] ${isDefault}
                </h6>
                <small class="text-muted">${addr.postCode || 'N/A'}</small>
            </div>

            <p class="mb-1">${addr.addressInfo || ''} ${addr.addressDetail || ''}</p>

        </div>
        `;
        });

        return `<div class="list-group">${html}</div>`;
    }


</script>
<div class="modal fade" id="packagingSelectModal" tabindex="-1" aria-labelledby="packagingModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="packagingModalLabel">포장지 선택</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <p>이 상품에 적용할 포장지를 선택하세요.</p>

                <form id="packagingSelectForm">

                    <input type="hidden" id="modal_order_item_id" name="orderItemId">

                    <div class="list-group">
                        <label class="list-group-item list-group-item-action d-flex align-items-center">
                            <input class="form-check-input me-3" type="radio" name="packagingId" value="0" checked>
                            <i class="bi bi-x-circle me-2 text-danger"></i>
                            <strong>포장 안 함</strong>
                            <span class="text-muted ms-auto">(0원)</span>
                        </label>

                        <th:block th:each="pack : ${packagingOptions}">
                            <label class="list-group-item list-group-item-action d-flex align-items-center">
                                <input class="form-check-input me-3" type="radio" name="packagingId"
                                       th:value="${pack.packagingId}">

                                <img th:src="${pack.packagingImageUrl}" class="img-thumbnail me-2"
                                     style="width: 50px; height: 50px; object-fit: cover;"
                                     th:if="${pack.packagingImageUrl != null and pack.packagingImageUrl != ''}">

                                <span th:text="${pack.packagingName}">포장지 이름</span>

                                <span class="text-muted ms-auto"
                                      th:text="'(+' + ${#numbers.formatInteger(pack.packagingPrice, 0, 'COMMA')} + '원)'">
                  (+1,000원)
                </span>
                            </label>
                        </th:block>

                        <tr th:if="${packagingOptions == null or #lists.isEmpty(packagingOptions)}">
                            <td colspan="4" class="text-center py-4">
                                등록된 포장지 정책이 없습니다.
                            </td>
                        </tr>
                    </div>
                </form>

            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" id="savePackagingButton">적용</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="addressSelectModal" tabindex="-1" aria-labelledby="addressSelectModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addressSelectModalLabel">내 주소 목록</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="address-list-body">
                <div class="text-center p-5">
                    <div class="spinner-border text-dark" role="status">
                        <span class="visually-hidden">주소 로딩 중...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>
</body>
</html>