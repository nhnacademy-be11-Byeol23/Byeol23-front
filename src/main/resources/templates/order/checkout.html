<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Checkout - NiceShop Bootstrap Template</title>
    <meta name="description" content="">
    <meta name="keywords" content="">

    <th:block th:replace="~{fragments/file_link :: linkInfo}"></th:block>
    <script src="//js.tosspayments.com/v1"></script>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>

<body class="checkout-page">

<div th:replace="~{fragments/common_header :: commonHeader}"></div>
<main class="main">

    <!-- Page Title -->
    <div class="page-title light-background">
        <div class="container d-lg-flex justify-content-between align-items-center">
            <h1 class="mb-2 mb-lg-0">Ï£ºÎ¨∏</h1>
            <nav class="breadcrumbs">
                <ol>
                    <li><a th:hred="@{/}">Home</a></li>
                    <li class="current">Ï£ºÎ¨∏</li>
                </ol>
            </nav>
        </div>
    </div><!-- End Page Title -->

    <!-- Checkout Section -->
    <section id="checkout" class="checkout section">

        <div class="container" data-aos="fade-up" data-aos-delay="100">

            <form id="checkout-form">
                <div class="row">
                    <div class="col-lg-7">
                        <div class="checkout-container" data-aos="fade-up">
                            <div class="checkout-section" id="order-items-list">
                                <div class="section-header">
                                    <div class="section-number">1</div>
                                    <h3>Ï£ºÎ¨∏ ÏÉÅÌíà</h3>
                                </div>
                                <div class="section-content">
                                    <div class="order-items-container">

                                        <div class="order-item"
                                             th:each="item : ${bookOrderRequest.bookList()}"
                                             th:data-book-id="${item.bookId}"
                                             th:data-quantity="${item.quantity}"
                                             th:data-sale-price="${item.salePrice}"
                                             th:data-regular-price="${item.regularPrice}"
                                             th:data-book-name="${item.bookName}"
                                             th:data-image-url="${item.imageUrl}"
                                             th:data-publisher-id="${item.publisher().publisherId()}"
                                             th:data-publisher-name="${item.publisher().publisherName()}"
                                        >

                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="order-item-image me-3">
                                                    <img th:src="${item.imageUrl}" alt="Product" class="img-fluid"
                                                         style="width: 80px; height: auto;">
                                                </div>

                                                <div class="order-item-details flex-grow-1 me-3">
                                                    <h5 class="mb-1" th:text="${item.bookName}">ÎèÑÏÑú Ï†úÎ™©</h5>

                                                    <p class="text-muted small mb-0">
                                                        <span th:text="${item.publisher().publisherName()}">Ï∂úÌåêÏÇ¨</span>
                                                        <span class="mx-1">|</span>
                                                        <th:block th:each="contributor, iter : ${item.contributors()}">
                                                            <span th:text="${contributor.contributorName()}">Ï†ÄÏûêÎ™Ö</span>
                                                            <span th:text="${contributor.contributorRole()} ? ' (' + ${contributor.contributorRole()} + ')' : ''">(Ï†Ä)</span>
                                                            <span th:if="!${iter.last}">, </span>
                                                        </th:block>
                                                    </p>

                                                </div>

                                                <div class="order-item-price mb-2">
                                                    <div class="mb-1">
                                                        <span class="quantity"
                                                              th:text="${item.quantity} + ' √ó'">1 √ó</span>
                                                    </div>
                                                    <span class="price-sale fw-bold fs-5"
                                                          th:text="${#numbers.formatInteger(item.salePrice, 0, 'COMMA') + 'Ïõê'}">
                                                      10,000Ïõê
                                                    </span>
                                                    <span class="price-regular text-muted text-decoration-line-through ms-1"
                                                          style="font-size: 0.9em;"
                                                          th:if="${item.regularPrice > item.salePrice}"
                                                          th:text="${#numbers.formatInteger(item.regularPrice, 0, 'COMMA') + 'Ïõê'}">
                                                      16,000Ïõê
                                                    </span>
                                                </div>

                                                <div th:if="${item.isPack}">
                                                    <button type="button" class="btn btn-outline-secondary btn-sm"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#packagingSelectModal"
                                                            th:data-order-item-id="${item.bookId}"><i
                                                            class="bi bi-box-seam me-1"></i> Ìè¨Ïû• ÏÑ†ÌÉù
                                                    </button>
                                                </div>

                                                <div class="contributor-data" style="display: none;">
                                                    <div class="contributor"
                                                         th:each="c : ${item.contributors()}"
                                                         th:data-contributor-id="${c.contributorId()}"
                                                         th:data-contributor-name="${c.contributorName()}"
                                                         th:data-contributor-role="${c.contributorRole()}">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="checkout-section" id="customer-info">
                                <div class="section-header">
                                    <div class="section-number">2</div>
                                    <h3>Ï£ºÎ¨∏Ïûê Ï†ïÎ≥¥</h3>
                                </div>
                                <div class="section-content">
                                    <div class="row">
                                        <div class="col-md-12 form-group">
                                            <label for="name">Ïù¥Î¶Ñ</label>
                                            <input type="text" name="name" class="form-control" id="name"
                                                   placeholder="Ï£ºÎ¨∏Ïûê Ïù¥Î¶Ñ" required="">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="phone">Ïó∞ÎùΩÏ≤ò</label>
                                        <input type="tel" class="form-control" name="phone" id="phone"
                                               placeholder="010-1234-5678" required="">
                                    </div>
                                </div>
                            </div>

                            <div class="checkout-section" id="shipping-address">
                                <div class="section-header">
                                    <div class="section-number">3</div>
                                    <h3>Î∞∞ÏÜ°ÏßÄ Ï†ïÎ≥¥</h3>
                                </div>
                                <div class="section-content">
                                    <div class="form-group">
                                        <label for="zip">Ïö∞Ìé∏Î≤àÌò∏</label>
                                        <div class="input-group">
                                            <input type="text" name="zip" class="form-control" id="zip"
                                                   placeholder="Ïö∞Ìé∏Î≤àÌò∏" required="" readonly
                                                   th:value="${defaultAddress?.postCode}">
                                            <button class="btn btn-outline-secondary" type="button" id="find-zip-btn">
                                                Ïö∞Ìé∏Î≤àÌò∏ Ï∞æÍ∏∞
                                            </button>

                                            <button class="btn btn-outline-primary" type="button"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#addressSelectModal"
                                                    id="load-addresses-btn">
                                                Í∏∞Ï°¥ Î∞∞ÏÜ°ÏßÄ Î∂àÎü¨Ïò§Í∏∞
                                            </button>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="address">Ï£ºÏÜå</label>
                                        <input type="text" class="form-control" name="address" id="address"
                                               placeholder="Í∏∞Î≥∏ Ï£ºÏÜå" readonly
                                               th:value="${defaultAddress?.addressInfo}"></div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="address-detail">ÏÉÅÏÑ∏Ï£ºÏÜå</label>
                                                <input type="text" class="form-control" name="address-detail"
                                                       id="address-detail" placeholder="ÏÉÅÏÑ∏Ï£ºÏÜå (ÏïÑÌååÌä∏ Îèô, Ìò∏Ïàò Îì±)"
                                                       th:value="${defaultAddress?.addressDetail}"></div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="address-extra">Ï∞∏Í≥† Ìï≠Î™©</label>
                                                <input type="text" class="form-control" name="address-extra"
                                                       id="address-extra" placeholder="Ï∞∏Í≥†Ìï≠Î™©" readonly
                                                       th:value="${defaultAddress?.addressExtra}"></div>
                                        </div>
                                    </div>
                                    <div class="section-content">
                                        <div class="form-group mt-3">
                                            <label class="form-label">Î∞∞ÏÜ°Ïùº ÏÑ†ÌÉù <small class="text-muted">(ÎèÑÏ∞© ÏòàÏÉÅÏùº)</small></label>
                                            <div class="delivery-date-buttons d-flex flex-wrap gap-2">
                                                <th:block th:each="dateInfo, iterStat : ${deliveryDates}">
                                                    <input type="radio" class="btn-check" name="deliveryDate"
                                                           th:id="'date-' + ${dateInfo.valueDate}"
                                                           th:value="${dateInfo.valueDate}"
                                                           th:checked="${iterStat.first}"
                                                           autocomplete="off">
                                                    <label class="btn btn-outline-secondary"
                                                           th:for="'date-' + ${dateInfo.valueDate}"
                                                           th:text="${dateInfo.dayName} + ' (' + ${dateInfo.displayDate} + ')'">
                                                        ÎÇ†Ïßú Î≤ÑÌäº
                                                    </label>
                                                </th:block>
                                            </div>
                                            <small class="text-muted d-block mt-1">Ï£ºÎßê Î∞è Í≥µÌú¥Ïùº Ï†úÏô∏, 5 ÏòÅÏóÖÏùº Ïù¥ÎÇ¥ ÏÑ†ÌÉù
                                                Í∞ÄÎä•Ìï©ÎãàÎã§.</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div class="checkout-section" id="discount-section">
                            <div class="section-header">
                                <div class="section-number">4</div>
                                <h3>Ìï†Ïù∏ Ï†ÅÏö©</h3>
                            </div>
                            <div class="section-content">
                                <div class="mb-3 row align-items-center">
                                    <label class="col-sm-2 col-form-label"><i class="bi bi-coin me-1"></i>Î≥¥Ïú†</label>
                                    <div class="col-sm-10">
                                        <div class="fw-bold" id="current-points"
                                             th:text="${userPoint != null ? #numbers.formatInteger(userPoint, 0, 'COMMA') + ' P' : '0 P'}">
                                            5,000 P
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3 row align-items-center">
                                    <label for="points-to-use" class="col-sm-2 col-form-label">ÏÇ¨Ïö©</label>
                                    <div class="col-sm-10">
                                        <div class="input-group">
                                            <input type="number" class="form-control text-end" id="points-to-use"
                                                   name="usedPoints" placeholder="0" min="0"
                                                   th:max="${userPoint ?: 0}" step="1">
                                            <span class="input-group-text">P</span>
                                            <button class="btn btn-outline-secondary" type="button"
                                                    id="apply-all-points-btn">Î™®Îëê ÏÇ¨Ïö©
                                            </button>
                                        </div>
                                        <small class="text-muted d-block mt-1"
                                               th:text="'(ÏµúÎåÄ ' + (${userPoint != null ? #numbers.formatInteger(userPoint, 0, 'COMMA') : 0}) + ' P ÏÇ¨Ïö© Í∞ÄÎä•)'">(ÏµúÎåÄ
                                            5,000 P ÏÇ¨Ïö© Í∞ÄÎä•)</small></div>
                                </div>

                                <div class="row align-items-center">
                                    <label class="col-sm-2 col-form-label"><i
                                            class="bi bi-ticket-perc me-1"></i>Ïø†Ìè∞</label>
                                    <div class="col-sm-10">
                                        <button type="button" class="btn btn-outline-secondary" id="select-coupon-btn"
                                                data-bs-toggle="modal" data-bs-target="#couponSelectModal">
                                            ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ïø†Ìè∞ ÏÑ†ÌÉùÌïòÍ∏∞
                                        </button>
                                        <div id="selected-coupon-info" class="mt-2 text-success fw-semibold"
                                             style="display: none;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-5">
                        <div class="order-summary" data-aos="fade-left" data-aos-delay="200">
                            <div class="order-summary-header">
                                <h3>Ï£ºÎ¨∏ ÏöîÏïΩ</h3>
                                <span class="item-count" th:text="${totalQuantity} + 'Í∞ú ÏÉÅÌíà'">0Í∞ú ÏÉÅÌíà</span>
                            </div>

                            <div class="order-summary-content">
                                <div class="order-totals">
                                    <div class="order-subtotal d-flex justify-content-between">
                                        <span>ÏÉÅÌíà Í∏àÏï°</span>
                                        <span id="total-book-price"
                                              th:text="${#numbers.formatInteger(totalBookPrice, 0, 'COMMA') + 'Ïõê'}">0Ïõê</span>
                                    </div>

                                    <div class="order-shipping d-flex justify-content-between">
                                        <span>Î∞∞ÏÜ°ÎπÑ</span>
                                        <span id="delivery-fee"
                                              th:text="${deliveryFee != null ? #numbers.formatInteger(deliveryFee, 0, 'COMMA') : '0'} + 'Ïõê'">0Ïõê</span>
                                    </div>

                                    <div class="order-points-discount d-flex justify-content-between text-danger"
                                         style="display: none;">
                                        <span>Ìè¨Ïù∏Ìä∏ Ìï†Ïù∏</span>
                                        <span id="points-discount-amount">-0Ïõê</span>
                                    </div>

                                    <div class="order-coupon-discount d-flex justify-content-between text-danger"
                                         style="display: none;">
                                        <span>Ïø†Ìè∞ Ìï†Ïù∏</span>
                                        <span id="coupon-discount-amount">-0Ïõê</span>
                                    </div>
                                    <hr class="my-2">

                                    <div class="order-total d-flex justify-content-between fw-bold">
                                        <span>ÏµúÏ¢Ö Í≤∞Ï†ú Í∏àÏï°</span>
                                        <span id="actual-order-price"
                                              th:text="${actualOrderPrice != null ? #numbers.formatInteger(actualOrderPrice, 0, 'COMMA') : '0'} + 'Ïõê'">
                      0Ïõê
                    </span>
                                    </div>
                                </div>

                                <div class="d-grid mt-4">
                                    <button type="button" id="payment-button" class="btn btn-primary btn-lg"
                                            th:text="${#numbers.formatInteger(actualOrderPrice, 0, 'COMMA') + 'Ïõê Í≤∞Ï†úÌïòÍ∏∞'}">
                                        0Ïõê Í≤∞Ï†úÌïòÍ∏∞
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checkout-section" id="payment-method">
                        <div class="section-header">
                            <div class="section-number">5</div>
                            <h3>Í≤∞Ï†ú Î∞©Î≤ï</h3>
                        </div>
                        <div class="section-content">

                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="pointPay"
                                       value="POINT_PAYMENT">
                                <label class="form-check-label" for="pointPay">
                                    <strong>Ìè¨Ïù∏Ìä∏ Í≤∞Ï†ú</strong>
                                </label>
                            </div>

                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="tossPay"
                                       value="TOSS_EASY_PAY">
                                <label class="form-check-label" for="tossPay">
                                    <strong>ÌÜ†Ïä§ Í∞ÑÌé∏ Í≤∞Ï†ú</strong>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
            <!-- Terms and Privacy Modals -->
            <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="termsModalLabel">Terms and Conditions</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam in dui mauris. Vivamus
                                hendrerit arcu sed erat molestie vehicula. Sed auctor neque eu tellus rhoncus ut
                                eleifend nibh porttitor. Ut in nulla enim. Phasellus molestie magna non est bibendum non
                                venenatis nisl tempor.</p>
                            <p>Suspendisse in orci enim. Vivamus hendrerit arcu sed erat molestie vehicula. Sed auctor
                                neque eu tellus rhoncus ut eleifend nibh porttitor. Ut in nulla enim. Phasellus molestie
                                magna non est bibendum non venenatis nisl tempor.</p>
                            <p>Suspendisse in orci enim. Vivamus hendrerit arcu sed erat molestie vehicula. Sed auctor
                                neque eu tellus rhoncus ut eleifend nibh porttitor. Ut in nulla enim. Phasellus molestie
                                magna non est bibendum non venenatis nisl tempor.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">I Understand</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="privacyModal" tabindex="-1" aria-labelledby="privacyModalLabel"
                 aria-hidden="true">
                <div class="modal-dialog modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="privacyModalLabel">Privacy Policy</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam in dui mauris. Vivamus
                                hendrerit arcu sed erat molestie vehicula. Sed auctor neque eu tellus rhoncus ut
                                eleifend nibh porttitor. Ut in nulla enim.</p>
                            <p>Suspendisse in orci enim. Vivamus hendrerit arcu sed erat molestie vehicula. Sed auctor
                                neque eu tellus rhoncus ut eleifend nibh porttitor. Ut in nulla enim. Phasellus molestie
                                magna non est bibendum non venenatis nisl tempor.</p>
                            <p>Suspendisse in orci enim. Vivamus hendrerit arcu sed erat molestie vehicula. Sed auctor
                                neque eu tellus rhoncus ut eleifend nibh porttitor. Ut in nulla enim. Phasellus molestie
                                magna non est bibendum non venenatis nisl tempor.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">I Understand</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section><!-- /Checkout Section -->
</main>

<div th:replace="~{fragments/common_footer :: commonFooter}"></div>
<!-- Scroll Top -->
<a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i
        class="bi bi-arrow-up-short"></i></a>
<!-- Preloader -->
<div id="preloader"></div>

<!-- Vendor & Main JS Files -->
<th:block th:replace="~{fragments/common_scripts :: commonScripts}"></th:block>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        initPhoneHyphen();
        const TOSS_CLIENT_KEY = /*[[${tossClientIKey}]]*/ 'test_ck_nRQoOaPz8L4QRwM6lGa58y47BMw6';
        initTossPayments(TOSS_CLIENT_KEY);
        initPointInputListener();
        initApplyAllPointsButton();
        initPackagingModal();
        initAddressSelectModal();
        initCouponSelection();

        const findZipBtn = document.getElementById('find-zip-btn');
        if (findZipBtn) {
            findZipBtn.addEventListener('click', sample6_execDaumPostcode);
        }
    });

    // --- [1. Ïú†Ìã∏Î¶¨Ìã∞ Ìï®Ïàò] ---

    function initPhoneHyphen() {
        const phoneInput = document.getElementById('phone');
        if (!phoneInput) return;
        phoneInput.addEventListener('input', (e) => {
            let val = e.target.value.replace(/[^\d]/g, '');
            if (val.length > 11) val = val.slice(0, 11);
            if (val.length < 4) e.target.value = val;
            else if (val.length < 8) e.target.value = `${val.slice(0, 3)}-${val.slice(3)}`;
            else e.target.value = `${val.slice(0, 3)}-${val.slice(3, 7)}-${val.slice(7)}`;
        });
    }

    const parsePrice = (element) => {
        if (!element || (typeof element !== 'string' && !element.textContent)) return 0;
        const text = typeof element === 'string' ? element : element.textContent;
        return parseInt(text.replace(/[^\d]/g, ''), 10) || 0;
    };

    // --- [2. Ïø†Ìè∞ Í¥ÄÎ†® Î°úÏßÅ (Ï†ÅÏö© Î∞è Í≥ÑÏÇ∞)] ---

    // 2-1. Ï£ºÎ¨∏ ÏÉÅÌíà Ï†ïÎ≥¥ ÏàòÏßë
    function collectOrderItems() {
        const orderItems = [];
        document.querySelectorAll('.order-item').forEach(item => {
            orderItems.push({
                bookId: parseInt(item.dataset.bookId, 10),
                quantity: parseInt(item.dataset.quantity, 10)
            });
        });
        return orderItems;
    }

    // 2-2. Î∞±ÏóîÎìú API Ìò∏Ï∂ú (ÏµúÏ¢Ö Ìï†Ïù∏ Í∏àÏï° ÏöîÏ≤≠)
    async function fetchFinalCouponDiscount(couponId, orderItems) {
        if (!couponId || couponId === '0') return 0;

        try {
            const response = await fetch('/api/coupon/calculate-discount', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ couponId: couponId, orderItems: orderItems })
            });

            if (!response.ok) throw new Error();
            const data = await response.json();
            return data.discountAmount || 0; // Î∞±ÏóîÎìúÏóêÏÑú Í≥ÑÏÇ∞Îêú Í∏àÏï° Î∞òÌôò

        } catch (error) {
            console.error("Ïø†Ìè∞ Í≥ÑÏÇ∞ Ïã§Ìå®:", error);
            return 0;
        }
    }

    // 2-3. Ïø†Ìè∞ ÏÑ†ÌÉù Î∞è Ï†ÅÏö© Î≤ÑÌäº Î°úÏßÅ
    function initCouponSelection() {
        const selectBtn = document.getElementById('select-coupon-btn');
        const modalEl = document.getElementById('couponSelectModal');
        const applyBtn = document.getElementById('applyCouponButton');

        if (!selectBtn || !modalEl) return;

        // Î™®Îã¨ Ïó¥Í∏∞
        selectBtn.addEventListener('click', () => {
            new bootstrap.Modal(modalEl).show();
        });

        // 'Ï†ÅÏö©' Î≤ÑÌäº ÌÅ¥Î¶≠
        if (applyBtn) {
            applyBtn.addEventListener('click', async () => {
                const selectedRadio = modalEl.querySelector('input[name="couponSelect"]:checked');
                if (!selectedRadio) return;

                const couponId = selectedRadio.value;
                const couponName = selectedRadio.dataset.couponName || 'ÏÑ†ÌÉùÎêú Ïø†Ìè∞';
                const selectedCouponInfoEl = document.getElementById('selected-coupon-info');
                const selectedCouponIdHidden = document.getElementById('selected_coupon_id_hidden');
                const couponDiscountHidden = document.getElementById('coupon_discount_amount_hidden');

                let finalDiscount = 0;

                // (A) Ïø†Ìè∞ ÎØ∏Ï†ÅÏö© ÏÑ†ÌÉù Ïãú
                if (couponId === '0') {
                    selectedCouponIdHidden.value = '';
                    couponDiscountHidden.value = 0;
                    selectedCouponInfoEl.style.display = 'none';
                }
                // (B) Ïú†Ìö®Ìïú Ïø†Ìè∞ ÏÑ†ÌÉù Ïãú -> Î∞±ÏóîÎìú Í≥ÑÏÇ∞ ÏöîÏ≤≠
                else {
                    const orderItems = collectOrderItems();
                    finalDiscount = await fetchFinalCouponDiscount(couponId, orderItems);

                    if (finalDiscount > 0) {
                        selectedCouponIdHidden.value = couponId;
                        couponDiscountHidden.value = finalDiscount;
                        selectedCouponInfoEl.textContent = `${couponName}: ${finalDiscount.toLocaleString()}Ïõê Ìï†Ïù∏ Ï†ÅÏö©`;
                        selectedCouponInfoEl.style.display = 'block';
                    } else {
                        alert("Ï†ÅÏö© Ï°∞Í±¥ Î∂àÏ∂©Ï°±(ÏµúÏÜåÍ∏àÏï°/ÎåÄÏÉÅÏÉÅÌíà)ÏúºÎ°ú Ìï†Ïù∏Ïù¥ Ï†ÅÏö©ÎêòÏßÄ ÏïäÏäµÎãàÎã§.");
                        // Ï¥àÍ∏∞Ìôî
                        modalEl.querySelector('input[value="0"]').checked = true;
                        selectedCouponIdHidden.value = '';
                        couponDiscountHidden.value = 0;
                        selectedCouponInfoEl.style.display = 'none';
                    }
                }

                // (C) Î™®Îã¨ Îã´Í∏∞ Î∞è UI Í∞±Ïã†
                const instance = bootstrap.Modal.getInstance(modalEl);
                if (instance) instance.hide();

                // ÏûîÏÉÅ Ï†úÍ±∞
                document.body.classList.remove('modal-open');
                document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
                document.body.style.removeProperty('overflow');
                document.body.style.removeProperty('padding-right');

                // Í∞ÄÍ≤© Ïû¨Í≥ÑÏÇ∞
                updatePriceSummary();
            });
        }

        // Î™®Îã¨ Îã´Ìûò Ïù¥Î≤§Ìä∏ (ÏïàÏ†ÑÏû•Ïπò)
        modalEl.addEventListener('hidden.bs.modal', () => {
            document.body.classList.remove('modal-open');
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');
        });
    }

    // --- [3. Í≤∞Ï†ú Î∞è Í∞ÄÍ≤© Í≥ÑÏÇ∞ Ìï®Ïàò] ---

    function initTossPayments(clientKey) {
        const paymentButton = document.getElementById('payment-button');
        const actualOrderPriceEl = document.getElementById('actual-order-price');

        if (!paymentButton || !actualOrderPriceEl) return;
        var tossPayments = TossPayments(clientKey);

        paymentButton.addEventListener('click', async function () {
            // Ï£ºÎ¨∏ ÏÉÅÌíà ÏàòÏßë
            const bookInfoRequestList = [];
            document.querySelectorAll('.order-item').forEach(item => {
                const ds = item.dataset;
                const contributors = [];
                item.querySelectorAll('.contributor').forEach(c => contributors.push({
                    contributorId: parseInt(c.dataset.contributorId),
                    contributorName: c.dataset.contributorName,
                    contributorRole: c.dataset.contributorRole
                }));
                bookInfoRequestList.push({
                    bookId: parseInt(ds.bookId),
                    bookName: ds.bookName,
                    imageUrl: ds.imageUrl,
                    isPack: ds.isPack === 'true',
                    regularPrice: parseFloat(ds.regularPrice),
                    salePrice: parseFloat(ds.salePrice),
                    publisher: { publisherId: parseInt(ds.publisherId), publisherName: ds.publisherName },
                    quantity: parseInt(ds.quantity),
                    contributors: contributors,
                    packagingId: parseInt(ds.packagingId || '0')
                });
            });

            if (bookInfoRequestList.length === 0) {
                alert("Ï£ºÎ¨∏Ìï† ÏÉÅÌíàÏù¥ ÏóÜÏäµÎãàÎã§."); return;
            }

            // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÏàòÏßë
            const name = document.getElementById('name').value.trim();
            const phone = document.getElementById('phone').value.replace(/[^\d]/g, '');
            const zip = document.getElementById('zip').value;
            const address = document.getElementById('address').value;
            const detail = document.getElementById('address-detail').value;

            if (!name || phone.length < 10 || !zip || !address || !detail) {
                alert("Ï£ºÎ¨∏Ïûê Ï†ïÎ≥¥ Î∞è Î∞∞ÏÜ°ÏßÄ Ï†ïÎ≥¥Î•º Ï†ïÌôïÌûà ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî."); return;
            }

            // Í∏àÏï° Ï†ïÎ≥¥
            const totalBookPrice = parsePrice(document.getElementById('total-book-price'));
            const currentFinalPrice = parsePrice(actualOrderPriceEl);
            const deliveryDate = document.querySelector('input[name="deliveryDate"]:checked')?.value || null;

            // Ïø†Ìè∞ Î∞è Ìè¨Ïù∏Ìä∏ Ï†ïÎ≥¥
            const couponId = document.getElementById('selected_coupon_id_hidden').value;
            const usedPoints = parseInt(document.getElementById('points-to-use').value || '0', 10);

            const requestBody = {
                totalBookPrice: totalBookPrice,
                actualOrderPrice: currentFinalPrice,
                receiver: name,
                receiverPhone: phone,
                postCode: zip,
                receiverAddress: address,
                receiverAddressDetail: detail,
                receiverAddressExtra: document.getElementById('address-extra').value,
                deliveryArrivedDate: deliveryDate,
                bookInfoRequestList: bookInfoRequestList,
                // usedCouponId: couponId ? parseInt(couponId) : null,
                usedPoints: usedPoints
            };

            const tossPay = document.getElementById('tossPay');
            const pointPay = document.getElementById('pointPay');

            if (currentFinalPrice === 0) {
                if (tossPay && tossPay.checked) {
                    alert("0Ïõê Í≤∞Ï†ú Ïãú ÌÜ†Ïä§ Í≤∞Ï†úÎäî Î∂àÍ∞ÄÎä•Ìï©ÎãàÎã§."); return;
                }
            } else {
                if (pointPay && pointPay.checked) {
                    alert("Ïú†Î£å Í≤∞Ï†ú Ïãú Ï†ÑÏï° Ìè¨Ïù∏Ìä∏ Í≤∞Ï†úÎäî Î∂àÍ∞ÄÎä•Ìï©ÎãàÎã§."); return;
                }
                if (!tossPay || !tossPay.checked) {
                    alert("Í≤∞Ï†ú Î∞©Î≤ïÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî."); return;
                }
            }

            try {
                const res = await fetch('/orders/prepare', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                if (!res.ok) throw new Error();
                const data = await res.json();

                if (currentFinalPrice === 0) {
                    window.location.href = `/orders/success?orderNumber=${data.orderNumber}`;
                } else {
                    //Ïø†Ìè∞ ÏÇ¨Ïö© ÎêêÏúºÎ©¥ coupon id Í∞ÄÏ†∏Ïò¥
                    const rawCouponId = document.getElementById('selected_coupon_id_hidden').value;
                    const couponId = (rawCouponId && rawCouponId !== '0') ? rawCouponId : null;

                    let successUrl = window.location.origin + "/payments/confirm";
                    if (couponId) {
                        successUrl += `?couponId=${couponId}`; // üí° URL Îí§Ïóê Î∂ôÏù¥Í∏∞
                    }

                    tossPayments.requestPayment('ÌÜ†Ïä§ÌéòÏù¥', {
                        orderId: data.orderNumber,
                        amount: currentFinalPrice,
                        orderName: "Ï£ºÎ¨∏ ÏÉÅÌíà",
                        customerName: data.receiver,
                        successUrl: successUrl,
                        failUrl: window.location.origin + "/payments/fail"
                    });
                }
            } catch (e) {
                console.error(e);
                alert("Ï£ºÎ¨∏ Ï§ÄÎπÑ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
            }
        });
    }

    function initPointInputListener() {
        const input = document.getElementById('points-to-use');
        if (input) input.addEventListener('input', updatePriceSummary);
    }

    function initApplyAllPointsButton() {
        const btn = document.getElementById('apply-all-points-btn');
        if (btn) {
            btn.addEventListener('click', () => {
                const input = document.getElementById('points-to-use');
                const max = parseInt(input.getAttribute('max') || '0');
                const current = parsePrice(document.getElementById('current-points'));
                const totalBook = parsePrice(document.getElementById('total-book-price'));
                const delivery = parsePrice(document.getElementById('delivery-fee'));

                input.value = Math.min(max, current, totalBook + delivery);
                updatePriceSummary();
            });
        }
    }

    // üí° Í∞ÄÍ≤© ÏöîÏïΩ ÏóÖÎç∞Ïù¥Ìä∏ (Ïø†Ìè∞ Ìï†Ïù∏ Î∞òÏòÅ)
    function updatePriceSummary() {
        const pointsInput = document.getElementById('points-to-use');
        const pointsEl = document.getElementById('points-discount-amount');
        const pointsRow = document.querySelector('.order-points-discount');

        // Ïø†Ìè∞ ÏöîÏÜå
        const couponHidden = document.getElementById('coupon_discount_amount_hidden');
        const couponEl = document.getElementById('coupon-discount-amount');
        const couponRow = document.querySelector('.order-coupon-discount');

        const totalBookEl = document.getElementById('total-book-price');
        const deliveryEl = document.getElementById('delivery-fee');
        const actualPriceEl = document.getElementById('actual-order-price');
        const payBtn = document.getElementById('payment-button');

        // 1. ÏÉÅÌíà & Ìè¨Ïû•ÎπÑ
        let subtotal = 0;
        let packTotal = 0;
        document.querySelectorAll('.order-item').forEach(item => {
            const qty = parseInt(item.dataset.quantity);
            subtotal += parseFloat(item.dataset.salePrice) * qty;
            packTotal += parseFloat(item.dataset.packagingPrice || 0) * qty;
        });

        totalBookEl.textContent = `${subtotal.toLocaleString()}Ïõê`;

        let packRow = document.getElementById('order-packaging-total');
        if (!packRow) {
            packRow = document.createElement('div');
            packRow.id = 'order-packaging-total';
            packRow.className = 'order-shipping d-flex justify-content-between';
            deliveryEl.parentNode.insertAdjacentElement('afterend', packRow);
        }
        packRow.innerHTML = `<span>Ìè¨Ïû•ÎπÑ</span><span>+${packTotal.toLocaleString()}Ïõê</span>`;
        packRow.style.display = packTotal > 0 ? 'flex' : 'none';

        // 2. Ìï†Ïù∏ Ï†Ñ Ï¥ùÏï°
        const deliveryFee = parsePrice(deliveryEl);
        const totalBeforeDiscount = subtotal + packTotal + deliveryFee;

        // 3. Ìè¨Ïù∏Ìä∏
        let usedPoints = parseInt(pointsInput.value || 0);
        const maxPoints = parseInt(pointsInput.getAttribute('max') || 0);
        const userPoints = parsePrice(document.getElementById('current-points'));
        const limit = Math.min(maxPoints, userPoints, totalBeforeDiscount);

        if (usedPoints < 0) usedPoints = 0;
        if (usedPoints > limit) usedPoints = limit;
        pointsInput.value = usedPoints;

        // 4. Ìï†Ïù∏ Î∞òÏòÅ
        const couponDiscount = parseInt(couponHidden?.value || 0); // üí° Í∞í ÏùΩÍ∏∞

        // Ìè¨Ïù∏Ìä∏ UI
        if (usedPoints > 0) {
            pointsEl.textContent = `-${usedPoints.toLocaleString()}Ïõê`;
            pointsRow.style.display = 'flex';
        } else {
            pointsRow.style.display = 'none';
        }

        // Ïø†Ìè∞ UI üí°
        if (couponDiscount > 0) {
            couponEl.textContent = `-${couponDiscount.toLocaleString()}Ïõê`;
            couponRow.style.display = 'flex';
        } else {
            couponRow.style.display = 'none';
        }

        // 5. ÏµúÏ¢Ö Í∏àÏï°
        const finalPrice = Math.max(0, totalBeforeDiscount - usedPoints - couponDiscount);

        actualPriceEl.textContent = `${finalPrice.toLocaleString()}Ïõê`;
        payBtn.textContent = `${finalPrice.toLocaleString()}Ïõê Í≤∞Ï†úÌïòÍ∏∞`;
    }

    // --- [4. Í∏∞ÌÉÄ Î™®Îã¨ Î°úÏßÅ] ---

    function initPackagingModal() {
        const modal = document.getElementById('packagingSelectModal');
        const saveBtn = document.getElementById('savePackagingButton');
        if (!modal || !saveBtn) return;

        modal.addEventListener('show.bs.modal', (e) => {
            document.getElementById('modal_order_item_id').value = e.relatedTarget.dataset.orderItemId;
        });

        saveBtn.addEventListener('click', () => {
            const bookId = document.getElementById('modal_order_item_id').value;
            const selected = modal.querySelector('input[name="packagingId"]:checked');
            if (selected) {
                const price = parsePrice(selected.closest('label').querySelector('.text-muted'));
                const item = document.querySelector(`.order-item[data-book-id="${bookId}"]`);
                if (item) {
                    item.dataset.packagingId = selected.value;
                    item.dataset.packagingPrice = price;
                    const btn = document.querySelector(`button[data-order-item-id="${bookId}"]`);
                    if (selected.value === '0') {
                        btn.className = 'btn btn-outline-secondary btn-sm';
                        btn.innerHTML = '<i class="bi bi-box-seam me-1"></i> Ìè¨Ïû• ÏÑ†ÌÉù';
                    } else {
                        const name = selected.closest('label').querySelector('span').textContent;
                        btn.className = 'btn btn-dark text-white btn-sm';
                        btn.innerHTML = `<i class="bi bi-check-lg me-1"></i> ${name}`;
                    }
                }
            }
            updatePriceSummary();
            bootstrap.Modal.getInstance(modal).hide();
        });
    }

    function initAddressSelectModal() {
        const modal = document.getElementById('addressSelectModal');
        if (!modal) return;

        modal.addEventListener('show.bs.modal', async () => {
            const body = document.getElementById('address-list-body');
            body.innerHTML = '<div class="text-center p-3">Î°úÎî© Ï§ë...</div>';
            try {
                const res = await fetch('/addresses/me');
                if (!res.ok) throw new Error();
                const list = await res.json();
                body.innerHTML = renderAddressList(list);
            } catch (e) {
                body.innerHTML = '<div class="text-danger">Ï£ºÏÜå Î°úÎî© Ïã§Ìå®</div>';
            }
        });

        modal.addEventListener('click', (e) => {
            const item = e.target.closest('.address-select-item');
            if (item) {
                const ds = item.dataset;
                document.getElementById('zip').value = ds.postCode;
                document.getElementById('address').value = ds.addressInfo;
                document.getElementById('address-detail').value = ds.addressDetail;
                document.getElementById('address-extra').value = ds.addressExtra;
                bootstrap.Modal.getInstance(modal).hide();
            }
        });
    }

    function renderAddressList(list) {
        if (!list || !list.length) return '<div class="alert alert-info">Ï£ºÏÜå ÏóÜÏùå</div>';
        return '<div class="list-group">' + list.map(addr => `
            <div class="list-group-item address-select-item list-group-item-action ${addr.isDefault ? 'border-primary' : ''}"
                 role="button"
                 data-post-code="${addr.postCode}" data-address-info="${addr.addressInfo}"
                 data-address-detail="${addr.addressDetail}" data-address-extra="${addr.addressExtra}">
                 <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1 fw-bold">[${addr.addressAlias || 'Ï£ºÏÜå'}] ${addr.isDefault ? '(Í∏∞Î≥∏)' : ''}</h6>
                    <small>${addr.postCode}</small>
                 </div>
                 <p class="mb-1">${addr.addressInfo} ${addr.addressDetail}</p>
            </div>
        `).join('') + '</div>';
    }

    function sample6_execDaumPostcode() {
        new daum.Postcode({
            oncomplete: function (data) {
                document.getElementById('zip').value = data.zonecode;
                document.getElementById("address").value = data.roadAddress || data.jibunAddress;
                let extra = '';
                if (data.userSelectedType === 'R') {
                    if (data.bname && /[Îèô|Î°ú|Í∞Ä]$/g.test(data.bname)) extra += data.bname;
                    if (data.buildingName && data.apartment === 'Y') extra += (extra !== '' ? ', ' + data.buildingName : data.buildingName);
                    if (extra !== '') extra = ' (' + extra + ')';
                }
                document.getElementById("address-extra").value = extra;
                document.getElementById("address-detail").focus();
            }
        }).open();
    }
</script>
<!--<script>-->
<!--    document.addEventListener('DOMContentLoaded', () => {-->
<!--        initPhoneHyphen();-->
<!--        const TOSS_CLIENT_KEY = /*[[${tossClientIKey}]]*/ 'test_ck_nRQoOaPz8L4QRwM6lGa58y47BMw6';-->
<!--        initTossPayments(TOSS_CLIENT_KEY);-->
<!--        initPointInputListener();-->
<!--        initApplyAllPointsButton();-->
<!--        initPackagingModal();-->
<!--        initAddressSelectModal();-->
<!--        initCouponSelection();-->

<!--        const findZipBtn = document.getElementById('find-zip-btn');-->
<!--        if (findZipBtn) {-->
<!--            findZipBtn.addEventListener('click', sample6_execDaumPostcode);-->
<!--        }-->
<!--    });-->

<!--    function initPhoneHyphen() {-->
<!--        const phoneInput = document.getElementById('phone');-->
<!--        if (!phoneInput) return;-->

<!--        const formatPhoneNumber = (value) => {-->
<!--            if (!value) return value;-->
<!--            let phoneNumber = value.replace(/[^\d]/g, '');-->
<!--            if (phoneNumber.length > 11) phoneNumber = phoneNumber.slice(0, 11);-->
<!--            const len = phoneNumber.length;-->
<!--            if (len < 4) return phoneNumber;-->
<!--            if (len < 8) return `${phoneNumber.slice(0, 3)}-${phoneNumber.slice(3)}`;-->
<!--            return `${phoneNumber.slice(0, 3)}-${phoneNumber.slice(3, 7)}-${phoneNumber.slice(7)}`;-->
<!--        };-->

<!--        phoneInput.addEventListener('input', (e) => {-->
<!--            const target = e.target;-->
<!--            const originalValue = target.value;-->
<!--            const formattedValue = formatPhoneNumber(originalValue);-->
<!--            // Ïª§ÏÑú Í≥ÑÏÇ∞ÏùÄ Í∞ÑÎã®ÌïòÍ≤å Ï≤òÎ¶¨ (Ï†ïÍµêÌôî Í∞ÄÎä•)-->
<!--            target.value = formattedValue;-->
<!--        });-->
<!--    }-->

<!--    // Í≤∞Ï†ú Í∏àÏï° Í∞ÄÏ†∏Ïò§Í∏∞-->
<!--    // Í∏àÏï° ÌååÏã± Ìï®Ïàò (Ïù¥ Ìï®Ïàò Ïä§ÏΩîÌîÑ ÏïàÏóêÎèÑ Ï†ïÏùò)-->
<!--    const parsePrice = (priceValue) => {-->
<!--        if (priceValue == null) return 0;-->
<!--        const priceString = String(priceValue);-->
<!--        return Number(priceString.replace(/[^\d]/g, '')) || 0;-->
<!--    };-->

<!--    function initTossPayments(clientKey) {-->
<!--        const paymentButton = document.getElementById('payment-button');-->
<!--        const actualOrderPriceEl = document.getElementById('actual-order-price'); // ÏöîÏÜå ÎØ∏Î¶¨ Ï∞æÏïÑÎëêÍ∏∞-->

<!--        if (!paymentButton || !actualOrderPriceEl) {-->
<!--            console.error("Í≤∞Ï†ú Î≤ÑÌäº ÎòêÎäî ÏµúÏ¢Ö Í∏àÏï° ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§!");-->
<!--            return;-->
<!--        }-->
<!--        var tossPayments = TossPayments(clientKey);-->

<!--        paymentButton.addEventListener('click', async function () {-->

<!--            const bookInfoRequestList = []; // Î∞±ÏóîÎìúÎ°ú Î≥¥ÎÇº ÏµúÏ¢Ö Î¶¨Ïä§Ìä∏-->
<!--            const orderItemElements = document.querySelectorAll('.order-item');-->

<!--            orderItemElements.forEach(item => {-->
<!--                const dataset = item.dataset;-->

<!--                const publisher = {-->
<!--                    publisherId: parseInt(dataset.publisherId, 10),-->
<!--                    publisherName: dataset.publisherName-->
<!--                };-->

<!--                const contributors = [];-->
<!--                const contributorElements = item.querySelectorAll('.contributor-data .contributor');-->

<!--                contributorElements.forEach(c_item => {-->
<!--                    contributors.push({-->
<!--                        contributorId: parseInt(c_item.dataset.contributorId, 10),-->
<!--                        contributorName: c_item.dataset.contributorName,-->
<!--                        contributorRole: c_item.dataset.contributorRole-->
<!--                    });-->
<!--                });-->

<!--                bookInfoRequestList.push({-->
<!--                    bookId: parseInt(dataset.bookId, 10),-->
<!--                    bookName: dataset.bookName,-->
<!--                    imageUrl: dataset.imageUrl,-->
<!--                    isPack: (dataset.isPack === 'true'),-->
<!--                    regularPrice: parseFloat(dataset.regularPrice),-->
<!--                    salePrice: parseFloat(dataset.salePrice),-->
<!--                    publisher: publisher,-->
<!--                    quantity: parseInt(dataset.quantity, 10),-->
<!--                    contributors: contributors,-->
<!--                    packagingId: parseInt(dataset.packagingId || '0', 10)-->
<!--                });-->
<!--            });-->

<!--            console.log("bookInfoRequestList:", bookInfoRequestList);-->

<!--            if (bookInfoRequestList.length === 0) {-->
<!--                alert("Ï£ºÎ¨∏Ìï† ÏÉÅÌíàÏù¥ ÏóÜÏäµÎãàÎã§.");-->
<!--                return;-->
<!--            }-->

<!--            const customerName = document.getElementById('name')?.value.trim();-->
<!--            const rawPhone = document.getElementById('phone')?.value;-->
<!--            const phoneNumber = rawPhone ? rawPhone.replace(/[^\d]/g, '') : '';-->
<!--            const zip = document.getElementById('zip')?.value;-->
<!--            const address = document.getElementById('address')?.value;-->
<!--            const addressDetail = document.getElementById('address-detail')?.value;-->
<!--            const addressExtra = document.getElementById('address-extra')?.value;-->
<!--            const totalBookPrice = parsePrice(document.getElementById('total-book-price')?.textContent);-->

<!--            const currentFinalPrice = parsePrice(actualOrderPriceEl.textContent); // ÎØ∏Î¶¨ Ï∞æÏïÑÎëî ÏöîÏÜå ÏÇ¨Ïö©-->

<!--            const pointsInput = document.getElementById('points-to-use');-->
<!--            const usedPointsValue = parseInt(pointsInput.value, 10) || 0;-->

<!--            const orderItems = document.querySelectorAll('.order-summary-content .order-item');-->
<!--            let orderName = "Ï£ºÎ¨∏ ÏÉÅÌíà"; // Í∏∞Î≥∏Í∞í-->
<!--            if (!customerName || customerName.length === 0) {-->
<!--                alert("Ï£ºÎ¨∏Ïûê Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.");-->
<!--                document.getElementById('name').focus();-->
<!--                return;-->
<!--            }-->
<!--            if (!phoneNumber || phoneNumber.length < 10) { // ÏµúÏÜå 10ÏûêÎ¶¨ (ÌïòÏù¥Ìîà Ï†úÏô∏)-->
<!--                alert("Ïú†Ìö®Ìïú Ïó∞ÎùΩÏ≤òÎ•º ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.");-->
<!--                document.getElementById('phone').focus();-->
<!--                return;-->
<!--            }-->
<!--            if (!zip || zip.length === 0) {-->
<!--                alert("Ïö∞Ìé∏Î≤àÌò∏ Ï∞æÍ∏∞Î•º ÌÜµÌï¥ Î∞∞ÏÜ°ÏßÄ Ï£ºÏÜåÎ•º ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.");-->
<!--                document.getElementById('find-zip-btn').focus();-->
<!--                return;-->
<!--            }-->
<!--            if (!address || address.length === 0 || !addressDetail || addressDetail.length === 0) {-->
<!--                alert("ÏÉÅÏÑ∏ Ï£ºÏÜåÎ•º Ìè¨Ìï®ÌïòÏó¨ Ï†ïÌôïÌïú Î∞∞ÏÜ°ÏßÄ Ï†ïÎ≥¥Î•º ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.");-->
<!--                document.getElementById('address-detail').focus();-->
<!--                return;-->
<!--            }-->

<!--            if (orderItems.length > 0) {-->
<!--                const firstItemName = orderItems[0].querySelector('.order-item-details h4')?.textContent.trim();-->
<!--                if (firstItemName) {-->
<!--                    if (orderItems.length > 1) {-->
<!--                        orderName = `${firstItemName} Ïô∏ ${orderItems.length - 1}Í±¥`;-->
<!--                    } else {-->
<!--                        orderName = firstItemName;-->
<!--                    }-->
<!--                }-->
<!--            }-->

<!--            const selectedDeliveryArrivedDate = document.querySelector('input[name="deliveryDate"]:checked');-->
<!--            const deliveryDateValue = selectedDeliveryArrivedDate ? selectedDeliveryArrivedDate.value : null;-->

<!--            const orderPrepareRequest = {-->
<!--                totalBookPrice: totalBookPrice,-->
<!--                actualOrderPrice: currentFinalPrice,-->
<!--                receiver: customerName,-->
<!--                postCode: `${zip}`,-->
<!--                receiverAddress: `${address}`,-->
<!--                receiverAddressDetail: addressDetail,-->
<!--                receiverAddressExtra: addressExtra,-->
<!--                receiverPhone: phoneNumber,-->
<!--                deliveryArrivedDate: deliveryDateValue,-->
<!--                bookInfoRequestList: bookInfoRequestList,-->
<!--                usedPoints: usedPointsValue-->
<!--            };-->

<!--            const tossPayRadio = document.getElementById('tossPay');-->
<!--            const pointPayRadio = document.getElementById('pointPay');-->

<!--            if (currentFinalPrice === 0) {-->
<!--                // Case 1: 0ÏõêÏù∏Îç∞ ÌÜ†Ïä§Í∞Ä ÏÑ†ÌÉùÎêú Í≤ΩÏö∞ (Alert ÌõÑ Ï§ëÎã®)-->
<!--                if (tossPayRadio && tossPayRadio.checked) {-->
<!--                    alert("ÏµúÏ¢Ö Í≤∞Ï†ú Í∏àÏï°Ïù¥ 0ÏõêÏù¥ÎØÄÎ°ú ÌÜ†Ïä§ Í∞ÑÌé∏ Í≤∞Ï†ú(Ïú†Î£å)Î•º ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§. ÌÜ†Ïä§ Í≤∞Ï†ú ÏÑ†ÌÉùÏùÑ Ìï¥Ï†ú ÌõÑ Ï£ºÎ¨∏ÏùÑ ÏßÑÌñâÌï¥ Ï£ºÏÑ∏Ïöî.");-->
<!--                    return;-->
<!--                }-->
<!--            } else {-->
<!--                if (pointPayRadio && pointPayRadio.checked) {-->
<!--                    // Case 2: Ïú†Î£å Í≤∞Ï†úÏù∏Îç∞ 'Ï†ÑÏï° Ìè¨Ïù∏Ìä∏ Í≤∞Ï†ú'Í∞Ä ÏÑ†ÌÉùÎêú Í≤ΩÏö∞ (Í≤ΩÍ≥† ÌõÑ Ï§ëÎã®)-->
<!--                    alert("Ï¥ù Í≤∞Ï†ú Í∏àÏï°Ïù¥ 0Ïõê Ïù¥ÏÉÅÏù¥ÎØÄÎ°ú 'Ï†ÑÏï° Ìè¨Ïù∏Ìä∏ Í≤∞Ï†ú'Î•º ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§. ÌÜ†Ïä§ Í∞ÑÌé∏ Í≤∞Ï†úÎ•º ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî.");-->
<!--                    return; // Ìï®Ïàò Ïã§Ìñâ Ï§ëÎã®-->
<!--                }-->

<!--                if (!tossPayRadio || !tossPayRadio.checked) {-->
<!--                    // Case 3: Ïú†Î£å Í≤∞Ï†úÏù∏Îç∞ TOSSÎèÑ ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞-->
<!--                    alert("Í≤∞Ï†ú Î∞©Î≤ïÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");-->
<!--                    return; // Ìï®Ïàò Ïã§Ìñâ Ï§ëÎã®-->
<!--                }-->
<!--            }-->

<!--            console.log("Ï†ÑÏÜ°Ìï† Í∞ùÏ≤¥:", orderPrepareRequest);-->
<!--            console.log("Ïã§Ï†ú JSON:", JSON.stringify(orderPrepareRequest));-->

<!--            try {-->
<!--                const response = await fetch('/orders/prepare', {-->
<!--                    method: 'POST',-->
<!--                    headers: {'Content-Type': 'application/json'},-->
<!--                    body: JSON.stringify(orderPrepareRequest)-->
<!--                });-->

<!--                console.log("Ï£ºÎ¨∏ Ï§ÄÎπÑ ÏùëÎãµ: {}", response)-->
<!--                console.log("Ï£ºÎ¨∏ Ï§ÄÎπÑ ÏùëÎãµ Î∞îÎîî: {}", response.body);-->
<!--                console.log("Ï£ºÎ¨∏ Ï§ÄÎπÑ ÏùëÎãµ ÏΩîÎìú: {}", response.status);-->

<!--                if (!response.ok) {-->
<!--                    const err = await response.json().catch(() => ({message: 'Ï£ºÎ¨∏ Ï§ÄÎπÑ API ÏùëÎãµ Ïã§Ìå®.'}));-->
<!--                    throw new Error(err.message || 'Ï£ºÎ¨∏ Ï§ÄÎπÑÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');-->
<!--                }-->
<!--                const prepareResponse = await response.json();-->
<!--                const orderIdFromServer = prepareResponse.orderNumber;-->
<!--                if (!orderIdFromServer) {-->
<!--                    throw new Error('Ï£ºÎ¨∏ IDÎ•º ÏÑúÎ≤ÑÎ°úÎ∂ÄÌÑ∞ Î∞õÏßÄ Î™ªÌñàÏäµÎãàÎã§.');-->
<!--                }-->

<!--                if (currentFinalPrice === 0) {-->
<!--                    // ÌöåÏõê Ï£ºÎ¨∏Ïùº Í≤ΩÏö∞ÏóêÎßå 0Ïõê Ï≤òÎ¶¨ (ÎπÑÌöåÏõêÏùÄ ÏúÑÏóêÏÑú Ïù¥ÎØ∏ Ï∞®Îã®Îê®)-->
<!--                    console.log("0Ïõê Ï£ºÎ¨∏: ÏÑ±Í≥µ Ï≤òÎ¶¨.");-->
<!--                    window.location.href = window.location.origin + `/orders/success?orderNumber=${orderIdFromServer}`;-->
<!--                } else {-->
<!--                    // Ïú†Î£å Ï£ºÎ¨∏: ÌÜ†Ïä§ÌéòÏù¥Î®ºÏ∏† Ìò∏Ï∂ú-->
<!--                    console.log("Ïú†Î£å Ï£ºÎ¨∏: ÌÜ†Ïä§ÌéòÏù¥Î®ºÏ∏† Ìò∏Ï∂ú");-->
<!--                    tossPayments.requestPayment('ÌÜ†Ïä§ÌéòÏù¥', {-->
<!--                        orderId: orderIdFromServer,-->
<!--                        amount: currentFinalPrice,-->
<!--                        orderName: orderName,-->
<!--                        customerName: prepareResponse.receiver,-->
<!--                        successUrl: window.location.origin + "/payments/confirm",-->
<!--                        failUrl: window.location.origin + "/payments/fail"-->
<!--                    });-->
<!--                }-->
<!--            } catch (error) {-->
<!--                console.error('Ï£ºÎ¨∏ Ï≤òÎ¶¨ Ï§ë Ïò§Î•ò: ', error);-->
<!--                alert(error.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•òÍ∞Ä Î∞úÏÉùÌïòÏòÄÏäµÎãàÎã§.');-->
<!--            }-->
<!--        });-->
<!--    }-->

<!--    /**-->
<!--     * Ìè¨Ïù∏Ìä∏ ÏûÖÎ†• ÌïÑÎìúÏóê Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑàÎ•º Ï∂îÍ∞ÄÌïòÎäî Ìï®Ïàò-->
<!--     */-->
<!--    function initPointInputListener() {-->
<!--        const pointsInput = document.getElementById('points-to-use');-->
<!--        if (pointsInput) {-->
<!--            console.log("Ìè¨Ïù∏Ìä∏ ÏûÖÎ†• Î¶¨Ïä§ÎÑà Ï∂îÍ∞ÄÎê®"); // <-&#45;&#45; Î°úÍ∑∏ Ï∂îÍ∞Ä-->
<!--            pointsInput.addEventListener('input', (event) => { // event ÌååÎùºÎØ∏ÌÑ∞ Ï∂îÍ∞Ä-->
<!--                console.log("Ìè¨Ïù∏Ìä∏ ÏûÖÎ†• Í∞êÏßÄ:", event.target.value); // <-&#45;&#45; Î°úÍ∑∏ Ï∂îÍ∞Ä-->
<!--                updatePriceSummary();-->
<!--            });-->
<!--        } else {-->
<!--            console.error("ID 'points-to-use' ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå!"); // <-&#45;&#45; ÏöîÏÜå Î™ª Ï∞æÏùÑ Îïå Î°úÍ∑∏ Ï∂îÍ∞Ä-->
<!--        }-->
<!--    }-->

<!--    // -&#45;&#45; [Ï∂îÍ∞Ä] 'Î™®Îëê ÏÇ¨Ïö©' Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà -&#45;&#45;-->
<!--    function initApplyAllPointsButton() {-->
<!--        const applyAllBtn = document.getElementById('apply-all-points-btn');-->
<!--        const pointsInput = document.getElementById('points-to-use');-->
<!--        const totalBookPriceEl = document.getElementById('total-book-price');-->
<!--        const deliveryFeeEl = document.getElementById('delivery-fee'); // ‚≠ê ÏÉàÎ°ú Ï∂îÍ∞Ä: Î∞∞ÏÜ°ÎπÑ ÏöîÏÜå-->

<!--        const parsePrice = (element) => {-->
<!--            if (!element || !element.textContent) return 0;-->
<!--            return parseInt(element.textContent.replace(/[^\d]/g, ''), 10) || 0;-->
<!--        };-->

<!--        if (applyAllBtn && pointsInput && totalBookPriceEl && deliveryFeeEl) { // ‚≠ê deliveryFeeEl Ï≤¥ÌÅ¨ Ï∂îÍ∞Ä-->
<!--            console.log("'Î™®Îëê ÏÇ¨Ïö©' Î≤ÑÌäº Î¶¨Ïä§ÎÑà Ï∂îÍ∞ÄÎê®");-->
<!--            applyAllBtn.addEventListener('click', () => {-->
<!--                const maxPointsInput = parseInt(pointsInput.getAttribute('max') || '0', 10);-->
<!--                const currentPointsStr = document.getElementById('current-points')?.textContent.replace(/[^\d]/g, '');-->
<!--                const availablePoints = parseInt(currentPointsStr, 10) || 0;-->
<!--                const maxPointsFromBalance = Math.min(maxPointsInput, availablePoints);-->

<!--                const subtotal = parsePrice(totalBookPriceEl);-->
<!--                const deliveryFee = parsePrice(deliveryFeeEl);-->

<!--                const totalCost = subtotal + deliveryFee;-->

<!--                const maxPointsToUse = Math.min(maxPointsFromBalance, totalCost);-->

<!--                pointsInput.value = maxPointsToUse;-->
<!--                updatePriceSummary();-->
<!--            });-->
<!--        } else {-->
<!--            console.error("ID 'apply-all-points-btn' ÎòêÎäî ÌïÑÏàò ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå!");-->
<!--        }-->
<!--    }-->

<!--    /**-->
<!--     * ÏµúÏ¢Ö Í≤∞Ï†ú Í∏àÏï° Î∞è Ìï†Ïù∏ ÎÇ¥Ïó≠ÏùÑ ÏóÖÎç∞Ïù¥Ìä∏ÌïòÎäî Ìï®Ïàò-->
<!--     */-->
<!--    function updatePriceSummary() {-->
<!--        // 1. ÌïÑÏöîÌïú DOM ÏöîÏÜå Í∞ÄÏ†∏Ïò§Í∏∞-->
<!--        const pointsInput = document.getElementById('points-to-use');-->
<!--        const pointsDiscountAmountEl = document.getElementById('points-discount-amount');-->
<!--        const pointsDiscountRowEl = document.querySelector('.order-points-discount'); // Ìï†Ïù∏ Ìñâ Ï†ÑÏ≤¥ div-->
<!--        const couponDiscountAmountEl = document.getElementById('coupon-discount-amount'); // (Ïø†Ìè∞ Íµ¨ÌòÑ Ïãú)-->
<!--        const couponDiscountRowEl = document.querySelector('.order-coupon-discount'); // (Ïø†Ìè∞ Íµ¨ÌòÑ Ïãú)-->
<!--        const totalBookPriceEl = document.getElementById('total-book-price');-->
<!--        const deliveryFeeEl = document.getElementById('delivery-fee');-->
<!--        const actualOrderPriceEl = document.getElementById('actual-order-price');-->
<!--        const paymentButton = document.getElementById('payment-button');-->

<!--        let packagingTotalRow = document.getElementById('order-packaging-total');-->
<!--        // Ìè¨Ïû•ÎπÑ ÌñâÏù¥ ÏóÜÏúºÎ©¥ ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±-->
<!--        if (!packagingTotalRow) {-->
<!--            packagingTotalRow = document.createElement('div');-->
<!--            packagingTotalRow.id = 'order-packaging-total';-->
<!--            packagingTotalRow.className = 'order-shipping d-flex justify-content-between'; // Î∞∞ÏÜ°ÎπÑÏôÄ Í∞ôÏùÄ Ïä§ÌÉÄÏùº Ï†ÅÏö©-->
<!--            // Î∞∞ÏÜ°ÎπÑ(deliveryFeeEl)Ïùò Î∂ÄÎ™®(order-totals)Î•º Ï∞æÏïÑ Í∑∏ Îã§ÏùåÏóê ÏÇΩÏûÖ-->
<!--            deliveryFeeEl.parentNode.insertAdjacentElement('afterend', packagingTotalRow);-->
<!--        }-->

<!--        // Í∏àÏï° ÌååÏã± Ìï®Ïàò (ÏâºÌëú, 'Ïõê' Ï†úÍ±∞)-->
<!--        const parsePrice = (element) => {-->
<!--            if (!element || !element.textContent) return 0;-->
<!--            return parseInt(element.textContent.replace(/[^\d]/g, ''), 10) || 0;-->
<!--        };-->

<!--        // 2. ÌòÑÏû¨ Í∞í ÏùΩÍ∏∞-->
<!--        let usedPoints = parseInt(pointsInput.value, 10) || 0;-->
<!--        const maxPoints = parseInt(pointsInput.getAttribute('max') || '0', 10); // inputÏùò max ÏÜçÏÑ±Í∞í-->
<!--        const currentPointsStr = document.getElementById('current-points')?.textContent.replace(/[^\d]/g, '');-->
<!--        const availablePoints = parseInt(currentPointsStr, 10) || 0; // Ïã§Ï†ú Î≥¥Ïú† Ìè¨Ïù∏Ìä∏-->


<!--        // ‚ñº‚ñº‚ñº [ÏàòÏ†ï] ÏÉÅÌíà Í∏àÏï°(subtotal)Í≥º Ìè¨Ïû•ÎπÑ(packagingTotal) Í≥ÑÏÇ∞ ‚ñº‚ñº‚ñº-->
<!--        let subtotal = 0;-->
<!--        let packagingTotal = 0;-->
<!--        document.querySelectorAll('.order-item').forEach(item => {-->
<!--            const salePrice = parseFloat(item.dataset.salePrice) || 0;-->
<!--            const quantity = parseInt(item.dataset.quantity, 10) || 0;-->
<!--            subtotal += salePrice * quantity;-->

<!--            // Í∞Å ÏïÑÏù¥ÌÖúÏóê Ï†ÄÏû•Îêú Ìè¨Ïû•ÏßÄ Í∞ÄÍ≤© * ÏàòÎüâ-->
<!--            const packagingPrice = parseFloat(item.dataset.packagingPrice) || 0;-->
<!--            packagingTotal += packagingPrice * quantity;-->
<!--        });-->

<!--        // ÌôîÎ©¥Ïóê ÏÉÅÌíà Í∏àÏï° ÏóÖÎç∞Ïù¥Ìä∏-->
<!--        totalBookPriceEl.textContent = `${subtotal.toLocaleString('ko-KR')}Ïõê`;-->

<!--        // ÌôîÎ©¥Ïóê Ìè¨Ïû•ÎπÑ ÏóÖÎç∞Ïù¥Ìä∏-->
<!--        packagingTotalRow.innerHTML = `<span>Ìè¨Ïû•ÎπÑ</span><span>+${packagingTotal.toLocaleString('ko-KR')}Ïõê</span>`;-->
<!--        if (packagingTotal === 0) {-->
<!--            packagingTotalRow.style.display = 'none'; // Ìè¨Ïû•ÎπÑÍ∞Ä 0ÏõêÏù¥Î©¥ Ïà®ÍπÄ-->
<!--        } else {-->
<!--            packagingTotalRow.style.display = 'flex'; // 0Ïõê ÏïÑÎãàÎ©¥ ÌëúÏãú-->
<!--        }-->

<!--        const goodsCost = subtotal + packagingTotal;-->
<!--        const deliveryFee = parsePrice(deliveryFeeEl);-->

<!--        const totalBeforeDiscount = goodsCost + deliveryFee;-->

<!--        const maxPointsAllowed = Math.min(maxPoints, availablePoints);-->
<!--        const effectiveMaxPoints = Math.min(maxPointsAllowed, totalBeforeDiscount);-->
<!--        console.log("Í≥ÑÏÇ∞Îêú ÏµúÎåÄ ÏÇ¨Ïö© Í∞ÄÎä• Ìè¨Ïù∏Ìä∏:", effectiveMaxPoints); // <-&#45;&#45; Î°úÍ∑∏ Ï∂îÍ∞Ä!-->

<!--        // 3. Ìè¨Ïù∏Ìä∏ Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨ Î∞è Ï°∞Ï†ï-->
<!--        if (usedPoints < 0) {-->
<!--            usedPoints = 0;-->
<!--            pointsInput.value = 0; // ÏùåÏàò ÏûÖÎ†• Ïãú 0ÏúºÎ°ú Î≥ÄÍ≤Ω-->
<!--        }-->
<!--        if (usedPoints > effectiveMaxPoints) {-->
<!--            usedPoints = effectiveMaxPoints;-->
<!--            pointsInput.value = usedPoints;-->
<!--        }-->
<!--        // 4. Ìï†Ïù∏ Í∏àÏï° Í≥ÑÏÇ∞ (1Ìè¨Ïù∏Ìä∏ = 1ÏõêÏúºÎ°ú Í∞ÄÏ†ï)-->
<!--        const pointDiscount = usedPoints;-->
<!--        // const couponDiscount = parsePrice(couponDiscountAmountEl); // (Ïø†Ìè∞ Íµ¨ÌòÑ Ïãú)-->
<!--        const couponDiscount = document.getElementById('coupon_discount_amount_hidden').value;-->


<!--        // 5. Ìï†Ïù∏ Í∏àÏï° ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏-->
<!--        if (pointDiscount > 0) {-->
<!--            pointsDiscountAmountEl.textContent = `-${pointDiscount.toLocaleString('ko-KR')}Ïõê`;-->
<!--            pointsDiscountRowEl.style.display = 'flex'; // Ìï†Ïù∏ Ìñâ Î≥¥Ïù¥Í∏∞-->
<!--        } else {-->
<!--            pointsDiscountAmountEl.textContent = '-0Ïõê';-->
<!--            pointsDiscountRowEl.style.display = 'none'; // Ìï†Ïù∏ Ìñâ Ïà®Í∏∞Í∏∞-->
<!--        }-->

<!--        // (Ïø†Ìè∞ Ìï†Ïù∏ ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏ Î°úÏßÅ Ï∂îÍ∞Ä)-->
<!--        if (couponDiscount > 0) {-->
<!--            // 1. ÌÖçÏä§Ìä∏ Î≥ÄÍ≤Ω: Ïòà) "-3,000Ïõê"-->
<!--            couponDiscountAmountEl.textContent = `-${couponDiscount.toLocaleString('ko-KR')}Ïõê`;-->

<!--            // 2. Ìñâ Î≥¥Ïù¥Í∏∞ (display: none Ìï¥Ï†ú)-->
<!--            couponDiscountRowEl.style.display = 'flex';-->
<!--        } else {-->
<!--            // 1. ÌÖçÏä§Ìä∏ Ï¥àÍ∏∞Ìôî-->
<!--            couponDiscountAmountEl.textContent = '-0Ïõê';-->

<!--            // 2. Ìñâ Ïà®Í∏∞Í∏∞ (ÏÑ†ÌÉù ÏÇ¨Ìï≠: 0ÏõêÏùº Îïå Ïïà Î≥¥Ïù¥Í≤å ÌïòÎ†§Î©¥ none, Î≥¥Ïù¥Í≤å ÌïòÎ†§Î©¥ flex Ïú†ÏßÄ)-->
<!--            couponDiscountRowEl.style.display = 'none';-->
<!--        }-->

<!--        // 6. ÏµúÏ¢Ö Í≤∞Ï†ú Í∏àÏï° Í≥ÑÏÇ∞-->
<!--        // (ÏÉÅÌíàÍ∏àÏï° + Ìè¨Ïû•ÎπÑ + Î∞∞ÏÜ°ÎπÑ) - Ìï†Ïù∏-->
<!--        const finalPrice = Math.max(0, totalBeforeDiscount - pointDiscount - couponDiscount);-->

<!--        // 7. ÏµúÏ¢Ö Í≤∞Ï†ú Í∏àÏï° Î∞è Î≤ÑÌäº ÌÖçÏä§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏-->
<!--        actualOrderPriceEl.textContent = `${finalPrice.toLocaleString('ko-KR')}Ïõê`;-->
<!--        paymentButton.textContent = `${finalPrice.toLocaleString('ko-KR')}Ïõê Í≤∞Ï†úÌïòÍ∏∞`;-->
<!--    }-->

<!--    function sample6_execDaumPostcode() {-->
<!--        new daum.Postcode({-->
<!--            oncomplete: function (data) {-->
<!--                //  ÌåùÏóÖÏóêÏÑú Í≤ÄÏÉâ Í≤∞Í≥º Ìï≠Î™©ÏùÑ ÌÅ¥Î¶≠ÌñàÏùÑ Îïå Ïã§ÌñâÌï† ÏΩîÎìúÎ•º ÏûëÏÑ±ÌïòÎäî Î∂ÄÎ∂Ñ-->
<!--                var addr = '';-->
<!--                var extraAddr = '';-->

<!--                // ÏÇ¨Ïö©ÏûêÍ∞Ä ÏÑ†ÌÉùÌïú Ï£ºÏÜå ÌÉÄÏûÖÏóê Îî∞Îùº Ìï¥Îãπ Ï£ºÏÜå Í∞íÏùÑ Í∞ÄÏ†∏Ïò¥-->
<!--                if (data.userSelectedType !== 'R') { // ÏÇ¨Ïö©ÏûêÍ∞Ä ÎèÑÎ°úÎ™ÖÏùÑ ÏÑ†ÌÉùÌïòÏßÄ ÏïäÏïòÏùÑ Í≤ΩÏö∞-->
<!--                    alert('ÏßÄÎ≤à Ï£ºÏÜåÍ∞Ä ÏÑ†ÌÉùÎêòÏóàÏäµÎãàÎã§. ÎèÑÎ°úÎ™Ö Ï£ºÏÜåÎ°ú Î∞òÏòÅÎê©ÎãàÎã§.');-->
<!--                }-->

<!--                addr = data.roadAddress;-->

<!--                // ÏÇ¨Ïö©ÏûêÍ∞Ä ÏÑ†ÌÉùÌïú Ï£ºÏÜåÍ∞Ä ÎèÑÎ°úÎ™Ö ÌÉÄÏûÖÏùºÎïå Ï∞∏Í≥†Ìï≠Î™©ÏùÑ Ï°∞Ìï©ÌïúÎã§.-->
<!--                if (data.userSelectedType === 'R') {-->
<!--                    // Î≤ïÏ†ïÎèôÎ™ÖÏù¥ ÏûàÏùÑ Í≤ΩÏö∞ Ï∂îÍ∞ÄÌïúÎã§. (Î≤ïÏ†ïÎ¶¨Îäî Ï†úÏô∏)-->
<!--                    // Î≤ïÏ†ïÎèôÏùò Í≤ΩÏö∞ ÎßàÏßÄÎßâ Î¨∏ÏûêÍ∞Ä "Îèô/Î°ú/Í∞Ä"Î°ú ÎÅùÎÇúÎã§.-->
<!--                    if (data.bname !== '' && /[Îèô|Î°ú|Í∞Ä]$/g.test(data.bname)) {-->
<!--                        extraAddr += data.bname;-->
<!--                    }-->
<!--                    // Í±¥Î¨ºÎ™ÖÏù¥ ÏûàÍ≥†, Í≥µÎèôÏ£ºÌÉùÏùº Í≤ΩÏö∞ Ï∂îÍ∞ÄÌïúÎã§.-->
<!--                    if (data.buildingName !== '' && data.apartment === 'Y') {-->
<!--                        extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);-->
<!--                    }-->
<!--                    // ÌëúÏãúÌï† Ï∞∏Í≥†Ìï≠Î™©Ïù¥ ÏûàÏùÑ Í≤ΩÏö∞, Í¥ÑÌò∏ÍπåÏßÄ Ï∂îÍ∞ÄÌïú ÏµúÏ¢Ö Î¨∏ÏûêÏó¥ÏùÑ ÎßåÎì†Îã§.-->
<!--                    if (extraAddr !== '') {-->
<!--                        extraAddr = ' (' + extraAddr + ')';-->
<!--                    }-->
<!--                    // Ï°∞Ìï©Îêú Ï∞∏Í≥†Ìï≠Î™©ÏùÑ Ìï¥Îãπ ÌïÑÎìúÏóê ÎÑ£ÎäîÎã§.-->
<!--                    document.getElementById("address-extra").value = extraAddr;-->

<!--                } else {-->
<!--                    document.getElementById("address-extra").value = '';-->
<!--                }-->

<!--                document.getElementById('zip').value = data.zonecode;-->
<!--                document.getElementById("address").value = addr;-->
<!--                document.getElementById("address-detail").focus();-->
<!--            }-->
<!--        }).open();-->
<!--    }-->

<!--    document.addEventListener('DOMContentLoaded', () => {-->
<!--        // 1. "Ìè¨Ïû•ÏßÄ ÏÑ†ÌÉù" Î™®Îã¨ ÏöîÏÜåÎ•º Í∞ÄÏ†∏ÏòµÎãàÎã§.-->
<!--        const packagingModal = document.getElementById('packagingSelectModal');-->
<!--        if (packagingModal) {-->
<!--            // 2. Î™®Îã¨Ïù¥ Ïó¥Î¶¨Í∏∞ 'ÏßÅÏ†Ñ'Ïóê Ïã§ÌñâÎêòÎäî Ïù¥Î≤§Ìä∏Î•º Í∞êÏßÄÌï©ÎãàÎã§.-->
<!--            packagingModal.addEventListener('show.bs.modal', function (event) {-->
<!--                // 3. Ïñ¥Îñ§ Î≤ÑÌäºÏù¥ Î™®Îã¨ÏùÑ Ïó¥ÏóàÎäîÏßÄ Í∞ÄÏ†∏ÏòµÎãàÎã§.-->
<!--                const button = event.relatedTarget;-->
<!--                // 4. Î≤ÑÌäºÏóê Ïã¨Ïñ¥Îëî 'data-order-item-id' ÏÜçÏÑ± Í∞íÏùÑ ÏùΩÏñ¥ÏòµÎãàÎã§.-->
<!--                const orderItemId = button.dataset.orderItemId;-->
<!--                // 5. Î™®Îã¨ ÏïàÏùò Ïà®Í≤®ÏßÑ(hidden) inputÏùÑ Ï∞æÏäµÎãàÎã§.-->
<!--                const hiddenInput = document.getElementById('modal_order_item_id');-->
<!--                // 6. Ïà®Í≤®ÏßÑ inputÏùò Í∞í(value)Ïóê ÏÉÅÌíà IDÎ•º ÏÑ§Ï†ïÌï©ÎãàÎã§.-->
<!--                hiddenInput.value = orderItemId;-->
<!--                // 7. (ÏÑ†ÌÉù) Î™®Îã¨Ïù¥ Ïó¥Î¶¥ ÎïåÎßàÎã§ "Ìè¨Ïû• Ïïà Ìï®"ÏùÑ Í∏∞Î≥∏ÏúºÎ°ú Ï≤¥ÌÅ¨-->
<!--                const defaultRadio = packagingModal.querySelector('input[name="packagingId"][value="0"]');-->
<!--                if (defaultRadio) {-->
<!--                    defaultRadio.checked = true;-->
<!--                }-->
<!--            });-->
<!--        }-->
<!--    });-->

<!--    function initPackagingModal() {-->
<!--        const packagingModal = document.getElementById('packagingSelectModal');-->
<!--        const savePackagingButton = document.getElementById('savePackagingButton');-->
<!--        if (!packagingModal || !savePackagingButton) return;-->

<!--        // ... (Î™®Îã¨ Ïó¥Î¶¥ Îïå Î°úÏßÅÏùÄ Í∑∏ÎåÄÎ°ú) ...-->

<!--        // 'Ï†ÅÏö©' Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú-->
<!--        savePackagingButton.addEventListener('click', () => {-->
<!--            const bookId = document.getElementById('modal_order_item_id').value;-->
<!--            const selectedRadio = packagingModal.querySelector('input[name="packagingId"]:checked');-->
<!--            if (!selectedRadio) return;-->

<!--            const packagingId = selectedRadio.value;-->
<!--            const label = selectedRadio.closest('label');-->

<!--            const priceText = label.querySelector('.text-muted').textContent;-->
<!--            const packagingPrice = parseInt(priceText.replace(/[^\d]/g, ''), 10) || 0;-->

<!--            const nameElement = label.querySelector('strong, span:not(.text-muted)');-->
<!--            const packagingName = nameElement ? nameElement.textContent : 'Ìè¨Ïû• ÏÑ†ÌÉùÎê®';-->

<!--            const orderItemDiv = document.querySelector(`.order-item[data-book-id="${bookId}"]`);-->
<!--            const triggerButton = document.querySelector(`button[data-order-item-id="${bookId}"]`);-->

<!--            if (orderItemDiv && triggerButton) {-->
<!--                orderItemDiv.dataset.packagingId = packagingId;-->
<!--                orderItemDiv.dataset.packagingPrice = packagingPrice;-->

<!--                // Î™®Îì† ÏÉâÏÉÅ ÌÅ¥ÎûòÏä§Î•º Ï†úÍ±∞ÌïòÏó¨ Ï¥àÍ∏∞ÌôîÌï©ÎãàÎã§.-->
<!--                triggerButton.classList.remove('btn-success', 'btn-dark', 'btn-outline-secondary', 'text-white');-->

<!--                if (packagingId === '0') {-->
<!--                    // 'Ìè¨Ïû• Ïïà Ìï®' ÏÑ†ÌÉù Ïãú (Í∏∞Î≥∏Í∞í)-->
<!--                    triggerButton.innerHTML = '<i class="bi bi-box-seam me-1"></i> Ìè¨Ïû• ÏÑ†ÌÉù';-->
<!--                    triggerButton.classList.add('btn-outline-secondary'); // Í∏∞Î≥∏ ÌöåÏÉâ ÌÖåÎëêÎ¶¨ Î≤ÑÌäº-->
<!--                } else {-->
<!--                    // Ìè¨Ïû• ÏÑ†ÌÉù Ïãú-->
<!--                    triggerButton.innerHTML = `<i class="bi bi-check-lg me-1"></i> ${packagingName}`;-->
<!--                    triggerButton.classList.add('btn', 'btn-dark', 'text-white'); // Í≤ÄÏùÄÏÉâ Î∞∞Í≤Ω, Ìù∞ÏÉâ ÌÖçÏä§Ìä∏-->
<!--                }-->
<!--            }-->

<!--            updatePriceSummary();-->

<!--            const modalInstance = bootstrap.Modal.getInstance(packagingModal);-->
<!--            modalInstance.hide();-->

<!--            if (triggerButton) {-->
<!--                triggerButton.focus();-->
<!--            }-->
<!--        });-->
<!--    }-->

<!--    /**-->
<!--     * Ï£ºÏÜå ÏÑ†ÌÉù Î™®Îã¨ Ï¥àÍ∏∞Ìôî Î∞è Î°úÎìú Î°úÏßÅ-->
<!--     */-->
<!--    function initAddressSelectModal() {-->
<!--        const addressSelectModal = document.getElementById('addressSelectModal');-->
<!--        if (addressSelectModal) {-->
<!--            addressSelectModal.addEventListener('show.bs.modal', async (event) => {-->
<!--                const modalBody = document.getElementById('address-list-body');-->

<!--                // 1. Î™®Îã¨ ÎÇ¥Ïö©ÏùÑ Î°úÎî© Ïä§ÌîºÎÑàÎ°ú Ï¥àÍ∏∞Ìôî (ÏûÑÏãú Ïä§ÌîºÎÑà)-->
<!--                modalBody.innerHTML = `<div class="text-center p-5"><div class="spinner-border text-dark" role="status"></div></div>`;-->

<!--                try {-->
<!--                    // 2. ‚ú® API Ìò∏Ï∂ú: ÌòÑÏû¨ Î°úÍ∑∏Ïù∏Ìïú ÌöåÏõêÏùò Ï£ºÏÜå Î™©Î°ùÏùÑ ÏöîÏ≤≠-->
<!--                    const response = await fetch('/addresses/me');-->

<!--                    if (!response.ok) {-->
<!--                        throw new Error('Ï£ºÏÜå Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');-->
<!--                    }-->

<!--                    // 3. Ï£ºÏÜå Î™©Î°ù Îç∞Ïù¥ÌÑ∞ (JSON Î∞∞Ïó¥) ÌöçÎìù-->
<!--                    const addresses = await response.json();-->

<!--                    // 4. Ï£ºÏÜå Î™©Î°ù HTML Î†åÎçîÎßÅ-->
<!--                    modalBody.innerHTML = renderAddressList(addresses);-->

<!--                } catch (error) {-->
<!--                    modalBody.innerHTML = `<div class="alert alert-danger">Ï£ºÏÜå Î°úÎî© Ïã§Ìå®: ${error.message || 'Ïò§Î•ò Î∞úÏÉù'}</div>`;-->
<!--                }-->
<!--            });-->

<!--            // 5. Ï£ºÏÜå Î™©Î°ùÏóêÏÑú Ìï≠Î™© ÏÑ†ÌÉù Ïãú ÌèºÏóê Îç∞Ïù¥ÌÑ∞ Ï£ºÏûÖ-->
<!--            addressSelectModal.addEventListener('click', function (event) {-->
<!--                const target = event.target.closest('.address-select-item');-->
<!--                if (target) {-->
<!--                    const dataset = target.dataset;-->

<!--                    // Ìèº ÏöîÏÜåÏóê Îç∞Ïù¥ÌÑ∞ Ï£ºÏûÖ-->
<!--                    document.getElementById('zip').value = dataset.postCode;         // DTO: postCode -> dataset.postCode-->
<!--                    document.getElementById('address').value = dataset.addressInfo;    // DTO: addressInfo -> dataset.addressInfo-->
<!--                    document.getElementById('address-detail').value = dataset.addressDetail || ''; // DTO: addressDetail -> dataset.addressDetail-->
<!--                    document.getElementById('address-extra').value = dataset.addressExtra || '';   // DTO: addressExtra -> dataset.addressExtra-->
<!--                    // Î™®Îã¨ Îã´Í∏∞-->
<!--                    const modalInstance = bootstrap.Modal.getInstance(addressSelectModal);-->
<!--                    modalInstance.hide();-->

<!--                    document.getElementById('address-detail').focus();-->
<!--                }-->
<!--            });-->
<!--        }-->
<!--    }-->


<!--    /**-->
<!--     * Ï£ºÏÜå Î™©Î°ù Îç∞Ïù¥ÌÑ∞Î•º Î∞õÏïÑ HTMLÎ°ú Î†åÎçîÎßÅÌïòÎäî Ìó¨Ìçº Ìï®Ïàò-->
<!--     */-->
<!--    function renderAddressList(addresses) {-->
<!--        if (addresses.length === 0) {-->
<!--            return '<div class="alert alert-info">Îì±Î°ùÎêú Î∞∞ÏÜ°ÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§. ÏÉàÎ°úÏö¥ Ï£ºÏÜåÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.</div>';-->
<!--        }-->

<!--        let html = '';-->

<!--        addresses.forEach((addr, index) => {-->

<!--            // ‚≠ê DTO: isDefault (Boolean) ÌïÑÎìúÎ•º ÏÇ¨Ïö©ÌïòÏó¨ 'Í∏∞Î≥∏' Ïó¨Î∂ÄÎ•º ÌåêÎã®Ìï©ÎãàÎã§.-->
<!--            const isDefault = addr.isDefault ? ' (Í∏∞Î≥∏)' : '';-->
<!--            const defaultClass = addr.isDefault ? ' border-primary border-2' : '';-->

<!--            html += `-->
<!--        <div class="list-group-item list-group-item-action d-flex flex-column address-select-item ${defaultClass}"-->
<!--             role="button"-->

<!--             data-post-code="${addr.postCode || ''}"-->
<!--             data-address-info="${addr.addressInfo || ''}"-->
<!--             data-address-detail="${addr.addressDetail || ''}"-->
<!--             data-address-extra="${addr.addressExtra || ''}"-->

<!--        >-->
<!--            <div class="d-flex w-100 justify-content-between">-->
<!--                <h6 class="mb-1 fw-bold">-->
<!--                    [${addr.addressAlias || 'Ï£ºÏÜå'}] ${isDefault}-->
<!--                </h6>-->
<!--                <small class="text-muted">${addr.postCode || 'N/A'}</small>-->
<!--            </div>-->

<!--            <p class="mb-1">${addr.addressInfo || ''} ${addr.addressDetail || ''}</p>-->

<!--        </div>-->
<!--        `;-->
<!--        });-->

<!--        return `<div class="list-group">${html}</div>`;-->
<!--    }-->


<!--</script>-->
<div class="modal fade" id="packagingSelectModal" tabindex="-1" aria-labelledby="packagingModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="packagingModalLabel">Ìè¨Ïû•ÏßÄ ÏÑ†ÌÉù</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <p>Ïù¥ ÏÉÅÌíàÏóê Ï†ÅÏö©Ìï† Ìè¨Ïû•ÏßÄÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.</p>

                <form id="packagingSelectForm">

                    <input type="hidden" id="modal_order_item_id" name="orderItemId">

                    <div class="list-group">
                        <label class="list-group-item list-group-item-action d-flex align-items-center">
                            <input class="form-check-input me-3" type="radio" name="packagingId" value="0" checked>
                            <i class="bi bi-x-circle me-2 text-danger"></i>
                            <strong>Ìè¨Ïû• Ïïà Ìï®</strong>
                            <span class="text-muted ms-auto">(0Ïõê)</span>
                        </label>

                        <th:block th:each="pack : ${packagingOptions}">
                            <label class="list-group-item list-group-item-action d-flex align-items-center">
                                <input class="form-check-input me-3" type="radio" name="packagingId"
                                       th:value="${pack.packagingId}">

                                <img th:src="${pack.packagingImageUrl}" class="img-thumbnail me-2"
                                     style="width: 50px; height: 50px; object-fit: cover;"
                                     th:if="${pack.packagingImageUrl != null and pack.packagingImageUrl != ''}">

                                <span th:text="${pack.packagingName}">Ìè¨Ïû•ÏßÄ Ïù¥Î¶Ñ</span>

                                <span class="text-muted ms-auto"
                                      th:text="'(+' + ${#numbers.formatInteger(pack.packagingPrice, 0, 'COMMA')} + 'Ïõê)'">
                  (+1,000Ïõê)
                </span>
                            </label>
                        </th:block>

                        <tr th:if="${packagingOptions == null or #lists.isEmpty(packagingOptions)}">
                            <td colspan="4" class="text-center py-4">
                                Îì±Î°ùÎêú Ìè¨Ïû•ÏßÄ Ï†ïÏ±ÖÏù¥ ÏóÜÏäµÎãàÎã§.
                            </td>
                        </tr>
                    </div>
                </form>

            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ï∑®ÏÜå</button>
                <button type="button" class="btn btn-primary" id="savePackagingButton">Ï†ÅÏö©</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="addressSelectModal" tabindex="-1" aria-labelledby="addressSelectModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addressSelectModalLabel">ÎÇ¥ Ï£ºÏÜå Î™©Î°ù</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="address-list-body">
                <div class="text-center p-5">
                    <div class="spinner-border text-dark" role="status">
                        <span class="visually-hidden">Ï£ºÏÜå Î°úÎî© Ï§ë...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Îã´Í∏∞</button>
            </div>
        </div>
    </div>
</div>
<!--Ïø†Ìè∞ modal-->
<div class="modal fade" id="couponSelectModal" tabindex="-1" aria-labelledby="couponModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="couponModalLabel">ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ïø†Ìè∞ ÏÑ†ÌÉù</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="selected_coupon_id_hidden" name="selectedCouponId" value="">
                <input type="hidden" id="coupon_discount_amount_hidden" value="0">

                <div th:if="${usableCoupons == null || #lists.isEmpty(usableCoupons)}">
                    <p class="text-center text-muted">ÌòÑÏû¨ Ï£ºÎ¨∏ ÏÉÅÌíàÏóê Ï†ÅÏö© Í∞ÄÎä•Ìïú Ïø†Ìè∞Ïù¥ ÏóÜÏäµÎãàÎã§.</p>
                </div>
                <div th:unless="${usableCoupons == null || #lists.isEmpty(usableCoupons)}" class="list-group">

                    <label class="list-group-item list-group-item-action d-flex align-items-center">
                        <input class="form-check-input me-3 coupon-radio" type="radio" name="couponSelect" value="0" checked data-name="Ïø†Ìè∞ ÎØ∏Ï†ÅÏö©">
                        <i class="bi bi-x-circle me-2 text-danger"></i>
                        <strong>Ïø†Ìè∞ ÎØ∏Ï†ÅÏö©</strong>
                        <span class="text-muted ms-auto">(Ìï†Ïù∏ ÏóÜÏùå)</span>
                    </label>

                    <th:block th:each="coupon : ${usableCoupons}">
                        <label class="list-group-item list-group-item-action d-flex align-items-center"
                               th:data-coupon-id="${coupon.couponId}"
                               th:data-discount-value="${coupon.discountValue}"
                               th:data-discount-type="${coupon.discountType}"
                               th:data-criterion-price="${coupon.criterionPrice}"
                               th:data-discount-limit="${coupon.discountLimit}">

                            <input class="form-check-input me-3 coupon-radio" type="radio" name="couponSelect"
                                   th:id="'coupon-' + ${coupon.couponId}"
                                   th:value="${coupon.couponId}"
                                   th:data-coupon-name="${coupon.couponName}">

                            <div class="flex-grow-1">
                                <strong th:text="${coupon.couponName}">Ïø†Ìè∞ Ïù¥Î¶Ñ</strong>
                                <span class="badge bg-secondary ms-2" th:text="${coupon.policyTargetType}">WELCOME</span>
                                <small class="text-muted d-block"
                                       th:text="'ÎßåÎ£åÏùº: ' + ${#temporals.format(coupon.expiredDate, 'yyyy-MM-dd')}">ÎßåÎ£åÏùº</small>
                                <small class="text-muted d-block"
                                       th:text="'ÏµúÏÜå Ï£ºÎ¨∏Ïï°: ' + ${#numbers.formatInteger(coupon.criterionPrice, 0, 'COMMA')} + 'Ïõê'">ÏµúÏÜå Ï£ºÎ¨∏Ïï°</small>
                            </div>

                            <span class="fw-bold text-success ms-auto"
                                  th:text="${coupon.discountType == 'RATE' ? (coupon.discountValue + '% Ìï†Ïù∏') : (#numbers.formatInteger(coupon.discountValue, 0, 'COMMA') + 'Ïõê Ìï†Ïù∏')}">
                                Ìï†Ïù∏ Í∏àÏï°/Ïú®
                            </span>
                            <small th:if="${coupon.discountType == 'RATE'}" class="text-muted d-block ms-2"
                                   th:text="'(ÏµúÎåÄ ' + ${#numbers.formatInteger(coupon.discountLimit, 0, 'COMMA')} + 'Ïõê)'"></small>
                        </label>
                    </th:block>

                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ï∑®ÏÜå</button>
                <button type="button" class="btn btn-primary" id="applyCouponButton">Ï†ÅÏö©</button>
            </div>
        </div>
    </div>
</div>

</body>
</html>