<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Checkout - NiceShop Bootstrap Template</title>
    <meta name="description" content="">
    <meta name="keywords" content="">

    <th:block th:replace="~{fragments/file_link :: linkInfo}"></th:block>
    <script src="//js.tosspayments.com/v1"></script>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>

<body class="checkout-page">

<div th:replace="~{fragments/common_header :: commonHeader}"></div>
<main class="main">

    <!-- Page Title -->
    <div class="page-title light-background">
        <div class="container d-lg-flex justify-content-between align-items-center">
            <h1 class="mb-2 mb-lg-0">ì£¼ë¬¸</h1>
            <nav class="breadcrumbs">
                <ol>
                    <li><a th:hred="@{/}">Home</a></li>
                    <li class="current">ì£¼ë¬¸</li>
                </ol>
            </nav>
        </div>
    </div><!-- End Page Title -->

    <!-- Checkout Section -->
    <section id="checkout" class="checkout section">

        <div class="container" data-aos="fade-up" data-aos-delay="100">

            <form id="checkout-form">
                <div class="row">
                    <div class="col-lg-7">
                        <div class="checkout-container" data-aos="fade-up">
                            <div class="checkout-section" id="order-items-list">
                                <div class="section-header">
                                    <div class="section-number">1</div>
                                    <h3>ì£¼ë¬¸ ìƒí’ˆ</h3>
                                </div>
                                <div class="section-content">
                                    <div class="order-items-container">

                                        <div class="order-item"
                                             th:each="item : ${orderItem}"
                                             th:data-book-id="${item.bookId}"
                                             th:data-quantity="${item.quantity}"
                                             th:data-sale-price="${item.salePrice}"
                                             th:data-regular-price="${item.regularPrice}"
                                             th:data-book-name="${item.bookName}"
                                             th:data-image-url="${item.imageUrl}"
                                             th:data-publisher-id="${item.publisher().publisherId()}"
                                             th:data-publisher-name="${item.publisher().publisherName()}"
                                        >

                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="order-item-image me-3">
                                                    <img th:src="${item.imageUrl}" alt="Product" class="img-fluid"
                                                         style="width: 80px; height: auto;">
                                                </div>

                                                <div class="order-item-details flex-grow-1 me-3">
                                                    <h5 class="mb-1" th:text="${item.bookName}">ë„ì„œ ì œëª©</h5>

                                                    <p class="text-muted small mb-0">
                                                        <span th:text="${item.publisher().publisherName()}">ì¶œíŒì‚¬</span>
                                                        <span class="mx-1">|</span>
                                                        <th:block th:each="contributor, iter : ${item.contributors()}">
                                                            <span th:text="${contributor.contributorName()}">ì €ìëª…</span>
                                                            <span th:text="${contributor.contributorRole()} ? ' (' + ${contributor.contributorRole()} + ')' : ''">(ì €)</span>
                                                            <span th:if="!${iter.last}">, </span>
                                                        </th:block>
                                                    </p>

                                                </div>

                                                <div class="order-item-price mb-2">
                                                    <div class="mb-1">
                                                        <span class="quantity"
                                                              th:text="${item.quantity} + ' Ã—'">1 Ã—</span>
                                                    </div>
                                                    <span class="price-sale fw-bold fs-5"
                                                          th:text="${#numbers.formatInteger(item.salePrice, 0, 'COMMA') + 'ì›'}">
                                                      10,000ì›
                                                    </span>
                                                    <span class="price-regular text-muted text-decoration-line-through ms-1"
                                                          style="font-size: 0.9em;"
                                                          th:if="${item.regularPrice > item.salePrice}"
                                                          th:text="${#numbers.formatInteger(item.regularPrice, 0, 'COMMA') + 'ì›'}">
                                                      16,000ì›
                                                    </span>
                                                </div>

                                                <div th:if="${item.isPack}">
                                                    <button type="button" class="btn btn-outline-secondary btn-sm"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#packagingSelectModal"
                                                            th:data-order-item-id="${item.bookId}"><i
                                                            class="bi bi-box-seam me-1"></i> í¬ì¥ ì„ íƒ
                                                    </button>
                                                </div>

                                                <div class="contributor-data" style="display: none;">
                                                    <div class="contributor"
                                                         th:each="c : ${item.contributors()}"
                                                         th:data-contributor-id="${c.contributorId()}"
                                                         th:data-contributor-name="${c.contributorName()}"
                                                         th:data-contributor-role="${c.contributorRole()}">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="checkout-section" id="customer-info">
                                <div class="section-header">
                                    <div class="section-number">2</div>
                                    <h3>ì£¼ë¬¸ì ì •ë³´</h3>
                                </div>
                                <div class="section-content">
                                    <div class="row">
                                        <div class="col-md-12 form-group">
                                            <label for="name">ì´ë¦„</label>
                                            <input type="text" name="name" class="form-control" id="name"
                                                   placeholder="ì£¼ë¬¸ì ì´ë¦„" required="">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="phone">ì—°ë½ì²˜</label>
                                        <input type="tel" class="form-control" name="phone" id="phone"
                                               placeholder="010-1234-5678" required="">
                                    </div>
                                </div>
                            </div>

                            <div class="checkout-section" id="shipping-address">
                                <div class="section-header">
                                    <div class="section-number">3</div>
                                    <h3>ë°°ì†¡ì§€ ì •ë³´</h3>
                                </div>
                                <div class="section-content">
                                    <div class="form-group">
                                        <label for="zip">ìš°í¸ë²ˆí˜¸</label>
                                        <div class="input-group">
                                            <input type="text" name="zip" class="form-control" id="zip"
                                                   placeholder="ìš°í¸ë²ˆí˜¸" required="" readonly>
                                            <button class="btn btn-outline-secondary" type="button" id="find-zip-btn">
                                                ìš°í¸ë²ˆí˜¸ ì°¾ê¸°
                                            </button>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="address">ì£¼ì†Œ</label>
                                        <input type="text" class="form-control" name="address" id="address"
                                               placeholder="ê¸°ë³¸ ì£¼ì†Œ" readonly>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="address-detail">ìƒì„¸ì£¼ì†Œ</label>
                                                <input type="text" class="form-control" name="address-detail"
                                                       id="address-detail" placeholder="ìƒì„¸ì£¼ì†Œ (ì•„íŒŒíŠ¸ ë™, í˜¸ìˆ˜ ë“±)">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="address-extra">ì°¸ê³  í•­ëª©</label>
                                                <input type="text" class="form-control" name="address-extra"
                                                       id="address-extra" placeholder="ì°¸ê³ í•­ëª©" readonly>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="section-content">
                                        <div class="form-group mt-3">
                                            <label class="form-label">ë°°ì†¡ì¼ ì„ íƒ <small class="text-muted">(ë„ì°© ì˜ˆìƒì¼)</small></label>
                                            <div class="delivery-date-buttons d-flex flex-wrap gap-2">
                                                <th:block th:each="dateInfo, iterStat : ${deliveryDates}">
                                                    <input type="radio" class="btn-check" name="deliveryDate"
                                                           th:id="'date-' + ${dateInfo.valueDate}"
                                                           th:value="${dateInfo.valueDate}"
                                                           th:checked="${iterStat.first}"
                                                           autocomplete="off">
                                                    <label class="btn btn-outline-secondary"
                                                           th:for="'date-' + ${dateInfo.valueDate}"
                                                           th:text="${dateInfo.dayName} + ' (' + ${dateInfo.displayDate} + ')'">
                                                        ë‚ ì§œ ë²„íŠ¼
                                                    </label>
                                                </th:block>
                                            </div>
                                            <small class="text-muted d-block mt-1">ì£¼ë§ ë° ê³µíœ´ì¼ ì œì™¸, 5 ì˜ì—…ì¼ ì´ë‚´ ì„ íƒ
                                                ê°€ëŠ¥í•©ë‹ˆë‹¤.</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div class="checkout-section" id="discount-section">
                            <div class="section-header">
                                <div class="section-number">4</div>
                                <h3>í• ì¸ ì ìš©</h3>
                            </div>
                            <div class="section-content">
                                <div class="mb-3 row align-items-center">
                                    <label class="col-sm-2 col-form-label"><i class="bi bi-coin me-1"></i>ë³´ìœ </label>
                                    <div class="col-sm-10">
                                        <div class="fw-bold" id="current-points"
                                             th:text="${userPoint != null ? #numbers.formatInteger(userPoint, 0, 'COMMA') + ' P' : '0 P'}">
                                            5,000 P
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3 row align-items-center">
                                    <label for="points-to-use" class="col-sm-2 col-form-label">ì‚¬ìš©</label>
                                    <div class="col-sm-10">
                                        <div class="input-group">
                                            <input type="number" class="form-control text-end" id="points-to-use"
                                                   name="usedPoints" placeholder="0" min="0"
                                                   th:max="${userPoint ?: 0}" step="1">
                                            <span class="input-group-text">P</span>
                                            <button class="btn btn-outline-secondary" type="button"
                                                    id="apply-all-points-btn">ëª¨ë‘ ì‚¬ìš©
                                            </button>
                                        </div>
                                        <small class="text-muted d-block mt-1"
                                               th:text="'(ìµœëŒ€ ' + (${userPoint != null ? #numbers.formatInteger(userPoint, 0, 'COMMA') : 0}) + ' P ì‚¬ìš© ê°€ëŠ¥)'">(ìµœëŒ€
                                            5,000 P ì‚¬ìš© ê°€ëŠ¥)</small></div>
                                </div>

                                <div class="row align-items-center">
                                    <label class="col-sm-2 col-form-label"><i
                                            class="bi bi-ticket-perc me-1"></i>ì¿ í°</label>
                                    <div class="col-sm-10">
                                        <button type="button" class="btn btn-outline-secondary" id="select-coupon-btn"
                                                data-bs-toggle="modal" data-bs-target="#couponSelectModal">
                                            ì‚¬ìš© ê°€ëŠ¥í•œ ì¿ í° ì„ íƒí•˜ê¸°
                                        </button>
                                        <div id="selected-coupon-info" class="mt-2 text-success fw-semibold"
                                             style="display: none;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-5">
                        <div class="order-summary" data-aos="fade-left" data-aos-delay="200">
                            <div class="order-summary-header">
                                <h3>ì£¼ë¬¸ ìš”ì•½</h3>
                                <span class="item-count" th:text="${totalQuantity} + 'ê°œ ìƒí’ˆ'">0ê°œ ìƒí’ˆ</span>
                            </div>

                            <div class="order-summary-content">
                                <div class="order-totals">
                                    <div class="order-subtotal d-flex justify-content-between">
                                        <span>ìƒí’ˆ ê¸ˆì•¡</span>
                                        <span id="total-book-price"
                                              th:text="${#numbers.formatInteger(totalBookPrice, 0, 'COMMA') + 'ì›'}">0ì›</span>
                                    </div>

                                    <div class="order-shipping d-flex justify-content-between">
                                        <span>ë°°ì†¡ë¹„</span>
                                        <span id="delivery-fee"
                                              th:text="${deliveryFee != null ? #numbers.formatInteger(deliveryFee, 0, 'COMMA') : '0'} + 'ì›'">0ì›</span>
                                    </div>

                                    <div class="order-points-discount d-flex justify-content-between text-danger"
                                         style="display: none;">
                                        <span>í¬ì¸íŠ¸ í• ì¸</span>
                                        <span id="points-discount-amount">-0ì›</span>
                                    </div>

                                    <div class="order-coupon-discount d-flex justify-content-between text-danger"
                                         style="display: none;">
                                        <span>ì¿ í° í• ì¸</span>
                                        <span id="coupon-discount-amount">-0ì›</span>
                                    </div>
                                    <hr class="my-2">

                                    <div class="order-total d-flex justify-content-between fw-bold">
                                        <span>ìµœì¢… ê²°ì œ ê¸ˆì•¡</span>
                                        <span id="actual-order-price"
                                              th:text="${actualOrderPrice != null ? #numbers.formatInteger(actualOrderPrice, 0, 'COMMA') : '0'} + 'ì›'">
                      0ì›
                    </span>
                                    </div>
                                </div>

                                <div class="d-grid mt-4">
                                    <button type="button" id="payment-button" class="btn btn-primary btn-lg"
                                            th:text="${#numbers.formatInteger(actualOrderPrice, 0, 'COMMA') + 'ì› ê²°ì œí•˜ê¸°'}">
                                        0ì› ê²°ì œí•˜ê¸°
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checkout-section" id="payment-method">
                        <div class="section-header">
                            <div class="section-number">5</div>
                            <h3>ê²°ì œ ë°©ë²•</h3>
                        </div>
                        <div class="section-content">

                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="tossPay"
                                       value="TOSS_EASY_PAY">
                                <label class="form-check-label" for="tossPay">
                                    <strong>í† ìŠ¤ ê°„í¸ ê²°ì œ</strong>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
            <!-- Terms and Privacy Modals -->
            <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="termsModalLabel">Terms and Conditions</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam in dui mauris. Vivamus
                                hendrerit arcu sed erat molestie vehicula. Sed auctor neque eu tellus rhoncus ut
                                eleifend nibh porttitor. Ut in nulla enim. Phasellus molestie magna non est bibendum non
                                venenatis nisl tempor.</p>
                            <p>Suspendisse in orci enim. Vivamus hendrerit arcu sed erat molestie vehicula. Sed auctor
                                neque eu tellus rhoncus ut eleifend nibh porttitor. Ut in nulla enim. Phasellus molestie
                                magna non est bibendum non venenatis nisl tempor.</p>
                            <p>Suspendisse in orci enim. Vivamus hendrerit arcu sed erat molestie vehicula. Sed auctor
                                neque eu tellus rhoncus ut eleifend nibh porttitor. Ut in nulla enim. Phasellus molestie
                                magna non est bibendum non venenatis nisl tempor.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">I Understand</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="privacyModal" tabindex="-1" aria-labelledby="privacyModalLabel"
                 aria-hidden="true">
                <div class="modal-dialog modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="privacyModalLabel">Privacy Policy</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam in dui mauris. Vivamus
                                hendrerit arcu sed erat molestie vehicula. Sed auctor neque eu tellus rhoncus ut
                                eleifend nibh porttitor. Ut in nulla enim.</p>
                            <p>Suspendisse in orci enim. Vivamus hendrerit arcu sed erat molestie vehicula. Sed auctor
                                neque eu tellus rhoncus ut eleifend nibh porttitor. Ut in nulla enim. Phasellus molestie
                                magna non est bibendum non venenatis nisl tempor.</p>
                            <p>Suspendisse in orci enim. Vivamus hendrerit arcu sed erat molestie vehicula. Sed auctor
                                neque eu tellus rhoncus ut eleifend nibh porttitor. Ut in nulla enim. Phasellus molestie
                                magna non est bibendum non venenatis nisl tempor.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">I Understand</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section><!-- /Checkout Section -->
</main>

<div th:replace="~{fragments/common_footer :: commonFooter}"></div>
<!-- Scroll Top -->
<a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i
        class="bi bi-arrow-up-short"></i></a>
<!-- Preloader -->
<div id="preloader"></div>

<!-- Vendor JS Files -->
<script th:src="@{/assets/vendor/bootstrap/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/assets/vendor/php-email-form/validate.js}"></script>
<script th:src="@{/assets/vendor/swiper/swiper-bundle.min.js}"></script>
<script th:src="@{/assets/vendor/aos/aos.js}"></script>
<script th:src="@{/assets/vendor/glightbox/js/glightbox.min.js}"></script>
<script th:src="@{/assets/vendor/drift-zoom/Drift.min.js}"></script>
<script th:src="@{/assets/vendor/purecounter/purecounter_vanilla.js}"></script>

<!-- Main JS File -->
<script th:src="@{/assets/js/main.js}"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        initPhoneHyphen();
        const TOSS_CLIENT_KEY = /*[[${tossClientIKey}]]*/ 'test_ck_nRQoOaPz8L4QRwM6lGa58y47BMw6';
        initTossPayments(TOSS_CLIENT_KEY);
        initPointInputListener();
        initApplyAllPointsButton();
        initPackagingModal();
        initCouponSelection();

        const findZipBtn = document.getElementById('find-zip-btn');
        if (findZipBtn) {
            findZipBtn.addEventListener('click', sample6_execDaumPostcode);
        }
    });

    function initPhoneHyphen() {
        const phoneInput = document.getElementById('phone');
        if (!phoneInput) return;

        const formatPhoneNumber = (value) => {
            if (!value) return value;
            let phoneNumber = value.replace(/[^\d]/g, '');
            if (phoneNumber.length > 11) phoneNumber = phoneNumber.slice(0, 11);
            const len = phoneNumber.length;
            if (len < 4) return phoneNumber;
            if (len < 8) return `${phoneNumber.slice(0, 3)}-${phoneNumber.slice(3)}`;
            return `${phoneNumber.slice(0, 3)}-${phoneNumber.slice(3, 7)}-${phoneNumber.slice(7)}`;
        };

        phoneInput.addEventListener('input', (e) => {
            const target = e.target;
            const originalValue = target.value;
            const formattedValue = formatPhoneNumber(originalValue);
            // ì»¤ì„œ ê³„ì‚°ì€ ê°„ë‹¨í•˜ê²Œ ì²˜ë¦¬ (ì •êµí™” ê°€ëŠ¥)
            target.value = formattedValue;
        });
    }

    // ê²°ì œ ê¸ˆì•¡ ê°€ì ¸ì˜¤ê¸°
    // ê¸ˆì•¡ íŒŒì‹± í•¨ìˆ˜ (ì´ í•¨ìˆ˜ ìŠ¤ì½”í”„ ì•ˆì—ë„ ì •ì˜)
    const parsePrice = (priceValue) => {
        if (priceValue == null) return 0;
        const priceString = String(priceValue);
        return Number(priceString.replace(/[^\d]/g, '')) || 0;
    };

    function initTossPayments(clientKey) {
        const paymentButton = document.getElementById('payment-button');
        const actualOrderPriceEl = document.getElementById('actual-order-price'); // ìš”ì†Œ ë¯¸ë¦¬ ì°¾ì•„ë‘ê¸°

        if (!paymentButton || !actualOrderPriceEl) {
            console.error("ê²°ì œ ë²„íŠ¼ ë˜ëŠ” ìµœì¢… ê¸ˆì•¡ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
            return;
        }
        var tossPayments = TossPayments(clientKey);

        paymentButton.addEventListener('click', async function () {

            const bookInfoRequestList = []; // ë°±ì—”ë“œë¡œ ë³´ë‚¼ ìµœì¢… ë¦¬ìŠ¤íŠ¸
            const orderItemElements = document.querySelectorAll('.order-item');

            orderItemElements.forEach(item => {
                const dataset = item.dataset;

                const publisher = {
                    publisherId: parseInt(dataset.publisherId, 10),
                    publisherName: dataset.publisherName
                };

                const contributors = [];
                const contributorElements = item.querySelectorAll('.contributor-data .contributor');

                contributorElements.forEach(c_item => {
                    contributors.push({
                        contributorId: parseInt(c_item.dataset.contributorId, 10),
                        contributorName: c_item.dataset.contributorName,
                        contributorRole: c_item.dataset.contributorRole
                    });
                });

                bookInfoRequestList.push({
                    bookId: parseInt(dataset.bookId, 10),
                    bookName: dataset.bookName,
                    imageUrl: dataset.imageUrl,
                    isPack: (dataset.isPack === 'true'),
                    regularPrice: parseFloat(dataset.regularPrice),
                    salePrice: parseFloat(dataset.salePrice),
                    publisher: publisher,
                    quantity: parseInt(dataset.quantity, 10),
                    contributors: contributors,
                    packagingId: parseInt(dataset.packagingId || '0', 10)
                });
            });

            console.log("bookInfoRequestList:", bookInfoRequestList);

            if (bookInfoRequestList.length === 0) {
                alert("ì£¼ë¬¸í•  ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            const customerName = document.getElementById('name')?.value.trim();
            const rawPhone = document.getElementById('phone')?.value;
            const phoneNumber = rawPhone ? rawPhone.replace(/[^\d]/g, '') : '';
            const zip = document.getElementById('zip')?.value;
            const address = document.getElementById('address')?.value;
            const addressDetail = document.getElementById('address-detail')?.value;
            const addressExtra = document.getElementById('address-extra')?.value;
            const totalBookPrice = parsePrice(document.getElementById('total-book-price')?.textContent);

            const currentFinalPrice = parsePrice(actualOrderPriceEl.textContent); // ë¯¸ë¦¬ ì°¾ì•„ë‘” ìš”ì†Œ ì‚¬ìš©

            const orderItems = document.querySelectorAll('.order-summary-content .order-item');
            let orderName = "ì£¼ë¬¸ ìƒí’ˆ"; // ê¸°ë³¸ê°’
            if (orderItems.length > 0) {
                const firstItemName = orderItems[0].querySelector('.order-item-details h4')?.textContent.trim();
                if (firstItemName) {
                    if (orderItems.length > 1) {
                        orderName = `${firstItemName} ì™¸ ${orderItems.length - 1}ê±´`;
                    } else {
                        orderName = firstItemName;
                    }
                }
            }

            const selectedDeliveryArrivedDate = document.querySelector('input[name="deliveryDate"]:checked');
            const deliveryDateValue = selectedDeliveryArrivedDate ? selectedDeliveryArrivedDate.value : null;

            const orderPrepareRequest = {
                totalBookPrice: totalBookPrice,
                actualOrderPrice: currentFinalPrice,
                receiver: customerName,
                postCode: `${zip}`,
                receiverAddress: `${address}`,
                receiverAddressDetail: addressDetail,
                receiverAddressExtra: addressExtra,
                receiverPhone: phoneNumber,
                deliveryArrivedDate: deliveryDateValue,
                bookInfoRequestList: bookInfoRequestList
            };

            const tossPayRadio = document.getElementById('tossPay');

            // ìµœì¢… ê¸ˆì•¡ì´ 0ë³´ë‹¤ í¬ê³ , í† ìŠ¤í˜ì´ ë¼ë””ì˜¤ ë²„íŠ¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì•Œë¦¼ í›„ ì¤‘ë‹¨
            if (currentFinalPrice > 0 && (!tossPayRadio || !tossPayRadio.checked)) {
                alert("ê²°ì œ ë°©ë²•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return; // í•¨ìˆ˜ ì‹¤í–‰ ì¤‘ë‹¨
            }

            console.log("ì „ì†¡í•  ê°ì²´:", orderPrepareRequest);
            console.log("ì‹¤ì œ JSON:", JSON.stringify(orderPrepareRequest));

            try {
                const response = await fetch('/orders/prepare', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(orderPrepareRequest)
                });

                console.log("ì£¼ë¬¸ ì¤€ë¹„ ì‘ë‹µ: {}", response)
                console.log("ì£¼ë¬¸ ì¤€ë¹„ ì‘ë‹µ ë°”ë””: {}", response.body);
                console.log("ì£¼ë¬¸ ì¤€ë¹„ ì‘ë‹µ ì½”ë“œ: {}", response.status);

                if (!response.ok) {
                    const err = await response.json().catch(() => ({message: 'ì£¼ë¬¸ ì¤€ë¹„ API ì‘ë‹µ ì‹¤íŒ¨.'}));
                    throw new Error(err.message || 'ì£¼ë¬¸ ì¤€ë¹„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                const prepareResponse = await response.json();
                const orderIdFromServer = prepareResponse.orderNumber;
                if (!orderIdFromServer) {
                    throw new Error('ì£¼ë¬¸ IDë¥¼ ì„œë²„ë¡œë¶€í„° ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                }

                if (currentFinalPrice === 0) {
                    // íšŒì› ì£¼ë¬¸ì¼ ê²½ìš°ì—ë§Œ 0ì› ì²˜ë¦¬ (ë¹„íšŒì›ì€ ìœ„ì—ì„œ ì´ë¯¸ ì°¨ë‹¨ë¨)
                    console.log("0ì› ì£¼ë¬¸: ì„±ê³µ ì²˜ë¦¬.");
                    window.location.href = window.location.origin + `/orders/success?orderNumber=${orderIdFromServer}`;
                } else {
                    // ìœ ë£Œ ì£¼ë¬¸: í† ìŠ¤í˜ì´ë¨¼ì¸  í˜¸ì¶œ
                    console.log("ìœ ë£Œ ì£¼ë¬¸: í† ìŠ¤í˜ì´ë¨¼ì¸  í˜¸ì¶œ");
                    tossPayments.requestPayment('í† ìŠ¤í˜ì´', {
                        orderId: orderIdFromServer,
                        amount: currentFinalPrice,
                        orderName: orderName,
                        customerName: prepareResponse.receiver,
                        successUrl: window.location.origin + "/payments/confirm",
                        failUrl: window.location.origin + "/payments/fail"
                    });
                }
            } catch (error) {
                console.error('ì£¼ë¬¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: ', error);
                alert(error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.');
            }
        });
    }

    /**
     * í¬ì¸íŠ¸ ì…ë ¥ í•„ë“œì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
     */
    function initPointInputListener() {
        const pointsInput = document.getElementById('points-to-use');
        if (pointsInput) {
            console.log("í¬ì¸íŠ¸ ì…ë ¥ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ë¨"); // <--- ë¡œê·¸ ì¶”ê°€
            pointsInput.addEventListener('input', (event) => { // event íŒŒë¼ë¯¸í„° ì¶”ê°€
                console.log("í¬ì¸íŠ¸ ì…ë ¥ ê°ì§€:", event.target.value); // <--- ë¡œê·¸ ì¶”ê°€
                updatePriceSummary();
            });
        } else {
            console.error("ID 'points-to-use' ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ!"); // <--- ìš”ì†Œ ëª» ì°¾ì„ ë•Œ ë¡œê·¸ ì¶”ê°€
        }
    }

    // --- [ì¶”ê°€] 'ëª¨ë‘ ì‚¬ìš©' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
    function initApplyAllPointsButton() {
        const applyAllBtn = document.getElementById('apply-all-points-btn');
        const pointsInput = document.getElementById('points-to-use');
        const totalBookPriceEl = document.getElementById('total-book-price');

        const parsePrice = (element) => {
            if (!element || !element.textContent) return 0;
            return parseInt(element.textContent.replace(/[^\d]/g, ''), 10) || 0;
        };

        if (applyAllBtn && pointsInput && totalBookPriceEl) {
            console.log("'ëª¨ë‘ ì‚¬ìš©' ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ë¨"); // <--- ë¡œê·¸ ì¶”ê°€
            applyAllBtn.addEventListener('click', () => {
                const maxPointsInput = parseInt(pointsInput.getAttribute('max') || '0', 10);
                const currentPointsStr = document.getElementById('current-points')?.textContent.replace(/[^\d]/g, '');
                const availablePoints = parseInt(currentPointsStr, 10) || 0;
                const maxPointsFromBalance = Math.min(maxPointsInput, availablePoints);

                const subtotal = parsePrice(totalBookPriceEl);

                const maxPointsToUse = Math.min(maxPointsFromBalance, subtotal);

                pointsInput.value = maxPointsToUse;
                // 2. ê·¸ ë‹¤ìŒ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ í˜¸ì¶œ
                updatePriceSummary();
            });
        } else {
            console.error("ID 'apply-all-points-btn' ë˜ëŠ” 'points-to-use' ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ!");
        }
    }

    /**
     * ìµœì¢… ê²°ì œ ê¸ˆì•¡ ë° í• ì¸ ë‚´ì—­ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
     */
    function updatePriceSummary() {
        // 1. í•„ìš”í•œ DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const pointsInput = document.getElementById('points-to-use');
        const pointsDiscountAmountEl = document.getElementById('points-discount-amount');
        const pointsDiscountRowEl = document.querySelector('.order-points-discount'); // í• ì¸ í–‰ ì „ì²´ div
        // const couponDiscountAmountEl = document.getElementById('coupon-discount-amount'); // (ì¿ í° êµ¬í˜„ ì‹œ)
        // const couponDiscountRowEl = document.querySelector('.order-coupon-discount'); // (ì¿ í° êµ¬í˜„ ì‹œ)
        const totalBookPriceEl = document.getElementById('total-book-price');
        const deliveryFeeEl = document.getElementById('delivery-fee');
        const actualOrderPriceEl = document.getElementById('actual-order-price');
        const paymentButton = document.getElementById('payment-button');

        let packagingTotalRow = document.getElementById('order-packaging-total');
        // í¬ì¥ë¹„ í–‰ì´ ì—†ìœ¼ë©´ ë™ì ìœ¼ë¡œ ìƒì„±
        if (!packagingTotalRow) {
            packagingTotalRow = document.createElement('div');
            packagingTotalRow.id = 'order-packaging-total';
            packagingTotalRow.className = 'order-shipping d-flex justify-content-between'; // ë°°ì†¡ë¹„ì™€ ê°™ì€ ìŠ¤íƒ€ì¼ ì ìš©
            // ë°°ì†¡ë¹„(deliveryFeeEl)ì˜ ë¶€ëª¨(order-totals)ë¥¼ ì°¾ì•„ ê·¸ ë‹¤ìŒì— ì‚½ì…
            deliveryFeeEl.parentNode.insertAdjacentElement('afterend', packagingTotalRow);
        }

        // ê¸ˆì•¡ íŒŒì‹± í•¨ìˆ˜ (ì‰¼í‘œ, 'ì›' ì œê±°)
        const parsePrice = (element) => {
            if (!element || !element.textContent) return 0;
            return parseInt(element.textContent.replace(/[^\d]/g, ''), 10) || 0;
        };

        // 2. í˜„ì¬ ê°’ ì½ê¸°
        let usedPoints = parseInt(pointsInput.value, 10) || 0;
        const maxPoints = parseInt(pointsInput.getAttribute('max') || '0', 10); // inputì˜ max ì†ì„±ê°’
        const currentPointsStr = document.getElementById('current-points')?.textContent.replace(/[^\d]/g, '');
        const availablePoints = parseInt(currentPointsStr, 10) || 0; // ì‹¤ì œ ë³´ìœ  í¬ì¸íŠ¸


        // â–¼â–¼â–¼ [ìˆ˜ì •] ìƒí’ˆ ê¸ˆì•¡(subtotal)ê³¼ í¬ì¥ë¹„(packagingTotal) ê³„ì‚° â–¼â–¼â–¼
        let subtotal = 0;
        let packagingTotal = 0;
        document.querySelectorAll('.order-item').forEach(item => {
            const salePrice = parseFloat(item.dataset.salePrice) || 0;
            const quantity = parseInt(item.dataset.quantity, 10) || 0;
            subtotal += salePrice * quantity;

            // ê° ì•„ì´í…œì— ì €ì¥ëœ í¬ì¥ì§€ ê°€ê²© * ìˆ˜ëŸ‰
            const packagingPrice = parseFloat(item.dataset.packagingPrice) || 0;
            packagingTotal += packagingPrice * quantity;
        });

        // í™”ë©´ì— ìƒí’ˆ ê¸ˆì•¡ ì—…ë°ì´íŠ¸
        totalBookPriceEl.textContent = `${subtotal.toLocaleString('ko-KR')}ì›`;

        // í™”ë©´ì— í¬ì¥ë¹„ ì—…ë°ì´íŠ¸
        packagingTotalRow.innerHTML = `<span>í¬ì¥ë¹„</span><span>+${packagingTotal.toLocaleString('ko-KR')}ì›</span>`;
        if (packagingTotal === 0) {
            packagingTotalRow.style.display = 'none'; // í¬ì¥ë¹„ê°€ 0ì›ì´ë©´ ìˆ¨ê¹€
        } else {
            packagingTotalRow.style.display = 'flex'; // 0ì› ì•„ë‹ˆë©´ í‘œì‹œ
        }
        // â–²â–²â–² [ìˆ˜ì •] ìƒí’ˆ ê¸ˆì•¡(subtotal)ê³¼ í¬ì¥ë¹„(packagingTotal) ê³„ì‚° â–²â–²â–²
        const deliveryFee = parsePrice(deliveryFeeEl);

        const totalBeforeDiscount = subtotal + packagingTotal + deliveryFee;
        const maxPointsFromBalance = Math.min(maxPoints, availablePoints);
        const effectiveMaxPoints = Math.min(maxPointsFromBalance, totalBeforeDiscount);

        console.log("ê³„ì‚°ëœ ìµœëŒ€ ì‚¬ìš© ê°€ëŠ¥ í¬ì¸íŠ¸:", effectiveMaxPoints); // <--- ë¡œê·¸ ì¶”ê°€!

        // 3. í¬ì¸íŠ¸ ìœ íš¨ì„± ê²€ì‚¬ ë° ì¡°ì •
        if (usedPoints < 0) {
            usedPoints = 0;
            pointsInput.value = 0; // ìŒìˆ˜ ì…ë ¥ ì‹œ 0ìœ¼ë¡œ ë³€ê²½
        }
        if (usedPoints > effectiveMaxPoints) {
            usedPoints = effectiveMaxPoints;
            pointsInput.value = usedPoints; // ìµœëŒ€ê°’ ì´ˆê³¼ ì‹œ ìµœëŒ€ê°’ìœ¼ë¡œ ë³€ê²½
        }

        // 4. í• ì¸ ê¸ˆì•¡ ê³„ì‚° (1í¬ì¸íŠ¸ = 1ì›ìœ¼ë¡œ ê°€ì •)
        const pointDiscount = usedPoints;
        // const couponDiscount = parsePrice(couponDiscountAmountEl); // (ì¿ í° êµ¬í˜„ ì‹œ)
        const couponDiscount = 0; // ì„ì‹œ

        // 5. í• ì¸ ê¸ˆì•¡ í‘œì‹œ ì—…ë°ì´íŠ¸
        if (pointDiscount > 0) {
            pointsDiscountAmountEl.textContent = `-${pointDiscount.toLocaleString('ko-KR')}ì›`;
            pointsDiscountRowEl.style.display = 'flex'; // í• ì¸ í–‰ ë³´ì´ê¸°
        } else {
            pointsDiscountAmountEl.textContent = '-0ì›';
            pointsDiscountRowEl.style.display = 'none'; // í• ì¸ í–‰ ìˆ¨ê¸°ê¸°
        }

        // (ì¿ í° í• ì¸ í‘œì‹œ ì—…ë°ì´íŠ¸ ë¡œì§ ì¶”ê°€)

        // 6. ìµœì¢… ê²°ì œ ê¸ˆì•¡ ê³„ì‚°
        // (ìƒí’ˆê¸ˆì•¡ + í¬ì¥ë¹„ + ë°°ì†¡ë¹„) - í• ì¸
        const finalPrice = Math.max(0, totalBeforeDiscount - pointDiscount - couponDiscount);

        // 7. ìµœì¢… ê²°ì œ ê¸ˆì•¡ ë° ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        actualOrderPriceEl.textContent = `${finalPrice.toLocaleString('ko-KR')}ì›`;
        paymentButton.textContent = `${finalPrice.toLocaleString('ko-KR')}ì› ê²°ì œí•˜ê¸°`;
    }

    function sample6_execDaumPostcode() {
        new daum.Postcode({
            oncomplete: function (data) {
                //  íŒì—…ì—ì„œ ê²€ìƒ‰ ê²°ê³¼ í•­ëª©ì„ í´ë¦­í–ˆì„ ë•Œ ì‹¤í–‰í•  ì½”ë“œë¥¼ ì‘ì„±í•˜ëŠ” ë¶€ë¶„
                var addr = '';
                var extraAddr = '';

                // ì‚¬ìš©ìê°€ ì„ íƒí•œ ì£¼ì†Œ íƒ€ì…ì— ë”°ë¼ í•´ë‹¹ ì£¼ì†Œ ê°’ì„ ê°€ì ¸ì˜´
                if (data.userSelectedType !== 'R') { // ì‚¬ìš©ìê°€ ë„ë¡œëª…ì„ ì„ íƒí•˜ì§€ ì•Šì•˜ì„ ê²½ìš°
                    alert('ì§€ë²ˆ ì£¼ì†Œê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. ë„ë¡œëª… ì£¼ì†Œë¡œ ë°˜ì˜ë©ë‹ˆë‹¤.');
                }

                addr = data.roadAddress;

                // ì‚¬ìš©ìê°€ ì„ íƒí•œ ì£¼ì†Œê°€ ë„ë¡œëª… íƒ€ì…ì¼ë•Œ ì°¸ê³ í•­ëª©ì„ ì¡°í•©í•œë‹¤.
                if (data.userSelectedType === 'R') {
                    // ë²•ì •ë™ëª…ì´ ìˆì„ ê²½ìš° ì¶”ê°€í•œë‹¤. (ë²•ì •ë¦¬ëŠ” ì œì™¸)
                    // ë²•ì •ë™ì˜ ê²½ìš° ë§ˆì§€ë§‰ ë¬¸ìê°€ "ë™/ë¡œ/ê°€"ë¡œ ëë‚œë‹¤.
                    if (data.bname !== '' && /[ë™|ë¡œ|ê°€]$/g.test(data.bname)) {
                        extraAddr += data.bname;
                    }
                    // ê±´ë¬¼ëª…ì´ ìˆê³ , ê³µë™ì£¼íƒì¼ ê²½ìš° ì¶”ê°€í•œë‹¤.
                    if (data.buildingName !== '' && data.apartment === 'Y') {
                        extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                    }
                    // í‘œì‹œí•  ì°¸ê³ í•­ëª©ì´ ìˆì„ ê²½ìš°, ê´„í˜¸ê¹Œì§€ ì¶”ê°€í•œ ìµœì¢… ë¬¸ìì—´ì„ ë§Œë“ ë‹¤.
                    if (extraAddr !== '') {
                        extraAddr = ' (' + extraAddr + ')';
                    }
                    // ì¡°í•©ëœ ì°¸ê³ í•­ëª©ì„ í•´ë‹¹ í•„ë“œì— ë„£ëŠ”ë‹¤.
                    document.getElementById("address-extra").value = extraAddr;

                } else {
                    document.getElementById("address-extra").value = '';
                }

                document.getElementById('zip').value = data.zonecode;
                document.getElementById("address").value = addr;
                document.getElementById("address-detail").focus();
            }
        }).open();
    }

    document.addEventListener('DOMContentLoaded', () => {
        // 1. "í¬ì¥ì§€ ì„ íƒ" ëª¨ë‹¬ ìš”ì†Œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const packagingModal = document.getElementById('packagingSelectModal');
        if (packagingModal) {
            // 2. ëª¨ë‹¬ì´ ì—´ë¦¬ê¸° 'ì§ì „'ì— ì‹¤í–‰ë˜ëŠ” ì´ë²¤íŠ¸ë¥¼ ê°ì§€í•©ë‹ˆë‹¤.
            packagingModal.addEventListener('show.bs.modal', function (event) {
                // 3. ì–´ë–¤ ë²„íŠ¼ì´ ëª¨ë‹¬ì„ ì—´ì—ˆëŠ”ì§€ ê°€ì ¸ì˜µë‹ˆë‹¤.
                const button = event.relatedTarget;
                // 4. ë²„íŠ¼ì— ì‹¬ì–´ë‘” 'data-order-item-id' ì†ì„± ê°’ì„ ì½ì–´ì˜µë‹ˆë‹¤.
                const orderItemId = button.dataset.orderItemId;
                // 5. ëª¨ë‹¬ ì•ˆì˜ ìˆ¨ê²¨ì§„(hidden) inputì„ ì°¾ìŠµë‹ˆë‹¤.
                const hiddenInput = document.getElementById('modal_order_item_id');
                // 6. ìˆ¨ê²¨ì§„ inputì˜ ê°’(value)ì— ìƒí’ˆ IDë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
                hiddenInput.value = orderItemId;
                // 7. (ì„ íƒ) ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œë§ˆë‹¤ "í¬ì¥ ì•ˆ í•¨"ì„ ê¸°ë³¸ìœ¼ë¡œ ì²´í¬
                const defaultRadio = packagingModal.querySelector('input[name="packagingId"][value="0"]');
                if (defaultRadio) {
                    defaultRadio.checked = true;
                }
            });
        }
    });

    function initPackagingModal() {
        const packagingModal = document.getElementById('packagingSelectModal');
        const savePackagingButton = document.getElementById('savePackagingButton');
        if (!packagingModal || !savePackagingButton) return;

        // ... (ëª¨ë‹¬ ì—´ë¦´ ë•Œ ë¡œì§ì€ ê·¸ëŒ€ë¡œ) ...

        // 'ì ìš©' ë²„íŠ¼ í´ë¦­ ì‹œ
        savePackagingButton.addEventListener('click', () => {
            const bookId = document.getElementById('modal_order_item_id').value;
            const selectedRadio = packagingModal.querySelector('input[name="packagingId"]:checked');
            if (!selectedRadio) return;

            const packagingId = selectedRadio.value;
            const label = selectedRadio.closest('label');

            const priceText = label.querySelector('.text-muted').textContent;
            const packagingPrice = parseInt(priceText.replace(/[^\d]/g, ''), 10) || 0;

            const nameElement = label.querySelector('strong, span:not(.text-muted)');
            const packagingName = nameElement ? nameElement.textContent : 'í¬ì¥ ì„ íƒë¨';

            const orderItemDiv = document.querySelector(`.order-item[data-book-id="${bookId}"]`);
            const triggerButton = document.querySelector(`button[data-order-item-id="${bookId}"]`);

            if (orderItemDiv && triggerButton) {
                orderItemDiv.dataset.packagingId = packagingId;
                orderItemDiv.dataset.packagingPrice = packagingPrice;

                // ëª¨ë“  ìƒ‰ìƒ í´ë˜ìŠ¤ë¥¼ ì œê±°í•˜ì—¬ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
                triggerButton.classList.remove('btn-success', 'btn-dark', 'btn-outline-secondary', 'text-white');

                if (packagingId === '0') {
                    // 'í¬ì¥ ì•ˆ í•¨' ì„ íƒ ì‹œ (ê¸°ë³¸ê°’)
                    triggerButton.innerHTML = '<i class="bi bi-box-seam me-1"></i> í¬ì¥ ì„ íƒ';
                    triggerButton.classList.add('btn-outline-secondary'); // ê¸°ë³¸ íšŒìƒ‰ í…Œë‘ë¦¬ ë²„íŠ¼
                } else {
                    // í¬ì¥ ì„ íƒ ì‹œ
                    triggerButton.innerHTML = `<i class="bi bi-check-lg me-1"></i> ${packagingName}`;
                    triggerButton.classList.add('btn', 'btn-dark', 'text-white'); // ê²€ì€ìƒ‰ ë°°ê²½, í°ìƒ‰ í…ìŠ¤íŠ¸
                }
            }

            updatePriceSummary();

            const modalInstance = bootstrap.Modal.getInstance(packagingModal);
            modalInstance.hide();

            if (triggerButton) {
                triggerButton.focus();
            }
        });
    }


    function initCouponSelection() {
        const selectCouponBtn = document.getElementById('select-coupon-btn');
        const couponModal = document.getElementById('couponSelectModal');
        const applyCouponButton = document.getElementById('applyCouponButton');

        if (!selectCouponBtn || !couponModal) return;

        selectCouponBtn.addEventListener('click', () => {
            const modalInstance = new bootstrap.Modal(couponModal);
            modalInstance.show();
        });

        if (applyCouponButton) {
            applyCouponButton.addEventListener('click', () => {

                // 1. ëª¨ë‹¬ ë‹«ê¸°
                const modalInstance = bootstrap.Modal.getInstance(couponModal);
                if (modalInstance) modalInstance.hide();

                // ğŸŒŸğŸŒŸğŸŒŸ [ìµœì¢… í•´ê²°] ì”ìƒ ê°•ì œ ë™ê¸° ì œê±° ğŸŒŸğŸŒŸğŸŒŸ
                // 'ì ìš©' ë²„íŠ¼ í´ë¦­ ì§í›„, ë‹¤ë¥¸ ë™ì‘ë³´ë‹¤ ë¨¼ì € í˜ì´ì§€ë¥¼ ë³µêµ¬í•©ë‹ˆë‹¤.
                document.body.classList.remove('modal-open');
                // document.body.style.paddingRight = ''; // íŒ¨ë”© ë¬¸ì œ ë°œìƒ ì‹œ ì¶”ê°€
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(backdrop => backdrop.remove());

                // 2. ê°€ê²© ìš”ì•½ ì—…ë°ì´íŠ¸ (í˜ì´ì§€ ë³µêµ¬ í›„ ì‹¤í–‰)
                updatePriceSummary();
            });
        }

        // 2. hidden.bs.modal ì´ë²¤íŠ¸: ì·¨ì†Œ/ì™¸ë¶€ í´ë¦­ ì‹œ ì”ìƒ ì œê±° (ë™ì¼í•˜ê²Œ ìœ ì§€)
        //    ì´ ì½”ë“œëŠ” 'ì·¨ì†Œ' ë²„íŠ¼ì„ ìœ„í•´ í•„ìš”í•˜ë©°, 'ì ìš©' ë²„íŠ¼ í´ë¦­ ì‹œ ìœ„ ë¡œì§ì´ ë” ë¹¨ë¦¬ ì‹¤í–‰ë©ë‹ˆë‹¤.
        couponModal.addEventListener('hidden.bs.modal', function () {
            document.body.classList.remove('modal-open');
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());

            // ğŸ’¡ ì¶”ê°€: bodyì— ì§ì ‘ styleì´ ë‚¨ì•„ìˆì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•˜ì—¬ styleë„ ì œê±°
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');
        });
    }

</script>
<div class="modal fade" id="packagingSelectModal" tabindex="-1" aria-labelledby="packagingModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="packagingModalLabel">í¬ì¥ì§€ ì„ íƒ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <p>ì´ ìƒí’ˆì— ì ìš©í•  í¬ì¥ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>

                <form id="packagingSelectForm">

                    <input type="hidden" id="modal_order_item_id" name="orderItemId">

                    <div class="list-group">
                        <label class="list-group-item list-group-item-action d-flex align-items-center">
                            <input class="form-check-input me-3" type="radio" name="packagingId" value="0" checked>
                            <i class="bi bi-x-circle me-2 text-danger"></i>
                            <strong>í¬ì¥ ì•ˆ í•¨</strong>
                            <span class="text-muted ms-auto">(0ì›)</span>
                        </label>

                        <th:block th:each="pack : ${packagingOptions}">
                            <label class="list-group-item list-group-item-action d-flex align-items-center">
                                <input class="form-check-input me-3" type="radio" name="packagingId"
                                       th:value="${pack.packagingId}">

                                <img th:src="${pack.packagingImageUrl}" class="img-thumbnail me-2"
                                     style="width: 50px; height: 50px; object-fit: cover;"
                                     th:if="${pack.packagingImageUrl != null and pack.packagingImageUrl != ''}">

                                <span th:text="${pack.packagingName}">í¬ì¥ì§€ ì´ë¦„</span>

                                <span class="text-muted ms-auto"
                                      th:text="'(+' + ${#numbers.formatInteger(pack.packagingPrice, 0, 'COMMA')} + 'ì›)'">
                  (+1,000ì›)
                </span>
                            </label>
                        </th:block>

                        <tr th:if="${packagingOptions == null or #lists.isEmpty(packagingOptions)}">
                            <td colspan="4" class="text-center py-4">
                                ë“±ë¡ëœ í¬ì¥ì§€ ì •ì±…ì´ ì—†ìŠµë‹ˆë‹¤.
                            </td>
                        </tr>
                    </div>
                </form>

            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" id="savePackagingButton">ì ìš©</button>
            </div>
        </div>
    </div>
</div>
<!--ì¿ í° modal-->
<div class="modal fade" id="couponSelectModal" tabindex="-1" aria-labelledby="couponModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="couponModalLabel">ì‚¬ìš© ê°€ëŠ¥í•œ ì¿ í° ì„ íƒ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="selected_coupon_id_hidden" name="selectedCouponId" value="">
                <input type="hidden" id="coupon_discount_amount_hidden" value="0">

                <div th:if="${usableCoupons == null || #lists.isEmpty(usableCoupons)}">
                    <p class="text-center text-muted">í˜„ì¬ ì£¼ë¬¸ ìƒí’ˆì— ì ìš© ê°€ëŠ¥í•œ ì¿ í°ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
                <div th:unless="${usableCoupons == null || #lists.isEmpty(usableCoupons)}" class="list-group">

                    <label class="list-group-item list-group-item-action d-flex align-items-center">
                        <input class="form-check-input me-3 coupon-radio" type="radio" name="couponSelect" value="0" checked data-name="ì¿ í° ë¯¸ì ìš©">
                        <i class="bi bi-x-circle me-2 text-danger"></i>
                        <strong>ì¿ í° ë¯¸ì ìš©</strong>
                        <span class="text-muted ms-auto">(í• ì¸ ì—†ìŒ)</span>
                    </label>

                    <th:block th:each="coupon : ${usableCoupons}">
                        <label class="list-group-item list-group-item-action d-flex align-items-center"
                               th:data-coupon-id="${coupon.couponId}"
                               th:data-discount-value="${coupon.discountValue}"
                               th:data-discount-type="${coupon.discountType}"
                               th:data-criterion-price="${coupon.criterionPrice}"
                               th:data-discount-limit="${coupon.discountLimit}">

                            <input class="form-check-input me-3 coupon-radio" type="radio" name="couponSelect"
                                   th:id="'coupon-' + ${coupon.couponId}"
                                   th:value="${coupon.couponId}"
                                   th:data-coupon-name="${coupon.couponName}">

                            <div class="flex-grow-1">
                                <strong th:text="${coupon.couponName}">ì¿ í° ì´ë¦„</strong>
                                <span class="badge bg-secondary ms-2" th:text="${coupon.policyTargetType}">WELCOME</span>
                                <small class="text-muted d-block"
                                       th:text="'ë§Œë£Œì¼: ' + ${#temporals.format(coupon.expiredDate, 'yyyy-MM-dd')}">ë§Œë£Œì¼</small>
                                <small class="text-muted d-block"
                                       th:text="'ìµœì†Œ ì£¼ë¬¸ì•¡: ' + ${#numbers.formatInteger(coupon.criterionPrice, 0, 'COMMA')} + 'ì›'">ìµœì†Œ ì£¼ë¬¸ì•¡</small>
                            </div>

                            <span class="fw-bold text-success ms-auto"
                                  th:text="${coupon.discountType == 'RATE' ? (coupon.discountValue + '% í• ì¸') : (#numbers.formatInteger(coupon.discountValue, 0, 'COMMA') + 'ì› í• ì¸')}">
                                í• ì¸ ê¸ˆì•¡/ìœ¨
                            </span>
                            <small th:if="${coupon.discountType == 'RATE'}" class="text-muted d-block ms-2"
                                   th:text="'(ìµœëŒ€ ' + ${#numbers.formatInteger(coupon.discountLimit, 0, 'COMMA')} + 'ì›)'"></small>
                        </label>
                    </th:block>

                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" id="applyCouponButton">ì ìš©</button>
            </div>
        </div>
    </div>
</div>

</body>
</html>