<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Checkout - NiceShop Bootstrap Template</title>
    <meta name="description" content="">
    <meta name="keywords" content="">

    <th:block th:replace="~{fragments/file_link :: linkInfo}"></th:block>
    <script src="//js.tosspayments.com/v1"></script>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>

<body class="checkout-page">

<div th:replace="~{fragments/common_header :: commonHeader}"></div>
<main class="main">

    <!-- Page Title -->
    <div class="page-title light-background">
        <div class="container d-lg-flex justify-content-between align-items-center">
            <h1 class="mb-2 mb-lg-0">주문</h1>
            <nav class="breadcrumbs">
                <ol>
                    <li><a th:hred="@{/}">Home</a></li>
                    <li class="current">주문</li>
                </ol>
            </nav>
        </div>
    </div><!-- End Page Title -->

    <!-- Checkout Section -->
    <section id="checkout" class="checkout section">

        <div class="container" data-aos="fade-up" data-aos-delay="100">

            <form id="checkout-form">
                <div class="row">
                    <div class="col-lg-7">
                        <div class="checkout-container" data-aos="fade-up">
                            <div class="checkout-section" id="order-items-list">
                                <div class="section-header">
                                    <div class="section-number">1</div>
                                    <h3>주문 상품</h3>
                                </div>
                                <div class="section-content">
                                    <div class="order-items-container">

                                        <div class="order-item"
                                             th:each="item : ${orderItem}"
                                             th:data-book-id="${item.bookId}"
                                             th:data-quantity="${item.quantity}"
                                             th:data-sale-price="${item.salePrice}"
                                             th:data-regular-price="${item.regularPrice}"
                                             th:data-book-name="${item.bookName}"
                                             th:data-image-url="${item.imageUrl}"
                                             th:data-publisher-id="${item.publisher().publisherId()}"
                                             th:data-publisher-name="${item.publisher().publisherName()}"
                                        >

                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="order-item-image me-3">
                                                    <img th:src="${item.imageUrl}" alt="Product" class="img-fluid"
                                                         style="width: 80px; height: auto;">
                                                </div>

                                                <div class="order-item-details flex-grow-1 me-3">
                                                    <h5 class="mb-1" th:text="${item.bookName}">도서 제목</h5>

                                                    <p class="text-muted small mb-0">
                                                        <span th:text="${item.publisher().publisherName()}">출판사</span>
                                                        <span class="mx-1">|</span>
                                                        <th:block th:each="contributor, iter : ${item.contributors()}">
                                                            <span th:text="${contributor.contributorName()}">저자명</span>
                                                            <span th:text="${contributor.contributorRole()} ? ' (' + ${contributor.contributorRole()} + ')' : ''">(저)</span>
                                                            <span th:if="!${iter.last}">, </span>
                                                        </th:block>
                                                    </p>

                                                </div>

                                                <div class="order-item-price mb-2">
                                                    <div class="mb-1">
                                                        <span class="quantity"
                                                              th:text="${item.quantity} + ' ×'">1 ×</span>
                                                    </div>
                                                    <span class="price-sale fw-bold fs-5"
                                                          th:text="${#numbers.formatInteger(item.salePrice, 0, 'COMMA') + '원'}">
                                                      10,000원
                                                    </span>
                                                    <span class="price-regular text-muted text-decoration-line-through ms-1"
                                                          style="font-size: 0.9em;"
                                                          th:if="${item.regularPrice > item.salePrice}"
                                                          th:text="${#numbers.formatInteger(item.regularPrice, 0, 'COMMA') + '원'}">
                                                      16,000원
                                                    </span>
                                                </div>

                                                <div th:if="${item.isPack}">
                                                    <button type="button" class="btn btn-outline-secondary btn-sm"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#packagingSelectModal"
                                                            th:data-order-item-id="${item.bookId}"><i
                                                            class="bi bi-box-seam me-1"></i> 포장 선택
                                                    </button>
                                                </div>

                                                <div class="contributor-data" style="display: none;">
                                                    <div class="contributor"
                                                         th:each="c : ${item.contributors()}"
                                                         th:data-contributor-id="${c.contributorId()}"
                                                         th:data-contributor-name="${c.contributorName()}"
                                                         th:data-contributor-role="${c.contributorRole()}">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="checkout-section" id="customer-info">
                                <div class="section-header">
                                    <div class="section-number">2</div>
                                    <h3>주문자 정보</h3>
                                </div>
                                <div class="section-content">
                                    <div class="row">
                                        <div class="col-md-12 form-group">
                                            <label for="name">이름</label>
                                            <input type="text" name="name" class="form-control" id="name"
                                                   placeholder="주문자 이름" required="">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="phone">연락처</label>
                                        <input type="tel" class="form-control" name="phone" id="phone"
                                               placeholder="010-1234-5678" required="">
                                    </div>
                                </div>
                            </div>

                            <div class="checkout-section" id="shipping-address">
                                <div class="section-header">
                                    <div class="section-number">3</div>
                                    <h3>배송지 정보</h3>
                                </div>
                                <div class="section-content">
                                    <div class="form-group">
                                        <label for="zip">우편번호</label>
                                        <div class="input-group">
                                            <input type="text" name="zip" class="form-control" id="zip"
                                                   placeholder="우편번호" required="" readonly>
                                            <button class="btn btn-outline-secondary" type="button" id="find-zip-btn">
                                                우편번호 찾기
                                            </button>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="address">주소</label>
                                        <input type="text" class="form-control" name="address" id="address"
                                               placeholder="기본 주소" readonly>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="address-detail">상세주소</label>
                                                <input type="text" class="form-control" name="address-detail"
                                                       id="address-detail" placeholder="상세주소 (아파트 동, 호수 등)">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="address-extra">참고 항목</label>
                                                <input type="text" class="form-control" name="address-extra"
                                                       id="address-extra" placeholder="참고항목" readonly>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="section-content">
                                        <div class="form-group mt-3">
                                            <label class="form-label">배송일 선택 <small class="text-muted">(도착 예상일)</small></label>
                                            <div class="delivery-date-buttons d-flex flex-wrap gap-2">
                                                <th:block th:each="dateInfo, iterStat : ${deliveryDates}">
                                                    <input type="radio" class="btn-check" name="deliveryDate"
                                                           th:id="'date-' + ${dateInfo.valueDate}"
                                                           th:value="${dateInfo.valueDate}"
                                                           th:checked="${iterStat.first}"
                                                           autocomplete="off">
                                                    <label class="btn btn-outline-secondary"
                                                           th:for="'date-' + ${dateInfo.valueDate}"
                                                           th:text="${dateInfo.dayName} + ' (' + ${dateInfo.displayDate} + ')'">
                                                        날짜 버튼
                                                    </label>
                                                </th:block>
                                            </div>
                                            <small class="text-muted d-block mt-1">주말 및 공휴일 제외, 5 영업일 이내 선택
                                                가능합니다.</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div class="checkout-section" id="discount-section">
                            <div class="section-header">
                                <div class="section-number">4</div>
                                <h3>할인 적용</h3>
                            </div>
                            <div class="section-content">
                                <div class="mb-3 row align-items-center">
                                    <label class="col-sm-2 col-form-label"><i class="bi bi-coin me-1"></i>보유</label>
                                    <div class="col-sm-10">
                                        <div class="fw-bold" id="current-points"
                                             th:text="${userPoint != null ? #numbers.formatInteger(userPoint, 0, 'COMMA') + ' P' : '0 P'}">
                                            5,000 P
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3 row align-items-center">
                                    <label for="points-to-use" class="col-sm-2 col-form-label">사용</label>
                                    <div class="col-sm-10">
                                        <div class="input-group">
                                            <input type="number" class="form-control text-end" id="points-to-use"
                                                   name="usedPoints" placeholder="0" min="0"
                                                   th:max="${userPoint ?: 0}" step="1">
                                            <span class="input-group-text">P</span>
                                            <button class="btn btn-outline-secondary" type="button"
                                                    id="apply-all-points-btn">모두 사용
                                            </button>
                                        </div>
                                        <small class="text-muted d-block mt-1"
                                               th:text="'(최대 ' + (${userPoint != null ? #numbers.formatInteger(userPoint, 0, 'COMMA') : 0}) + ' P 사용 가능)'">(최대
                                            5,000 P 사용 가능)</small></div>
                                </div>

                                <div class="row align-items-center">
                                    <label class="col-sm-2 col-form-label"><i
                                            class="bi bi-ticket-perc me-1"></i>쿠폰</label>
                                    <div class="col-sm-10">
                                        <button type="button" class="btn btn-outline-secondary" id="select-coupon-btn"
                                                data-bs-toggle="modal" data-bs-target="#couponSelectModal">
                                            사용 가능한 쿠폰 선택하기
                                        </button>
                                        <div id="selected-coupon-info" class="mt-2 text-success fw-semibold"
                                             style="display: none;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-5">
                        <div class="order-summary" data-aos="fade-left" data-aos-delay="200">
                            <div class="order-summary-header">
                                <h3>주문 요약</h3>
                                <span class="item-count" th:text="${totalQuantity} + '개 상품'">0개 상품</span>
                            </div>

                            <div class="order-summary-content">
                                <div class="order-totals">
                                    <div class="order-subtotal d-flex justify-content-between">
                                        <span>상품 금액</span>
                                        <span id="total-book-price"
                                              th:text="${#numbers.formatInteger(totalBookPrice, 0, 'COMMA') + '원'}">0원</span>
                                    </div>

                                    <div class="order-shipping d-flex justify-content-between">
                                        <span>배송비</span>
                                        <span id="delivery-fee"
                                              th:text="${deliveryFee != null ? #numbers.formatInteger(deliveryFee, 0, 'COMMA') : '0'} + '원'">0원</span>
                                    </div>

                                    <div class="order-points-discount d-flex justify-content-between text-danger"
                                         style="display: none;">
                                        <span>포인트 할인</span>
                                        <span id="points-discount-amount">-0원</span>
                                    </div>

                                    <div class="order-coupon-discount d-flex justify-content-between text-danger"
                                         style="display: none;">
                                        <span>쿠폰 할인</span>
                                        <span id="coupon-discount-amount">-0원</span>
                                    </div>
                                    <hr class="my-2">

                                    <div class="order-total d-flex justify-content-between fw-bold">
                                        <span>최종 결제 금액</span>
                                        <span id="actual-order-price"
                                              th:text="${actualOrderPrice != null ? #numbers.formatInteger(actualOrderPrice, 0, 'COMMA') : '0'} + '원'">
                      0원
                    </span>
                                    </div>
                                </div>

                                <div class="d-grid mt-4">
                                    <button type="button" id="payment-button" class="btn btn-primary btn-lg"
                                            th:text="${#numbers.formatInteger(actualOrderPrice, 0, 'COMMA') + '원 결제하기'}">
                                        0원 결제하기
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checkout-section" id="payment-method">
                        <div class="section-header">
                            <div class="section-number">5</div>
                            <h3>결제 방법</h3>
                        </div>
                        <div class="section-content">

                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="tossPay"
                                       value="TOSS_EASY_PAY">
                                <label class="form-check-label" for="tossPay">
                                    <strong>토스 간편 결제</strong>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
            <!-- Terms and Privacy Modals -->
            <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="termsModalLabel">Terms and Conditions</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam in dui mauris. Vivamus
                                hendrerit arcu sed erat molestie vehicula. Sed auctor neque eu tellus rhoncus ut
                                eleifend nibh porttitor. Ut in nulla enim. Phasellus molestie magna non est bibendum non
                                venenatis nisl tempor.</p>
                            <p>Suspendisse in orci enim. Vivamus hendrerit arcu sed erat molestie vehicula. Sed auctor
                                neque eu tellus rhoncus ut eleifend nibh porttitor. Ut in nulla enim. Phasellus molestie
                                magna non est bibendum non venenatis nisl tempor.</p>
                            <p>Suspendisse in orci enim. Vivamus hendrerit arcu sed erat molestie vehicula. Sed auctor
                                neque eu tellus rhoncus ut eleifend nibh porttitor. Ut in nulla enim. Phasellus molestie
                                magna non est bibendum non venenatis nisl tempor.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">I Understand</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="privacyModal" tabindex="-1" aria-labelledby="privacyModalLabel"
                 aria-hidden="true">
                <div class="modal-dialog modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="privacyModalLabel">Privacy Policy</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam in dui mauris. Vivamus
                                hendrerit arcu sed erat molestie vehicula. Sed auctor neque eu tellus rhoncus ut
                                eleifend nibh porttitor. Ut in nulla enim.</p>
                            <p>Suspendisse in orci enim. Vivamus hendrerit arcu sed erat molestie vehicula. Sed auctor
                                neque eu tellus rhoncus ut eleifend nibh porttitor. Ut in nulla enim. Phasellus molestie
                                magna non est bibendum non venenatis nisl tempor.</p>
                            <p>Suspendisse in orci enim. Vivamus hendrerit arcu sed erat molestie vehicula. Sed auctor
                                neque eu tellus rhoncus ut eleifend nibh porttitor. Ut in nulla enim. Phasellus molestie
                                magna non est bibendum non venenatis nisl tempor.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">I Understand</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section><!-- /Checkout Section -->
</main>

<div th:replace="~{fragments/common_footer :: commonFooter}"></div>
<!-- Scroll Top -->
<a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i
        class="bi bi-arrow-up-short"></i></a>
<!-- Preloader -->
<div id="preloader"></div>

<!-- Vendor JS Files -->
<script th:src="@{/assets/vendor/bootstrap/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/assets/vendor/php-email-form/validate.js}"></script>
<script th:src="@{/assets/vendor/swiper/swiper-bundle.min.js}"></script>
<script th:src="@{/assets/vendor/aos/aos.js}"></script>
<script th:src="@{/assets/vendor/glightbox/js/glightbox.min.js}"></script>
<script th:src="@{/assets/vendor/drift-zoom/Drift.min.js}"></script>
<script th:src="@{/assets/vendor/purecounter/purecounter_vanilla.js}"></script>

<!-- Main JS File -->
<script th:src="@{/assets/js/main.js}"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        initPhoneHyphen();
        const TOSS_CLIENT_KEY = /*[[${tossClientIKey}]]*/ 'test_ck_nRQoOaPz8L4QRwM6lGa58y47BMw6';
        initTossPayments(TOSS_CLIENT_KEY);
        initPointInputListener();
        initApplyAllPointsButton();
        initPackagingModal();
        initCouponSelection();

        const findZipBtn = document.getElementById('find-zip-btn');
        if (findZipBtn) {
            findZipBtn.addEventListener('click', sample6_execDaumPostcode);
        }
    });

    function initPhoneHyphen() {
        const phoneInput = document.getElementById('phone');
        if (!phoneInput) return;

        const formatPhoneNumber = (value) => {
            if (!value) return value;
            let phoneNumber = value.replace(/[^\d]/g, '');
            if (phoneNumber.length > 11) phoneNumber = phoneNumber.slice(0, 11);
            const len = phoneNumber.length;
            if (len < 4) return phoneNumber;
            if (len < 8) return `${phoneNumber.slice(0, 3)}-${phoneNumber.slice(3)}`;
            return `${phoneNumber.slice(0, 3)}-${phoneNumber.slice(3, 7)}-${phoneNumber.slice(7)}`;
        };

        phoneInput.addEventListener('input', (e) => {
            const target = e.target;
            const originalValue = target.value;
            const formattedValue = formatPhoneNumber(originalValue);
            // 커서 계산은 간단하게 처리 (정교화 가능)
            target.value = formattedValue;
        });
    }

    // 결제 금액 가져오기
    // 금액 파싱 함수 (이 함수 스코프 안에도 정의)
    const parsePrice = (priceValue) => {
        if (priceValue == null) return 0;
        const priceString = String(priceValue);
        return Number(priceString.replace(/[^\d]/g, '')) || 0;
    };

    function initTossPayments(clientKey) {
        const paymentButton = document.getElementById('payment-button');
        const actualOrderPriceEl = document.getElementById('actual-order-price'); // 요소 미리 찾아두기

        if (!paymentButton || !actualOrderPriceEl) {
            console.error("결제 버튼 또는 최종 금액 요소를 찾을 수 없습니다!");
            return;
        }
        var tossPayments = TossPayments(clientKey);

        paymentButton.addEventListener('click', async function () {

            const bookInfoRequestList = []; // 백엔드로 보낼 최종 리스트
            const orderItemElements = document.querySelectorAll('.order-item');

            orderItemElements.forEach(item => {
                const dataset = item.dataset;

                const publisher = {
                    publisherId: parseInt(dataset.publisherId, 10),
                    publisherName: dataset.publisherName
                };

                const contributors = [];
                const contributorElements = item.querySelectorAll('.contributor-data .contributor');

                contributorElements.forEach(c_item => {
                    contributors.push({
                        contributorId: parseInt(c_item.dataset.contributorId, 10),
                        contributorName: c_item.dataset.contributorName,
                        contributorRole: c_item.dataset.contributorRole
                    });
                });

                bookInfoRequestList.push({
                    bookId: parseInt(dataset.bookId, 10),
                    bookName: dataset.bookName,
                    imageUrl: dataset.imageUrl,
                    isPack: (dataset.isPack === 'true'),
                    regularPrice: parseFloat(dataset.regularPrice),
                    salePrice: parseFloat(dataset.salePrice),
                    publisher: publisher,
                    quantity: parseInt(dataset.quantity, 10),
                    contributors: contributors,
                    packagingId: parseInt(dataset.packagingId || '0', 10)
                });
            });

            console.log("bookInfoRequestList:", bookInfoRequestList);

            if (bookInfoRequestList.length === 0) {
                alert("주문할 상품이 없습니다.");
                return;
            }

            const customerName = document.getElementById('name')?.value.trim();
            const rawPhone = document.getElementById('phone')?.value;
            const phoneNumber = rawPhone ? rawPhone.replace(/[^\d]/g, '') : '';
            const zip = document.getElementById('zip')?.value;
            const address = document.getElementById('address')?.value;
            const addressDetail = document.getElementById('address-detail')?.value;
            const addressExtra = document.getElementById('address-extra')?.value;
            const totalBookPrice = parsePrice(document.getElementById('total-book-price')?.textContent);

            const currentFinalPrice = parsePrice(actualOrderPriceEl.textContent); // 미리 찾아둔 요소 사용

            const orderItems = document.querySelectorAll('.order-summary-content .order-item');
            let orderName = "주문 상품"; // 기본값
            if (orderItems.length > 0) {
                const firstItemName = orderItems[0].querySelector('.order-item-details h4')?.textContent.trim();
                if (firstItemName) {
                    if (orderItems.length > 1) {
                        orderName = `${firstItemName} 외 ${orderItems.length - 1}건`;
                    } else {
                        orderName = firstItemName;
                    }
                }
            }

            const selectedDeliveryArrivedDate = document.querySelector('input[name="deliveryDate"]:checked');
            const deliveryDateValue = selectedDeliveryArrivedDate ? selectedDeliveryArrivedDate.value : null;

            const orderPrepareRequest = {
                totalBookPrice: totalBookPrice,
                actualOrderPrice: currentFinalPrice,
                receiver: customerName,
                postCode: `${zip}`,
                receiverAddress: `${address}`,
                receiverAddressDetail: addressDetail,
                receiverAddressExtra: addressExtra,
                receiverPhone: phoneNumber,
                deliveryArrivedDate: deliveryDateValue,
                bookInfoRequestList: bookInfoRequestList
            };

            const tossPayRadio = document.getElementById('tossPay');

            // 최종 금액이 0보다 크고, 토스페이 라디오 버튼이 선택되지 않았으면 알림 후 중단
            if (currentFinalPrice > 0 && (!tossPayRadio || !tossPayRadio.checked)) {
                alert("결제 방법을 선택해주세요.");
                return; // 함수 실행 중단
            }

            console.log("전송할 객체:", orderPrepareRequest);
            console.log("실제 JSON:", JSON.stringify(orderPrepareRequest));

            try {
                const response = await fetch('/orders/prepare', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(orderPrepareRequest)
                });

                console.log("주문 준비 응답: {}", response)
                console.log("주문 준비 응답 바디: {}", response.body);
                console.log("주문 준비 응답 코드: {}", response.status);

                if (!response.ok) {
                    const err = await response.json().catch(() => ({message: '주문 준비 API 응답 실패.'}));
                    throw new Error(err.message || '주문 준비에 실패했습니다.');
                }
                const prepareResponse = await response.json();
                const orderIdFromServer = prepareResponse.orderNumber;
                if (!orderIdFromServer) {
                    throw new Error('주문 ID를 서버로부터 받지 못했습니다.');
                }

                if (currentFinalPrice === 0) {
                    // 회원 주문일 경우에만 0원 처리 (비회원은 위에서 이미 차단됨)
                    console.log("0원 주문: 성공 처리.");
                    window.location.href = window.location.origin + `/orders/success?orderNumber=${orderIdFromServer}`;
                } else {
                    // 유료 주문: 토스페이먼츠 호출
                    console.log("유료 주문: 토스페이먼츠 호출");
                    tossPayments.requestPayment('토스페이', {
                        orderId: orderIdFromServer,
                        amount: currentFinalPrice,
                        orderName: orderName,
                        customerName: prepareResponse.receiver,
                        successUrl: window.location.origin + "/payments/confirm",
                        failUrl: window.location.origin + "/payments/fail"
                    });
                }
            } catch (error) {
                console.error('주문 처리 중 오류: ', error);
                alert(error.message || '알 수 없는 오류가 발생하였습니다.');
            }
        });
    }

    /**
     * 포인트 입력 필드에 이벤트 리스너를 추가하는 함수
     */
    function initPointInputListener() {
        const pointsInput = document.getElementById('points-to-use');
        if (pointsInput) {
            console.log("포인트 입력 리스너 추가됨"); // <--- 로그 추가
            pointsInput.addEventListener('input', (event) => { // event 파라미터 추가
                console.log("포인트 입력 감지:", event.target.value); // <--- 로그 추가
                updatePriceSummary();
            });
        } else {
            console.error("ID 'points-to-use' 요소를 찾을 수 없음!"); // <--- 요소 못 찾을 때 로그 추가
        }
    }

    // --- [추가] '모두 사용' 버튼 클릭 이벤트 리스너 ---
    function initApplyAllPointsButton() {
        const applyAllBtn = document.getElementById('apply-all-points-btn');
        const pointsInput = document.getElementById('points-to-use');
        const totalBookPriceEl = document.getElementById('total-book-price');

        const parsePrice = (element) => {
            if (!element || !element.textContent) return 0;
            return parseInt(element.textContent.replace(/[^\d]/g, ''), 10) || 0;
        };

        if (applyAllBtn && pointsInput && totalBookPriceEl) {
            console.log("'모두 사용' 버튼 리스너 추가됨"); // <--- 로그 추가
            applyAllBtn.addEventListener('click', () => {
                const maxPointsInput = parseInt(pointsInput.getAttribute('max') || '0', 10);
                const currentPointsStr = document.getElementById('current-points')?.textContent.replace(/[^\d]/g, '');
                const availablePoints = parseInt(currentPointsStr, 10) || 0;
                const maxPointsFromBalance = Math.min(maxPointsInput, availablePoints);

                const subtotal = parsePrice(totalBookPriceEl);

                const maxPointsToUse = Math.min(maxPointsFromBalance, subtotal);

                pointsInput.value = maxPointsToUse;
                // 2. 그 다음 업데이트 함수 호출
                updatePriceSummary();
            });
        } else {
            console.error("ID 'apply-all-points-btn' 또는 'points-to-use' 요소를 찾을 수 없음!");
        }
    }

    /**
     * 최종 결제 금액 및 할인 내역을 업데이트하는 함수
     */
    function updatePriceSummary() {
        // 1. 필요한 DOM 요소 가져오기
        const pointsInput = document.getElementById('points-to-use');
        const pointsDiscountAmountEl = document.getElementById('points-discount-amount');
        const pointsDiscountRowEl = document.querySelector('.order-points-discount'); // 할인 행 전체 div
        const couponDiscountAmountEl = document.getElementById('coupon-discount-amount'); // (쿠폰 구현 시)
        const couponDiscountRowEl = document.querySelector('.order-coupon-discount'); // (쿠폰 구현 시)
        const totalBookPriceEl = document.getElementById('total-book-price');
        const deliveryFeeEl = document.getElementById('delivery-fee');
        const actualOrderPriceEl = document.getElementById('actual-order-price');
        const paymentButton = document.getElementById('payment-button');

        let packagingTotalRow = document.getElementById('order-packaging-total');
        // 포장비 행이 없으면 동적으로 생성
        if (!packagingTotalRow) {
            packagingTotalRow = document.createElement('div');
            packagingTotalRow.id = 'order-packaging-total';
            packagingTotalRow.className = 'order-shipping d-flex justify-content-between'; // 배송비와 같은 스타일 적용
            // 배송비(deliveryFeeEl)의 부모(order-totals)를 찾아 그 다음에 삽입
            deliveryFeeEl.parentNode.insertAdjacentElement('afterend', packagingTotalRow);
        }

        // 금액 파싱 함수 (쉼표, '원' 제거)
        const parsePrice = (element) => {
            if (!element || !element.textContent) return 0;
            return parseInt(element.textContent.replace(/[^\d]/g, ''), 10) || 0;
        };

        // 2. 현재 값 읽기
        let usedPoints = parseInt(pointsInput.value, 10) || 0;
        const maxPoints = parseInt(pointsInput.getAttribute('max') || '0', 10); // input의 max 속성값
        const currentPointsStr = document.getElementById('current-points')?.textContent.replace(/[^\d]/g, '');
        const availablePoints = parseInt(currentPointsStr, 10) || 0; // 실제 보유 포인트


        // ▼▼▼ [수정] 상품 금액(subtotal)과 포장비(packagingTotal) 계산 ▼▼▼
        let subtotal = 0;
        let packagingTotal = 0;
        document.querySelectorAll('.order-item').forEach(item => {
            const salePrice = parseFloat(item.dataset.salePrice) || 0;
            const quantity = parseInt(item.dataset.quantity, 10) || 0;
            subtotal += salePrice * quantity;

            // 각 아이템에 저장된 포장지 가격 * 수량
            const packagingPrice = parseFloat(item.dataset.packagingPrice) || 0;
            packagingTotal += packagingPrice * quantity;
        });

        // 화면에 상품 금액 업데이트
        totalBookPriceEl.textContent = `${subtotal.toLocaleString('ko-KR')}원`;

        // 화면에 포장비 업데이트
        packagingTotalRow.innerHTML = `<span>포장비</span><span>+${packagingTotal.toLocaleString('ko-KR')}원</span>`;
        if (packagingTotal === 0) {
            packagingTotalRow.style.display = 'none'; // 포장비가 0원이면 숨김
        } else {
            packagingTotalRow.style.display = 'flex'; // 0원 아니면 표시
        }
        // ▲▲▲ [수정] 상품 금액(subtotal)과 포장비(packagingTotal) 계산 ▲▲▲
        const deliveryFee = parsePrice(deliveryFeeEl);

        const totalBeforeDiscount = subtotal + packagingTotal + deliveryFee;
        const maxPointsFromBalance = Math.min(maxPoints, availablePoints);
        const effectiveMaxPoints = Math.min(maxPointsFromBalance, totalBeforeDiscount);

        console.log("계산된 최대 사용 가능 포인트:", effectiveMaxPoints); // <--- 로그 추가!

        // 3. 포인트 유효성 검사 및 조정
        if (usedPoints < 0) {
            usedPoints = 0;
            pointsInput.value = 0; // 음수 입력 시 0으로 변경
        }
        if (usedPoints > effectiveMaxPoints) {
            usedPoints = effectiveMaxPoints;
            pointsInput.value = usedPoints; // 최대값 초과 시 최대값으로 변경
        }

        // 4. 할인 금액 계산 (1포인트 = 1원으로 가정)
        const pointDiscount = usedPoints;
        // const couponDiscount = parsePrice(couponDiscountAmountEl); // (쿠폰 구현 시)
        const couponDiscount = document.getElementById('coupon_discount_amount_hidden').value;


        // 5. 할인 금액 표시 업데이트
        if (pointDiscount > 0) {
            pointsDiscountAmountEl.textContent = `-${pointDiscount.toLocaleString('ko-KR')}원`;
            pointsDiscountRowEl.style.display = 'flex'; // 할인 행 보이기
        } else {
            pointsDiscountAmountEl.textContent = '-0원';
            pointsDiscountRowEl.style.display = 'none'; // 할인 행 숨기기
        }

        // (쿠폰 할인 표시 업데이트 로직 추가)
        if (couponDiscount > 0) {
            // 1. 텍스트 변경: 예) "-3,000원"
            couponDiscountAmountEl.textContent = `-${couponDiscount.toLocaleString('ko-KR')}원`;

            // 2. 행 보이기 (display: none 해제)
            couponDiscountRowEl.style.display = 'flex';
        } else {
            // 1. 텍스트 초기화
            couponDiscountAmountEl.textContent = '-0원';

            // 2. 행 숨기기 (선택 사항: 0원일 때 안 보이게 하려면 none, 보이게 하려면 flex 유지)
            couponDiscountRowEl.style.display = 'none';
        }

        // 6. 최종 결제 금액 계산
        // (상품금액 + 포장비 + 배송비) - 할인
        const finalPrice = Math.max(0, totalBeforeDiscount - pointDiscount - couponDiscount);

        // 7. 최종 결제 금액 및 버튼 텍스트 업데이트
        actualOrderPriceEl.textContent = `${finalPrice.toLocaleString('ko-KR')}원`;
        paymentButton.textContent = `${finalPrice.toLocaleString('ko-KR')}원 결제하기`;
    }

    function sample6_execDaumPostcode() {
        new daum.Postcode({
            oncomplete: function (data) {
                //  팝업에서 검색 결과 항목을 클릭했을 때 실행할 코드를 작성하는 부분
                var addr = '';
                var extraAddr = '';

                // 사용자가 선택한 주소 타입에 따라 해당 주소 값을 가져옴
                if (data.userSelectedType !== 'R') { // 사용자가 도로명을 선택하지 않았을 경우
                    alert('지번 주소가 선택되었습니다. 도로명 주소로 반영됩니다.');
                }

                addr = data.roadAddress;

                // 사용자가 선택한 주소가 도로명 타입일때 참고항목을 조합한다.
                if (data.userSelectedType === 'R') {
                    // 법정동명이 있을 경우 추가한다. (법정리는 제외)
                    // 법정동의 경우 마지막 문자가 "동/로/가"로 끝난다.
                    if (data.bname !== '' && /[동|로|가]$/g.test(data.bname)) {
                        extraAddr += data.bname;
                    }
                    // 건물명이 있고, 공동주택일 경우 추가한다.
                    if (data.buildingName !== '' && data.apartment === 'Y') {
                        extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                    }
                    // 표시할 참고항목이 있을 경우, 괄호까지 추가한 최종 문자열을 만든다.
                    if (extraAddr !== '') {
                        extraAddr = ' (' + extraAddr + ')';
                    }
                    // 조합된 참고항목을 해당 필드에 넣는다.
                    document.getElementById("address-extra").value = extraAddr;

                } else {
                    document.getElementById("address-extra").value = '';
                }

                document.getElementById('zip').value = data.zonecode;
                document.getElementById("address").value = addr;
                document.getElementById("address-detail").focus();
            }
        }).open();
    }

    document.addEventListener('DOMContentLoaded', () => {
        // 1. "포장지 선택" 모달 요소를 가져옵니다.
        const packagingModal = document.getElementById('packagingSelectModal');
        if (packagingModal) {
            // 2. 모달이 열리기 '직전'에 실행되는 이벤트를 감지합니다.
            packagingModal.addEventListener('show.bs.modal', function (event) {
                // 3. 어떤 버튼이 모달을 열었는지 가져옵니다.
                const button = event.relatedTarget;
                // 4. 버튼에 심어둔 'data-order-item-id' 속성 값을 읽어옵니다.
                const orderItemId = button.dataset.orderItemId;
                // 5. 모달 안의 숨겨진(hidden) input을 찾습니다.
                const hiddenInput = document.getElementById('modal_order_item_id');
                // 6. 숨겨진 input의 값(value)에 상품 ID를 설정합니다.
                hiddenInput.value = orderItemId;
                // 7. (선택) 모달이 열릴 때마다 "포장 안 함"을 기본으로 체크
                const defaultRadio = packagingModal.querySelector('input[name="packagingId"][value="0"]');
                if (defaultRadio) {
                    defaultRadio.checked = true;
                }
            });
        }
    });

    function initPackagingModal() {
        const packagingModal = document.getElementById('packagingSelectModal');
        const savePackagingButton = document.getElementById('savePackagingButton');
        if (!packagingModal || !savePackagingButton) return;

        // ... (모달 열릴 때 로직은 그대로) ...

        // '적용' 버튼 클릭 시
        savePackagingButton.addEventListener('click', () => {
            const bookId = document.getElementById('modal_order_item_id').value;
            const selectedRadio = packagingModal.querySelector('input[name="packagingId"]:checked');
            if (!selectedRadio) return;

            const packagingId = selectedRadio.value;
            const label = selectedRadio.closest('label');

            const priceText = label.querySelector('.text-muted').textContent;
            const packagingPrice = parseInt(priceText.replace(/[^\d]/g, ''), 10) || 0;

            const nameElement = label.querySelector('strong, span:not(.text-muted)');
            const packagingName = nameElement ? nameElement.textContent : '포장 선택됨';

            const orderItemDiv = document.querySelector(`.order-item[data-book-id="${bookId}"]`);
            const triggerButton = document.querySelector(`button[data-order-item-id="${bookId}"]`);

            if (orderItemDiv && triggerButton) {
                orderItemDiv.dataset.packagingId = packagingId;
                orderItemDiv.dataset.packagingPrice = packagingPrice;

                // 모든 색상 클래스를 제거하여 초기화합니다.
                triggerButton.classList.remove('btn-success', 'btn-dark', 'btn-outline-secondary', 'text-white');

                if (packagingId === '0') {
                    // '포장 안 함' 선택 시 (기본값)
                    triggerButton.innerHTML = '<i class="bi bi-box-seam me-1"></i> 포장 선택';
                    triggerButton.classList.add('btn-outline-secondary'); // 기본 회색 테두리 버튼
                } else {
                    // 포장 선택 시
                    triggerButton.innerHTML = `<i class="bi bi-check-lg me-1"></i> ${packagingName}`;
                    triggerButton.classList.add('btn', 'btn-dark', 'text-white'); // 검은색 배경, 흰색 텍스트
                }
            }

            updatePriceSummary();

            const modalInstance = bootstrap.Modal.getInstance(packagingModal);
            modalInstance.hide();

            if (triggerButton) {
                triggerButton.focus();
            }
        });
    }


    // function initCouponSelection() {
    //     const selectCouponBtn = document.getElementById('select-coupon-btn');
    //     const couponModal = document.getElementById('couponSelectModal');
    //     const applyCouponButton = document.getElementById('applyCouponButton');
    //
    //     if (!selectCouponBtn || !couponModal) return;
    //
    //     selectCouponBtn.addEventListener('click', () => {
    //         const modalInstance = new bootstrap.Modal(couponModal);
    //         modalInstance.show();
    //     });
    //
    //     if (applyCouponButton) {
    //         applyCouponButton.addEventListener('click', () => {
    //
    //             // 1. 모달 닫기
    //             const modalInstance = bootstrap.Modal.getInstance(couponModal);
    //             if (modalInstance) modalInstance.hide();
    //
    //             // 🌟🌟🌟 [최종 해결] 잔상 강제 동기 제거 🌟🌟🌟
    //             // '적용' 버튼 클릭 직후, 다른 동작보다 먼저 페이지를 복구합니다.
    //             document.body.classList.remove('modal-open');
    //             // document.body.style.paddingRight = ''; // 패딩 문제 발생 시 추가
    //             const backdrops = document.querySelectorAll('.modal-backdrop');
    //             backdrops.forEach(backdrop => backdrop.remove());
    //
    //             // 2. 가격 요약 업데이트 (페이지 복구 후 실행)
    //             updatePriceSummary();
    //         });
    //     }
    //
    //     // 2. hidden.bs.modal 이벤트: 취소/외부 클릭 시 잔상 제거 (동일하게 유지)
    //     //    이 코드는 '취소' 버튼을 위해 필요하며, '적용' 버튼 클릭 시 위 로직이 더 빨리 실행됩니다.
    //     couponModal.addEventListener('hidden.bs.modal', function () {
    //         document.body.classList.remove('modal-open');
    //         const backdrops = document.querySelectorAll('.modal-backdrop');
    //         backdrops.forEach(backdrop => backdrop.remove());
    //
    //         // 💡 추가: body에 직접 style이 남아있을 경우를 대비하여 style도 제거
    //         document.body.style.removeProperty('overflow');
    //         document.body.style.removeProperty('padding-right');
    //     });
    // }

    function initCouponSelection() {
        const selectCouponBtn = document.getElementById('select-coupon-btn');
        const couponModal = document.getElementById('couponSelectModal');
        const applyCouponButton = document.getElementById('applyCouponButton');

        if (!selectCouponBtn || !couponModal) return;

        selectCouponBtn.addEventListener('click', () => {
            const modalInstance = new bootstrap.Modal(couponModal);
            modalInstance.show();
        });

        // 1. '적용' 버튼 클릭 로직 (API 호출 포함)
        if (applyCouponButton) {
            applyCouponButton.addEventListener('click', async () => { // 💡 async 키워드 추가
                const selectedRadio = couponModal.querySelector('input[name="couponSelect"]:checked');
                if (!selectedRadio) return;

                const selectedCouponInfoEl = document.getElementById('selected-coupon-info');
                const selectedCouponIdHidden = document.getElementById('selected_coupon_id_hidden');
                const couponDiscountAmountHidden = document.getElementById('coupon_discount_amount_hidden');

                const couponId = selectedRadio.value;
                const couponName = selectedRadio.dataset.couponName; // data-coupon-name 속성에서 가져온다고 가정

                // 주문 항목 수집 (BookId, Quantity)
                const orderItems = collectOrderItems();
                // ⚠️ 토큰 추출 로직은 사용자 환경에 맞게 조정하세요 (예: 쿠키에서 추출)

                let finalDiscountAmount = 0;

                // 1. 쿠폰 미적용 (ID=0) 처리
                if (couponId === '0') {
                    finalDiscountAmount = 0;
                } else {
                    // 2. 백엔드 호출: 주문 항목과 쿠폰 ID를 보내 최종 할인액 요청
                    finalDiscountAmount = await fetchFinalCouponDiscount(couponId, orderItems);

                    // 3. API 호출 결과 반영
                    if (finalDiscountAmount === 0) {
                        // 할인 금액이 0이면 미적용 처리
                        alert(`[${couponName}] 쿠폰이 적용되었으나, 주문 조건/상품 불일치로 할인 금액이 0원입니다. (미적용 처리)`);
                        couponModal.querySelector('input[name="couponSelect"][value="0"]').checked = true;
                        selectedCouponIdHidden.value = '';
                        selectedCouponInfoEl.style.display = 'none';
                        finalDiscountAmount = 0;
                    } else {
                        // 4. 성공적으로 할인액 적용
                        selectedCouponIdHidden.value = couponId;
                        selectedCouponInfoEl.textContent = `${couponName}: ${finalDiscountAmount.toLocaleString('ko-KR')}원 할인 적용`;
                        selectedCouponInfoEl.style.display = 'block';
                    }
                }

                // 5. Hidden 필드 업데이트
                couponDiscountAmountHidden.value = finalDiscountAmount;

                // 6. 모달 닫기 및 잔상 강제 제거
                const modalInstance = bootstrap.Modal.getInstance(couponModal);
                if (modalInstance) modalInstance.hide();

                document.body.classList.remove('modal-open');
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(backdrop => backdrop.remove());
                document.body.style.removeProperty('overflow');
                document.body.style.removeProperty('padding-right');

                // 7. 최종 가격 요약 업데이트
                updatePriceSummary();
            });
        }

        // 2. hidden.bs.modal 이벤트: 취소/외부 클릭 시 잔상 제거
        couponModal.addEventListener('hidden.bs.modal', function () {
            document.body.classList.remove('modal-open');
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());

            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');
        });
    }

    /**
     * 결제 버튼 로직과 동일하게 주문 상품 리스트를 수집하는 헬퍼 함수
     */
    function collectOrderItems() {
        const orderItems = [];
        document.querySelectorAll('.order-item').forEach(item => {
            const dataset = item.dataset;
            orderItems.push({
                bookId: parseInt(dataset.bookId, 10),
                quantity: parseInt(dataset.quantity, 10)
                // 백엔드에서 price를 직접 조회하므로 price는 불필요
            });
        });
        return orderItems;
    }

    /**
     * 백엔드에 선택된 쿠폰을 보내고 최종 할인 금액을 받아오는 API 호출 함수
     * @param {string} token - 액세스 토큰
     * @param {Long} couponId - 선택된 쿠폰 ID
     * @param {Array<Object>} orderItems - 주문 항목 리스트 (bookId, quantity 포함)
     * @returns {number} 최종 할인 금액 (원)
     */
    async function fetchFinalCouponDiscount(couponId, orderItems) {
        if (!couponId || couponId === '0') return 0;

        // 백엔드의 POST /api/coupon/apply 엔드포인트로 요청한다고 가정
        // (이 엔드포인트는 백엔드에서 새로 만들어야 합니다.)
        const url = '/api/coupon/calculate-discount';

        const requestBody = {
            couponId: couponId,
            orderItems: orderItems
        };

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({message: "서버 오류"}));
                throw new Error(errorData.message || '할인 금액 계산에 실패했습니다.');
            }

            // 백엔드가 {discountAmount: 5000} 형태로 응답한다고 가정
            const data = await response.json();
            return data.discountAmount || 0;

        } catch (error) {
            console.error("쿠폰 할인 계산 중 오류 발생:", error);
            alert(error.message);
            return 0;
        }
    }

</script>
<div class="modal fade" id="packagingSelectModal" tabindex="-1" aria-labelledby="packagingModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="packagingModalLabel">포장지 선택</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <p>이 상품에 적용할 포장지를 선택하세요.</p>

                <form id="packagingSelectForm">

                    <input type="hidden" id="modal_order_item_id" name="orderItemId">

                    <div class="list-group">
                        <label class="list-group-item list-group-item-action d-flex align-items-center">
                            <input class="form-check-input me-3" type="radio" name="packagingId" value="0" checked>
                            <i class="bi bi-x-circle me-2 text-danger"></i>
                            <strong>포장 안 함</strong>
                            <span class="text-muted ms-auto">(0원)</span>
                        </label>

                        <th:block th:each="pack : ${packagingOptions}">
                            <label class="list-group-item list-group-item-action d-flex align-items-center">
                                <input class="form-check-input me-3" type="radio" name="packagingId"
                                       th:value="${pack.packagingId}">

                                <img th:src="${pack.packagingImageUrl}" class="img-thumbnail me-2"
                                     style="width: 50px; height: 50px; object-fit: cover;"
                                     th:if="${pack.packagingImageUrl != null and pack.packagingImageUrl != ''}">

                                <span th:text="${pack.packagingName}">포장지 이름</span>

                                <span class="text-muted ms-auto"
                                      th:text="'(+' + ${#numbers.formatInteger(pack.packagingPrice, 0, 'COMMA')} + '원)'">
                  (+1,000원)
                </span>
                            </label>
                        </th:block>

                        <tr th:if="${packagingOptions == null or #lists.isEmpty(packagingOptions)}">
                            <td colspan="4" class="text-center py-4">
                                등록된 포장지 정책이 없습니다.
                            </td>
                        </tr>
                    </div>
                </form>

            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" id="savePackagingButton">적용</button>
            </div>
        </div>
    </div>
</div>
<!--쿠폰 modal-->
<div class="modal fade" id="couponSelectModal" tabindex="-1" aria-labelledby="couponModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="couponModalLabel">사용 가능한 쿠폰 선택</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="selected_coupon_id_hidden" name="selectedCouponId" value="">
                <input type="hidden" id="coupon_discount_amount_hidden" value="0">

                <div th:if="${usableCoupons == null || #lists.isEmpty(usableCoupons)}">
                    <p class="text-center text-muted">현재 주문 상품에 적용 가능한 쿠폰이 없습니다.</p>
                </div>
                <div th:unless="${usableCoupons == null || #lists.isEmpty(usableCoupons)}" class="list-group">

                    <label class="list-group-item list-group-item-action d-flex align-items-center">
                        <input class="form-check-input me-3 coupon-radio" type="radio" name="couponSelect" value="0" checked data-name="쿠폰 미적용">
                        <i class="bi bi-x-circle me-2 text-danger"></i>
                        <strong>쿠폰 미적용</strong>
                        <span class="text-muted ms-auto">(할인 없음)</span>
                    </label>

                    <th:block th:each="coupon : ${usableCoupons}">
                        <label class="list-group-item list-group-item-action d-flex align-items-center"
                               th:data-coupon-id="${coupon.couponId}"
                               th:data-discount-value="${coupon.discountValue}"
                               th:data-discount-type="${coupon.discountType}"
                               th:data-criterion-price="${coupon.criterionPrice}"
                               th:data-discount-limit="${coupon.discountLimit}">

                            <input class="form-check-input me-3 coupon-radio" type="radio" name="couponSelect"
                                   th:id="'coupon-' + ${coupon.couponId}"
                                   th:value="${coupon.couponId}"
                                   th:data-coupon-name="${coupon.couponName}">

                            <div class="flex-grow-1">
                                <strong th:text="${coupon.couponName}">쿠폰 이름</strong>
                                <span class="badge bg-secondary ms-2" th:text="${coupon.policyTargetType}">WELCOME</span>
                                <small class="text-muted d-block"
                                       th:text="'만료일: ' + ${#temporals.format(coupon.expiredDate, 'yyyy-MM-dd')}">만료일</small>
                                <small class="text-muted d-block"
                                       th:text="'최소 주문액: ' + ${#numbers.formatInteger(coupon.criterionPrice, 0, 'COMMA')} + '원'">최소 주문액</small>
                            </div>

                            <span class="fw-bold text-success ms-auto"
                                  th:text="${coupon.discountType == 'RATE' ? (coupon.discountValue + '% 할인') : (#numbers.formatInteger(coupon.discountValue, 0, 'COMMA') + '원 할인')}">
                                할인 금액/율
                            </span>
                            <small th:if="${coupon.discountType == 'RATE'}" class="text-muted d-block ms-2"
                                   th:text="'(최대 ' + ${#numbers.formatInteger(coupon.discountLimit, 0, 'COMMA')} + '원)'"></small>
                        </label>
                    </th:block>

                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" id="applyCouponButton">적용</button>
            </div>
        </div>
    </div>
</div>

</body>
</html>